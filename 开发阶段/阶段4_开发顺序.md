# 阶段4 开发顺序表

> **进度追踪说明**：每个整数序号的步骤完成后，在对应行的"完成"列中将 `[ ]` 改为 `[x]` 进行打钩确认。
>
> **当前进度**：28 / 93 已完成

## 阶段 1 - 基础设施准备（Week 1 前）

**目标**：准备仿真域所需的基础设施模块

| 完成 | 序号 | 模块                                | 文档章节 | 依赖 |
| :--: | ---- | ----------------------------------- | -------- | ---- |
| [x] | 1.1  | `load_result.py`                  | 4.0.5.1  | 无   |
| [x] | 1.2  | `file_reference_validator.py`     | 4.0.5.2  | 1.1  |
| [x] | 1.3  | 仿真事件定义（event_types.py 扩展） | 4.0.3    | 无   |

**验收**：文件引用校验机制可用，仿真事件常量已定义

---

## 阶段 2 - 基础仿真核心（Week 1）

**目标**：建立最小可用的仿真执行链路

| 完成 | 序号 | 模块                              | 文档章节 | 依赖                |
| :--: | ---- | --------------------------------- | -------- | ------------------- |
| [x] | 2.1  | `simulation_result.py`          | 4.1.1    | 无                  |
| [x] | 2.2  | `simulation_error.py`           | 4.1.2    | 无                  |
| [x] | 2.3  | `simulation_config.py`          | 4.1.3    | 无                  |
| [x] | 2.4  | `simulation_executor.py` (基类) | 4.2.2    | 2.1,2.2             |
| [x] | 2.5  | `executor_registry.py`          | 4.2.3    | 2.4                 |
| [x] | 2.6  | `spice_executor.py`             | 4.2.5    | 2.4, ngspice_config |
| [x] | 2.7  | `simulation_service.py`         | 4.3.1    | 2.5,2.6             |

**验收**：能执行单个 .cir 文件的 AC/DC/TRAN 分析，返回结构化结果

---

## 阶段 3 - 文件发现与配置（Week 1）

**目标**：支持自动检测主电路和配置管理

| 完成 | 序号 | 模块                             | 文档章节 | 依赖 |
| :--: | ---- | -------------------------------- | -------- | ---- |
| [x] | 3.1  | `circuit_analyzer.py`          | 4.2.1    | 无   |
| [x] | 3.2  | `simulation_config_service.py` | 4.3.2    | 2.3  |
| [x] | 3.3  | `python_executor.py`           | 4.2.7    | 2.4  |

**验收**：能自动识别项目中的主电路文件，配置可持久化

---

## 阶段 3.5 - 仿真选择器（Week 1）

**目标**：支持用户手动选择要执行的分析类型和要显示的图表类型

| 完成 | 序号  | 模块                                        | 文档章节 | 依赖  |
| :--: | ----- | ------------------------------------------- | -------- | ----- |
| [ ] | 3.5.1 | `analysis_selector.py`                    | 4.3.4    | 2.3   |
| [ ] | 3.5.2 | `chart_selector.py`                       | 4.3.5    | 3.5.1 |
| [ ] | 3.5.3 | 更新 `simulation_service.py` 支持批量执行 | 4.3.1    | 3.5.1 |

**验收**：用户可选择要执行的分析类型，选择可持久化到项目配置

---

## 阶段 4 - 基础指标提取（Week 2 前半）

**目标**：从仿真结果中提取关键性能指标

| 完成 | 序号 | 模块                            | 文档章节 | 依赖    |
| :--: | ---- | ------------------------------- | -------- | ------- |
| [x] | 4.1  | `metric_result.py`            | 4.5.1    | 无      |
| [x] | 4.2  | `amplifier_metrics.py`        | 4.5.3    | 4.1     |
| [x] | 4.3  | `noise_metrics.py`            | 4.5.4    | 4.1     |
| [x] | 4.4  | `distortion_metrics.py`       | 4.5.5    | 4.1     |
| [x] | 4.5  | `power_metrics.py`            | 4.5.6    | 4.1     |
| [x] | 4.6  | `transient_metrics.py`        | 4.5.7    | 4.1     |
| [x] | 4.7  | `metrics_extractor.py` (门面) | 4.5.2    | 4.2-4.6 |

**验收**：能从 AC/TRAN 结果中提取增益、带宽、上升时间等基础指标

---

## 阶段 5 - 设计管理域（Week 2 前半）

**目标**：建立设计目标管理和迭代控制机制

| 完成 | 序号 | 模块                       | 文档章节 | 依赖 |
| :--: | ---- | -------------------------- | -------- | ---- |
|      | 5.1  | `design_goals.py`        | 4.10.1   | 无   |
|      | 5.2  | `termination_checker.py` | 4.10.2   | 5.1  |
|      | 5.3  | `undo_manager.py`        | 4.10.3   | 无   |

**验收**：设计目标可创建/编辑/持久化，终止条件判断逻辑正确

---

## 阶段 6 - 仿真面板 UI（Week 2 后半）

**目标**：建立仿真结果的基础展示界面

| 完成 | 序号 | 模块                              | 文档章节  | 依赖            |
| :--: | ---- | --------------------------------- | --------- | --------------- |
| [ ] | 6.1  | `simulation_view_model.py`      | 4.11.1.0  | 2.7,4.7         |
| [ ] | 6.2  | `metric_card.py`                | 4.11.1.1  | 无              |
| [ ] | 6.3  | `metrics_panel.py`              | 4.11.1.2  | 6.2             |
| [ ] | 6.4  | `chart_viewer.py` (基础版)      | 4.11.1.3  | 无              |
| [ ] | 6.5  | `simulation_settings_dialog.py` | 4.11.1.15 | 3.5.1,3.5.2     |
| [ ] | 6.6  | `simulation_tab.py`             | 4.11.1.6  | 6.1,6.3,6.4,6.5 |
| [ ] | 6.7  | `bottom_panel.py`               | 4.11.0    | 6.6             |
|      | 6.8  | **主窗口集成：下栏面板**    | 4.12.1    | 6.7             |
|      |      | - 添加下栏面板到主窗口布局        |           |                 |
|      |      | - 添加「设置 → 仿真设置」菜单项   |           |                 |
|      |      | - 添加仿真工具栏按钮              |           |                 |

**验收**：仿真完成后能在下栏面板显示指标卡片和基础图表，可通过菜单打开仿真设置对话框

---

## 阶段 7 - 仿真配置对话框（Week 2 后半）

**目标**：提供仿真参数配置界面

| 完成 | 序号 | 模块                                | 文档章节 | 依赖 |
| :--: | ---- | ----------------------------------- | -------- | ---- |
|      | 7.1  | `simulation_config_view_model.py` | 4.10.4.1 | 3.2  |
|      | 7.2  | `simulation_config_dialog.py`     | 4.10.4.2 | 7.1  |
|      | 7.3  | `ac_config_tab.py`                | 4.10.4.3 | 无   |
|      | 7.4  | `dc_config_tab.py`                | 4.10.4.4 | 无   |
|      | 7.5  | `transient_config_tab.py`         | 4.10.4.5 | 无   |
|      | 7.6  | `noise_config_tab.py`             | 4.10.4.6 | 无   |
|      | 7.7  | `convergence_config_tab.py`       | 4.10.4.7 | 无   |

**验收**：用户可通过对话框配置 AC/DC/瞬态/噪声分析参数和收敛参数

---

## 阶段 8 - 波形数据处理（Week 3 前半）

**目标**：支持大数据量波形的高效显示

| 完成 | 序号 | 模块                            | 文档章节  | 依赖     |
| :--: | ---- | ------------------------------- | --------- | -------- |
| [ ] | 8.1  | `downsampler.py`              | 4.7.2     | 无       |
| [ ] | 8.2  | `resolution_pyramid.py`       | 4.7.3     | 8.1      |
| [ ] | 8.3  | `waveform_data_service.py`    | 4.7.1     | 8.1,8.2  |
| [ ] | 8.4  | `data_exporter.py`            | 4.7.4     | 无       |
| [ ] | 8.5  | `simulation_output_reader.py` | 4.7.5     | 无       |
| [ ] | 8.6  | `waveform_widget.py`          | 4.11.1.10 | 8.3      |
| [ ] | 8.7  | `measurement_tool.py`         | 4.11.1.11 | 8.6      |
| [ ] | 8.8  | `raw_data_table.py`           | 4.11.1.12 | 8.3      |
| [ ] | 8.9  | `output_log_viewer.py`        | 4.11.1.13 | 8.5      |
| [ ] | 8.10 | `waveform_math_dialog.py`     | 4.11.1.14 | 8.6      |
|      | 8.11 | **主窗口集成：波形工具**  | 4.12.1    | 8.6-8.10 |
|      |      | - 添加波形查看器到仿真面板      |           |          |
|      |      | - 添加数据导出菜单项            |           |          |
|      |      | - 添加测量工具快捷键            |           |          |

**验收**：百万点波形能流畅缩放，双光标测量功能可用，数据导出正常

---

## 阶段 9 - 快速调参与状态指示（Week 3 前半）

**目标**：提供参数调整和状态显示功能

| 完成 | 序号 | 模块                    | 文档章节 | 依赖 |
| :--: | ---- | ----------------------- | -------- | ---- |
|      | 9.1  | `tuning_panel.py`     | 4.11.1.4 | 2.7  |
|      | 9.2  | `status_indicator.py` | 4.11.1.5 | 无   |

**验收**：可调参数提取正确，滑块调参响应正常，状态指示器显示正确

---

## 阶段 10 - 设计管理与迭代（Week 3 后半）

**目标**：支持设计目标管理和迭代撤回

| 完成 | 序号 | 模块                                 | 文档章节 | 依赖      |
| :--: | ---- | ------------------------------------ | -------- | --------- |
| [ ] | 10.1 | `design_goals.py`                  | 4.10.1   | 无        |
| [ ] | 10.2 | `termination_checker.py`           | 4.10.2   | 10.1      |
| [ ] | 10.3 | `undo_manager.py`                  | 4.10.3   | 无        |
| [ ] | 10.4 | `history_dialog.py`                | 4.11.2   | 10.3      |
| [ ] | 10.5 | `select_simulation_file_dialog.py` | 4.11.3   | 2.7       |
|      | 10.6 | **主窗口集成：设计管理**       | 4.12.1   | 10.4,10.5 |
|      |      | - 添加设计目标菜单项                 |          |           |
|      |      | - 添加历史记录对话框入口             |          |           |
|      |      | - 添加撤回操作快捷键                 |          |           |

**验收**：能创建/编辑设计目标，能撤回到历史迭代，能选择仿真文件

---

## 阶段 11 - 仿真辅助模块（Week 3 后半）

**目标**：提供收敛辅助和反馈生成功能

| 完成 | 序号 | 模块                      | 文档章节    | 依赖 |
| :--: | ---- | ------------------------- | ----------- | ---- |
|      | 11.1 | `convergence_helper.py` | 4.6.1       | 2.6  |
|      | 11.2 | `feedback_generator.py` | 4.6 helpers | 4.7  |

**验收**：能诊断收敛问题并提供修复建议，能生成仿真反馈

---

## 阶段 12 - 高级分析（可选，Week 4+）

**目标**：扩展高级仿真分析能力

| 完成 | 序号  | 模块                           | 文档章节 | 依赖      |
| :--: | ----- | ------------------------------ | -------- | --------- |
| [x] | 12.1  | `analysis_result.py`         | 4.1.4    | 2.1       |
| [x] | 12.2  | `pvt_analysis.py`            | 4.4.1    | 2.7,12.1  |
| [x] | 12.3  | `monte_carlo_analysis.py`    | 4.4.2    | 2.7,12.1  |
| [x] | 12.4  | `parametric_sweep.py`        | 4.4.3    | 2.7,12.1  |
| [x] | 12.5  | `worst_case_analysis.py`     | 4.4.4    | 2.7,12.1  |
| [ ] | 12.6  | `sensitivity_analysis.py`    | 4.4.5    | 2.7,12.1  |
| [ ] | 12.7  | `post_processor.py`          | 4.4.6    | 2.7       |
| [ ] | 12.8  | `topology_recognizer.py`     | 4.4.7    | 无        |
| [ ] | 12.9  | 高级分析结果标签页组           | 4.11.1.7 | 12.1-12.8 |
|      | 12.10 | **主窗口集成：高级分析** | 4.12.1   | 12.9      |
|      |       | - 添加高级分析标签页到下栏面板 |          |           |
|      |       | - 添加高级分析菜单项           |          |           |

**验收**：PVT/蒙特卡洛/参数扫描/敏感度分析功能可用

---

## 阶段 13 - 高级分析结果标签页（可选，Week 4+）

**目标**：为高级分析提供专用结果展示界面

| 完成 | 序号 | 模块                          | 文档章节 | 依赖 |
| :--: | ---- | ----------------------------- | -------- | ---- |
|      | 13.1 | `pvt_result_tab.py`         | 4.11.1.7 | 12.2 |
|      | 13.2 | `monte_carlo_result_tab.py` | 4.11.1.7 | 12.3 |
|      | 13.3 | `sweep_result_tab.py`       | 4.11.1.7 | 12.4 |
|      | 13.4 | `worst_case_result_tab.py`  | 4.11.1.7 | 12.5 |
|      | 13.5 | `sensitivity_result_tab.py` | 4.11.1.7 | 12.6 |
|      | 13.6 | `fft_result_tab.py`         | 4.11.1.7 | 12.7 |
|      | 13.7 | `topology_info_panel.py`    | 4.11.1.7 | 12.8 |
|      | 13.8 | `diagnosis_panel.py`        | 4.11.1.7 | 11.1 |

**验收**：各高级分析结果能正确展示，支持图表交互和数据导出

---

## 阶段 14 - 电路图生成（可选，Week 4+）

**目标**：从网表生成可视化电路图

| 完成 | 序号  | 模块                               | 文档章节 | 依赖      |
| :--: | ----- | ---------------------------------- | -------- | --------- |
| [ ] | 14.1  | `circuit_element.py`             | 4.8.1.1  | 无        |
| [ ] | 14.2  | `schematic_result.py`            | 4.8.1.2  | 无        |
| [ ] | 14.3  | `netlist_parser.py`              | 4.8.2.1  | 14.1      |
| [ ] | 14.4  | `element_mapper.py`              | 4.8.3.1  | 14.1      |
| [ ] | 14.5  | `schemdraw_adapter.py`           | 4.8.3.2  | 14.3,14.4 |
| [ ] | 14.6  | `schematic_service.py`           | 4.8.4    | 14.5      |
| [ ] | 14.7  | `schematic_panel.py`             | 4.8.5.1  | 14.6      |
| [ ] | 14.8  | `schematic_view.py`              | 4.8.5.2  | 14.7      |
| [ ] | 14.9  | `schematic_toolbar.py`           | 4.8.5.3  | 14.7      |
|      | 14.10 | **主窗口集成：电路图查看器** | 4.12.1   | 14.7-14.9 |
|      |       | - 添加电路图面板到主窗口           |          |           |
|      |       | - 添加电路图生成菜单项             |          |           |
|      |       | - 添加电路图工具栏                 |          |           |

**验收**：能从 .cir 文件生成 SVG 电路图并显示

---

## 阶段 15 - 电路图查看器面板扩展（可选，Week 4+）

**目标**：提供完整的电路图查看器功能

| 完成 | 序号 | 模块                          | 文档章节   | 依赖      |
| :--: | ---- | ----------------------------- | ---------- | --------- |
|      | 15.1 | `schematic_viewer_panel.py` | 4.10.6.1.1 | 14.7-14.9 |
|      | 15.2 | `schematic/toolbar.py`      | 4.10.6.1.2 | 无        |
|      | 15.3 | `schematic/info_panel.py`   | 4.10.6.1.3 | 无        |
|      | 15.4 | `schematic/zoom_control.py` | 4.10.6.1.4 | 无        |

**验收**：电路图查看器支持缩放、平移、元件信息显示、与代码编辑器联动

---

## 阶段 16 - 报告生成（可选，Week 4+）

**目标**：支持 LLM 辅助生成设计报告

| 完成 | 序号  | 模块                           | 文档章节 | 依赖      |
| :--: | ----- | ------------------------------ | -------- | --------- |
| [ ] | 16.1  | `report_types.py`            | 4.18.1   | 无        |
| [ ] | 16.2  | `report_context_builder.py`  | 4.18.2   | 16.1      |
| [ ] | 16.3  | `report_generator.py`        | 4.18.3   | 16.2      |
| [ ] | 16.4  | `report_view_model.py`       | 4.17.2   | 16.3      |
| [ ] | 16.5  | `report_tab.py`              | 4.17.3   | 16.4      |
| [ ] | 16.6  | `info_collector_widget.py`   | 4.17.4   | 无        |
| [ ] | 16.7  | `current_info_dialog.py`     | 4.17.5   | 无        |
| [ ] | 16.8  | `prompt_input_widget.py`     | 4.17.6   | 无        |
| [ ] | 16.9  | `report_progress_widget.py`  | 4.17.7   | 无        |
|      | 16.10 | **主窗口集成：报告生成** | 4.12.1   | 16.5-16.9 |
|      |       | - 添加报告标签页到下栏面板     |          |           |
|      |       | - 添加报告生成菜单项           |          |           |

**验收**：能收集信息并生成 Markdown 报告

---

## 阶段 17 - 报告生成事件与 Prompt（可选，Week 4+）

**目标**：完善报告生成的事件机制和 Prompt 模板

| 完成 | 序号 | 模块                    | 文档章节 | 依赖 |
| :--: | ---- | ----------------------- | -------- | ---- |
|      | 17.1 | `report_events.py`    | 4.17.1   | 无   |
|      | 17.2 | `report_prompts.json` | 4.18.4   | 无   |

**验收**：报告生成事件正确发布，Prompt 模板可用

---

## 阶段 18 - 仿真辅助模块（可选，Week 4+）

**目标**：提供收敛辅助和元件库管理功能

| 完成 | 序号  | 模块                             | 文档章节 | 依赖           |
| :--: | ----- | -------------------------------- | -------- | -------------- |
| [ ] | 18.1  | `convergence_helper.py`        | 4.6.1    | 2.6            |
| [ ] | 18.2  | `library_manager.py`           | 4.6.2.1  | ngspice_config |
| [ ] | 18.3  | `library_downloader.py`        | 4.6.2.2  | 18.2           |
| [ ] | 18.4  | `library_panel.py`             | 4.10.7.1 | 18.2,18.3      |
| [ ] | 18.5  | `library_view_model.py`        | 4.10.7.2 | 18.2           |
| [ ] | 18.6  | `library_browser.py`           | 4.10.7.3 | 无             |
| [ ] | 18.7  | `component_search.py`          | 4.10.7.4 | 无             |
| [ ] | 18.8  | `component_detail.py`          | 4.10.7.5 | 无             |
| [ ] | 18.9  | `library_import_dialog.py`     | 4.10.7.6 | 18.2           |
|      | 18.10 | **主窗口集成：元件库管理** | 4.12.1   | 18.4-18.9      |
|      |       | - 添加元件库面板入口             |          |                |
|      |       | - 添加元件库菜单项               |          |                |

**验收**：能诊断收敛问题并提供修复建议，能管理和搜索元件库

---

## 阶段 19 - 代码编辑器增强（可选，Week 4+）

**目标**：为 SPICE 文件提供智能编辑支持

| 完成 | 序号 | 模块                             | 文档章节 | 依赖      |
| :--: | ---- | -------------------------------- | -------- | --------- |
| [ ] | 19.1 | `spice_completer.py`           | 4.13.1   | 无        |
| [ ] | 19.2 | `spice_linter.py`              | 4.13.2   | 无        |
| [ ] | 19.3 | 代码编辑器集成                   | 4.13.3   | 19.1,19.2 |
|      | 19.4 | **主窗口集成：编辑器增强** | 4.12.1   | 19.3      |
|      |      | - 集成自动补全到代码编辑器       |          |           |
|      |      | - 集成语法检查到代码编辑器       |          |           |

**验收**：SPICE 文件支持自动补全和实时语法检查

---

## 阶段 20 - 仿真执行上下文（Week 3）

**目标**：封装仿真任务的异步执行逻辑

| 完成 | 序号 | 模块                   | 文档章节 | 依赖 |
| :--: | ---- | ---------------------- | -------- | ---- |
| [ ] | 20.1 | `simulation_task.py` | 4.9.1    | 2.7  |
| [ ] | 20.2 | `schematic_task.py`  | 4.9.2    | 14.6 |

**验收**：仿真和电路图生成任务能异步执行，支持取消操作

---

## 阶段 21 - 核心流程预集成（Week 4）

**目标**：验证 LLM → 仿真 → 分析主线流程

| 完成 | 序号 | 模块             | 文档章节 | 依赖    |
| :--: | ---- | ---------------- | -------- | ------- |
| [ ] | 21.1 | 主线流程集成验证 | 4.15.1   | 2.7,4.7 |
| [ ] | 21.2 | 迭代确认机制验证 | 4.15.2   | 21.1    |
| [ ] | 21.3 | 工作流锁定机制   | 4.15.3   | 21.1    |

**验收**：LLM 输出能触发仿真，仿真结果能传递到分析节点，迭代暂停和恢复正常

---

## 阶段 22 - 统一信息面板集成（Week 4）

**目标**：与阶段九统一信息展示面板对接

| 完成 | 序号 | 模块                       | 文档章节 | 依赖 |
| :--: | ---- | -------------------------- | -------- | ---- |
| [ ] | 22.1 | `simulation_progress.py` | 4.16.1   | 2.1  |
| [ ] | 22.2 | 仿真事件数据规范           | 4.16.2   | 22.1 |
| [ ] | 22.3 | 面板间跳转事件             | 4.16.3   | 22.2 |

**验收**：仿真事件正确发布，右栏信息面板能显示仿真摘要卡片

---

## 阶段 23 - 跨阶段集成点（Week 4）

**目标**：确保与其他阶段的接口正确对接

| 完成 | 序号 | 模块                                   | 文档章节 | 依赖      |
| :--: | ---- | -------------------------------------- | -------- | --------- |
| [ ] | 23.1 | 与阶段三（LLM 集成）的接口             | 4.14.1   | 2.7       |
| [ ] | 23.2 | 与阶段五（RAG 知识检索）的集成点       | 4.14.2   | 2.7       |
| [ ] | 23.3 | 与阶段九（统一信息展示面板）的集成细节 | 4.14.3   | 22.1-22.3 |
| [ ] | 23.4 | 与阶段一（基础设施）的依赖             | 4.14.4   | 无        |

**验收**：跨阶段接口正确对接，数据流转正常

---

## 关键依赖图

```
ngspice_config (已实现)
       │
       ▼
[阶段 2] 基础仿真核心
       │
       ├──────────────────┐
       ▼                  ▼
[阶段 3]            [阶段 4]
文件发现与配置        基础指标提取
       │                  │
       ▼                  │
[阶段 3.5]                │
仿真选择器                │
       │                  │
       └────────┬─────────┘
                ▼
         [阶段 6]
    仿真面板 UI + 选择器面板 + 主窗口集成
                │
       ┌────────┼────────┐
       ▼        ▼        ▼
[阶段 8]  [阶段 10] [阶段 20]
波形数据处理 设计管理   仿真执行上下文
+ 主窗口集成 + 主窗口集成
       │        │        │
       └────────┴────────┘
                │
       ┌────────┼────────┬────────┐
       ▼        ▼        ▼        ▼
[阶段 12] [阶段 14] [阶段 16] [阶段 18]
高级分析    电路图生成  报告生成   仿真辅助
+ 主窗口集成 + 主窗口集成 + 主窗口集成 + 主窗口集成
       │        │        │        │
       └────────┴────────┴────────┘
                │
                ▼
         [阶段 19]
    代码编辑器增强 + 主窗口集成
                │
                ▼
         [阶段 21]
         核心流程预集成
                │
                ▼
         [阶段 22]
         统一信息面板集成
```

> **渐进式集成原则**：每个 Phase 完成 UI 组件后立即集成到主窗口，而非等到最后统一集成。
> 这样可以：
>
> 1. 及早发现集成问题
> 2. 每个阶段都有可运行的完整功能
> 3. 便于增量测试和演示

---

## 开发原则

1. **先跑通再优化**：阶段 2-6 是最小可用路径，优先完成
2. **UI 跟随领域**：先实现领域层逻辑，再开发对应 UI
3. **渐进式集成**：每个阶段完成 UI 后立即集成到主窗口，不等到最后统一集成
4. **高级功能后置**：阶段 12-19 标记为可选，基础稳定后再开发
5. **测试驱动**：每个阶段完成后执行验收测试，再进入下一阶段
6. **集成验证**：阶段 21-22 用于验证跨模块集成，确保主线流程畅通
7. **渐进式交付**：Week 1-2 完成核心功能，Week 3-4 完成扩展功能和集成

---
