## 阶段四：仿真引擎与可视化 (3周)

> **目标**：实现电路仿真、性能指标提取、图表生成，完成下栏面板（仿真结果标签页 + 报告生成标签页 + 电路图标签页）

### 4.0 核心架构

#### 4.0.0 统一路径规范

> **⚠️ 路径设计原则**：所有系统生成的数据统一存储在 `.circuit_ai/` 目录下，确保路径一致性

**路径常量定义**（位于 `shared/constants/paths.py`）：

```python
# 系统隐藏目录
SYSTEM_DIR = ".circuit_ai"

# 仿真结果目录（相对于项目根目录）
SIM_RESULTS_DIR = f"{SYSTEM_DIR}/sim_results"

# 仿真配置文件
SIM_CONFIG_FILE = f"{SYSTEM_DIR}/simulation_config.json"

# 分析选择配置
ANALYSIS_SELECTION_FILE = f"{SYSTEM_DIR}/analysis_selection.json"

# 图表选择配置
CHART_SELECTION_FILE = f"{SYSTEM_DIR}/chart_selection.json"

# 设计目标文件
DESIGN_GOALS_FILE = f"{SYSTEM_DIR}/design_goals.json"
```

**仿真结果存储路径**：
- 完整路径：`{project_root}/.circuit_ai/sim_results/{uuid}.json`
- GraphState 存储相对路径：`sim_results/{uuid}.json`（相对于 `.circuit_ai/`）
- 读取时通过 `SimulationService.load_sim_result(project_root, relative_path)` 拼接

**路径解析规则**：
- 所有服务层方法接收 `project_root` 参数，内部拼接完整路径
- 禁止在代码中硬编码绝对路径
- 路径常量统一从 `shared/constants/paths.py` 导入

#### 4.0.1 单一数据源原则

> **核心约束**：GraphState 是仿真数据的唯一真相来源（Single Source of Truth）

**数据流向**：
1. 仿真执行 → 结果写入 `.circuit_ai/sim_results/{uuid}.json`
2. GraphState 存储相对路径 `sim_result_path` 和指标摘要 `last_metrics`
3. 各消费方通过 `SimulationService.load_sim_result()` 按需读取

**禁止行为**：任何模块不得绕过 GraphState 直接从文件系统读取仿真结果作为实时数据

#### 4.0.2 面板职责边界

**下栏面板（本阶段）**：专注于仿真结果的详细展示与交互操作
- 波形图表查看器（双光标测量、缩放、导出）
- 高级分析结果标签页（PVT/蒙特卡洛/参数扫描）
- 电路图查看器、仿真输出日志、原始数据表格

**右栏信息面板（阶段九）**：专注于轻量级信息聚合与快速查看
- 仿真状态摘要卡片，点击跳转到下栏详情

#### 4.0.3 技术实现要点

- SPICE 仿真通过 PySpice 的 NgSpiceShared 共享库模式执行
- Python 脚本仿真通过 subprocess 在子进程中执行
- 仿真进度通过 `EventBus` 事件通知 UI，使用 `EventThrottler` 聚合高频更新
- 仿真错误通过 ErrorHandler 统一处理，不自动回滚
- 新增 UI 面板需实现 `retranslate_ui()` 方法

#### 4.0.4 跨阶段依赖

开始本阶段前，确认以下模块已正确实现：
- `shared/async_task_registry.py` - 异步任务注册表（阶段一）
- `infrastructure/persistence/file_manager.py` - 文件写入接口
- `shared/error_handler.py` - 错误处理接口

### 4.0 仿真域架构概览
### 4.1 仿真域目录结构

> **职责分离原则**：
> - **领域层（domain/simulation/）**：仿真执行、数据处理、指标提取
> - **表示层（presentation/panels/simulation/）**：UI 组件、图表渲染、用户交互

```
domain/simulation/
├── models/                          # 数据模型
│   ├── simulation_result.py         # 仿真结果数据类
│   ├── simulation_error.py          # 仿真错误数据类
│   ├── simulation_config.py         # 仿真配置数据类
│   └── analysis_result.py           # 高级分析结果数据类
├── executor/                        # 仿真执行器
│   ├── simulation_executor.py       # 执行器抽象基类
│   ├── executor_registry.py         # 执行器注册表
│   ├── spice_executor.py            # SPICE 执行器
│   ├── python_executor.py           # Python 执行器
│   └── circuit_analyzer.py          # 电路文件分析器
├── analysis/                        # 高级分析模块
│   ├── pvt_analysis.py              # PVT 角点仿真
│   ├── monte_carlo_analysis.py      # 蒙特卡洛分析
│   ├── parametric_sweep.py          # 参数扫描
│   └── worst_case_analysis.py       # 最坏情况分析
├── metrics/                         # 指标提取
│   ├── metrics_extractor.py         # 门面类
│   ├── metric_result.py             # 指标结果数据类
│   ├── amplifier_metrics.py         # 放大器指标
│   ├── noise_metrics.py             # 噪声指标
│   ├── distortion_metrics.py        # 失真指标
│   ├── power_metrics.py             # 电源指标
│   └── transient_metrics.py         # 瞬态指标
├── data/                            # 仿真数据处理层
│   ├── waveform_data_service.py     # 波形数据服务
│   ├── downsampler.py               # LTTB 降采样算法
│   └── data_exporter.py             # 数据导出
└── service/                         # 仿真域内部服务
    ├── simulation_config_service.py # 仿真配置服务
    ├── analysis_selector.py         # 分析类型选择器
    └── chart_selector.py            # 图表类型选择器

domain/services/
└── simulation_service.py            # 仿真服务（核心入口）

presentation/panels/simulation/      # 仿真结果面板
├── simulation_tab.py                # 仿真标签页主组件
├── simulation_view_model.py         # ViewModel 层
├── chart_viewer.py                  # 图表查看器
├── metrics_panel.py                 # 指标面板
└── metric_card.py                   # 指标卡片组件
```

### 4.2 分析结果与输出机制

| 分析模块 | 结果数据类 | UI 展示组件 | 事件名称 |
| -------- | ---------- | ----------- | -------- |
| 基础仿真 | `SimulationResult` | `ChartViewer` | `EVENT_SIM_COMPLETE` |
| PVT 角点 | `PVTAnalysisResult` | `PVTResultTab` | `EVENT_PVT_COMPLETE` |
| 蒙特卡洛 | `MonteCarloResult` | `MonteCarloTab` | `EVENT_MC_COMPLETE` |
| 参数扫描 | `SweepResult` | `SweepResultTab` | `EVENT_SWEEP_COMPLETE` |

### 4.3 用户选择机制

用户通过菜单栏「设置 → 仿真设置」打开 `SimulationSettingsDialog` 配置：
- **分析类型标签页**：勾选要执行的分析类型（AC/DC/TRAN/PVT 等）
- **图表显示标签页**：勾选要显示的图表类型（Bode 图/波形图等）

配置文件存储路径：
- 分析选择：`.circuit_ai/analysis_selection.json`
- 图表选择：`.circuit_ai/chart_selection.json`

### 4.4 仿真数据流图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           仿真数据流转路径                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  [用户配置阶段 - 菜单栏「设置 → 仿真设置」]                              │
│       │                                                                 │
│       ├──► SimulationSettingsDialog（分析类型标签页）                   │
│       │         │                                                       │
│       │         ▼                                                       │
│       │    用户勾选分析类型 [✓AC] [✓DC] [✓TRAN] [ ]PVT [ ]MC           │
│       │         │                                                       │
│       │         ▼                                                       │
│       │    AnalysisSelector.save_selection()                            │
│       │                                                                 │
│       ├──► SimulationSettingsDialog（图表显示标签页）                   │
│       │         │                                                       │
│       │         ▼                                                       │
│       │    用户勾选图表类型 [✓Bode] [✓波形] [ ]直方图                   │
│       │         │                                                       │
│       │         ▼                                                       │
│       │    ChartSelector.save_selection()                               │
│       │                                                                 │
│  [UI 触发仿真]                                                          │
│       │                                                                 │
│       ▼                                                                 │
│  SimulationService.run_selected_analyses()                              │
│       │                                                                 │
│       ├──► AnalysisSelector.get_execution_order()                       │
│       │         │                                                       │
│       │         ▼                                                       │
│       │    [按优先级排序的分析列表: OP → AC → DC → TRAN]                │
│       │                                                                 │
│       ├──► FileDiscoveryStrategy.discover()                             │
│       │         │                                                       │
│       │         ▼                                                       │
│       │    CircuitAnalyzer.detect_main_circuit()                        │
│       │         │                                                       │
│       │         ▼                                                       │
│       │    [主电路文件路径]                                              │
│       │                                                                 │
│       ├──► 循环执行每个选中的分析                                        │
│       │         │                                                       │
│       │         ├──► ExecutorRegistry.get_executor_for_file()           │
│       │         │         │                                             │
│       │         │         ▼                                             │
│       │         │    [SpiceExecutor / PythonExecutor]                   │
│       │         │                                                       │
│       │         ├──► SpiceExecutor.execute(analysis_type)               │
│       │         │         │                                             │
│       │         │         ▼                                             │
│       │         │    SimulationResult (dataclass)                       │
│       │         │                                                       │
│       │         ├──► EventBus.publish(EVENT_ANALYSIS_COMPLETE)          │
│       │         │                                                       │
│       │         └──► [继续下一个分析]                                    │
│       │                                                                 │
│       ▼                                                                 │
│  EventBus.publish(EVENT_ALL_ANALYSES_COMPLETE, results)                 │
│       │                                                                 │
│       ▼                                                                 │
│  [图表渲染阶段]                                                          │
│       │                                                                 │
│       ├──► ChartSelector.get_selected_charts()                          │
│       │         │                                                       │
│       │         ▼                                                       │
│       │    [用户选中的图表类型列表]                                      │
│       │                                                                 │
│       ├──► ChartViewer.render_selected_charts(results, chart_types)     │
│       │         │                                                       │
│       │         ▼                                                       │
│       │    [动态渲染用户选中的图表]                                      │
│       │                                                                 │
│       ▼                                                                 │
│  [UI 更新显示]                                                           │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 4.0.3 仿真事件定义

> **设计原则**：集中定义所有仿真相关事件常量，避免事件名拼写错误，便于追踪发布者和订阅者

- [X] **文件路径**：`shared/event_types.py`（遵循现有架构，在统一的事件类型文件中定义）
- [X] **事件常量定义**（模块级常量，遵循 `EVENT_` 前缀命名规范）：

**基础仿真事件**：

```python
# 仿真生命周期事件
EVENT_SIM_STARTED = "sim_started"           # 仿真开始
EVENT_SIM_PROGRESS = "sim_progress"         # 仿真进度（节流发布）
EVENT_SIM_COMPLETE = "sim_complete"         # 仿真完成
EVENT_SIM_ERROR = "sim_error"               # 仿真错误
EVENT_SIM_CANCELLED = "sim_cancelled"       # 仿真取消
EVENT_SIM_CONFIG_CHANGED = "sim_config_changed"  # 仿真配置变更

# 电路分析事件
EVENT_MAIN_CIRCUIT_DETECTED = "main_circuit_detected"
EVENT_MAIN_CIRCUIT_CHANGED = "main_circuit_changed"
EVENT_CIRCUIT_ANALYSIS_COMPLETE = "circuit_analysis_complete"

# 分析选择事件
EVENT_ANALYSIS_SELECTION_CHANGED = "analysis_selection_changed"  # 分析类型选择变更
EVENT_ANALYSIS_COMPLETE = "analysis_complete"                    # 单个分析完成
EVENT_ALL_ANALYSES_COMPLETE = "all_analyses_complete"            # 所有选中分析完成

# 图表选择事件
EVENT_CHART_SELECTION_CHANGED = "chart_selection_changed"        # 图表类型选择变更
```

**高级仿真事件**（PVT/蒙特卡洛/参数扫描）：

```python
EVENT_PVT_CORNER_COMPLETE = "sim_pvt_corner_complete"
EVENT_MONTE_CARLO_RUN_COMPLETE = "sim_monte_carlo_run_complete"
EVENT_SWEEP_POINT_COMPLETE = "sim_sweep_point_complete"
```

**电路图事件**：

```python
EVENT_SCHEMATIC_LOADED = "schematic_loaded"
EVENT_SCHEMATIC_ELEMENT_SELECTED = "schematic_element_selected"
EVENT_SCHEMATIC_ELEMENT_HOVERED = "schematic_element_hovered"
EVENT_SCHEMATIC_JUMP_TO_SOURCE = "schematic_jump_to_source"
EVENT_SCHEMATIC_ZOOM_CHANGED = "schematic_zoom_changed"
```

- [X] **使用方式**：所有仿真相关模块通过 `from shared.event_types import EVENT_SIM_*` 导入使用
- [X] **事件数据结构**：每个事件的携带数据已在 `event_types.py` 中以注释形式详细说明

#### 4.0.3.1 仿真结果到 UI 的事件链路

> **设计目标**：确保仿真结果从执行完成到 UI 显示的完整事件链路清晰可追踪```
[仿真完成] → SimulationTask 读取结果 → EventBus.publish(SIMULATION_COMPLETE)
    │
    ├──► UIEventBridge → QMetaObject.invokeMethod() → SimulationViewModel → UI 更新
    │
    └──► GraphStateProjector → 更新 SessionState.last_simulation_result
```

- [X] **关键节点**：`SimulationTask` 监听完成 → `EventBus` 发布事件 → `UIEventBridge` 桥接到主线程 → `SimulationViewModel` 触发 UI 更新

> **实现说明**：本节事件定义已在 `shared/event_types.py` 中完成，遵循项目现有的事件管理架构。

#### 4.0.4 仿真数据单一数据源原则

> **⚠️ 核心架构约束**：GraphState 是仿真数据的唯一真相来源（Single Source of Truth）

#### 数据源层级定义

- [X] **唯一数据源**：`GraphState.sim_result_path` + `GraphState.last_metrics` 是所有仿真数据的权威来源
- [X] **数据流向**：仿真执行 → 写入文件 → GraphState 存路径 → 各消费方按需读取
- [X] **禁止行为**：任何模块不得绕过 GraphState 直接从文件系统读取仿真结果作为实时数据

#### 数据位置与用途

- [X] **GraphState.sim_result_path**：仿真结果文件路径（指针），工作流状态传递
- [X] **GraphState.last_metrics**：最新仿真指标摘要，用于 UI 显示和条件边判断
- [X] **GraphState.error_context**：错误信息传递，仿真成功后自动清除
- [X] **.circuit_ai/sim_results/ 目录**：仿真结果持久化存储，按需读取
- [X] **SimulationResult 数据类**：内存中的结构化数据，执行后写入文件

#### 数据刷新机制

- [X] **写入文件**：每次仿真执行后，结果写入 `.circuit_ai/sim_results/{uuid}.json`
- [X] **返回路径**：图节点返回 `{"sim_result_path": "...", "last_metrics": {...}}`
- [X] **错误处理**：仿真失败时，错误信息写入 `error_context` 字段

#### 各模块数据读取规范

- [X] **analysis_node**：调用 `SimulationService.load_sim_result(project_root, sim_result_path)` 读取
- [X] **diagnostics_collector**：从 GraphState 的 `error_context` 读取错误信息
- [X] **chart_generator**：调用 `SimulationService.load_sim_result()` 读取数据生成图表
- [X] **simulation_result_storage**：仿真结果已在文件中，无需额外归档

> **实现说明**：GraphState 已在 `application/graph/state.py` 中定义，包含 `sim_result_path`、`last_metrics`、`error_context` 等字段。

---

#### 4.0.5 文件引用有效性校验（Dangling Pointer 防护）

> **⚠️ 问题场景**：GraphState 存储的是文件路径（指针），而非实际数据。当用户在文件系统中手动删除了被引用的文件（如 `sim_result_path` 指向的 `.circuit_ai/sim_results/run_001.json`），GraphState 中的路径就变成了悬空指针（Dangling Pointer）。

> **设计原则**：
>
> - 服务层防御性读取：返回结构化结果对象，明确区分"成功/文件缺失/解析错误"
> - UI 层感知状态：调用前校验路径有效性，发现缺失时显示占位图和操作按钮
> - 工作流层闭环：通过 GraphState 控制标志触发重新执行，不绕过 LangGraph

#### 4.0.5.1 `LoadResult` - 统一加载结果数据类

- [X] **文件路径**：`shared/models/load_result.py`
- [X] **职责**：定义文件加载操作的统一返回结构，替代返回空字典或抛异常的做法
- [X] **数据类定义**：
  - `LoadResult[T]` - 泛型加载结果
    - `success: bool` - 是否成功
    - `data: Optional[T]` - 加载的数据（成功时有值）
    - `error_code: Optional[LoadErrorCode]` - 错误码（失败时有值）
    - `error_message: Optional[str]` - 错误消息（失败时有值）
    - `file_path: str` - 尝试加载的文件路径
- [X] **错误码枚举** `LoadErrorCode`：
  - `FILE_MISSING` - 文件不存在（悬空指针场景）
  - `PARSE_ERROR` - 文件存在但解析失败
  - `PERMISSION_DENIED` - 文件存在但无读取权限
  - `PATH_EMPTY` - 路径为空字符串
  - `UNKNOWN_ERROR` - 未知错误
- [X] **工厂方法**：
  - `LoadResult.ok(data, file_path)` - 创建成功结果
  - `LoadResult.file_missing(file_path)` - 创建文件缺失结果
  - `LoadResult.path_empty()` - 创建路径为空结果
  - `LoadResult.parse_error(file_path, message)` - 创建解析错误结果
  - `LoadResult.permission_denied(file_path)` - 创建权限拒绝结果
  - `LoadResult.unknown_error(file_path, message)` - 创建未知错误结果
- [X] **辅助方法**：
  - `is_file_missing()` - 检查是否为文件缺失错误
  - `get_data_or_default(default)` - 获取数据，失败时返回默认值
- [X] **被调用方**：`SimulationService.load_sim_result()`、`DesignService.load_goals()`、所有 `load_*` 方法

#### 4.0.5.2 `FileReferenceValidator` - 文件引用校验器

- [X] **文件路径**：`shared/file_reference_validator.py`
- [X] **职责**：提供文件路径有效性校验的统一入口，供 UI 层和工作流层调用
- [X] **核心方法**：
  - `validate_path(project_root, relative_path) -> bool` - 校验单个路径是否有效
  - `validate_sim_result_path(project_root, sim_result_path) -> bool` - 校验仿真结果路径
  - `validate_design_goals_path(project_root, design_goals_path) -> bool` - 校验设计目标路径
  - `validate_circuit_file_path(project_root, circuit_file_path) -> bool` - 校验电路文件路径
  - `get_invalid_references(project_root, state) -> list[str]` - 批量校验 GraphState 中的所有路径，返回无效路径列表
  - `get_invalid_references_from_dict(project_root, state_dict) -> list[str]` - 从字典格式的状态中批量校验路径
- [X] **设计原则**：
  - 纯函数式：无状态，仅做路径存在性检查
  - 不修改 GraphState：仅返回校验结果，由调用方决定后续处理
- [X] **模块级单例**：`file_reference_validator` 便于直接导入使用
- [X] **被调用方**：UI 面板（显示前校验）、图节点（执行前校验）

#### 4.0.5.3 服务层防御性读取规范

> **`SimulationService.load_sim_result` 返回类型规范**

- [X] **返回类型**：`LoadResult[Dict[str, Any]]`
- [X] **行为规范**：
  - 路径为空：返回 `LoadResult.path_empty()`
  - 文件不存在：返回 `LoadResult.file_missing(path)`
  - 解析失败：返回 `LoadResult.parse_error(path, message)`
  - 成功：返回 `LoadResult.ok(data, path)`
- [X] **调用方适配**：所有调用 `load_sim_result` 的代码需检查 `result.success` 后再使用 `result.data`

#### 4.0.5.4 UI 层文件缺失处理规范

- [X] **校验时机**：UI 面板在显示仿真结果/图表前，先调用 `FileReferenceValidator.validate_sim_result_path()`
- [X] **缺失时显示**：
  - 显示占位图（灰色背景 + 文件缺失图标）
  - 显示提示文字："仿真结果文件已丢失"
  - 显示"重新仿真"按钮
- [X] **"重新仿真"按钮行为**：
  - **禁止**：直接调用 `SimulationService.run_simulation()`（绕过 LangGraph）
  - **正确做法**：通过 EventBus 发送 `EVENT_REQUEST_RESIMULATION` 事件，由 `SessionManager` 接收后设置 `GraphState.force_resimulate = True` 并触发工作流执行
- [X] **事件定义**：
  - `EVENT_REQUEST_RESIMULATION = "ui.request_resimulation"` - UI 请求重新仿真（已在 `shared/event_types.py` 中定义）

#### 4.0.5.5 工作流层状态校验与重新执行

> **GraphState 控制标志**

- [X] **字段定义**：`force_resimulate: bool = False`（已在 `application/graph/state.py` 中定义）
- [X] **字段用途**：当 UI 发现文件缺失并请求重新仿真时，设置此标志为 True
- [X] **router_node 条件边逻辑**：
  - 检查 `state.force_resimulate`，若为 True 则直接路由到 `simulation_node`
  - `simulation_node` 执行完成后，将 `force_resimulate` 重置为 False
- [X] **图节点前置校验**：
  - `analysis_node` 开头检查 `sim_result_path` 指向的文件是否存在
  - 若不存在，返回 `{"error_context": "SIM_RESULT_FILE_MISSING", "force_resimulate": True}`
  - 条件边检测到此状态后路由回 `simulation_node`

> **实现说明**：
>
> - `LoadResult` 和 `LoadErrorCode` 已在 `shared/models/load_result.py` 中完整实现
> - `FileReferenceValidator` 已在 `shared/file_reference_validator.py` 中完整实现
> - `GraphState.force_resimulate` 已在 `application/graph/state.py` 中定义
> - `EVENT_REQUEST_RESIMULATION` 已在 `shared/event_types.py` 中定义

---

#### 4.0.6 仿真结果实时加载机制

> **⚠️ 问题场景**：当前仿真结果加载依赖 `EVENT_SIM_COMPLETE` 事件驱动，但存在以下盲区：
>
> 1. LangGraph 工作流在后台执行仿真时，若事件发布与 UI 订阅存在时序问题，UI 可能无法及时感知
> 2. 用户手动将仿真结果文件复制到 `.circuit_ai/sim_results/` 目录时，UI 无法自动加载
> 3. 跨进程执行仿真（如 subprocess 调用外部仿真器）时，事件通知链路可能断裂

> **设计原则**：采用三层加载策略，确保仿真结果能及时、可靠地加载到 UI

#### 4.0.6.1 三层加载策略

**第一层：事件驱动（主路径）**
- 仿真服务执行完成后发布 `EVENT_SIM_COMPLETE` 事件
- `SimulationTab` 订阅该事件，触发结果加载
- 这是最快的加载路径，延迟最低

**第二层：文件监控（补充路径）**
- `FileWatchTask` 已监控项目目录的文件变化
- 新增 `SimulationResultWatcher` 组件，专门过滤 `.circuit_ai/sim_results/` 目录的变化
- 发现新的 `.json` 文件时，发布 `EVENT_SIM_RESULT_FILE_CREATED` 事件
- `SimulationTab` 订阅该事件，触发结果加载
- 作为事件驱动的补充，覆盖事件丢失或跨进程场景

**第三层：手动刷新（用户控制）**
- 在仿真面板提供"刷新"按钮
- 用户点击后调用 `SimulationService.get_latest_sim_result()` 重新加载
- 作为最后的兜底手段

#### 4.0.6.2 `SimulationResultWatcher` - 仿真结果文件监控器

- [ ] **文件路径**：`domain/simulation/service/simulation_result_watcher.py`
- [ ] **职责**：监控仿真结果目录的文件变化，过滤并发布结果文件创建事件
- [ ] **设计原则**：
  - 订阅 `EVENT_FILE_CHANGED` 事件，过滤出 `.circuit_ai/sim_results/` 目录下的 `.json` 文件
  - 仅处理 `created` 类型的文件事件（新文件创建）
  - 发布 `EVENT_SIM_RESULT_FILE_CREATED` 事件，携带文件路径
  - 防抖处理：同一文件在 500ms 内的多次事件合并为一次
- [ ] **核心方法**：
  - `start(project_root)` - 开始监控指定项目
  - `stop()` - 停止监控
  - `_on_file_changed(event_data)` - 处理文件变更事件
  - `_is_sim_result_file(path)` - 判断是否为仿真结果文件
- [ ] **事件订阅**：
  - 订阅 `EVENT_FILE_CHANGED`
- [ ] **事件发布**：
  - 发布 `EVENT_SIM_RESULT_FILE_CREATED`，携带数据：
    - `file_path: str` - 结果文件相对路径
    - `project_root: str` - 项目根目录
- [ ] **生命周期**：
  - 在 `EVENT_STATE_PROJECT_OPENED` 时启动
  - 在 `EVENT_STATE_PROJECT_CLOSED` 时停止
- [ ] **被调用方**：`SessionManager` 或 `MainWindow` 负责生命周期管理

#### 4.0.6.3 事件定义扩展

- [ ] **新增事件常量**（在 `shared/event_types.py` 中）：

```python
# 仿真结果文件创建（文件监控触发）
# 携带数据：
#   - file_path: str - 结果文件相对路径
#   - project_root: str - 项目根目录
EVENT_SIM_RESULT_FILE_CREATED = "sim_result_file_created"
```

#### 4.0.6.4 `SimulationTab` 加载机制增强

- [ ] **新增事件订阅**：
  - 订阅 `EVENT_SIM_RESULT_FILE_CREATED`，在 `_on_sim_result_file_created` 中处理
  - 订阅 `EVENT_FILE_CHANGED`，过滤仿真结果目录变化（作为备选方案）
- [ ] **新增 UI 元素**：
  - 在左侧面板底部添加"刷新"按钮，点击调用 `refresh()` 方法
- [ ] **加载去重机制**：
  - 记录当前显示的结果文件路径和时间戳
  - 收到加载请求时，比较文件路径和时间戳，避免重复加载相同结果
- [ ] **核心方法增强**：
  - `_on_sim_result_file_created(event_data)` - 处理结果文件创建事件
  - `_should_reload(file_path, timestamp)` - 判断是否需要重新加载
  - `refresh()` - 手动刷新，强制重新加载最新结果

#### 4.0.6.5 版本校验机制

- [ ] **`SimulationViewModel` 增强**：
  - 新增 `_current_result_id: Optional[str]` 字段，记录当前显示的结果 ID
  - 新增 `_current_result_timestamp: Optional[str]` 字段，记录当前结果时间戳
  - 新增 `check_for_updates(project_root) -> bool` 方法：
    - 调用 `SimulationService.get_latest_sim_result()` 获取最新结果
    - 比较时间戳，若有更新则返回 True
  - 修改 `load_result()` 方法，更新 `_current_result_id` 和 `_current_result_timestamp`

#### 4.0.6.6 加载时序图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        仿真结果加载时序                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  [场景1：正常仿真完成]                                                   │
│                                                                         │
│  SimulationService ──► EVENT_SIM_COMPLETE ──► SimulationTab             │
│       │                                            │                    │
│       │                                            ▼                    │
│       │                                    _on_simulation_complete()    │
│       │                                            │                    │
│       │                                            ▼                    │
│       │                                    load_result()                │
│       │                                                                 │
│  [场景2：文件监控触发]                                                   │
│                                                                         │
│  FileWatchTask ──► EVENT_FILE_CHANGED ──► SimulationResultWatcher       │
│                                                   │                     │
│                                                   ▼                     │
│                                           _is_sim_result_file()         │
│                                                   │                     │
│                                                   ▼                     │
│                                    EVENT_SIM_RESULT_FILE_CREATED        │
│                                                   │                     │
│                                                   ▼                     │
│                                           SimulationTab                 │
│                                                   │                     │
│                                                   ▼                     │
│                                    _on_sim_result_file_created()        │
│                                                   │                     │
│                                                   ▼                     │
│                                           load_result()                 │
│                                                                         │
│  [场景3：手动刷新]                                                       │
│                                                                         │
│  用户点击"刷新"按钮 ──► SimulationTab.refresh()                         │
│                              │                                          │
│                              ▼                                          │
│                    SimulationService.get_latest_sim_result()            │
│                              │                                          │
│                              ▼                                          │
│                        load_result()                                    │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

> **实现说明**：
>
> - 三层策略互为补充，确保仿真结果能可靠加载
> - 事件驱动是主路径，延迟最低
> - 文件监控覆盖事件丢失场景
> - 手动刷新作为最后兜底

---

### 4.1 仿真数据模型 (`domain/simulation/models/`)

> **设计原则**：使用 dataclass 定义标准化数据结构，确保类型安全，提供 IDE 自动补全支持

#### 4.1.1 `simulation_result.py` - 仿真结果数据类

- [ ] **文件路径**：`domain/simulation/models/simulation_result.py`
- [ ] **职责**：定义标准化的仿真结果数据结构，供所有仿真相关模块使用
- [ ] **数据类定义**：
  - `SimulationData` - 仿真数据容器
    - `frequency: Optional[np.ndarray]` - AC 分析频率点
    - `time: Optional[np.ndarray]` - 瞬态分析时间点
    - `signals: Dict[str, np.ndarray]` - 信号数据字典
  - `SimulationResult` - 标准化仿真结果
    - `executor: str` - 执行器名称
    - `file_path: str` - 仿真文件路径
    - `analysis_type: str` - 分析类型
    - `success: bool` - 是否成功
    - `data: Optional[SimulationData]` - 仿真数据
    - `metrics: Optional[Dict]` - 性能指标
    - `error: Optional[SimulationError]` - 错误信息
    - `raw_output: Optional[str]` - 原始输出
    - `timestamp: str` - ISO 格式时间戳（如 2024-12-20T14:30:22）
    - `duration_seconds: float` - 执行耗时
    - `version: int` - 版本号，每次仿真递增，用于验证数据新鲜度
- [ ] **核心方法**：
  - `to_dict()` - 序列化为字典
  - `from_dict(data)` - 从字典反序列化
  - `is_successful()` - 判断是否成功
  - `get_signal(name)` - 获取指定信号数据
  - `is_fresh(max_age_seconds)` - 检查数据是否在指定时间内（用于缓存验证）
- [ ] **被调用方**：所有仿真执行器、仿真服务、分析节点

#### 4.1.2 `simulation_error.py` - 仿真错误数据类

- [ ] **文件路径**：`domain/simulation/models/simulation_error.py`
- [ ] **职责**：定义标准化的仿真错误数据结构
- [ ] **错误类型枚举**：
  ```python
  class SimulationErrorType(Enum):
      SYNTAX_ERROR = "E001"
      MODEL_MISSING = "E002"
      NODE_FLOATING = "E003"
      CONVERGENCE_DC = "E004"
      CONVERGENCE_TRAN = "E005"
      TIMEOUT = "E006"
      MEMORY_OVERFLOW = "E007"
      NGSPICE_CRASH = "E008"
      FILE_ACCESS = "E009"
      PARAMETER_INVALID = "E010"
  ```
- [ ] **错误严重级别枚举**：
  ```python
  class ErrorSeverity(Enum):
      LOW = "low"
      MEDIUM = "medium"
      HIGH = "high"
      CRITICAL = "critical"
  ```
- [ ] **数据类定义**：
  - `SimulationError` - 仿真错误
    - `code: str` - 错误码
    - `type: SimulationErrorType` - 错误类型
    - `severity: ErrorSeverity` - 严重级别
    - `message: str` - 错误消息摘要
    - `file_path: Optional[str]` - 出错文件路径
    - `line_number: Optional[int]` - 出错行号
    - `context: Optional[str]` - 错误上下文代码
    - `details: Optional[Dict]` - 详细信息
    - `recovery_attempted: bool` - 是否已尝试恢复
    - `recovery_result: Optional[str]` - 恢复结果
    - `recovery_suggestion: Optional[str]` - 恢复建议
    - `raw_output: Optional[str]` - 原始输出
- [ ] **核心方法**：
  - `to_dict()` - 序列化为字典
  - `from_dict(data)` - 从字典反序列化
  - `is_recoverable()` - 判断是否可自动恢复
  - `get_user_message()` - 获取用户友好的错误消息
- [ ] **被调用方**：`SpiceExecutor`、`SimulationResult`、`FixErrorAction`、`SpiceErrorRecovery`

#### 4.1.3 `simulation_config.py` - 仿真配置数据类

- [ ] **文件路径**：`domain/simulation/models/simulation_config.py`
- [ ] **职责**：定义仿真配置的数据结构（纯数据类，不含业务逻辑）
- [ ] **设计原则**：配置数据类仅定义结构，配置的读写、校验、持久化由 `SimulationConfigService` 处理
- [ ] **数据类定义**：
  - `ACAnalysisConfig` - AC 分析配置
    - `start_freq: float` - 起始频率（Hz）
    - `stop_freq: float` - 终止频率（Hz）
    - `points_per_decade: int` - 每十倍频程点数
    - `sweep_type: str` - 扫描类型（dec/oct/lin）
  - `DCAnalysisConfig` - DC 分析配置
    - `source_name: str` - 扫描源名称
    - `start_value: float` - 起始值
    - `stop_value: float` - 终止值
    - `step: float` - 步进值
  - `TransientConfig` - 瞬态分析配置
    - `step_time: float` - 时间步长（秒）
    - `end_time: float` - 终止时间（秒）
    - `start_time: float` - 起始时间（秒）
    - `max_step: Optional[float]` - 最大步长
    - `use_initial_conditions: bool` - 是否使用初始条件
  - `NoiseConfig` - 噪声分析配置
    - `output_node: str` - 输出节点
    - `input_source: str` - 输入源
    - `start_freq: float` - 起始频率（Hz）
    - `stop_freq: float` - 终止频率（Hz）
  - `ConvergenceConfig` - 收敛参数配置（用户可调）
    - `gmin: float` - 最小电导（默认 1e-12）
    - `abstol: float` - 绝对电流容差（默认 1e-12）
    - `reltol: float` - 相对容差（默认 1e-3）
    - `vntol: float` - 电压容差（默认 1e-6）
    - `itl1: int` - DC 迭代限制（默认 100）
    - `itl4: int` - 瞬态迭代限制（默认 10）
  - `GlobalSimulationConfig` - 全局仿真配置
    - `timeout_seconds: int` - 超时时间（秒）
    - `temperature: float` - 仿真温度（摄氏度，默认 27）
    - `convergence: ConvergenceConfig` - 收敛参数
- [ ] **核心方法**：
  - `to_dict()` - 序列化为字典
  - `from_dict(data)` - 从字典反序列化
  - `get_default()` - 获取默认配置（类方法）
- [ ] **被调用方**：`SimulationConfigService`、各执行器

#### 4.1.4 `analysis_result.py` - 高级分析结果数据类（统一）

> **设计原则**：为所有高级分析模块定义统一的结果数据结构，确保输出格式一致

- [ ] **文件路径**：`domain/simulation/models/analysis_result.py`
- [ ] **职责**：定义高级分析（PVT/蒙特卡洛/参数扫描/最坏情况/敏感度）的统一结果结构
- [ ] **基类定义**：
  - `AnalysisResultBase` - 分析结果基类
    - `analysis_type: str` - 分析类型标识
    - `timestamp: str` - 分析完成时间（ISO 格式）
    - `duration_seconds: float` - 分析耗时
    - `success: bool` - 是否成功
    - `error_message: Optional[str]` - 错误信息
    - `summary: str` - 结果摘要（用于 UI 显示）
- [ ] **PVT 分析结果**：
  - `PVTAnalysisResult(AnalysisResultBase)` - PVT 角点分析结果
    - `corners: List[PVTCorner]` - 角点列表
    - `corner_results: Dict[str, SimulationResult]` - 各角点仿真结果
    - `worst_corner: str` - 最差角点标识
    - `all_passed: bool` - 是否所有角点都通过
    - `metrics_comparison: Dict[str, Dict[str, float]]` - 各指标在各角点的值
  - `PVTCorner` - 单个角点定义
    - `name: str` - 角点名称（TT/FF/SS/FS/SF）
    - `process: str` - 工艺角（typical/fast/slow）
    - `voltage: float` - 电压（V）
    - `temperature: float` - 温度（°C）
- [ ] **蒙特卡洛分析结果**：
  - `MonteCarloResult(AnalysisResultBase)` - 蒙特卡洛分析结果
    - `num_runs: int` - 运行次数
    - `num_passed: int` - 通过次数
    - `num_failed: int` - 失败次数
    - `yield_percent: float` - 良率百分比
    - `statistics: Dict[str, MetricStatistics]` - 各指标统计数据
    - `histogram_data: Dict[str, HistogramData]` - 直方图数据
    - `sensitive_params: List[str]` - 敏感参数列表
  - `MetricStatistics` - 指标统计数据
    - `mean: float` - 均值
    - `std: float` - 标准差
    - `min: float` - 最小值
    - `max: float` - 最大值
    - `sigma_3_low: float` - 3σ 下限
    - `sigma_3_high: float` - 3σ 上限
  - `HistogramData` - 直方图数据
    - `bins: List[float]` - 分箱边界
    - `counts: List[int]` - 各箱计数
    - `target_line: Optional[float]` - 目标值线
- [ ] **参数扫描结果**：
  - `SweepResult(AnalysisResultBase)` - 参数扫描结果
    - `sweep_params: List[SweepParam]` - 扫描参数定义
    - `sweep_data: np.ndarray` - 扫描数据（多维数组）
    - `optimal_point: Dict[str, float]` - 最优参数点
    - `feasible_region: List[Dict]` - 可行区域边界
  - `SweepParam` - 扫描参数定义
    - `name: str` - 参数名
    - `values: List[float]` - 扫描值列表
    - `unit: str` - 单位
- [ ] **最坏情况分析结果**：
  - `WorstCaseResult(AnalysisResultBase)` - 最坏情况分析结果
    - `method: str` - 分析方法（RSS/EVA）
    - `nominal_value: float` - 标称值
    - `worst_case_max: float` - 最坏情况最大值
    - `worst_case_min: float` - 最坏情况最小值
    - `design_margin_percent: float` - 设计裕度百分比
    - `critical_params: List[CriticalParam]` - 关键参数列表
  - `CriticalParam` - 关键参数
    - `name: str` - 参数名
    - `sensitivity: float` - 敏感度系数
    - `contribution_percent: float` - 贡献百分比
- [ ] **敏感度分析结果**：
  - `SensitivityResult(AnalysisResultBase)` - 敏感度分析结果
    - `metric_name: str` - 分析的指标名称
    - `param_sensitivities: List[ParamSensitivity]` - 参数敏感度列表
    - `tornado_data: TornadoChartData` - 龙卷风图数据
    - `optimization_suggestions: List[str]` - 优化建议
  - `ParamSensitivity` - 参数敏感度
    - `param_name: str` - 参数名
    - `nominal_value: float` - 标称值
    - `absolute_sensitivity: float` - 绝对敏感度
    - `relative_sensitivity: float` - 相对敏感度
    - `direction: str` - 影响方向（positive/negative）
  - `TornadoChartData` - 龙卷风图数据
    - `param_names: List[str]` - 参数名列表
    - `positive_impacts: List[float]` - 正向影响值
    - `negative_impacts: List[float]` - 负向影响值
    - `baseline_value: float` - 基准值
- [ ] **FFT 后处理结果**：
  - `FFTResult(AnalysisResultBase)` - FFT 分析结果
    - `signal_name: str` - 信号名称
    - `fundamental_freq: float` - 基波频率
    - `thd_percent: float` - 总谐波失真百分比
    - `harmonics: List[HarmonicData]` - 谐波数据列表
    - `spectrum_data: SpectrumData` - 频谱数据
  - `HarmonicData` - 谐波数据
    - `order: int` - 谐波次数
    - `frequency: float` - 频率
    - `amplitude: float` - 幅度
    - `phase: float` - 相位
  - `SpectrumData` - 频谱数据
    - `frequencies: np.ndarray` - 频率数组
    - `magnitudes: np.ndarray` - 幅度数组（dB）
    - `phases: np.ndarray` - 相位数组
- [ ] **拓扑识别结果**：
  - `TopologyResult(AnalysisResultBase)` - 拓扑识别结果
    - `topology_type: str` - 拓扑类型（amplifier/filter/power/oscillator）
    - `sub_type: str` - 子类型（如 common_source/differential_pair）
    - `confidence: float` - 置信度（0-1）
    - `recommended_analyses: List[str]` - 推荐的分析类型
    - `key_metrics: List[str]` - 关键性能指标
    - `critical_nodes: List[str]` - 关键节点列表
- [ ] **收敛诊断结果**：
  - `ConvergenceDiagnosis(AnalysisResultBase)` - 收敛诊断结果
    - `issue_type: str` - 问题类型（dc_convergence/tran_convergence/floating_node）
    - `severity: str` - 严重程度（low/medium/high/critical）
    - `affected_nodes: List[str]` - 受影响的节点
    - `suggested_fixes: List[SuggestedFix]` - 建议的修复方案
    - `auto_fix_available: bool` - 是否可自动修复
  - `SuggestedFix` - 建议的修复方案
    - `description: str` - 修复描述
    - `action_type: str` - 操作类型（add_resistor/adjust_param/add_ic）
    - `parameters: Dict[str, Any]` - 操作参数
- [ ] **核心方法**（基类）：
  - `to_dict()` - 序列化为字典
  - `from_dict(data)` - 从字典反序列化
  - `get_display_summary()` - 获取用于 UI 显示的摘要文本
  - `get_chart_data()` - 获取用于图表生成的数据
- [ ] **被调用方**：各高级分析模块、`chart_generator`、UI 面板

### 4.2 仿真执行器模块组 (`domain/simulation/executor/`)

> **三层分离架构设计**：
>
> 本域采用策略模式 + 适配器模式实现三层分离，确保仿真执行、文件选择、工作流模式三个维度正交解耦：
>
> **第一层：仿真执行器（SimulationExecutor）**
>
> - 定义统一的仿真执行接口
> - 不同仿真方式实现此接口（SpiceExecutor、PythonExecutor）
> - 符合开闭原则：新增仿真方式只需新增实现类并注册
>
> **第二层：文件发现策略（FileDiscoveryStrategy）**
>
> - 自动扫描策略：扫描工作目录，分析文件引用关系
> - 手动选择策略：弹出对话框让用户选择
> - 与仿真执行方式无关
>
> **组合自由度**：用户可自由组合两个维度，例如：
>
> - 自动扫描 + SPICE 仿真
> - 手动选择 + Python 仿真
> - 自动扫描 + Python 仿真

#### 4.2.1 `circuit_analyzer.py` - 电路文件分析器

> **初始化顺序**：无需显式初始化，作为工具类按需实例化
>
> **职责边界**：本模块专注于电路文件结构分析和主电路识别，底层的 `.include/.lib` 语句解析复用阶段2的 `include_parser.py`，避免重复实现

- [X] **文件路径**：`domain/simulation/executor/circuit_analyzer.py`
- [X] **职责**：分析工作区中的电路文件结构，识别主电路文件，提取文件引用关系
- [X] **依赖**：`domain.dependency.scanner.include_parser` - 复用阶段2的语句解析器
- [X] **核心功能**：
  - `scan_circuit_files(project_path)` - 扫描项目中所有 SPICE 文件
  - `scan_simulatable_files(project_path) -> ScanResult` - 扫描可仿真文件（整合自 circuit_file_scanner）
  - `parse_includes(file_path) -> list[ParsedInclude]` - 解析文件中的 `.include` 和 `.lib` 语句（委托给 `include_parser`）
  - `build_dependency_graph(project_path)` - 构建文件依赖关系图
  - `detect_main_circuit(project_path)` - 自动检测主电路文件
  - `get_circuit_type(file_path)` - 判断文件类型（主电路/子电路/参数文件）
  - `get_supported_extensions()` - 获取支持的文件扩展名（从 executor_registry 动态获取）
  - `set_executor_registry(registry)` - 设置执行器注册表
- [X] **数据结构定义**：
  - `ScanResult` - 文件扫描结果
    - `files: List[Path]` - 发现的可仿真文件列表
    - `main_circuit_candidates: List[Path]` - 主电路候选列表
    - `dependency_graph: Dict[str, List[str]]` - 文件依赖关系图
    - `has_single_main_circuit()` - 是否只有一个主电路候选
    - `has_multiple_candidates()` - 是否有多个主电路候选
    - `has_no_candidates()` - 是否没有主电路候选
  - `CircuitFileInfo` - 电路文件信息
    - `path: str` - 相对路径
    - `abs_path: Path` - 绝对路径
    - `file_type: str` - 文件类型
    - `has_simulation_commands: bool` - 是否包含仿真控制语句
    - `has_subcircuit_defs: bool` - 是否包含子电路定义
    - `has_only_params: bool` - 是否仅包含参数定义
    - `references: List[ParsedInclude]` - 引用的文件列表
  - `MainCircuitDetectionResult` - 主电路检测结果
    - `main_circuit: Optional[str]` - 主电路路径
    - `confidence: float` - 置信度（0-1）
    - `candidates: List[Dict]` - 其他候选主电路列表
    - `subcircuits: List[str]` - 子电路文件列表
    - `parameters: List[str]` - 参数文件列表
    - `dependency_graph: Dict[str, List[str]]` - 依赖关系图
- [X] **主电路识别策略（被引用分析法）**：
  - 扫描所有 `.cir`、`.sp`、`.spice` 文件
  - 解析每个文件的 `.include` 和 `.lib` 语句，提取被引用的文件路径
  - 构建引用关系图：`{file: [referenced_files]}`
  - 计算每个文件的被引用次数
  - 被引用次数为 0 且包含仿真控制语句的文件为主电路候选
  - 若只有一个候选，直接返回；若有多个，按优先级排序
- [X] **主电路优先级规则**：
  - 名为 `main.cir` 的文件优先级最高
  - 包含 `.ac`、`.dc`、`.tran`、`.noise` 等仿真控制语句的文件优先
  - 文件大小较大的优先（通常主电路包含更多内容）
  - 最近修改时间较新的优先
- [X] **文件类型判断规则**：
  - 主电路：不被其他文件引用，包含仿真控制语句
  - 子电路：仅包含 `.subckt ... .ends` 定义，被其他文件引用
  - 参数文件：仅包含 `.param` 语句，被其他文件引用
  - 库文件：包含多个 `.subckt` 或 `.model` 定义
- [X] **被调用方**：`simulation_service.py`（仿真服务）

#### 4.2.2 `simulation_executor.py` - 仿真执行器抽象基类

> **设计原则**：采用策略模式，将仿真执行方式与文件选择方式、工作流模式解耦，符合开闭原则

- [X] **文件路径**：`domain/simulation/executor/simulation_executor.py`
- [X] **职责**：定义统一的仿真执行接口，管理不同仿真执行器的注册与调度
- [X] **两层分离设计**：
  - **仿真执行方式**：由 `SimulationExecutor` 接口及其实现类控制（如 SPICE 仿真、Python 脚本仿真）
  - **文件选择方式**：由 `simulation_service.py` 控制（自动扫描 vs 手动选择）
  - 两者正交，互不影响，可自由组合
- [X] **抽象基类 `SimulationExecutor`**：
  - `get_name()` - 返回执行器名称（如 "spice"、"python"）
  - `get_supported_extensions()` - 返回支持的文件扩展名列表
  - `can_handle(file_path)` - 判断是否能处理指定文件
  - `execute(file_path, analysis_config)` - 执行仿真，返回标准化结果
  - `validate_file(file_path)` - 校验文件格式是否有效
  - `get_available_analyses()` - 返回支持的分析类型列表
- [X] **被调用方**：`simulation_service.py`（仿真服务）

#### 4.2.3 `executor_registry.py` - 执行器注册表

> **初始化顺序**：Phase 3.10，依赖 Logger，注册到 ServiceLocator

- [X] **文件路径**：`domain/simulation/executor/executor_registry.py`
- [X] **职责**：管理所有仿真执行器的注册、查询和调度
- [X] **核心功能**：
  - `register(executor)` - 注册仿真执行器实例
  - `unregister(name)` - 注销指定执行器
  - `get_executor(name)` - 按名称获取执行器
  - `get_executor_for_file(file_path)` - 根据文件扩展名自动选择执行器
  - `get_all_executors()` - 获取所有已注册执行器
  - `get_all_supported_extensions()` - 获取所有支持的文件扩展名
- [X] **执行器选择策略**：
  - 根据文件扩展名匹配执行器
  - 多个执行器支持同一扩展名时，按注册顺序优先
  - 无匹配执行器时返回 None，由调用方处理
- [X] **模块级单例**：`executor_registry` 便于直接导入使用
- [X] **被调用方**：`simulation_service.py`（仿真服务）

#### 4.2.4 `ngspice_config.py` - ngspice 路径配置（已实现）

> **设计原则**：将 ngspice 路径配置逻辑从 spice_executor 中分离，遵循单一职责原则
>
> **⚠️ 关键约束**：此模块必须在任何 PySpice 导入之前执行，否则 PySpice 会使用默认路径导致加载失败

- [X] **文件路径**：`infrastructure/utils/ngspice_config.py`（已实现）
- [X] **职责**：管理 ngspice 二进制和模型库的路径配置，处理跨平台差异
- [X] **核心功能**：
  - `configure_ngspice() -> bool` - 配置 ngspice 路径（必须在导入 PySpice 之前调用）
  - `get_ngspice_path() -> Path` - 获取 ngspice 基础目录路径
  - `get_ngspice_lib_path() -> Path` - 获取 lib/ngspice 目录路径（codemodel 文件）
  - `get_ngspice_models_path() -> Path` - 获取模型库基础路径（cmp/sub/custom）
  - `get_ngspice_scripts_path() -> Path` - 获取 spinit 脚本路径
  - `is_ngspice_available() -> bool` - 检查 ngspice 是否可用
  - `get_configuration_error() -> str` - 获取配置错误信息
  - `get_ngspice_info() -> dict` - 获取配置详细信息（调试用）
- [X] **路径解析逻辑**：
  - 开发环境：从 `vendor/ngspice/{platform}/` 加载
  - 打包环境：从 `sys._MEIPASS` 临时目录加载
  - 系统安装：作为回退方案，从系统常见路径查找
- [X] **环境变量设置**：
  - `PATH` - 添加 DLL 目录（Windows）
  - `SPICE_LIB_DIR` - codemodel 和 OSDI 模型路径
  - `SPICE_SCRIPTS` - spinit 脚本路径
  - `NGSPICE_LIBRARY_PATH` - ngspice 共享库路径
- [X] **调用时机**：在 `main.py` 的最开始调用，位于所有其他导入之前
- [X] **目录结构**（以 Windows 为例）：
  ```
  vendor/ngspice/
  ├── LICENSE                           # ngspice 许可证
  ├── win64/
  │   └── Spice64_dll/
  │       ├── dll-vs/                   # DLL 文件
  │       │   ├── ngspice.dll
  │       │   └── libomp140.x86_64.dll
  │       ├── lib/ngspice/              # codemodel 和 OSDI 模型
  │       │   ├── analog.cm
  │       │   ├── digital.cm
  │       │   └── ...
  │       └── share/ngspice/
  │           ├── models/               # SPICE 模型库
  │           │   ├── cmp/              # 基础器件模型
  │           │   ├── sub/              # 子电路定义
  │           │   └── custom/           # 用户自定义模型
  │           └── scripts/
  │               └── spinit            # 初始化脚本
  ├── linux64/
  │   └── .gitkeep
  └── macos/
      └── .gitkeep
  ```
- [ ] **版本要求**：ngspice 40 或更高版本
- [ ] **许可证**：ngspice 使用 BSD-3-Clause 许可证，允许二进制分发

#### 4.2.5 `spice_executor.py` - SPICE仿真执行器

> **初始化顺序**：无需显式初始化，作为工具类按需实例化，依赖 `ngspice_config`（路径配置）、PySpice 库
>
> **⚠️ 执行模式说明**：PySpice 通过 `NgSpiceShared` 共享库模式调用 ngspice，ngspice 在**同一进程内**执行，不需要启动独立子进程。这种模式性能更高，但需要确保 ngspice 共享库路径正确配置。
>
> **职责精简说明**：根据单一职责原则，ngspice 路径配置委托给 `ngspice_config`，错误解析作为执行器内部职责（`_parse_exception` 方法），本模块专注于仿真执行核心逻辑
>
> **⚠️ 路径解析策略**：采用工作目录切换方案，利用 ngspice 原生的相对路径解析能力，无需生成临时文件

- [X] **文件路径**：`domain/simulation/executor/spice_executor.py`
- [X] **职责**：实现 `SimulationExecutor` 接口，封装 PySpice 库执行 SPICE 电路仿真
- [X] **继承**：`SimulationExecutor`（抽象基类）
- [X] **支持的扩展名**：`.cir`、`.sp`、`.spice`、`.net`、`.ckt`
- [X] **核心功能**：
  - `execute(file_path, analysis_config) -> SimulationResult` - 执行仿真（接口方法）
  - `load_circuit(spice_file_path)` - 加载SPICE网表文件
  - `run_ac_analysis(start_freq, stop_freq, points)` - 交流小信号分析
  - `run_dc_analysis(source, start, stop, step)` - 直流扫描分析
  - `run_transient_analysis(step_time, end_time)` - 瞬态分析
  - `run_noise_analysis(output_node, input_source, freq_range)` - 噪声分析
  - `get_node_voltage(node_name)` - 获取节点电压
  - `get_branch_current(element_name)` - 获取支路电流
- [X] **仿真执行流程**：
  1. 校验文件存在性和扩展名（优先于 ngspice 检查）
  2. 检查 `ngspice_config.is_ngspice_available()` 确保 ngspice 已配置
  3. **切换工作目录到电路文件所在目录**（关键步骤，确保相对路径正确解析）
  4. 加载电路文件内容
  5. 使用 PySpice 的 SpiceParser 解析网表
  6. 根据分析类型执行仿真（AC/DC/瞬态/噪声/工作点）
  7. 提取仿真数据到标准化 SimulationData 结构
  8. 如果仿真失败，解析异常并返回结构化错误
  9. **恢复原工作目录**（使用 try-finally 确保恢复）
  10. 返回 SimulationResult
- [X] **依赖**：
  - `PySpice` 库 - SPICE 仿真引擎封装（通过 NgSpiceShared 共享库模式调用 ngspice）
  - `infrastructure.utils.ngspice_config` - ngspice 路径配置（已实现）
- [X] **元器件模型集成**（阶段十实现，此处预留接口）：
  - `check_required_models(circuit_file)` - 检查电路所需的 SPICE 模型
  - `_resolve_model_path(model_name)` - 解析模型文件路径
- [X] **被调用方**：`executor_registry.py`（执行器注册表）

##### 4.2.5.1 工作目录切换策略

> **设计原理**：ngspice 在解析 `.include` 和 `.lib` 语句时，会基于当前工作目录解析相对路径。通过在仿真执行前切换到电路文件所在目录，可以让 ngspice 自动正确解析所有相对路径引用，无需生成临时文件或修改网表内容。

- [X] **核心方法**：
  - `_execute_with_working_directory(file_path, callback)` - 在指定工作目录下执行回调
- [X] **实现要点**：
  - 使用 `os.getcwd()` 保存当前工作目录
  - 使用 `os.chdir(circuit_dir)` 切换到电路文件所在目录
  - 使用 `try-finally` 确保无论成功或失败都恢复原工作目录
  - 线程安全考虑：工作目录是进程级状态，并发仿真需要加锁或使用进程隔离
- [X] **优势**：
  - 零代码侵入，利用 ngspice 原生能力
  - 无需临时文件管理
  - 无需路径映射（错误信息直接对应原始文件）
  - 跨平台兼容（ngspice 在所有平台都支持相对路径）
- [X] **限制**：
  - 工作目录是进程级状态，不支持同一进程内并发仿真
  - 如需并发，应使用 `subprocess` 在独立进程中执行
- [ ] **并发仿真支持**（可选扩展）：
  - 当检测到并发仿真请求时，自动切换到 subprocess 模式
  - subprocess 模式下，每个仿真在独立进程中执行，工作目录互不影响

##### 4.2.5.2 错误解析增强

> **设计原则**：错误解析是仿真执行的内部职责，与执行逻辑紧密耦合，不单独分离为独立模块。在 PySpice 共享库模式下，错误信息来自 Python 异常而非原始 ngspice 输出，内聚处理更合理。

- [X] **核心方法**：`_parse_exception(exception, file_path) -> SimulationError`
- [X] **职责**：将 Python 异常转换为结构化的 `SimulationError` 对象
- [ ] **增强功能**：
  - `_extract_line_number(error_msg)` - 从异常消息中提取行号（如果包含）
  - `_extract_missing_models(error_msg)` - 从异常消息中提取缺失模型名称
  - `_extract_floating_nodes(error_msg)` - 从异常消息中提取浮空节点名称
- [X] **错误分类规则**：
  - 语法错误：匹配 "syntax"、"parse" 关键词
  - 模型缺失：匹配 "model"、"not found"、"unknown" 关键词
  - 节点浮空：匹配 "floating"、"no dc path" 关键词
  - 收敛失败：匹配 "convergence"、"no convergence" 关键词
  - 超时：匹配 "timeout" 关键词
- [X] **返回值**：`SimulationError` 对象，包含错误码、类型、严重级别、恢复建议等
- [X] **设计决策说明**：
  - 不创建独立的 `SpiceErrorParser` 模块
  - 原因：PySpice 共享库模式下，错误信息已被封装为 Python 异常，无需解析原始 ngspice stdout/stderr
  - 如未来需要 subprocess 模式（独立进程调用 ngspice CLI），可在该模式内部实现文本解析

#### 4.2.6 错误处理设计说明（已完成）

> **设计原则**：简化错误处理流程，用户主导问题解决，避免黑盒自动恢复

- [X] **错误处理策略：**

  - **立即失败，清晰反馈**：仿真错误立即返回，不进行自动重试
  - **用户友好的错误提示**：`SimulationError` 对象包含详细的错误信息和修改建议
  - **透明的参数调整**：用户通过 UI 手动调整仿真配置，理解每个参数的作用
  - **避免过度设计**：不引入复杂的自动恢复机制，降低维护成本
- [X] **错误解析实现：**

  - `spice_executor._parse_exception()` 方法负责将 ngspice 异常转换为结构化的 `SimulationError`
  - 每个错误类型包含：
    - 错误码和类型（如 E004 - CONVERGENCE_DC）
    - 严重级别（LOW/MEDIUM/HIGH/CRITICAL）
    - 用户友好的错误消息
    - 具体的修改建议（`recovery_suggestion` 字段）
    - 出错位置信息（文件路径、行号）
- [X] **用户工作流：**

  1. 用户触发仿真
  2. 仿真失败，UI 显示错误详情和建议
  3. 用户根据建议修改电路或调整配置
  4. 用户手动重新仿真
- [X] **配置调整支持：**

  - 通过 `SimulationConfigService` 提供配置编辑界面
  - 用户可手动调整收敛参数（gmin、reltol、itl1 等）
  - 配置保存到项目，下次仿真自动使用
- [X] **设计优势：**

  - 简化代码，降低维护成本
  - 用户理解问题根源，而非依赖黑盒自动修复
  - 避免自动重试浪费时间
  - 提高用户对仿真工具的掌控感

#### 4.2.7 `python_executor.py` - Python脚本仿真执行器

> **初始化顺序**：无需显式初始化，作为工具类按需实例化
>
> **⚠️ 设计简化说明**：本模块仅提供基础进程隔离，不实现完整沙箱。用户应仅执行可信脚本。
>
> **⚠️ 进程管理说明**：直接使用 Python 标准库 `subprocess` 模块管理子进程，不依赖额外的进程管理器。

- [X] **文件路径**：`domain/simulation/executor/python_executor.py`
- [X] **职责**：实现 `SimulationExecutor` 接口，在隔离子进程中执行用户自定义的 Python 仿真脚本
- [X] **继承**：`SimulationExecutor`（抽象基类）
- [X] **支持的扩展名**：`.py`
- [X] **适用场景**：
  - 用户需要自定义仿真逻辑（如参数扫描、蒙特卡洛分析）
  - 需要调用其他仿真工具（如 LTspice、Spectre）的 Python 封装
  - 需要进行复杂的数据后处理
- [X] **核心功能**：
  - `validate_file(file_path)` - 校验 Python 脚本格式，检查是否定义了符合约定的入口函数
  - `execute(file_path, analysis_config)` - 执行 Python 脚本并返回标准化结果
  - `_run_in_subprocess(file_path, config)` - 在子进程中执行脚本，实现进程隔离
  - `_parse_output(stdout, stderr)` - 解析脚本输出为标准化仿真结果
- [X] **脚本约定**：
  - 脚本必须定义 `run_simulation(config: dict) -> dict` 入口函数
  - 入口函数接收配置字典作为参数，返回符合标准化仿真结果结构的字典（见 4.2.2 节）
  - 返回字典需包含 `success` 布尔字段表示执行状态，`data` 字段存放仿真数据，`metrics` 字段存放性能指标
  - 脚本通过标准输出（stdout）以 JSON 格式输出结果
- [X] **进程管理实现**：
  - **进程启动**：使用 Python 标准库 `subprocess.run()` 启动独立子进程执行脚本
  - **超时控制**：通过 subprocess 的 timeout 参数设置执行时限，默认 600 秒
  - **进程终止**：超时后自动终止子进程并回收资源
  - **数据传递**：通过命令行参数传入配置，通过 stdout 获取 JSON 格式的执行结果
- [X] **基础隔离机制**：
  - **进程隔离**：脚本在独立子进程中执行，子进程崩溃不影响主程序稳定性，通过标准流进行数据交换
  - **资源限制**：仅实现执行超时限制，超限时自动终止子进程
  - **工作目录限制**：子进程工作目录设置为项目根目录，脚本可访问项目目录及其子目录
- [X] **安全声明**：
  - 本模块不提供完整的安全沙箱，不限制模块导入、文件系统访问、网络访问
  - 用户应仅执行可信的脚本
  - UI 层需明确提示用户相关安全风险
- [X] **输出解析**：
  - 执行器解析 stdout 中的最后一个有效 JSON 对象作为执行结果
  - stderr 内容记录到日志用于调试，不作为结果解析
- [X] **错误处理**：
  - 脚本语法错误 → 捕获异常并返回 `SimulationError`
  - 执行超时 → 终止子进程并返回超时错误
  - 输出格式错误 → 返回 JSON 解析错误
  - 子进程崩溃 → 返回进程异常退出错误
- [X] **被调用方**：`executor_registry.py`（执行器注册表）

### 4.3 仿真服务模块 (`domain/services/`)

> **初始化顺序**：Phase 3.11，依赖 ExecutorRegistry、EventBus、Logger，注册到 ServiceLocator

> **架构简化说明**：
> 原设计将仿真服务拆分为 8 个子模块（门面类 + 7 个子服务），存在以下问题：
>
> - 门面类变成纯转发层，增加调用链深度
> - `basic_simulation_runner` 和 `advanced_simulation_runner` 的区分是人为的
> - `simulation_state_manager` 只有 getter/setter，不值得独立
> - `simulation_control_service` 的暂停/断点功能在 PySpice 共享库模式下无法实现
>
> 简化后仿真服务放在 `domain/services/simulation_service.py`，与其他领域服务保持一致。

- [X] **目录结构**：
  ```
  domain/services/
  └── simulation_service.py        # 仿真服务（核心）

  # 后续可选添加：
  # ├── simulation_config_service.py # 配置管理
  # └── tuning_service.py            # 快速调参
  ```

#### 4.3.1 `simulation_service.py` - 仿真服务

> **设计原则**：作为仿真域的核心服务，直接实现仿真执行逻辑，不做无意义的委托转发

- [X] **文件路径**：`domain/services/simulation_service.py`
- [X] **职责**：提供仿真执行的统一入口，管理仿真状态，协调执行器和配置
- [X] **核心功能**：
  - `run_simulation(file_path, analysis_config) -> SimulationResult` - 执行单个分析（核心方法）
  - `run_with_auto_detect(project_path, analysis_config) -> SimulationResult` - 自动检测主电路并执行仿真
  - `run_selected_analyses(file_path, project_root) -> Dict[AnalysisType, SimulationResult]` - 执行用户选中的所有分析类型
  - `get_simulatable_files(project_path) -> list[Path]` - 获取可仿真文件列表
  - `get_main_circuit_candidates(project_path) -> list[Path]` - 获取主电路候选
  - `cancel_simulation()` - 取消当前仿真（通过超时机制实现）
  - `load_sim_result(project_root, sim_result_path) -> LoadResult` - 加载仿真结果文件
  - `save_sim_result(project_root, result) -> str` - 保存仿真结果，返回文件路径
- [X] **批量执行流程**（`run_selected_analyses`）：
  1. 从 `AnalysisSelector` 获取启用的分析列表（按优先级排序）
  2. 从 `SimulationConfigService` 获取各分析的配置
  3. 依次执行每个分析，收集结果
  4. 每完成一个分析发布 `EVENT_ANALYSIS_COMPLETE` 事件
  5. 全部完成后发布 `EVENT_ALL_ANALYSES_COMPLETE` 事件
  6. 返回所有分析结果的字典
- [X] **仿真执行流程**：
  1. 从 `executor_registry` 获取对应文件类型的执行器
  2. 调用执行器的 `execute()` 方法
  3. 将结果写入 `.circuit_ai/sim_results/{uuid}.json`
  4. 发布 `EVENT_SIM_COMPLETE` 事件
  5. 返回 `SimulationResult`
- [X] **状态管理**（内部字段，不单独拆分模块）：
  - `_last_simulation_file: Optional[Path]` - 上次仿真文件
  - `_main_circuit_candidates: list[Path]` - 主电路候选列表
  - `_is_running: bool` - 是否正在执行仿真
- [X] **事件发布**：
  - `EVENT_SIM_STARTED` - 仿真开始
  - `EVENT_SIM_COMPLETE` - 仿真完成（成功或失败）
  - `EVENT_SIM_PROGRESS` - 仿真进度（节流发布）
  - `EVENT_SIM_ERROR` - 仿真错误
  - `EVENT_MAIN_CIRCUIT_DETECTED` - 主电路检测完成
  - `EVENT_SIMULATION_NEED_SELECTION` - 需要用户选择主电路
  - `EVENT_SIMULATION_NO_MAIN_CIRCUIT` - 未找到主电路
  - `EVENT_ANALYSIS_COMPLETE` - 单个分析完成
  - `EVENT_ALL_ANALYSES_COMPLETE` - 所有选中分析完成
- [X] **依赖**：
  - `ExecutorRegistry` - 获取执行器
  - `CircuitAnalyzer` - 扫描可仿真文件和检测主电路
  - `AnalysisSelector` - 获取用户选中的分析类型
  - `SimulationConfigService` - 获取分析配置
- [X] **被调用方**：`simulation_worker.py`、`main_window.py`、`tool_executor.py`

##### 关于暂停/恢复功能的说明

> **⚠️ 技术限制**：PySpice 使用 NgSpiceShared 共享库模式，ngspice 在同一进程内同步执行，**无法中途暂停**。
>
> 如需暂停功能，需要：
>
> 1. 切换到 subprocess 模式（独立进程调用 ngspice CLI）
> 2. 通过进程信号（SIGSTOP/SIGCONT）控制暂停/恢复
> 3. 这会显著增加复杂度，且实际使用场景有限
>
> **当前策略**：不实现暂停/恢复功能，仅支持取消（通过超时或强制终止）。

#### 4.3.2 `simulation_config_service.py` - 仿真配置服务

> **⚠️ 核心设计原则**：仿真参数由用户通过 UI 手动设置，软件不内置硬编码的预设配置

- [X] **文件路径**：`domain/simulation/service/simulation_config_service.py`
- [X] **职责**：管理仿真配置的读取、校验、持久化
- [X] **核心功能**：
  - `load_config(project_root) -> GlobalSimulationConfig` - 加载项目配置
  - `save_config(project_root, config)` - 保存配置到项目
  - `validate_config(config) -> ValidationResult` - 校验配置有效性
  - `get_default_config() -> GlobalSimulationConfig` - 获取默认配置
  - `reset_to_default(project_root)` - 重置为默认配置
- [X] **配置存储**：`.circuit_ai/simulation_config.json`
- [X] **配置文件结构**：
  ```json
  {
    "version": "1.0",
    "global": {
      "timeout_seconds": 300,
      "temperature": 27.0,
      "convergence": {
        "gmin": 1e-12,
        "abstol": 1e-12,
        "reltol": 1e-3,
        "vntol": 1e-6,
        "itl1": 100,
        "itl4": 10
      }
    },
    "ac": { "start_freq": 1.0, "stop_freq": 1e9, "points_per_decade": 20, "sweep_type": "dec" },
    "dc": { "source_name": "", "start_value": 0.0, "stop_value": 5.0, "step": 0.1 },
    "transient": { "step_time": 1e-6, "end_time": 1e-3, "start_time": 0.0, "max_step": null, "use_initial_conditions": false },
    "noise": { "output_node": "", "input_source": "", "start_freq": 1.0, "stop_freq": 1e6 }
  }
  ```
- [X] **配置校验规则**：
  - 频率参数：`start_freq > 0`，`stop_freq > start_freq`
  - 时间参数：`step_time > 0`，`end_time > start_time`
  - 收敛参数：`gmin > 0`，`abstol > 0`，`reltol` 在 (0, 1) 范围内
- [X] **事件发布**：`EVENT_SIM_CONFIG_CHANGED` - 配置变更时发布
- [X] **被调用方**：`SimulationService`、`SimulationConfigDialog`（UI）

#### 4.3.3 主电路检测功能入口

> **实现位置**：主电路检测功能在 `circuit_analyzer.py` 和 `simulation_service.py` 中实现。

- [X] **检测功能**：`circuit_analyzer.detect_main_circuit(project_path)`
- [X] **服务层封装**：`simulation_service.get_main_circuit_candidates(project_path)`
- [X] **事件发布**：`EVENT_MAIN_CIRCUIT_DETECTED` 在 `simulation_service.run_with_auto_detect()` 中发布

#### 4.3.4 `analysis_selector.py` - 分析类型选择器

> **设计目标**：让用户手动勾选要执行的仿真分析类型，支持批量执行和选择持久化

- [ ] **文件路径**：`domain/simulation/service/analysis_selector.py`
- [ ] **职责**：管理用户选择的仿真分析类型，支持基础分析和高级分析的选择
- [ ] **数据类定义**：
  - `AnalysisType` - 分析类型枚举
    ```python
    class AnalysisType(Enum):
        # 基础分析
        AC = "ac"                    # AC 小信号分析
        DC = "dc"                    # DC 扫描分析
        TRANSIENT = "tran"           # 瞬态分析
        NOISE = "noise"              # 噪声分析
        OP = "op"                    # 工作点分析
        # 高级分析
        PVT = "pvt"                  # PVT 角点分析
        MONTE_CARLO = "monte_carlo"  # 蒙特卡洛分析
        PARAMETRIC = "parametric"    # 参数扫描
        WORST_CASE = "worst_case"    # 最坏情况分析
        SENSITIVITY = "sensitivity"  # 敏感度分析
    ```
  - `AnalysisSelection` - 分析选择数据类
    - `analysis_type: AnalysisType` - 分析类型
    - `enabled: bool` - 是否启用
    - `priority: int` - 执行优先级（数字越小越先执行）
    - `config_override: Optional[Dict]` - 该分析的配置覆盖（可选）
  - `AnalysisSelectionSet` - 分析选择集合
    - `selections: List[AnalysisSelection]` - 选择列表
    - `created_at: str` - 创建时间
    - `last_modified: str` - 最后修改时间
- [ ] **核心功能**：
  - `get_available_analyses() -> List[AnalysisType]` - 获取所有可用的分析类型
  - `get_selected_analyses() -> List[AnalysisSelection]` - 获取当前选中的分析列表
  - `set_analysis_enabled(analysis_type, enabled)` - 启用/禁用指定分析
  - `set_analysis_priority(analysis_type, priority)` - 设置分析执行优先级
  - `get_execution_order() -> List[AnalysisType]` - 获取按优先级排序的执行顺序
  - `save_selection(project_root)` - 保存选择到项目配置
  - `load_selection(project_root)` - 从项目配置加载选择
  - `reset_to_default()` - 重置为默认选择
  - `validate_selection() -> ValidationResult` - 校验选择的有效性
- [ ] **默认选择**：
  - 基础分析默认全部启用
  - 高级分析默认全部禁用（需用户手动启用）
- [ ] **配置存储**：`.circuit_ai/analysis_selection.json`
- [ ] **配置文件结构**：
  ```json
  {
    "version": "1.0",
    "selections": [
      {"type": "ac", "enabled": true, "priority": 1},
      {"type": "dc", "enabled": true, "priority": 2},
      {"type": "tran", "enabled": true, "priority": 3},
      {"type": "noise", "enabled": false, "priority": 4},
      {"type": "op", "enabled": true, "priority": 0},
      {"type": "pvt", "enabled": false, "priority": 10},
      {"type": "monte_carlo", "enabled": false, "priority": 11},
      {"type": "parametric", "enabled": false, "priority": 12},
      {"type": "worst_case", "enabled": false, "priority": 13},
      {"type": "sensitivity", "enabled": false, "priority": 14}
    ]
  }
  ```
- [ ] **事件发布**：
  - `EVENT_ANALYSIS_SELECTION_CHANGED` - 分析选择变更时发布
- [ ] **被调用方**：`SimulationService`、`AnalysisSelectorPanel`（UI）

#### 4.3.5 `chart_selector.py` - 图表类型选择器

> **设计目标**：让用户手动选择要显示的可视化图表类型，支持动态图表配置

- [ ] **文件路径**：`domain/simulation/service/chart_selector.py`
- [ ] **职责**：管理用户选择的图表显示类型，支持图表的启用/禁用和布局配置
- [ ] **数据类定义**：
  - `ChartType` - 图表类型枚举
    ```python
    class ChartType(Enum):
        # 基础波形图
        WAVEFORM_TIME = "waveform_time"       # 时域波形图
        WAVEFORM_FREQ = "waveform_freq"       # 频域波形图
        # Bode 图
        BODE_MAGNITUDE = "bode_mag"           # Bode 幅度图
        BODE_PHASE = "bode_phase"             # Bode 相位图
        BODE_COMBINED = "bode_combined"       # Bode 组合图（幅度+相位）
        # 特性曲线
        DC_TRANSFER = "dc_transfer"           # DC 传输特性曲线
        DC_SWEEP = "dc_sweep"                 # DC 扫描曲线
        # 频谱分析
        FFT_SPECTRUM = "fft_spectrum"         # FFT 频谱图
        HARMONIC_BAR = "harmonic_bar"         # 谐波柱状图
        # 统计图表
        HISTOGRAM = "histogram"               # 直方图（蒙特卡洛）
        SCATTER = "scatter"                   # 散点图
        BOX_PLOT = "box_plot"                 # 箱线图
        # 参数扫描图表
        CONTOUR = "contour"                   # 等高线图
        HEATMAP = "heatmap"                   # 热力图
        SURFACE_3D = "surface_3d"             # 3D 曲面图
        # 敏感度图表
        TORNADO = "tornado"                   # 龙卷风图
        SENSITIVITY_BAR = "sensitivity_bar"   # 敏感度柱状图
        # PVT 图表
        CORNER_COMPARISON = "corner_compare"  # 角点对比图
        CORNER_TABLE = "corner_table"         # 角点数据表格
        # 噪声图表
        NOISE_SPECTRUM = "noise_spectrum"     # 噪声频谱图
        NOISE_DENSITY = "noise_density"       # 噪声密度图
    ```
  - `ChartSelection` - 图表选择数据类
    - `chart_type: ChartType` - 图表类型
    - `enabled: bool` - 是否显示
    - `display_order: int` - 显示顺序
    - `layout_config: Optional[ChartLayoutConfig]` - 布局配置（可选）
  - `ChartLayoutConfig` - 图表布局配置
    - `width_ratio: float` - 宽度比例（0-1）
    - `height_ratio: float` - 高度比例（0-1）
    - `row: int` - 所在行
    - `column: int` - 所在列
  - `ChartSelectionSet` - 图表选择集合
    - `selections: List[ChartSelection]` - 选择列表
    - `layout_mode: str` - 布局模式（auto/grid/custom）
    - `columns: int` - 网格列数（grid 模式）
- [ ] **核心功能**：
  - `get_available_charts(analysis_types) -> List[ChartType]` - 根据分析类型获取可用图表
  - `get_selected_charts() -> List[ChartSelection]` - 获取当前选中的图表列表
  - `set_chart_enabled(chart_type, enabled)` - 启用/禁用指定图表
  - `set_chart_order(chart_type, order)` - 设置图表显示顺序
  - `set_layout_mode(mode)` - 设置布局模式
  - `get_chart_layout() -> List[ChartSelection]` - 获取按顺序排列的图表布局
  - `save_selection(project_root)` - 保存选择到项目配置
  - `load_selection(project_root)` - 从项目配置加载选择
  - `reset_to_default()` - 重置为默认选择
  - `get_recommended_charts(analysis_type) -> List[ChartType]` - 获取推荐图表
- [ ] **图表与分析类型的关联**：
  - AC 分析 → Bode 图、频域波形图
  - DC 分析 → DC 传输特性、DC 扫描曲线
  - 瞬态分析 → 时域波形图、FFT 频谱图
  - 噪声分析 → 噪声频谱图、噪声密度图
  - PVT 分析 → 角点对比图、角点数据表格
  - 蒙特卡洛 → 直方图、箱线图、散点图
  - 参数扫描 → 等高线图、热力图、3D 曲面图
  - 敏感度分析 → 龙卷风图、敏感度柱状图
- [ ] **默认选择规则**：
  - 根据启用的分析类型自动推荐相关图表
  - 用户可覆盖默认推荐
- [ ] **配置存储**：`.circuit_ai/chart_selection.json`
- [ ] **配置文件结构**：
  ```json
  {
    "version": "1.0",
    "layout_mode": "auto",
    "columns": 2,
    "selections": [
      {"type": "bode_combined", "enabled": true, "order": 1},
      {"type": "waveform_time", "enabled": true, "order": 2},
      {"type": "fft_spectrum", "enabled": false, "order": 3},
      {"type": "histogram", "enabled": false, "order": 10}
    ]
  }
  ```
- [ ] **事件发布**：
  - `EVENT_CHART_SELECTION_CHANGED` - 图表选择变更时发布
- [ ] **被调用方**：`SimulationPanel`、`ChartSelectorPanel`（UI）

#### 4.3.6 `tuning_service.py` - 快速调参服务（可选扩展）

> **实现优先级**：低。此功能为锦上添花，建议在核心功能稳定后再实现。
>
> **文件位置**：`domain/simulation/service/tuning_service.py`（与 `simulation_config_service.py` 同级）

- [ ] **文件路径**：`domain/simulation/service/tuning_service.py`
- [ ] **职责**：提供快速调参功能，支持参数提取和调参仿真
- [ ] **核心功能**：
  - `get_tunable_parameters(file_path) -> list[TunableParameter]` - 提取可调参数
  - `run_tuning(file_path, param_name, new_value) -> SimulationResult` - 调参仿真
- [ ] **参数提取规则**：
  - 从 `.param` 语句提取参数
  - 从 R/C/L 元件提取数值
- [ ] **被调用方**：`SimulationService`、`TuningPanel`（UI）

### 4.4 高级仿真分析模块组 (`domain/simulation/analysis/`)

> **设计说明**：为支持专业级电路设计验证，将高级仿真分析功能独立为模块组，包括 PVT 角点仿真、蒙特卡洛分析、参数扫描等。

- [X] **目录结构**：
  ```
  domain/simulation/analysis/
  ├── __init__.py
  ├── pvt_analysis.py           # PVT 角点仿真
  ├── monte_carlo_analysis.py   # 蒙特卡洛分析
  ├── parametric_sweep.py       # 参数扫描
  ├── worst_case_analysis.py    # 最坏情况分析
  ├── sensitivity_analysis.py   # 敏感度分析
  ├── post_processor.py         # 仿真后处理
  └── topology_recognizer.py    # 电路拓扑识别
  ```

#### 4.4.1 `pvt_analysis.py` - PVT 角点仿真

> **初始化顺序**：无需显式初始化，作为工具类按需实例化

- [X] **职责**：执行工艺-电压-温度（Process-Voltage-Temperature）角点仿真，验证电路在极端条件下的性能
- [X] **核心功能**：
  - `run_pvt_corners(circuit_file, analysis_config, corners)` - 执行多角点仿真
  - `get_default_corners()` - 获取默认角点配置
  - `add_custom_corner(name, process, voltage, temperature)` - 添加自定义角点
  - `generate_pvt_report(results)` - 生成 PVT 分析报告
  - `find_worst_case(results, metric)` - 找出指定指标的最差角点
- [X] **默认角点配置**：
  - TT（Typical-Typical）：典型工艺、标称电压、室温（25°C）
  - FF（Fast-Fast）：快速工艺、高电压（+10%）、低温（-40°C）
  - SS（Slow-Slow）：慢速工艺、低电压（-10%）、高温（85°C）
  - FS（Fast-Slow）：NMOS快/PMOS慢、标称电压、室温
  - SF（Slow-Fast）：NMOS慢/PMOS快、标称电压、室温
- [X] **工艺角点实现方式**：
  - 通过修改 `.lib` 文件中的模型参数实现工艺变化
  - 支持用户指定自定义工艺库文件
  - 若无工艺库，通过调整关键器件参数（如 Vth、mobility）模拟工艺偏差
- [X] **结果汇总结构**：包含各角点的仿真结果、各指标的最差角点标识、通过/失败状态，以及详细的角点对比数据
- [X] **与设计目标集成**：
  - 检查所有角点下是否满足设计目标
  - 标识哪些角点导致指标不达标
  - 生成角点覆盖率报告
- [X] **被调用方**：`simulation_service.py`、`tool_executor.py`（响应 `run_pvt_analysis` 工具调用）

#### 4.4.2 `monte_carlo_analysis.py` - 蒙特卡洛分析

> **初始化顺序**：无需显式初始化，作为工具类按需实例化
> **实现说明**：由于 PySpice 使用 NgSpiceShared 共享库模式，不支持同进程并发仿真，因此采用顺序执行策略而非进程池并行。

- [X] **职责**：执行蒙特卡洛统计分析，评估工艺偏差和元件容差对电路性能的影响
- [X] **核心功能**：
  - `run_monte_carlo(circuit_file, analysis_config, num_runs, variations)` - 执行蒙特卡洛仿真
  - `define_variation(component, param, distribution, sigma)` - 定义元件参数变化
  - `get_statistics(results, metric)` - 计算统计指标（均值、标准差、最大/最小值）
  - `calculate_yield(results, specs)` - 计算良率
  - `generate_histogram(results, metric, bins)` - 生成直方图数据
  - `identify_sensitive_params(results)` - 识别敏感参数
- [X] **参数变化分布类型**：
  - 高斯分布（Gaussian）：适用于大多数工艺参数
  - 均匀分布（Uniform）：适用于元件容差
  - 对数正态分布（Log-normal）：适用于某些物理参数
- [X] **典型变化配置**：
  - 电阻：±5% 或 ±10% 均匀分布
  - 电容：±10% 或 ±20% 均匀分布
  - 晶体管阈值电压：3σ = 30mV 高斯分布
  - 晶体管电流因子：3σ = 5% 高斯分布
- [X] **执行策略**：
  - **顺序执行**：由于 PySpice 共享库模式限制，采用顺序执行
  - **进度汇报**：每完成一次仿真发布 `EVENT_MONTE_CARLO_RUN_COMPLETE` 事件
  - **内存控制**：可选保留所有运行结果或仅保留统计摘要
  - **失败处理**：单次仿真失败不影响其他仿真，记录失败次数
  - **提前终止**：若失败率超过阈值（10%），提前终止并报告
- [X] **统计结果结构**：包含运行次数、各指标的统计数据（均值、标准差、最小值、最大值、3σ范围）、良率百分比、敏感参数排名
- [X] **良率计算**：
  - 根据设计目标计算各指标的通过率
  - 综合良率 = 所有指标同时满足的比例
  - 支持设置良率目标（如 99.7% 对应 3σ）
- [X] **被调用方**：`simulation_service.py`、`tool_executor.py`（响应 `run_monte_carlo` 工具调用）

#### 4.4.3 `parametric_sweep.py` - 参数扫描

> **初始化顺序**：无需显式初始化，作为工具类按需实例化

- [X] **职责**：执行参数扫描分析，探索设计空间，辅助参数优化
- [X] **核心功能**：
  - `run_sweep(circuit_file, analysis_config, sweep_config)` - 执行参数扫描
  - `define_sweep_param(component, param, start, stop, step)` - 定义扫描参数
  - `define_nested_sweep(params)` - 定义嵌套扫描（多参数同时扫描）
  - `find_optimal_point(results, objective, constraints)` - 找出最优参数点
  - `generate_contour_data(results, x_param, y_param, z_metric)` - 生成等高线图数据
- [X] **扫描类型**：
  - 线性扫描：等间距扫描
  - 对数扫描：对数间距扫描（适用于频率、电阻等）
  - 列表扫描：指定离散值列表
- [X] **嵌套扫描支持**：
  - 支持最多 3 层嵌套扫描
  - 自动计算总仿真次数并预估时间
  - 超过阈值时提示用户确认
- [X] **结果可视化数据**：
  - 单参数扫描：生成曲线数据
  - 双参数扫描：生成等高线/热力图数据
  - 三参数扫描：生成切片数据
- [X] **优化辅助**：
  - 根据扫描结果识别参数敏感度
  - 建议参数调整方向
  - 标识设计空间中的可行区域
- [X] **被调用方**：`simulation_service.py`、`tool_executor.py`（响应 `run_parametric_sweep` 工具调用）

#### 4.4.4 `worst_case_analysis.py` - 最坏情况分析

> **设计参考**：借鉴 LTspice 的最坏情况分析功能，比蒙特卡洛更快速地找到极端情况

- [X] **职责**：分析元件容差组合的最坏情况，快速评估设计裕度
- [X] **核心功能**：
  - `run_worst_case(circuit_file, tolerances, method, metric)` - 执行最坏情况分析
  - `define_tolerance(component, param, tolerance_percent)` - 定义元件容差
  - `get_worst_combination(results, metric)` - 获取导致最差性能的参数组合
  - `calculate_design_margin(results, spec)` - 计算设计裕度
  - `generate_worst_case_report(results)` - 生成最坏情况报告
- [X] **分析方法**：
  - RSS（Root Sum Square）方法：假设参数变化独立且服从正态分布，计算均方根叠加效应，适用于大多数情况
  - EVA（Extreme Value Analysis）方法：考虑所有参数同时取极端值的情况，结果更保守，适用于高可靠性要求
  - 敏感度加权方法：根据参数敏感度加权计算最坏情况
- [X] **RSS 方法计算**：首先对每个参数单独进行 +tolerance 和 -tolerance 仿真，计算每个参数对指标的影响量 Δi，然后计算总变化量为各影响量平方和的平方根，最后得到最坏情况值为标称值加减总变化量。
- [X] **EVA 方法计算**：首先确定每个参数对指标的影响方向（正相关或负相关），然后将所有正相关参数设为使指标变差的极端值，将所有负相关参数也设为使指标变差的极端值，最后执行一次仿真得到最坏情况。
- [X] **结果数据结构**：结果包含分析方法、标称值、最坏情况值（最大和最小）、设计裕度百分比、关键参数列表（按影响程度排序），以及各参数的敏感度系数。
- [X] **与蒙特卡洛的区别**：
  - 最坏情况分析：仿真次数少（2N+1 次，N 为参数数量），快速得到极端情况
  - 蒙特卡洛分析：仿真次数多（通常 100-1000 次），得到统计分布
  - 建议先用最坏情况分析快速评估，再用蒙特卡洛验证
- [X] **被调用方**：`simulation_service.py`、`tool_executor.py`（响应 `run_worst_case` 工具调用）

#### 4.4.5 `sensitivity_analysis.py` - 敏感度分析

> **设计参考**：借鉴 LTspice 的敏感度分析功能，识别关键元件指导优化方向

- [ ] **文件路径**：`domain/simulation/analysis/sensitivity_analysis.py`
- [ ] **职责**：分析各参数对输出的影响程度，识别关键元件，生成优化建议
- [ ] **核心功能**：
  - `run_sensitivity(circuit_file, params, metric, config) -> SensitivityResult` - 执行敏感度分析
  - `calculate_sensitivity(param, nominal, perturbed, delta) -> float` - 计算单个参数敏感度
  - `rank_by_sensitivity(results) -> List[ParamSensitivity]` - 按敏感度排序参数
  - `identify_critical_components(results, threshold) -> List[str]` - 识别关键元件
  - `generate_tornado_chart_data(results) -> TornadoChartData` - 生成龙卷风图数据
  - `get_optimization_suggestions(results, goals) -> List[str]` - 获取优化建议
- [ ] **敏感度计算方法**：
  - 绝对敏感度：S = ∂Output / ∂Param
  - 相对敏感度：S_rel = (∂Output / Output) / (∂Param / Param)
  - 归一化敏感度：将敏感度归一化到 0-1 范围
- [ ] **敏感度分析流程**：
  1. 执行标称值仿真获取基准结果
  2. 对每个参数分别进行 +1% 和 -1% 扰动仿真
  3. 计算敏感度系数
  4. 按敏感度绝对值排序
  5. 生成龙卷风图数据
  6. 生成优化建议
- [ ] **结果数据结构**：返回 `SensitivityResult`（定义见 4.1.4 节）
- [ ] **龙卷风图数据生成**：
  - 按敏感度绝对值降序排列参数
  - 计算每个参数的正向和负向影响
  - 生成 `TornadoChartData` 供图表生成器使用
- [ ] **优化建议生成**：
  - 根据敏感度和当前性能差距生成调参建议
  - 高敏感度参数优先调整
  - 考虑参数调整方向（增大或减小）
  - 估算调整量以达到目标
- [ ] **与 LLM 优化的协同**：
  - 敏感度分析结果可注入 Prompt，帮助 LLM 更有针对性地优化
  - 在 `OPTIMIZE_PARAMETERS` 模板中包含敏感度信息
  - LLM 优先调整高敏感度参数
- [ ] **事件发布**：
  - `EVENT_SENS_STARTED` - 敏感度分析开始
  - `EVENT_SENS_PROGRESS` - 分析进度（每完成一个参数）
  - `EVENT_SENS_COMPLETE` - 分析完成，携带 `SensitivityResult`
- [ ] **被调用方**：`simulation_service.py`、`tool_executor.py`（响应 `run_sensitivity` 工具调用）、`action_node.py`（优化时参考）

#### 4.4.6 `post_processor.py` - 仿真后处理

> **初始化顺序**：无需显式初始化，作为工具类按需实例化

- [ ] **文件路径**：`domain/simulation/analysis/post_processor.py`
- [ ] **职责**：对仿真原始数据进行后处理分析，提取高级特征，生成可视化数据
- [ ] **核心功能**：
  - `compute_fft(time_data, signal, window) -> FFTResult` - 计算 FFT 频谱
  - `compute_thd(fft_result, fundamental_freq) -> float` - 计算总谐波失真
  - `compute_sndr(fft_result, signal_freq) -> float` - 计算信噪失真比
  - `compute_sfdr(fft_result) -> float` - 计算无杂散动态范围
  - `compute_enob(sndr) -> float` - 计算有效位数
  - `find_poles_zeros(ac_data) -> Tuple[List, List]` - 提取极点和零点
  - `compute_group_delay(ac_data) -> np.ndarray` - 计算群延迟
  - `interpolate_data(data, new_points) -> np.ndarray` - 数据插值
  - `smooth_data(data, window_size) -> np.ndarray` - 数据平滑
- [ ] **FFT 分析参数**：
  - 窗函数选择：Hanning、Hamming、Blackman、Kaiser
  - 零填充支持：提高频率分辨率
  - 频谱平均：减少噪声影响
- [ ] **谐波分析**：
  - 自动识别基波频率
  - 计算各次谐波幅度
  - 支持指定谐波次数范围
- [ ] **极零点提取**：
  - 从 AC 分析数据拟合传递函数
  - 提取主极点和零点位置
  - 计算单位增益带宽、相位裕度等
- [ ] **结果数据结构**：返回 `FFTResult`（定义见 4.1.4 节）
- [ ] **事件发布**：
  - `EVENT_FFT_COMPLETE` - FFT 分析完成，携带 `FFTResult`
- [ ] **与图表生成器的集成**：
  - `FFTResult.get_chart_data()` 返回 `fft_chart.py` 所需的数据格式
  - 包含频谱数据、谐波柱状图数据、THD 标注数据
- [ ] **被调用方**：`metrics_extractor.py`、`chart_generator.py`、`distortion_metrics.py`

#### 4.4.7 `topology_recognizer.py` - 电路拓扑识别

> **初始化顺序**：无需显式初始化，作为工具类按需实例化

- [ ] **文件路径**：`domain/simulation/analysis/topology_recognizer.py`
- [ ] **职责**：自动识别电路拓扑类型，为仿真配置和指标提取提供指导，并将识别结果展示给用户
- [ ] **核心功能**：
  - `recognize_topology(spice_netlist) -> TopologyResult` - 识别电路拓扑类型
  - `get_recommended_analyses(topology) -> List[str]` - 获取推荐的分析类型
  - `get_key_metrics(topology) -> List[str]` - 获取关键性能指标列表
  - `get_typical_specs(topology) -> Dict[str, Tuple]` - 获取典型规格范围
  - `identify_critical_nodes(spice_netlist, topology) -> List[str]` - 识别关键节点
- [ ] **支持识别的拓扑类型**：
  - 放大器类：共源/共射、共漏/共集、共栅/共基、差分对、运算放大器、仪表放大器
  - 滤波器类：低通、高通、带通、带阻、全通
  - 电源类：LDO、Buck、Boost、Buck-Boost
  - 振荡器类：环形振荡器、LC 振荡器、晶振
  - 比较器类：单端比较器、迟滞比较器
  - 数据转换器类：ADC、DAC
- [ ] **识别方法**：
  - 基于网表结构分析：识别反馈路径、电源连接、信号流向
  - 基于器件组合模式：识别典型电路结构（如电流镜、差分对）
  - 基于仿真控制语句：从 .ac/.tran/.dc 推断分析意图
- [ ] **推荐分析配置**：
  - 放大器：AC 分析（Bode 图）、瞬态分析（阶跃响应）、噪声分析
  - 滤波器：AC 分析（频率响应）、群延迟分析
  - 电源：瞬态分析（负载阶跃）、DC 扫描（负载调整率）
  - 振荡器：瞬态分析（起振特性）、相位噪声分析
- [ ] **结果数据结构**：返回 `TopologyResult`（定义见 4.1.4 节）
- [ ] **事件发布**：
  - `EVENT_TOPOLOGY_DETECTED` - 拓扑识别完成，携带 `TopologyResult`
- [ ] **UI 展示方式**：
  - 在 `TopologyInfoPanel` 中以文本形式展示识别结果
  - 显示拓扑类型、置信度、推荐分析、关键指标
  - 提供"应用推荐配置"按钮
- [ ] **被调用方**：`simulation_service.py`（自动配置仿真）、`design_goals_node.py`（建议设计目标）、`TopologyInfoPanel`（UI 显示）

### 4.5 性能指标提取模块组 (`domain/simulation/metrics/`)

> **设计原则**：根据单一职责原则，将指标提取按类型拆分为独立子模块，便于维护和测试
>
> **目录结构**：
>
> ```
> domain/simulation/metrics/
> ├── __init__.py
> ├── metrics_extractor.py      # 门面类，委托给各子模块
> ├── amplifier_metrics.py      # 放大器指标
> ├── noise_metrics.py          # 噪声指标
> ├── distortion_metrics.py     # 失真指标
> ├── power_metrics.py          # 电源指标
> ├── transient_metrics.py      # 瞬态指标
> └── metric_result.py          # 指标结果数据类
> ```

#### 4.5.1 `metric_result.py` - 指标结果数据类

- [ ] **文件路径**：`domain/simulation/metrics/metric_result.py`
- [ ] **职责**：定义标准化的指标结果数据结构
- [ ] **数据类定义**：
  - `MetricResult` - 单个指标结果
    - `name: str` - 指标名称
    - `value: Optional[float]` - 指标数值
    - `unit: str` - 单位
    - `target: Optional[float]` - 目标值
    - `is_met: Optional[bool]` - 是否达标
    - `confidence: float` - 置信度（0-1）
    - `measurement_condition: str` - 测量条件描述
    - `error_message: Optional[str]` - 计算失败时的错误信息
- [ ] **被调用方**：所有指标提取子模块

#### 4.5.2 `metrics_extractor.py` - 指标提取门面类

> **初始化顺序**：无需显式初始化，作为工具类按需实例化

- [ ] **文件路径**：`domain/simulation/metrics/metrics_extractor.py`
- [ ] **职责**：作为门面类协调各子模块，提供统一的指标提取入口
- [ ] **核心功能**：
  - `extract_metrics(sim_data, topology, goals) -> Dict[str, MetricResult]` - 根据拓扑类型自动提取相关指标
  - `extract_all_metrics(sim_data) -> Dict[str, MetricResult]` - 提取所有可计算的指标
  - `get_metric_by_name(sim_data, metric_name) -> MetricResult` - 按名称提取单个指标
- [ ] **委托逻辑**：
  - 放大器指标 → `AmplifierMetrics`
  - 噪声指标 → `NoiseMetrics`
  - 失真指标 → `DistortionMetrics`
  - 电源指标 → `PowerMetrics`
  - 瞬态指标 → `TransientMetrics`
- [ ] **指标计算容错**：
  - 数据不足时返回 `MetricResult` 并设置 `error_message`
  - 计算异常时返回估计值并标记 `confidence`
- [ ] **被调用方**：`analysis_node.py`、`simulation_tab.py`、`pvt_analysis.py`

#### 4.5.3 `amplifier_metrics.py` - 放大器指标提取

- [ ] **文件路径**：`domain/simulation/metrics/amplifier_metrics.py`
- [ ] **职责**：提取放大器相关的性能指标
- [ ] **核心功能**：
  - `extract_gain(ac_data, freq_point)` - 提取指定频率的增益（dB）
  - `extract_bandwidth(ac_data, gain_ref)` - 提取 -3dB 带宽
  - `extract_gbw(ac_data)` - 提取增益带宽积
  - `extract_phase_margin(ac_data)` - 提取相位裕度
  - `extract_gain_margin(ac_data)` - 提取增益裕度
  - `extract_input_impedance(ac_data)` - 提取输入阻抗
  - `extract_output_impedance(ac_data)` - 提取输出阻抗
  - `extract_cmrr(ac_data)` - 提取共模抑制比
  - `extract_psrr(ac_data)` - 提取电源抑制比
  - `extract_slew_rate(tran_data)` - 提取压摆率（上升/下降）
  - `extract_settling_time(tran_data, target, tolerance)` - 提取整定时间
  - `extract_overshoot(tran_data)` - 提取过冲量
  - `extract_offset_voltage(dc_data)` - 提取输入失调电压
- [ ] **被调用方**：`metrics_extractor.py`（门面类）

#### 4.5.4 `noise_metrics.py` - 噪声指标提取

- [ ] **文件路径**：`domain/simulation/metrics/noise_metrics.py`
- [ ] **职责**：提取噪声相关的性能指标
- [ ] **核心功能**：
  - `extract_input_noise(noise_data, freq_point)` - 提取输入等效噪声电压密度
  - `extract_integrated_noise(noise_data, freq_range)` - 提取积分噪声
  - `extract_noise_figure(noise_data)` - 提取噪声系数
  - `extract_snr(noise_data, signal_level)` - 提取信噪比
- [ ] **被调用方**：`metrics_extractor.py`（门面类）

#### 4.5.5 `distortion_metrics.py` - 失真指标提取

- [ ] **文件路径**：`domain/simulation/metrics/distortion_metrics.py`
- [ ] **职责**：提取失真相关的性能指标
- [ ] **核心功能**：
  - `extract_thd(fft_data)` - 提取总谐波失真
  - `extract_thd_n(fft_data)` - 提取 THD+N
  - `extract_imd(fft_data, f1, f2)` - 提取互调失真
  - `extract_sfdr(fft_data)` - 提取无杂散动态范围
  - `extract_sndr(fft_data)` - 提取信噪失真比
  - `extract_enob(sndr)` - 提取有效位数
- [ ] **被调用方**：`metrics_extractor.py`（门面类）

#### 4.5.6 `power_metrics.py` - 电源指标提取

- [ ] **文件路径**：`domain/simulation/metrics/power_metrics.py`
- [ ] **职责**：提取电源相关的性能指标
- [ ] **核心功能**：
  - `extract_quiescent_current(dc_data)` - 提取静态电流
  - `extract_power_consumption(dc_data)` - 提取功耗
  - `extract_efficiency(tran_data)` - 提取效率（电源电路）
  - `extract_load_regulation(dc_data)` - 提取负载调整率
  - `extract_line_regulation(dc_data)` - 提取线性调整率
  - `extract_dropout_voltage(dc_data)` - 提取压差（LDO）
  - `extract_component_power(sim_data, component_name)` - 提取单个元件功耗
  - `extract_power_distribution(sim_data)` - 提取各元件功耗分布
  - `extract_efficiency_curve(tran_data, load_range)` - 提取效率随负载变化曲线
  - `extract_power_loss_breakdown(sim_data)` - 功耗损耗分解
  - `estimate_thermal_rise(power_data, thermal_resistance)` - 估算元件温升
- [ ] **被调用方**：`metrics_extractor.py`（门面类）

#### 4.5.7 `transient_metrics.py` - 瞬态指标提取

- [ ] **文件路径**：`domain/simulation/metrics/transient_metrics.py`
- [ ] **职责**：提取瞬态分析相关的性能指标
- [ ] **核心功能**：
  - `extract_rise_time(tran_data, low, high)` - 提取上升时间
  - `extract_fall_time(tran_data, low, high)` - 提取下降时间
  - `extract_propagation_delay(tran_data)` - 提取传播延迟
  - `extract_duty_cycle(tran_data)` - 提取占空比
  - `extract_frequency(tran_data)` - 提取振荡频率
- [ ] **被调用方**：`metrics_extractor.py`（门面类）

### 4.6 仿真辅助模块 (`domain/simulation/helpers/`)

#### 4.6.1 `convergence_helper.py` - 仿真收敛辅助

> **初始化顺序**：无需显式初始化，作为工具类按需实例化

- [ ] **文件路径**：`domain/simulation/helpers/convergence_helper.py`
- [ ] **职责**：辅助解决仿真收敛问题，诊断问题原因，生成修复建议，并将诊断结果展示给用户
- [ ] **核心功能**：
  - `diagnose_convergence_issue(error_output) -> ConvergenceDiagnosis` - 诊断收敛问题类型
  - `suggest_initial_conditions(netlist) -> List[str]` - 建议初始条件设置
  - `adjust_simulation_params(current_params, error_type) -> Dict` - 调整仿真参数
  - `add_convergence_aids(netlist) -> str` - 添加收敛辅助元件
  - `validate_netlist_connectivity(netlist) -> List[str]` - 验证网表连通性
  - `apply_auto_fix(diagnosis, netlist) -> Tuple[str, bool]` - 应用自动修复
- [ ] **收敛问题诊断**：
  - DC 工作点不收敛：检查电源连接、浮空节点、初始条件
  - 瞬态分析不收敛：检查时间步长、非线性元件、初始状态
  - AC 分析异常：检查直流偏置点、小信号模型有效性
- [ ] **自动修复策略**：
  - 浮空节点：自动添加高阻接地电阻（如 1GΩ）
  - DC 不收敛：逐步放宽 gmin、reltol、abstol 参数
  - 瞬态不收敛：减小最大时间步长、添加 .ic 初始条件
  - 模型问题：建议替换为简化模型或添加寄生参数
- [ ] **初始条件建议**：
  - 分析电路拓扑，识别需要初始条件的节点
  - 根据电源电压和电路结构估算合理的初始值
  - 生成 .ic 语句建议
- [ ] **收敛辅助元件**：
  - Gmin 步进：在关键节点添加小电导
  - 源步进：逐步增加电源电压
  - 伪瞬态分析：将 DC 分析转换为瞬态分析
- [ ] **网表验证**：
  - 检查所有节点是否有 DC 通路到地
  - 检查电源和地的连接完整性
  - 检查器件参数是否在有效范围内
  - 检查 .include 文件是否存在
- [ ] **结果数据结构**：返回 `ConvergenceDiagnosis`（定义见 4.1.4 节）
- [ ] **事件发布**：
  - `EVENT_CONVERGENCE_DIAGNOSED` - 收敛诊断完成，携带 `ConvergenceDiagnosis`
- [ ] **UI 展示方式**：
  - 在 `DiagnosisPanel` 中以文本形式展示诊断结果
  - 显示问题类型、严重程度、受影响节点、建议修复方案
  - 若可自动修复，显示"应用自动修复"按钮
- [ ] **被调用方**：`spice_executor.py`（仿真失败时）、`fix_error_action.py`（错误修复时）、`DiagnosisPanel`（UI 显示）

#### 4.6.2 元件库管理 (`domain/simulation/library/`)

#### 4.6.2.1 `library_manager.py` - 子电路库管理器

> **设计参考**：借鉴 LTspice 的元件库管理功能
>
> **路径解析说明**：
>
> - 调用 `ngspice_config.get_ngspice_models_path()` 获取模型库基础路径
> - 自动处理开发环境和打包环境的路径差异
> - 支持 cmp/sub/custom 三类模型目录

- [ ] **文件路径**：`domain/simulation/library/library_manager.py`
- [ ] **职责**：管理 SPICE 子电路库和元件模型，支持导入、搜索和组织
- [ ] **依赖**：`ngspice_config`（路径获取）
- [ ] **核心功能**：
  - `list_available_libraries()` - 列出所有可用库
  - `import_library(path, library_name)` - 导入外部库文件到 custom 目录
  - `export_library(library_name, output_path)` - 导出库文件
  - `search_component(keyword, category)` - 搜索元件
  - `get_component_info(component_name)` - 获取元件详细信息
  - `add_to_favorites(component_name)` - 添加到收藏
  - `get_favorites()` - 获取收藏列表
  - `validate_library(library_path)` - 校验库文件格式
- [ ] **库文件组织结构**：
  - 内嵌库目录：`vendor/ngspice/{platform}/.../models/cmp/` 和 `models/sub/`（只读，随应用分发）
  - 用户库目录：`vendor/ngspice/{platform}/.../models/custom/`（可写，用户导入的库）
  - 项目库目录：`{project}/libraries/`（项目专用库，可选）
- [ ] **预置库内容**（位于 sub 目录）：
  - 通用运放模型（如 LM741、LT1001、ADI 系列）
  - 通用比较器模型（如 LM393、LM311）
  - 电源管理芯片模型（LT 系列稳压器）
  - 基本晶体管和 MOSFET 模型（位于 cmp 目录）
- [ ] **元件搜索功能**：
  - 支持按名称模糊搜索
  - 支持按类别筛选（运放、比较器、晶体管、MOSFET、稳压器等）
  - 支持按厂商筛选
  - 支持按参数范围筛选（如增益带宽积 > 10MHz）
- [ ] **元件信息数据结构**：元件信息包含名称、类别、厂商、描述、关键参数列表、数据手册链接（可选）、库文件路径，以及使用示例代码。
- [ ] **库文件格式支持**：
  - 标准 SPICE 库文件（.lib、.mod）
  - LTspice 库文件（.lib、.sub）
  - PSpice 库文件（.lib）
  - 自动检测并转换格式差异
- [ ] **被调用方**：`LibraryPanel`（库管理面板）、`initial_design_node.py`（选择元件）

#### 4.6.2.2 `library_downloader.py` - 元件库下载器

> **设计目标**：提供预制元件库的自动下载和更新功能，确保用户开箱即用
>
> **架构说明**：网络下载属于 I/O 操作，按分层架构原则放在 infrastructure 层

- [ ] **文件路径**：`infrastructure/library/library_downloader.py`
- [ ] **职责**：从远程源下载和更新 SPICE 元件库
- [ ] **核心功能**：
  - `download_default_libraries()` - 下载默认预制库
  - `update_library(library_name)` - 更新指定库
  - `check_updates()` - 检查库更新
  - `get_download_progress()` - 获取下载进度
  - `cancel_download()` - 取消下载
- [ ] **预制库来源**：
  - **ngspice 官方模型**：从 ngspice SourceForge 仓库获取标准模型
  - **开源社区库**：从 GitHub `spice-models` 等项目获取
  - **厂商模型索引**：提供 TI、ADI、ON Semi 等厂商模型的下载链接索引
- [ ] **下载目录**：
  - 系统库：`vendor/spice_libraries/`（随应用分发）
  - 用户库：`~/.circuit_design_ai/libraries/`（用户下载）
- [ ] **首次启动检查**：
  - 应用首次启动时检查 `vendor/spice_libraries/` 是否存在
  - 若不存在或不完整，提示用户下载预制库
  - 提供"跳过"选项，用户可稍后手动下载
- [ ] **库清单文件**：
  - 远程清单：`https://example.com/circuit-ai/library-manifest.json`
  - 本地清单：`vendor/spice_libraries/manifest.json`
  - 清单内容：库名称、版本、下载 URL、SHA256 校验和、文件大小
- [ ] **下载流程**：
  1. 获取远程清单
  2. 比对本地清单，确定需要下载/更新的库
  3. 显示下载确认对话框（列出库名称和大小）
  4. 用户确认后开始下载
  5. 下载完成后校验 SHA256
  6. 解压到目标目录
  7. 更新本地清单
- [ ] **离线模式**：
  - 支持从本地 ZIP 文件导入库
  - 支持导出已安装库为 ZIP 文件
- [ ] **事件发布**：
  - `EVENT_LIBRARY_DOWNLOAD_STARTED` - 下载开始
  - `EVENT_LIBRARY_DOWNLOAD_PROGRESS` - 下载进度
  - `EVENT_LIBRARY_DOWNLOAD_COMPLETE` - 下载完成
  - `EVENT_LIBRARY_DOWNLOAD_ERROR` - 下载错误
- [ ] **被调用方**：`library_manager.py`、`startup_check.py`（首次启动检查）

---

### 4.7 仿真数据处理层 (`domain/simulation/data/`)

> **⚠️ 架构重构说明**：
>
> - 原 `visualization/` 目录职责混杂，包含了领域层数据服务和 UI 层组件
> - 重构后：领域层仅保留数据处理服务，UI 组件移至 `presentation/panels/simulation/`（详见 4.9 节）
> - 本节定义领域层的数据处理服务

> **设计原则**：
>
> - 领域层专注于数据处理逻辑（降采样、导出、日志解析）
> - 不包含任何 UI 组件、图表渲染、用户交互逻辑
> - 为表示层提供标准化的数据访问接口

> **大数据处理约束**：
>
> - 仿真产生的瞬态分析数据可能达百万级数据点
> - 数据服务层负责降采样处理，UI 层不直接处理原始大数据

#### 4.7.1 `waveform_data_service.py` - 波形数据服务

- [ ] **文件路径**：`domain/simulation/data/waveform_data_service.py`
- [ ] **职责**：作为波形数据访问的统一入口，协调降采样、缓存
- [ ] **核心功能**：
  - `get_initial_data(sim_result_path, signal_name, target_points) -> WaveformData` - 获取初始显示数据
  - `get_viewport_data(sim_result_path, signal_name, x_min, x_max, target_points) -> WaveformData` - 获取视口范围数据
  - `get_full_resolution_data(sim_result_path, signal_name) -> WaveformData` - 获取原始分辨率数据
  - `get_available_signals(sim_result_path) -> List[str]` - 获取可用信号列表
  - `get_table_data(sim_result_path, start_row, count) -> TableData` - 获取表格数据（虚拟滚动）
- [ ] **`WaveformData` 数据结构**：
  - `signal_name: str` - 信号名称
  - `x_data: np.ndarray` - X 轴数据
  - `y_data: np.ndarray` - Y 轴数据
  - `point_count: int` - 数据点数量
  - `x_range: Tuple[float, float]` - X 轴范围
  - `y_range: Tuple[float, float]` - Y 轴范围
  - `is_downsampled: bool` - 是否经过降采样
- [ ] **被调用方**：`presentation/panels/simulation/waveform_widget.py`

#### 4.7.2 `downsampler.py` - LTTB 降采样算法

- [ ] **文件路径**：`domain/simulation/data/downsampler.py`
- [ ] **职责**：实现 Largest Triangle Three Buckets 降采样算法，保持波形视觉特征
- [ ] **核心功能**：
  - `downsample(x: np.ndarray, y: np.ndarray, target_points: int) -> Tuple[np.ndarray, np.ndarray]` - 执行 LTTB 降采样
  - `downsample_multiple(x: np.ndarray, signals: Dict[str, np.ndarray], target_points: int) -> Dict` - 批量降采样
- [ ] **性能要求**：百万点降采样到 2000 点 < 100ms
- [ ] **被调用方**：`WaveformDataService`

#### 4.7.3 `resolution_pyramid.py` - 多分辨率金字塔

- [ ] **文件路径**：`domain/simulation/data/resolution_pyramid.py`
- [ ] **职责**：管理波形数据的多分辨率金字塔，支持快速缩放
- [ ] **核心功能**：
  - `build_pyramid(x: np.ndarray, y: np.ndarray, levels: List[int]) -> PyramidData` - 构建金字塔
  - `save_pyramid(pyramid: PyramidData, output_dir: Path)` - 保存到文件
  - `load_pyramid(input_dir: Path) -> PyramidData` - 从文件加载
  - `select_optimal_level(pyramid: PyramidData, required_points: int) -> int` - 选择最优层级
- [ ] **默认层级**：`[500, 2000, 10000, 50000]` 点
- [ ] **被调用方**：`WaveformDataService`

#### 4.7.4 `data_exporter.py` - 数据导出服务

- [ ] **文件路径**：`domain/simulation/data/data_exporter.py`
- [ ] **职责**：将仿真数据导出为多种标准格式
- [ ] **核心功能**：
  - `export_to_csv(sim_result_path, signals, output_path)` - 导出为 CSV 格式
  - `export_to_matlab(sim_result_path, output_path)` - 导出为 MATLAB .mat 格式
  - `export_to_numpy(sim_result_path, output_path)` - 导出为 NumPy .npy 格式
  - `export_to_json(sim_result_path, output_path)` - 导出为 JSON 格式
  - `get_supported_formats() -> List[str]` - 获取支持的导出格式列表
- [ ] **被调用方**：`presentation/panels/simulation/chart_viewer.py`

#### 4.7.5 `simulation_output_reader.py` - 仿真输出日志读取

- [ ] **文件路径**：`domain/simulation/data/simulation_output_reader.py`
- [ ] **职责**：读取和解析仿真引擎的输出日志
- [ ] **核心功能**：
  - `get_output_log(sim_result_path, max_lines) -> List[LogLine]` - 获取输出日志
  - `get_error_lines(sim_result_path) -> List[LogLine]` - 获取错误行
  - `search_log(sim_result_path, keyword) -> List[LogLine]` - 搜索日志内容
  - `get_simulation_summary(sim_result_path) -> SimulationSummary` - 获取仿真摘要
- [ ] **`LogLine` 数据结构**：
  - `line_number: int` - 行号
  - `content: str` - 日志内容
  - `level: str` - 日志级别（info/warning/error）
- [ ] **被调用方**：`presentation/panels/simulation/output_log_viewer.py`

---

### 4.8 电路图生成子域 (`domain/simulation/schematic/`)

> **设计目标**：将 SPICE 网表文件转换为可视化的电路原理图，支持静态图片生成和交互式查看
>
> **⚠️ 技术选型决策（成熟方案优先）**：
>
> - **核心引擎**：采用 **Schemdraw** 库作为电路图绘制引擎
> - **选型理由**：
>   - Schemdraw 是专门用于电路原理图绘制的成熟 Python 库，已被学术界和工业界广泛使用
>   - 内置丰富的 IEEE 标准电路元件符号（电阻、电容、运放、晶体管等）
>   - 采用相对定位方式，元件自动对齐，无需复杂的布局算法
>   - 原生支持 SVG、PNG、PDF 导出
>   - API 简洁，文档完善，学习成本低
> - **架构简化**：
>   - 删除自研的力导向布局算法、符号库、渲染器
>   - 保留网表解析器（提取元件和连接关系）
>   - 新增 Schemdraw 适配层（将解析结果转换为 Schemdraw 绘图指令）
> - **Qt 集成**：Schemdraw 生成的 SVG 可直接在 QSvgWidget 中显示
>
> **设计原则**：复用成熟库，降低开发风险，专注于业务逻辑

#### 4.8.0 电路图生成数据流图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         电路图生成数据流转路径                           │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  [SPICE 网表文件]                                                       │
│       │                                                                 │
│       ▼                                                                 │
│  NetlistParser.parse()                                                  │
│       │                                                                 │
│       ▼                                                                 │
│  [元件列表: List[CircuitElement]]                                       │
│       │                                                                 │
│       ▼                                                                 │
│  SchemdrawAdapter.generate()                                            │
│       │                                                                 │
│       ├──► ElementMapper.map_element() ──► Schemdraw 元件对象           │
│       │                                                                 │
│       ├──► 自动布局（Schemdraw 内置相对定位）                            │
│       │                                                                 │
│       ▼                                                                 │
│  schemdraw.Drawing 对象                                                 │
│       │                                                                 │
│       ▼                                                                 │
│  [输出分支]                                                             │
│       │                                                                 │
│       ├─ 静态导出 ──► drawing.save()                                    │
│       │                   │                                             │
│       │                   ├──► PNG (matplotlib backend)                 │
│       │                   ├──► SVG (svg backend)                        │
│       │                   └──► PDF (matplotlib backend)                 │
│       │                                                                 │
│       └─ 交互查看 ──► drawing.get_imagedata('svg')                      │
│                           │                                             │
│                           ▼                                             │
│                      QSvgWidget.load(svg_bytes)                         │
│                           │                                             │
│                           └──► SchematicPanel 集成到主窗口              │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 4.8.1 电路图数据模型 (`domain/simulation/schematic/models/`)

> **设计原则**：使用 dataclass 定义标准化数据结构，作为解析层和渲染层之间的数据传递载体

##### 4.8.1.1 `circuit_element.py` - 电路元件数据类

- [ ] **文件路径**：`domain/simulation/schematic/models/circuit_element.py`
- [ ] **职责**：定义从网表解析出的电路元件数据结构
- [ ] **元件类型枚举**：
  ```python
  class ElementType(Enum):
      RESISTOR = "R"           # 电阻
      CAPACITOR = "C"          # 电容
      INDUCTOR = "L"           # 电感
      VOLTAGE_SOURCE = "V"     # 电压源
      CURRENT_SOURCE = "I"     # 电流源
      DIODE = "D"              # 二极管
      BJT_NPN = "Q_NPN"        # NPN 三极管
      BJT_PNP = "Q_PNP"        # PNP 三极管
      MOSFET_N = "M_N"         # NMOS
      MOSFET_P = "M_P"         # PMOS
      OPAMP = "X_OPAMP"        # 运算放大器
      SUBCIRCUIT = "X"         # 子电路
      GROUND = "GND"           # 地
  ```
- [ ] **数据类定义**：
  - `CircuitElement` - 电路元件
    - `name: str` - 元件名称（如 R1、C2、Q3）
    - `element_type: ElementType` - 元件类型
    - `nodes: List[str]` - 连接的节点列表
    - `value: Optional[str]` - 元件值（如 10k、100n）
    - `model: Optional[str]` - 模型名称（晶体管等）
    - `parameters: Dict[str, str]` - 附加参数
    - `source_line: int` - 在网表中的行号
- [ ] **核心方法**：
  - `get_terminal_count()` - 获取端子数量
  - `to_dict()` / `from_dict()` - 序列化/反序列化
- [ ] **被调用方**：`netlist_parser.py`、`schemdraw_adapter.py`

##### 4.8.1.2 `schematic_result.py` - 电路图生成结果数据类

- [ ] **文件路径**：`domain/simulation/schematic/models/schematic_result.py`
- [ ] **职责**：定义电路图生成的结果数据结构
- [ ] **数据类定义**：
  - `SchematicResult` - 电路图生成结果
    - `success: bool` - 是否成功
    - `svg_data: Optional[bytes]` - SVG 图像数据（用于 UI 显示）
    - `output_path: Optional[str]` - 导出文件路径（静态导出时）
    - `element_count: int` - 元件数量
    - `error_message: Optional[str]` - 错误信息
    - `generation_time_ms: float` - 生成耗时
- [ ] **核心方法**：
  - `to_dict()` / `from_dict()` - 序列化/反序列化
- [ ] **被调用方**：`schematic_service.py`、`schematic_panel.py`

#### 4.8.2 网表解析器 (`domain/simulation/schematic/parser/`)

##### 4.8.2.1 `netlist_parser.py` - SPICE 网表解析器

- [ ] **文件路径**：`domain/simulation/schematic/parser/netlist_parser.py`
- [ ] **职责**：解析 SPICE 网表文件，提取电路元件列表
- [ ] **核心功能**：
  - `parse(file_path: str) -> List[CircuitElement]` - 解析网表文件
  - `parse_text(netlist_text: str) -> List[CircuitElement]` - 解析网表文本
  - `_preprocess(content: str) -> List[str]` - 预处理（移除注释、处理续行符）
  - `_parse_element_line(line: str, line_number: int) -> Optional[CircuitElement]` - 解析单行元件定义
  - `_identify_element_type(name: str, model: Optional[str]) -> ElementType` - 识别元件类型
- [ ] **元件识别规则**：
  - R 开头 → 电阻
  - C 开头 → 电容
  - L 开头 → 电感
  - V 开头 → 电压源
  - I 开头 → 电流源
  - D 开头 → 二极管
  - Q 开头 → BJT（根据模型判断 NPN/PNP）
  - M 开头 → MOSFET（根据模型判断 N/P）
  - X 开头 → 子电路（根据子电路名判断是否为运放等）
- [ ] **元件值解析**：
  - 支持 SPICE 单位后缀（k、meg、g、m、u、n、p、f）
  - 支持科学计数法（1e-9）
  - 支持参数引用（{R_value}）
- [ ] **支持的网表格式**：
  - 标准 SPICE 网表（.cir、.sp、.spice）
  - 支持 `.subckt` 子电路定义（提取为 SUBCIRCUIT 类型）
  - 忽略 `.include`、`.param`、`.model` 等控制语句
- [ ] **被调用方**：`schematic_service.py`

#### 4.8.3 Schemdraw 渲染适配层 (`domain/simulation/schematic/renderer/`)

> **设计原则**：将解析结果转换为 Schemdraw 绘图指令，复用 Schemdraw 的布局和渲染能力

##### 4.8.3.1 `element_mapper.py` - 元件类型映射器

- [ ] **文件路径**：`domain/simulation/schematic/renderer/element_mapper.py`
- [ ] **职责**：将 `ElementType` 映射到对应的 Schemdraw 元件类
- [ ] **核心功能**：
  - `get_schemdraw_element(element_type: ElementType) -> Type` - 获取 Schemdraw 元件类
  - `get_element_kwargs(element: CircuitElement) -> Dict` - 获取元件构造参数
- [ ] **映射表**：
  ```python
  ELEMENT_MAP = {
      ElementType.RESISTOR: elm.Resistor,
      ElementType.CAPACITOR: elm.Capacitor,
      ElementType.INDUCTOR: elm.Inductor,
      ElementType.VOLTAGE_SOURCE: elm.SourceV,
      ElementType.CURRENT_SOURCE: elm.SourceI,
      ElementType.DIODE: elm.Diode,
      ElementType.BJT_NPN: elm.BjtNpn,
      ElementType.BJT_PNP: elm.BjtPnp,
      ElementType.MOSFET_N: elm.NFet,
      ElementType.MOSFET_P: elm.PFet,
      ElementType.OPAMP: elm.Opamp,
      ElementType.GROUND: elm.Ground,
  }
  ```
- [ ] **标签生成**：
  - 元件名称作为顶部标签
  - 元件值作为底部标签
  - 格式：`element.label(name, loc='top').label(value, loc='bot')`
- [ ] **被调用方**：`schemdraw_adapter.py`

##### 4.8.3.2 `schemdraw_adapter.py` - Schemdraw 绘图适配器

- [ ] **文件路径**：`domain/simulation/schematic/renderer/schemdraw_adapter.py`
- [ ] **职责**：将电路元件列表转换为 Schemdraw Drawing 对象
- [ ] **核心功能**：
  - `generate(elements: List[CircuitElement], config: SchematicConfig) -> schemdraw.Drawing` - 生成电路图
  - `_build_connection_graph(elements: List[CircuitElement]) -> Dict` - 构建连接关系图
  - `_determine_layout_order(elements: List[CircuitElement], connections: Dict) -> List[str]` - 确定绘制顺序
  - `_add_element_to_drawing(drawing: Drawing, element: CircuitElement, anchor: str)` - 添加元件到画布
  - `export_svg(drawing: Drawing) -> bytes` - 导出为 SVG 字节流
  - `export_file(drawing: Drawing, output_path: str, format: str)` - 导出为文件
- [ ] **布局策略**：
  - **简单电路**（元件数 ≤ 10）：线性布局，从左到右依次放置
  - **复杂电路**（元件数 > 10）：分组布局，按信号流向分层
  - **连接处理**：使用 Schemdraw 的 `at()` 和 `anchor` 机制自动对齐
- [ ] **绘图配置 `SchematicConfig`**：
  - `unit: float` - 单位长度（默认 3.0）
  - `fontsize: float` - 字体大小（默认 12）
  - `color: str` - 默认颜色（默认 'black'）
  - `background: str` - 背景颜色（默认 'white'）
- [ ] **被调用方**：`schematic_service.py`

#### 4.8.4 `schematic_service.py` - 电路图服务门面类

- [ ] **文件路径**：`domain/simulation/schematic/schematic_service.py`
- [ ] **职责**：作为电路图生成功能的统一入口
- [ ] **核心功能**：
  - `generate_schematic(file_path: str, output_path: Optional[str], format: str, config: SchematicConfig) -> SchematicResult` - 生成电路图
  - `get_svg_data(file_path: str, config: SchematicConfig) -> bytes` - 获取 SVG 数据（供 UI 显示）
  - `get_supported_formats() -> List[str]` - 获取支持的输出格式
- [ ] **生成流程**：
  1. 调用 `NetlistParser.parse()` 解析网表
  2. 调用 `SchemdrawAdapter.generate()` 生成 Drawing 对象
  3. 根据需求导出为 SVG/PNG/PDF
  4. 返回 `SchematicResult`
- [ ] **支持的输出格式**：
  - SVG - 矢量格式（推荐，用于 UI 显示）
  - PNG - 位图格式
  - PDF - 打印格式
- [ ] **缓存机制**：
  - 缓存解析结果，文件未变更时复用
  - 使用文件哈希判断是否变更
- [ ] **错误处理**：
  - 网表解析失败 → 返回详细错误信息
  - Schemdraw 渲染失败 → 返回错误信息
- [ ] **被调用方**：`schematic_panel.py`、`report_generator.py`

#### 4.8.5 电路图查看器面板 (`presentation/panels/schematic/`)

> **设计原则**：使用 QSvgWidget 显示 Schemdraw 生成的 SVG，提供基本的缩放和导出功能

##### 4.8.5.1 `schematic_panel.py` - 电路图面板主组件

- [ ] **文件路径**：`presentation/panels/schematic/schematic_panel.py`
- [ ] **职责**：电路图查看器的主面板，集成视图和工具栏
- [ ] **核心类**：`SchematicPanel(QWidget)`
- [ ] **核心功能**：
  - `load_schematic(file_path: str)` - 加载并显示电路图
  - `refresh()` - 刷新电路图（重新生成）
  - `export(output_path: str, format: str)` - 导出电路图
  - `clear()` - 清空显示
- [ ] **UI 布局**：
  - 顶部：工具栏（缩放、导出按钮）
  - 中央：SVG 视图（SchematicView）
  - 底部：状态栏（元件数量、生成耗时）
- [ ] **事件处理**：
  - 监听 `EVENT_MAIN_CIRCUIT_CHANGED` 事件，自动刷新电路图
  - 监听 `EVENT_SCHEMATIC_LOADED` 事件，更新状态栏
- [ ] **被调用方**：`main_window.py`（下栏面板标签页）

##### 4.8.5.2 `schematic_view.py` - SVG 渲染视图

- [ ] **文件路径**：`presentation/panels/schematic/schematic_view.py`
- [ ] **职责**：显示 SVG 格式的电路图，支持缩放和平移
- [ ] **核心类**：`SchematicView(QScrollArea)`
- [ ] **核心功能**：
  - `load_svg(svg_data: bytes)` - 加载 SVG 数据
  - `zoom_in()` - 放大（1.25 倍）
  - `zoom_out()` - 缩小（0.8 倍）
  - `zoom_to_fit()` - 自适应缩放
  - `reset_zoom()` - 重置缩放
  - `get_zoom_level() -> float` - 获取当前缩放级别
- [ ] **内部组件**：
  - `QSvgWidget` - SVG 渲染组件
  - 通过 `setFixedSize()` 实现缩放
- [ ] **缩放控制**：
  - 最小缩放：0.1（10%）
  - 最大缩放：5.0（500%）
  - 滚轮缩放：Ctrl + 滚轮
- [ ] **被调用方**：`schematic_panel.py`

##### 4.8.5.3 `schematic_toolbar.py` - 电路图工具栏

- [ ] **文件路径**：`presentation/panels/schematic/schematic_toolbar.py`
- [ ] **职责**：提供电路图操作的工具栏
- [ ] **核心类**：`SchematicToolbar(QToolBar)`
- [ ] **工具按钮**：
  - 放大（Zoom In）- 快捷键 Ctrl++
  - 缩小（Zoom Out）- 快捷键 Ctrl+-
  - 适应窗口（Fit to Window）- 快捷键 Ctrl+0
  - 刷新（Refresh）- 快捷键 F5
  - 导出（Export）- 下拉菜单（PNG/SVG/PDF）
- [ ] **信号定义**：
  - `zoom_in_clicked()` - 放大按钮点击
  - `zoom_out_clicked()` - 缩小按钮点击
  - `fit_clicked()` - 适应窗口按钮点击
  - `refresh_clicked()` - 刷新按钮点击
  - `export_requested(format: str)` - 导出请求
- [ ] **被调用方**：`schematic_panel.py`

---

### 4.9 仿真执行上下文 (`domain/simulation/executor/`)

> **⚠️ 核心架构决策**：
>
> - **SpiceExecutor**：使用 PySpice 的 NgSpiceShared 共享库模式，ngspice 在主进程内执行，无需子进程
> - **PythonExecutor**：使用 subprocess 在子进程中执行用户脚本，提供基础进程隔离
> - ngspice 是外部 C 程序，共享库模式下崩溃可能影响主程序，但性能更高
> - Python 脚本仿真需要进程级隔离以确保安全

#### 4.9.1 `simulation_task.py` - 仿真任务封装

> **执行上下文**：主进程，协程
>
> **设计说明**：封装仿真任务的启动和结果收集逻辑。SpiceExecutor 使用 PySpice 共享库模式在同进程执行，PythonExecutor 使用 subprocess 在子进程执行。

- [ ] **文件路径**：`domain/simulation/executor/simulation_task.py`
- [ ] **职责**：封装仿真任务的启动、监控和结果收集逻辑
- [ ] **核心功能**：
  - `run_simulation_async(file_path, config) -> SimulationResult` - 异步执行仿真
    - 根据文件类型选择执行器（SpiceExecutor 或 PythonExecutor）
    - SpiceExecutor：直接调用 PySpice，同进程执行
    - PythonExecutor：通过 subprocess 启动子进程
    - 通过 `EventBus` 发布进度事件（使用 `EventThrottler` 聚合）
    - 返回仿真结果
  - `cancel()` - 取消仿真（仅对 PythonExecutor 有效，通过终止子进程实现）
- [ ] **进度事件发布**：
  ```python
  # 使用 EventThrottler 聚合高频进度更新
  throttler = EventThrottler(interval_ms=100)
  throttler.emit(SimulationEvents.SIMULATION_PROGRESS, {
      "percent": percent,
      "message": message
  })
  ```
- [ ] **超时处理**：
  - 默认超时 300 秒，可通过配置调整
  - SpiceExecutor：PySpice 内部超时机制
  - PythonExecutor：subprocess.run(timeout=...) 参数
- [ ] **被调用方**：`SimulationService`、`simulation_node.py`

#### 4.9.2 电路图生成任务

> **执行上下文**：主进程，QThreadPool（CPU 密集型）

- [ ] **文件路径**：`domain/simulation/schematic/schematic_task.py`
- [ ] **职责**：在 QThreadPool 中执行电路图布局计算和渲染
- [ ] **设计说明**：
  - 电路图生成是 CPU 密集型任务（布局算法、图形渲染）
  - 使用 `CpuTaskExecutor` 提交到 QThreadPool
  - 结果通过信号返回主线程
- [ ] **核心功能**：
  - `generate_schematic_async(file_path, config) -> SchematicResult` - 异步生成电路图
  - `cancel()` - 取消生成任务
- [ ] **被调用方**：`SchematicService`、`schematic_viewer_panel.py`

---

> **注意**：知识检索域（RAG）相关内容已移至阶段五，详见 `阶段5：RAG知识检索与代码索引.md`

### 4.10 设计管理域 (`domain/design/`)

> **职责说明**：本节定义设计迭代管理的核心领域模型，包括设计目标、终止判断、迭代撤回等。UI 面板相关内容见 4.10.4 节。

#### 4.10.1 `design_goals.py` - 设计目标实体

- [ ] **职责**：结构化存储和管理从用户需求中提取的电路设计指标
- [ ] **数据结构 `DesignGoal`**：包含指标英文标识符（如 gain、bandwidth）、显示名称（如增益、带宽）、期望值（使用基本单位）、单位（如 dB、Hz、Ω）、约束类型（minimum/maximum/exact/range/minimize/maximize）、权重（0-1，用于综合评分）、容差百分比（可选，默认 5%）、当前实际值（仿真后填充）、是否达标标记。
- [ ] **数据结构 `DesignGoalsCollection`**：包含设计目标列表、电路类型（如 amplifier、filter）、设计需求描述、创建和更新时间、来源标识（llm 或 user）。
- [ ] **支持的指标类别**：
  - **放大器指标**：增益（gain）、带宽（bandwidth）、增益带宽积（gbw）、相位裕度（phase_margin）、增益裕度（gain_margin）、输入阻抗（input_impedance）、输出阻抗（output_impedance）、CMRR、PSRR、压摆率（slew_rate）、整定时间（settling_time）、过冲量（overshoot）、失调电压（offset_voltage）
  - **噪声指标**：输入噪声（input_noise）、积分噪声（integrated_noise）、噪声系数（noise_figure）、信噪比（snr）
  - **失真指标**：总谐波失真（thd）、THD+N、互调失真（imd）、无杂散动态范围（sfdr）、信噪失真比（sndr）、有效位数（enob）
  - **电源指标**：静态电流（quiescent_current）、功耗（power_consumption）、效率（efficiency）、负载调整率（load_regulation）、线性调整率（line_regulation）、压差（dropout_voltage）
  - **时域指标**：上升时间（rise_time）、下降时间（fall_time）、传播延迟（propagation_delay）、占空比（duty_cycle）、振荡频率（frequency）
  - **可靠性指标**：良率目标（yield_target）、温度范围（temperature_range）、电源电压范围（supply_range）
- [ ] **核心功能**：
  - `DesignGoals` 类 - 管理多个设计目标的集合
  - `add_goal(goal)` - 添加设计目标
  - `update_goal(identifier, updates)` - 更新指定目标
  - `remove_goal(identifier)` - 删除指定目标
  - `validate()` - 校验目标完整性（必填字段、值范围、权重之和）
  - `is_satisfied(actual_value, identifier)` - 判断单个指标是否达标
  - `calculate_score(actual_values)` - 计算综合达标评分（加权）
  - `update_current_values(actual_values)` - 更新所有目标的当前值和达标状态
  - `to_dict()` / `from_dict()` - 序列化/反序列化
  - `from_llm_output(llm_json)` - 从 LLM 输出的 JSON 创建实例
- [ ] **LLM 输出映射规则**：
  - LLM 输出的 `name` → `identifier`
  - LLM 输出的 `display_name` → `name`
  - 其他字段直接映射
- [ ] **持久化**：存储到 `.circuit_ai/design_goals.json`
- [ ] **被调用方**：`design_goals_node.py`（创建）、`analysis_node.py`（比对）、`termination_checker.py`（判断）、`DesignGoalsEditDialog`（编辑）

#### 4.10.2 `termination_checker.py` - 停止判断器

- [x] **文件路径**：`domain/design/termination_checker.py`
- [x] **职责**：决定设计迭代循环是否应该终止
- [x] **数据类定义**：
  - `TerminationReason` - 终止原因枚举
    - `CONTINUE` - 继续迭代（未终止）
    - `SUCCESS` - 所有必需指标满足目标
    - `MAX_CHECKPOINTS` - 达到最大检查点次数
    - `STAGNATED` - 连续多次无性能提升
    - `USER_STOPPED` - 用户手动停止
    - `MAX_ITERATIONS` - 达到最大迭代次数
    - `ERROR` - 错误终止
  - `TerminationResult` - 终止判断结果数据类
    - `should_terminate: bool` - 是否应该终止
    - `reason: TerminationReason` - 终止原因
    - `message: str` - 详细消息
    - `details: Optional[Dict]` - 附加详情
- [x] **核心类 `TerminationChecker`**：
  - 构造参数：
    - `max_checkpoints: int = 20` - 最大检查点次数
    - `max_iterations: int = 100` - 最大迭代次数
    - `stagnation_window: int = 3` - 停滞检测窗口大小
    - `stagnation_threshold: float = 0.01` - 停滞检测阈值（1%）
    - `stagnation_metric_key: str = "score"` - 用于停滞检测的指标键名
  - 核心方法：
    - `check_termination(state, goals_manager, checkpointer, thread_id)` - 综合判断，返回 `TerminationResult`
    - `is_goals_satisfied(metrics, goals_manager)` - 检查所有必需指标是否达标
    - `is_max_checkpoints_reached(count, limit)` - 检查是否达到最大检查点次数
    - `is_max_iterations_reached(count, limit)` - 检查是否达到最大迭代次数
    - `is_stagnated(checkpointer, thread_id, metric_key)` - 检查是否连续N次无性能提升
- [x] **终止条件优先级（按顺序检查，任一满足即终止）**：
  1. 用户手动停止（`user_intent == "stop"`）→ `USER_STOPPED`
  2. 所有必需指标满足目标 → `SUCCESS`
  3. 达到最大检查点次数（默认20次）→ `MAX_CHECKPOINTS`
  4. 达到最大迭代次数（默认100次）→ `MAX_ITERATIONS`
  5. 连续N次无性能提升 → `STAGNATED`
- [x] **停滞检测算法**：
  - 复用 `iteration_history_service.check_stagnation()` 实现
  - 通过 Checkpointer 从 SqliteSaver 查询历史
  - 比较最近N次迭代的指标变化率
  - 若变化率小于阈值（默认1%），判定为停滞
- [x] **便捷函数**：
  - `check_termination(state, goals_manager, checkpointer, thread_id, **kwargs)` - 快速检查
  - `should_continue(state, goals_manager, checkpointer, thread_id, **kwargs)` - 返回 bool，用于条件边
- [x] **被调用方**：`edges.py`（条件边 `should_continue`）

#### 4.10.3 `undo_manager.py` - 迭代级别撤回协调器

> **撤销机制区分**：本系统存在两种不同层级的撤销机制，需明确区分：
>
> - **编辑器级别撤销**（Ctrl+Z）：由 `QPlainTextEdit` 内置撤销栈实现，撤销单次编辑操作，仅影响当前编辑器内容
> - **迭代级别撤回**（本模块）：恢复到之前的迭代检查点，会覆盖用户的手动编辑，将所有文件状态回滚到指定迭代时的快照

> **⚠️ 架构说明**：本模块是**协调器**，复用现有 `domain/services/snapshot_service.py` 的快照功能，不重复实现快照创建/恢复逻辑。
> - 快照存储：复用 `snapshot_service`，存储在 `.circuit_ai/snapshots/`
> - 迭代历史：复用 `iteration_history_service`，从 LangGraph Checkpointer 查询
> - 本模块职责：协调任务暂停、快照恢复、GraphState 更新、事件发布

- [ ] **文件路径**：`domain/design/undo_manager.py`
- [ ] **职责**：协调迭代级别撤回操作，确保并发安全和状态一致性
- [ ] **核心功能**：

  - `undo_to_previous()` - 撤回到上一个迭代（线性撤回）
  - `undo_to_iteration(iteration_id)` - 撤回到指定迭代
  - `can_undo()` - 检查是否可以撤回
  - `get_undo_info()` - 获取撤回目标信息（用于 UI 显示）
  - `is_operation_in_progress()` - 检查是否有操作正在进行
- [ ] **撤回流程**：

  1. 获取操作锁（30 秒超时）
  2. 取消所有运行中的异步任务（通过 `AsyncTaskRegistry.cancel_all()`）
  3. 调用 `snapshot_service.restore_snapshot()` 恢复项目文件
  4. 更新 GraphState 的 `iteration_count` 字段
  5. 发布 `EVENT_UNDO_COMPLETED` 事件
  6. 释放操作锁
  - **失败处理**：`snapshot_service` 内部已实现回滚点机制，恢复失败时自动回滚
- [ ] **并发安全机制**：

  - **操作锁**：使用 `threading.RLock` 实现可重入锁，撤回操作互斥
  - **任务取消**：撤回前取消所有异步任务，避免并发写入
  - **锁超时**：30 秒，超时后返回 `UndoResult` 错误
- [ ] **数据类定义**：

  - `UndoResult` - 撤回操作结果
    - `success: bool` - 是否成功
    - `message: str` - 结果消息
    - `restored_iteration: int` - 恢复到的迭代号（成功时）
    - `error_code: Optional[str]` - 错误码（失败时）
  - `UndoInfo` - 撤回目标信息
    - `can_undo: bool` - 是否可以撤回
    - `target_iteration: int` - 目标迭代号
    - `target_timestamp: str` - 目标时间戳
    - `current_iteration: int` - 当前迭代号
- [ ] **事件定义**（在 `event_types.py` 中添加）：

  - `EVENT_UNDO_STARTED` - 撤回开始
  - `EVENT_UNDO_COMPLETED` - 撤回完成
  - `EVENT_UNDO_FAILED` - 撤回失败
- [ ] **策略**：

  - 仅响应用户明确的撤回操作
  - 仿真失败时不自动回滚，保留当前改动继续优化
  - 快照由 `user_checkpoint_node` 在用户确认时创建（复用 `snapshot_service`）
- [ ] **被调用方**：`main_window.py`（撤回按钮/菜单）、`history_dialog.py`（历史对话框）

---

#### 4.10.4 仿真配置对话框 (`presentation/dialogs/simulation_config/`)

> **⚠️ 核心设计原则**：仿真参数由用户通过此对话框手动设置，软件不提供"一键预设"，所有参数对用户透明可见

> **目录结构**：
>
> ```
> presentation/dialogs/simulation_config/
> ├── __init__.py
> ├── simulation_config_dialog.py     # 对话框主类
> ├── simulation_config_view_model.py # ViewModel 层
> ├── ac_config_tab.py                # AC 分析配置标签页
> ├── dc_config_tab.py                # DC 分析配置标签页
> ├── transient_config_tab.py         # 瞬态分析配置标签页
> ├── noise_config_tab.py             # 噪声分析配置标签页
> └── convergence_config_tab.py       # 收敛参数配置标签页
> ```

#### 4.10.4.1 `simulation_config_view_model.py` - ViewModel 层

- [ ] **文件路径**：`presentation/dialogs/simulation_config/simulation_config_view_model.py`
- [ ] **职责**：作为 UI 与 SimulationConfigService 之间的中间层，管理配置编辑状态
- [ ] **继承**：`BaseViewModel`（阶段一 1.7.2 节定义）
- [ ] **核心属性**（Qt Property）：
  - `ac_config: ACAnalysisConfig` - AC 分析配置
  - `dc_config: DCAnalysisConfig` - DC 分析配置
  - `transient_config: TransientConfig` - 瞬态分析配置
  - `noise_config: NoiseConfig` - 噪声分析配置
  - `convergence_config: ConvergenceConfig` - 收敛参数配置
  - `global_config: GlobalSimulationConfig` - 全局配置
  - `validation_errors: list[str]` - 校验错误列表
  - `is_dirty: bool` - 是否有未保存的修改
- [ ] **核心方法**：
  - `load_config()` - 从 SimulationConfigService 加载配置
  - `save_config()` - 保存配置到 SimulationConfigService
  - `validate_all() -> bool` - 校验所有配置
  - `reset_to_default()` - 重置为默认值
  - `update_ac_config(field, value)` - 更新 AC 配置字段
  - `update_dc_config(field, value)` - 更新 DC 配置字段
  - `update_transient_config(field, value)` - 更新瞬态配置字段
  - `update_noise_config(field, value)` - 更新噪声配置字段
  - `update_convergence_config(field, value)` - 更新收敛配置字段
- [ ] **信号**：
  - `config_changed` - 配置变更时发射
  - `validation_failed(errors: list[str])` - 校验失败时发射
  - `save_completed` - 保存完成时发射
- [ ] **被调用方**：`simulation_config_dialog.py`

#### 4.10.4.2 `simulation_config_dialog.py` - 对话框主类

- [ ] **文件路径**：`presentation/dialogs/simulation_config/simulation_config_dialog.py`
- [ ] **职责**：协调各配置标签页，管理对话框整体布局和按钮行为
- [ ] **核心类**：`SimulationConfigDialog(QDialog)`
- [ ] **UI 布局**：
  - 顶部：标题栏
  - 中部：QTabWidget 包含各分析类型的配置标签页
  - 底部：按钮栏（保存、重置、取消）
- [ ] **标签页组织**：
  - "AC 分析" - AC 分析参数配置
  - "DC 分析" - DC 分析参数配置
  - "瞬态分析" - 瞬态分析参数配置
  - "噪声分析" - 噪声分析参数配置
  - "收敛参数" - 全局收敛参数配置
- [ ] **核心方法**：
  - `_setup_ui()` - 初始化 UI 布局
  - `_connect_signals()` - 连接信号槽
  - `_on_save_clicked()` - 保存按钮点击处理
  - `_on_reset_clicked()` - 重置按钮点击处理
  - `_on_validation_failed(errors)` - 校验失败处理，显示错误提示
  - `retranslate_ui()` - 国际化支持
- [ ] **被调用方**：`main_window.py`（菜单项触发）

#### 4.10.4.3 `ac_config_tab.py` - AC 分析配置标签页

- [ ] **文件路径**：`presentation/dialogs/simulation_config/ac_config_tab.py`
- [ ] **职责**：提供 AC 分析参数的编辑界面
- [ ] **核心类**：`ACConfigTab(QWidget)`
- [ ] **UI 组件**：
  - 起始频率输入框（QDoubleSpinBox，支持科学计数法）
  - 终止频率输入框（QDoubleSpinBox，支持科学计数法）
  - 每十倍频程点数输入框（QSpinBox）
  - 扫描类型下拉框（QComboBox：dec/oct/lin）
  - 参数说明标签（解释各参数含义）
- [ ] **被调用方**：`simulation_config_dialog.py`

#### 4.10.4.4 `dc_config_tab.py` - DC 分析配置标签页

- [ ] **文件路径**：`presentation/dialogs/simulation_config/dc_config_tab.py`
- [ ] **职责**：提供 DC 分析参数的编辑界面
- [ ] **核心类**：`DCConfigTab(QWidget)`
- [ ] **UI 组件**：
  - 扫描源名称输入框（QLineEdit）
  - 起始值输入框（QDoubleSpinBox）
  - 终止值输入框（QDoubleSpinBox）
  - 步进值输入框（QDoubleSpinBox）
  - 参数说明标签
- [ ] **被调用方**：`simulation_config_dialog.py`

#### 4.10.4.5 `transient_config_tab.py` - 瞬态分析配置标签页

- [ ] **文件路径**：`presentation/dialogs/simulation_config/transient_config_tab.py`
- [ ] **职责**：提供瞬态分析参数的编辑界面
- [ ] **核心类**：`TransientConfigTab(QWidget)`
- [ ] **UI 组件**：
  - 时间步长输入框（QDoubleSpinBox，支持科学计数法）
  - 终止时间输入框（QDoubleSpinBox，支持科学计数法）
  - 起始时间输入框（QDoubleSpinBox）
  - 最大步长输入框（QDoubleSpinBox，可选）
  - 使用初始条件复选框（QCheckBox）
  - 参数说明标签
- [ ] **被调用方**：`simulation_config_dialog.py`

#### 4.10.4.6 `noise_config_tab.py` - 噪声分析配置标签页

- [ ] **文件路径**：`presentation/dialogs/simulation_config/noise_config_tab.py`
- [ ] **职责**：提供噪声分析参数的编辑界面
- [ ] **核心类**：`NoiseConfigTab(QWidget)`
- [ ] **UI 组件**：
  - 输出节点输入框（QLineEdit）
  - 输入源输入框（QLineEdit）
  - 起始频率输入框（QDoubleSpinBox）
  - 终止频率输入框（QDoubleSpinBox）
  - 参数说明标签
- [ ] **被调用方**：`simulation_config_dialog.py`

#### 4.10.4.7 `convergence_config_tab.py` - 收敛参数配置标签页

- [ ] **文件路径**：`presentation/dialogs/simulation_config/convergence_config_tab.py`
- [ ] **职责**：提供全局收敛参数的编辑界面
- [ ] **核心类**：`ConvergenceConfigTab(QWidget)`
- [ ] **UI 组件**：
  - gmin 输入框（QDoubleSpinBox，科学计数法，默认 1e-12）
  - abstol 输入框（QDoubleSpinBox，科学计数法，默认 1e-12）
  - reltol 输入框（QDoubleSpinBox，默认 1e-3）
  - vntol 输入框（QDoubleSpinBox，科学计数法，默认 1e-6）
  - itl1 输入框（QSpinBox，DC 迭代限制，默认 100）
  - itl4 输入框（QSpinBox，瞬态迭代限制，默认 10）
  - 超时时间输入框（QSpinBox，秒）
  - 仿真温度输入框（QDoubleSpinBox，摄氏度）
  - 参数说明标签（解释各收敛参数的作用）
- [ ] **参数说明文本**：
  - gmin：最小电导，用于避免零电导导致的矩阵奇异
  - abstol：绝对电流容差，电流误差小于此值视为收敛
  - reltol：相对容差，相对误差小于此值视为收敛
  - vntol：电压容差，电压误差小于此值视为收敛
  - itl1：DC 分析最大迭代次数
  - itl4：瞬态分析每个时间点最大迭代次数
- [ ] **被调用方**：`simulation_config_dialog.py`

---

#### 4.10.6 电路图查看器面板 (`presentation/panels/schematic/`)

> **设计目标**：提供交互式电路图查看功能，支持缩放、平移、元件点击高亮，与代码编辑器联动
>
> **目录结构**：
>
> ```
> presentation/panels/
> ├── schematic_viewer_panel.py       # 面板主类
> └── schematic/                      # 电路图面板子模块
>     ├── __init__.py
>     ├── toolbar.py                  # 工具栏组件
>     ├── info_panel.py               # 元件信息面板
>     └── zoom_control.py             # 缩放控制组件
> ```

#### 4.10.6.1 电路图查看器面板模块组

##### 4.10.6.1.1 `presentation/panels/schematic_viewer_panel.py` - 面板主类

- [ ] **文件路径**：`presentation/panels/schematic_viewer_panel.py`
- [ ] **职责**：协调电路图查看器的各子组件，管理面板整体布局
- [ ] **核心类**：`SchematicViewerPanel(QWidget)`
- [ ] **核心功能**：
  - `load_schematic(file_path: str)` - 加载并显示电路图
  - `refresh()` - 刷新当前电路图
  - `clear()` - 清空电路图显示
  - `zoom_in()` / `zoom_out()` / `zoom_to_fit()` - 缩放控制
  - `export_image(path: str, format: str)` - 导出电路图为图片
  - `highlight_element(name: str)` - 高亮指定元件
  - `jump_to_element(name: str)` - 跳转到指定元件并居中显示
- [ ] **布局结构**：
  - 顶部工具栏：缩放按钮、适应窗口、导出、刷新
  - 中央区域：SchematicView（电路图视图）
  - 右侧信息面板（可折叠）：显示选中元件的详细信息
  - 底部状态栏：显示缩放级别、元件数量、当前文件名
- [ ] **与 schematic_service 集成**：
  - 调用 `schematic_service.get_layout()` 获取布局结果
  - 将布局结果传递给 `SchematicScene.load_layout()`
  - 使用 `schematic_worker` 异步执行布局计算
- [ ] **与代码编辑器联动**：
  - 订阅 `InteractionHandler.jump_to_source_requested` 信号
  - 发布 `EVENT_JUMP_TO_LINE` 事件，携带文件路径和行号
  - 代码编辑器订阅事件后跳转到对应行
- [ ] **事件订阅**：
  - `EVENT_FILE_OPENED` - 文件打开时检查是否为 SPICE 文件，自动加载电路图
  - `EVENT_FILE_SAVED` - 文件保存时刷新电路图
  - `EVENT_SIMULATION_COMPLETE` - 仿真完成时可选刷新电路图
- [ ] **国际化支持**：
  - 实现 `retranslate_ui()` 方法
  - 订阅 `EVENT_LANGUAGE_CHANGED` 事件
- [ ] **被调用方**：`main_window.py`

##### 4.10.6.1.2 `presentation/panels/schematic/toolbar.py` - 工具栏组件

- [ ] **文件路径**：`presentation/panels/schematic/toolbar.py`
- [ ] **职责**：提供电路图查看器的工具栏按钮
- [ ] **核心类**：`SchematicToolbar(QToolBar)`
- [ ] **工具栏按钮**（使用 SVG 图标，路径：`resources/icons/schematic/`）：
  - `zoom_in.svg` 放大 - 调用 `zoom_in()`
  - `zoom_out.svg` 缩小 - 调用 `zoom_out()`
  - `fit_to_window.svg` 适应窗口 - 调用 `zoom_to_fit()`
  - `reset_view.svg` 重置视图 - 调用 `reset_view()`
  - `export_image.svg` 导出图片 - 弹出保存对话框
  - `refresh.svg` 刷新 - 重新加载电路图
  - 分隔符
  - `info_panel.svg` 信息面板开关 - 切换右侧信息面板显示
- [ ] **信号定义**：
  - `zoom_in_clicked()`
  - `zoom_out_clicked()`
  - `fit_clicked()`
  - `reset_clicked()`
  - `export_clicked()`
  - `refresh_clicked()`
  - `info_panel_toggled(visible: bool)`
- [ ] **被调用方**：`schematic_viewer_panel.py`

##### 4.10.6.1.3 `presentation/panels/schematic/info_panel.py` - 元件信息面板

- [ ] **文件路径**：`presentation/panels/schematic/info_panel.py`
- [ ] **职责**：显示选中元件的详细信息
- [ ] **核心类**：`ElementInfoPanel(QWidget)`
- [ ] **核心功能**：
  - `show_element_info(element: SchematicElement)` - 显示元件信息
  - `clear()` - 清空信息显示
  - `set_collapsed(collapsed: bool)` - 设置折叠状态
- [ ] **显示内容**：
  - 元件名称（如 R1、C2、Q3）
  - 元件类型（如 电阻、电容、NPN 三极管）
  - 元件值（如 10kΩ、100nF）
  - 模型名称（如 2N2222，仅晶体管等）
  - 连接节点列表
  - 在网表中的位置（行号，可点击跳转）
  - 附加参数（如有）
- [ ] **布局**：
  - 标题：选中元件名称
  - 属性列表：使用 QFormLayout 显示键值对
  - 跳转按钮：点击跳转到代码编辑器对应行
- [ ] **视觉设计**：
  - 面板宽度：200px（可拖拽调整）
  - 背景色：`#f8f9fa`
  - 分隔线：`#e0e0e0`
- [ ] **信号定义**：
  - `jump_to_source_clicked(file_path: str, line: int)` - 跳转到源代码
- [ ] **被调用方**：`schematic_viewer_panel.py`

##### 4.10.6.1.4 `presentation/panels/schematic/zoom_control.py` - 缩放控制组件

- [ ] **文件路径**：`presentation/panels/schematic/zoom_control.py`
- [ ] **职责**：提供缩放级别显示和快速缩放控制
- [ ] **核心类**：`ZoomControl(QWidget)`
- [ ] **核心功能**：
  - `set_zoom_level(level: float)` - 设置当前缩放级别
  - `get_zoom_level() -> float` - 获取当前缩放级别
- [ ] **UI 组件**：
  - 缩放滑块：范围 10%-1000%
  - 缩放百分比显示：如 "100%"
  - 预设缩放按钮：50%、100%、200%
- [ ] **信号定义**：
  - `zoom_level_changed(level: float)` - 缩放级别变化
- [ ] **被调用方**：`schematic_viewer_panel.py`

#### 4.10.7 库管理面板 (`presentation/panels/library/`)

> **设计目标**：提供 SPICE 元件库的浏览、搜索、导入和管理功能
> **目录结构**：
>
> ```
> presentation/panels/library/
> ├── __init__.py
> ├── library_panel.py              # 库管理面板主类
> ├── library_view_model.py         # ViewModel 层
> ├── library_browser.py            # 库浏览器组件
> ├── component_search.py           # 元件搜索组件
> ├── component_detail.py           # 元件详情组件
> └── library_import_dialog.py      # 库导入对话框
> ```

#### 4.10.7.1 `library_panel.py` - 库管理面板主类

- [ ] **文件路径**：`presentation/panels/library/library_panel.py`
- [ ] **职责**：协调库管理面板的各子组件，管理面板整体布局
- [ ] **核心类**：`LibraryPanel(QWidget)`
- [ ] **UI 布局**：
  - 顶部：搜索栏（关键词输入 + 类别筛选下拉框）
  - 左侧：库浏览树（按类别/厂商组织）
  - 右侧：元件详情面板（选中元件的详细信息）
  - 底部：操作按钮栏（导入库、导出库、添加收藏）
- [ ] **核心功能**：
  - `refresh_libraries()` - 刷新库列表
  - `search_components(keyword, category)` - 搜索元件
  - `show_component_detail(component_name)` - 显示元件详情
  - `import_library()` - 打开库导入对话框
  - `export_library(library_name)` - 导出库文件
- [ ] **国际化支持**：
  - 实现 `retranslate_ui()` 方法
  - 订阅 `EVENT_LANGUAGE_CHANGED` 事件
- [ ] **被调用方**：`main_window.py`

#### 4.10.7.2 `library_view_model.py` - ViewModel 层

- [ ] **文件路径**：`presentation/panels/library/library_view_model.py`
- [ ] **职责**：作为 UI 与 LibraryManager 之间的中间层
- [ ] **继承**：`BaseViewModel`（阶段一 1.7.2 节定义）
- [ ] **核心功能**：
  - `get_library_tree() -> Dict` - 获取库树结构
  - `search(keyword, category) -> List[ComponentInfo]` - 搜索元件
  - `get_component_info(name) -> ComponentInfo` - 获取元件详情
  - `import_library(path, name)` - 导入库
  - `add_to_favorites(name)` - 添加到收藏
  - `get_favorites() -> List[str]` - 获取收藏列表
- [ ] **依赖**：`LibraryManager`
- [ ] **被调用方**：`library_panel.py`

#### 4.10.7.3 `library_browser.py` - 库浏览器组件

- [ ] **文件路径**：`presentation/panels/library/library_browser.py`
- [ ] **职责**：以树形结构展示库和元件
- [ ] **核心类**：`LibraryBrowser(QTreeWidget)`
- [ ] **树结构**：
  - 一级节点：库类别（运放、比较器、晶体管、MOSFET、稳压器等）
  - 二级节点：厂商（TI、ADI、ON Semi 等）
  - 三级节点：具体元件（LM741、LT1001 等）
- [ ] **核心功能**：
  - `load_tree(tree_data)` - 加载树结构数据
  - `filter_by_category(category)` - 按类别筛选
  - `expand_to_component(component_name)` - 展开到指定元件
- [ ] **信号定义**：
  - `component_selected(component_name: str)` - 元件被选中
  - `component_double_clicked(component_name: str)` - 元件被双击（插入到编辑器）
- [ ] **被调用方**：`library_panel.py`

#### 4.10.7.4 `component_search.py` - 元件搜索组件

- [ ] **文件路径**：`presentation/panels/library/component_search.py`
- [ ] **职责**：提供元件搜索功能
- [ ] **核心类**：`ComponentSearch(QWidget)`
- [ ] **UI 组件**：
  - 搜索输入框：支持实时搜索（防抖 300ms）
  - 类别筛选下拉框：全部/运放/比较器/晶体管等
  - 厂商筛选下拉框：全部/TI/ADI/ON Semi 等
  - 搜索结果列表：显示匹配的元件
- [ ] **核心功能**：
  - `set_search_text(text)` - 设置搜索文本
  - `set_category_filter(category)` - 设置类别筛选
  - `set_vendor_filter(vendor)` - 设置厂商筛选
  - `get_search_results() -> List[str]` - 获取搜索结果
- [ ] **信号定义**：
  - `search_changed(keyword: str, category: str, vendor: str)` - 搜索条件变化
  - `result_selected(component_name: str)` - 搜索结果被选中
- [ ] **被调用方**：`library_panel.py`

#### 4.10.7.5 `component_detail.py` - 元件详情组件

- [ ] **文件路径**：`presentation/panels/library/component_detail.py`
- [ ] **职责**：显示选中元件的详细信息
- [ ] **核心类**：`ComponentDetail(QWidget)`
- [ ] **UI 布局**：
  - 元件名称（大字体）
  - 类别和厂商标签
  - 描述文本
  - 关键参数表格（参数名、典型值、单位）
  - 数据手册链接（可点击打开）
  - 使用示例代码（可复制）
  - `[添加到收藏]` / `[从收藏移除]` 按钮
  - `[插入到编辑器]` 按钮
- [ ] **核心功能**：
  - `show_component(info: ComponentInfo)` - 显示元件信息
  - `clear()` - 清空显示
  - `copy_example_code()` - 复制示例代码
  - `open_datasheet()` - 打开数据手册
- [ ] **信号定义**：
  - `insert_requested(component_name: str)` - 请求插入到编辑器
  - `favorite_toggled(component_name: str, is_favorite: bool)` - 收藏状态切换
- [ ] **被调用方**：`library_panel.py`

#### 4.10.7.6 `library_import_dialog.py` - 库导入对话框

- [ ] **文件路径**：`presentation/panels/library/library_import_dialog.py`
- [ ] **职责**：提供库文件导入功能
- [ ] **核心类**：`LibraryImportDialog(QDialog)`
- [ ] **UI 布局**：
  - 文件选择区：`[浏览...]` 按钮 + 文件路径显示
  - 库名称输入框
  - 库类别选择下拉框
  - 文件预览区（显示库文件前 50 行）
  - 校验结果显示（格式是否正确、元件数量）
  - `[导入]` / `[取消]` 按钮
- [ ] **核心功能**：
  - `select_file()` - 打开文件选择对话框
  - `validate_library()` - 校验库文件格式
  - `import_library()` - 执行导入
- [ ] **支持的文件格式**：`.lib`、`.mod`、`.sub`
- [ ] **被调用方**：`library_panel.py`

---

### 4.11 下栏面板 (`presentation/panels/`)

> **⚠️ UI架构对齐**：本节设计遵循阶段一 1.7 节定义的 UI 层架构规范：
>
> - 各 ViewModel 继承自 `BaseViewModel`，遵循统一的 ViewModel 模式
> - 面板通过 `PanelManager` 注册到 BOTTOM 区域
> - 事件通过 `UIEventBridge` 桥接到 UI 层，确保主线程执行
> - 与对话面板的通信通过 EventBus，禁止直接调用

> **下栏标签页设计**：下栏面板使用 `QTabWidget` 管理多个功能标签页：
>
> - **仿真结果标签页**：显示仿真指标、图表、调参面板
> - **报告生成标签页**：信息收集、提示输入、报告生成控制
>
> 两个标签页功能独立，互不干扰，用户可随时切换。

> **单一职责拆分**：为避免单个文件职责过重，将下栏面板拆分为多个协作组件：
>
> - `bottom_panel.py` - 下栏面板主类，管理标签页切换
> - `simulation/` - 仿真结果标签页子模块
> - `report/` - 报告生成标签页子模块
>
> **目录结构**：
>
> ```
> presentation/panels/
> ├── bottom_panel.py                 # 下栏面板主类（QTabWidget）
> ├── simulation/                     # 仿真结果标签页子模块
> │   ├── __init__.py
> │   ├── simulation_tab.py           # 仿真结果标签页主类
> │   ├── simulation_view_model.py    # ViewModel 层
> │   ├── metrics_panel.py            # 指标显示面板
> │   ├── metric_card.py              # 单个指标卡片组件
> │   ├── chart_viewer.py             # 图表查看器（Plotly 集成）
> │   ├── waveform_widget.py          # 波形图表组件
> │   ├── measurement_tool.py         # 双光标测量工具
> │   ├── waveform_math_dialog.py     # 波形数学运算对话框
> │   ├── raw_data_table.py           # 原始数据表格（虚拟滚动）
> │   ├── output_log_viewer.py        # 仿真输出日志查看器
> │   ├── tuning_panel.py             # 快速调参面板
> │   ├── status_indicator.py         # 状态指示器组件
> │   ├── analysis_selector_panel.py  # 分析类型选择面板（详见 4.11.1.15 节）
> │   ├── chart_selector_panel.py     # 图表类型选择面板（详见 4.11.1.16 节）
> │   └── analysis_tabs/              # 高级分析结果标签页
> │       ├── __init__.py
> │       ├── pvt_result_tab.py       # PVT 角点结果
> │       ├── monte_carlo_tab.py      # 蒙特卡洛结果
> │       ├── sweep_result_tab.py     # 参数扫描结果
> │       └── sensitivity_tab.py      # 敏感度分析结果
> ├── schematic/                      # 电路图查看器面板
> │   ├── __init__.py
> │   ├── schematic_panel.py          # 电路图面板主组件
> │   ├── schematic_view.py           # SVG 渲染视图（QSvgWidget 封装）
> │   └── schematic_toolbar.py        # 电路图工具栏（缩放、导出）
> └── report/                         # 报告生成标签页子模块
>     ├── __init__.py
>     ├── report_tab.py               # 报告标签页主类
>     ├── report_view_model.py        # ViewModel 层
>     ├── info_collector_widget.py    # 信息收集区组件
>     ├── prompt_input_widget.py      # 提示输入区组件
>     ├── current_info_dialog.py      # 选择当前信息对话框
>     └── report_progress_widget.py   # 生成进度显示组件
> ```
>
> 此设计与阶段二的 `code_editor_panel` 模块组和阶段三的 `conversation_panel` 模块组保持一致的颗粒度，便于测试和维护。
>
> **⚠️ 职责分离说明**：
>
> - **领域层（domain/simulation/data/）**：数据处理服务（降采样、导出、日志解析）
> - **表示层（presentation/panels/simulation/）**：UI 组件（图表渲染、用户交互、测量工具）
> - 表示层组件调用领域层服务获取数据，不直接处理原始大数据

#### 4.11.0 下栏面板主类 (`bottom_panel.py`)

- [x] **文件路径**：`presentation/panels/bottom_panel.py`
- [x] **职责**：管理下栏的标签页切换，协调仿真结果和报告生成两个功能模块
- [x] **核心类**：`BottomPanel(QWidget)`
- [x] **UI 结构**：
  - 使用 `QTabWidget` 管理标签页
  - 标签页1：仿真结果（`SimulationTab`）
  - 标签页2：报告生成（`ReportTab`）
- [x] **核心功能**：
  - `switch_to_simulation()` - 切换到仿真结果标签页
  - `switch_to_report()` - 切换到报告生成标签页
  - `get_current_tab()` - 获取当前标签页类型
- [x] **事件订阅**：
  - 订阅 `EVENT_SIMULATION_COMPLETE` 自动切换到仿真结果标签页
  - 订阅 `EVENT_REPORT_GENERATION_STARTED` 自动切换到报告标签页
- [x] **国际化支持**：
  - 实现 `retranslate_ui()` 方法
  - 标签页标题支持中英文切换（"仿真结果"/"Simulation Results"、"报告生成"/"Report"）
- [x] **被调用方**：`main_window.py`

#### 4.11.1 仿真结果标签页模块组

##### 4.11.1.0 `presentation/panels/simulation/simulation_view_model.py` - ViewModel 层

- [x] **文件路径**：`presentation/panels/simulation/simulation_view_model.py`
- [x] **职责**：作为 UI 与仿真服务之间的中间层，隔离 simulation_tab 与 SimulationService 的直接依赖
- [x] **继承**：`BaseViewModel`（阶段一 1.7.2 节定义）
- [x] **核心属性**（供 UI 绑定）：
  - `current_result` - 当前仿真结果（`SimulationResult` 类型）
  - `metrics_list` - 格式化后的指标列表（`DisplayMetric` 类型）
  - `chart_paths` - 图表文件路径列表
  - `overall_score` - 综合评分（0-100）
  - `simulation_status` - 仿真状态（idle/running/complete/error/cancelled）
  - `progress` - 仿真进度（0-100）
  - `error_message` - 错误信息（若有）
  - `tuning_parameters` - 可调参数列表
- [x] **核心方法**：
  - `load_result(result)` - 加载仿真结果并转换为显示格式
  - `format_metric(metric)` - 将原始指标转换为 `DisplayMetric`
  - `request_simulation()` - 请求执行仿真
  - `request_batch_simulation()` - 请求执行批量仿真（执行用户选中的所有分析类型）
  - `cancel_simulation()` - 取消仿真
  - `export_result(format, path)` - 导出仿真结果（支持 csv/json/mat 格式）
  - `update_tuning_parameter(name, value)` - 更新调参参数
  - `apply_tuning()` - 应用调参并重新仿真
  - `reset_tuning()` - 重置调参参数为原始值
  - `get_metrics_by_category(category)` - 按类别获取指标列表
  - `get_metric_by_name(name)` - 按名称获取指标
  - `clear()` - 清空所有数据
- [x] **事件订阅**：
  - 订阅 `EVENT_SIM_STARTED` 更新状态为 running
  - 订阅 `EVENT_SIM_PROGRESS` 更新进度
  - 订阅 `EVENT_SIM_COMPLETE` 加载结果
  - 订阅 `EVENT_SIM_ERROR` 显示错误
  - 订阅 `EVENT_SIM_CANCELLED` 重置状态
  - 订阅 `EVENT_ALL_ANALYSES_COMPLETE` 处理批量分析完成
- [x] **SimulationStatus 枚举**：
  - `IDLE` - 空闲状态
  - `RUNNING` - 仿真运行中
  - `COMPLETE` - 仿真完成
  - `ERROR` - 仿真出错
  - `CANCELLED` - 仿真已取消
- [x] **DisplayMetric 数据结构**（UI 友好格式）：
  - `name` - 指标标识名（英文）
  - `display_name` - 指标显示名（已国际化）
  - `value` - 格式化后的数值字符串
  - `unit` - 单位
  - `target` - 目标值描述
  - `is_met` - 是否达标
  - `trend` - 趋势（up/down/stable/unknown）
  - `category` - 指标类别（gain/bandwidth/noise 等）
  - `raw_value` - 原始数值（用于排序和计算）
  - `confidence` - 置信度（0-1）
  - `error_message` - 错误信息（若计算失败）
- [x] **TuningParameter 数据结构**（可调参数）：
  - `name` - 参数名称
  - `current_value` - 当前值
  - `min_value` / `max_value` - 范围
  - `step` - 步进值
  - `unit` - 单位
  - `source_file` / `source_line` - 来源位置
- [x] **被调用方**：`simulation_tab.py`

> **实现说明**：已完成 SimulationViewModel 的完整实现，包含状态管理、事件订阅、指标格式化、数据导出等功能。测试文件 `tests/test_simulation_view_model.py` 包含 30 个测试用例，全部通过。

##### 4.11.1.1 `presentation/panels/simulation/metric_card.py` - 指标卡片组件

- [ ] **文件路径**：`presentation/panels/simulation/metric_card.py`
- [ ] **职责**：专注于单个性能指标的卡片式渲染
- [ ] **核心类**：`MetricCard(QFrame)`
- [ ] **核心功能**：
  - `set_metric(name, value, unit, target, is_met)` - 设置指标数据
  - `set_highlight(enabled)` - 设置高亮状态
  - `update_status(is_met)` - 更新达标状态
- [ ] **视觉设计**：
  - 卡片背景：略深于面板背景 `#f0f4f8`
  - 圆角边框：`border-radius: 8px`
  - 指标名称：小字灰色 `#666666`
  - 指标值：大字主色 `#333333`
  - 目标值：小字显示目标范围 `#888888`
  - 达标图标：右上角，绿色勾选 `#4caf50` / 红色叉号 `#f44336`
- [ ] **被调用方**：`metrics_panel.py`

##### 4.11.1.2 `presentation/panels/simulation/metrics_panel.py` - 指标显示面板

- [ ] **文件路径**：`presentation/panels/simulation/metrics_panel.py`
- [ ] **职责**：专注于指标网格布局和综合评分显示
- [ ] **核心类**：`MetricsPanel(QWidget)`
- [ ] **核心功能**：
  - `update_metrics(metrics_list)` - 更新所有指标卡片
  - `set_overall_score(score)` - 设置综合评分
  - `clear()` - 清空所有指标
- [ ] **布局**：
  - 指标网格：2-3 列卡片布局，自适应宽度
  - 综合评分：进度条 + 百分比
- [ ] **被调用方**：`simulation_tab.py`

##### 4.11.1.3 `presentation/panels/simulation/chart_viewer.py` - 图表查看器

- [ ] **文件路径**：`presentation/panels/simulation/chart_viewer.py`
- [ ] **职责**：专注于仿真图表的显示和交互，支持双光标测量和波形运算
- [ ] **核心类**：`ChartViewer(QWidget)`
- [ ] **核心功能**：
  - `load_chart(chart_path)` - 加载图表图片
  - `set_chart_tabs(chart_types)` - 设置图表类型标签
  - `zoom_in()` / `zoom_out()` / `reset_zoom()` - 缩放控制
  - `export_chart(path)` - 导出图表
  - `export_data(format)` - 导出波形数据
- [ ] **UI组件**：
  - 图表标签栏：类似浏览器标签，显示图表类型（Bode/瞬态/噪声/频谱等）
  - 图表显示区：深色背景，图表居中显示
  - 图表工具栏：缩放、平移、重置、导出、测量、运算按钮
  - 测量信息栏：显示光标位置和测量结果
- [ ] **图表交互**：
  - 鼠标滚轮缩放
  - 拖拽平移
  - 双击重置视图
  - 右键菜单：保存图片、复制到剪贴板、导出数据
- [ ] **双光标测量功能**（借鉴 LTspice）：
  - 点击"测量"按钮进入测量模式
  - 左键点击放置第一个光标，再次点击放置第二个光标
  - 光标可拖拽调整位置
  - 自动吸附到最近的数据点
  - 测量信息栏显示：光标1坐标、光标2坐标、Δx、Δy、斜率、频率
  - 按 ESC 退出测量模式
- [ ] **波形数学运算功能**（借鉴 LTspice）：
  - 点击"运算"按钮打开运算对话框
  - 支持选择两个波形进行加减乘除运算
  - 支持单波形的微分、积分、绝对值运算
  - 支持自定义表达式输入
  - 运算结果作为新波形显示在图表中
  - 运算波形可导出
- [ ] **数据导出功能**（借鉴 LTspice）：
  - 支持导出为 CSV 格式
  - 支持导出为 MATLAB .mat 格式
  - 支持选择导出的信号子集
  - 支持设置导出的时间/频率范围
- [ ] **被调用方**：`simulation_tab.py`

##### 4.11.1.4 `presentation/panels/simulation/tuning_panel.py` - 快速调参面板

> **设计参考**：借鉴 LTspice 的实时参数调整（Tuning）功能

- [ ] **文件路径**：`presentation/panels/simulation/tuning_panel.py`
- [ ] **职责**：提供可视化的参数调整界面，支持滑块调参和实时仿真更新
- [ ] **核心类**：`TuningPanel(QWidget)`
- [ ] **核心功能**：
  - `load_parameters(param_list)` - 加载可调参数列表
  - `add_parameter_slider(param_name, min_val, max_val, current_val)` - 添加参数滑块
  - `on_parameter_changed(param_name, new_value)` - 参数变化回调
  - `apply_changes()` - 应用参数修改到电路文件
  - `reset_to_original()` - 重置为原始值
- [ ] **UI 组件**：
  - 参数列表区：显示所有可调参数，每个参数一行
  - 参数滑块：水平滑块 + 数值输入框 + 单位标签
  - 范围设置：可调整滑块的最小/最大范围
  - 步进设置：可设置调整步进值
  - 操作按钮：应用、重置、自动仿真开关
- [ ] **参数提取规则**：
  - 从 `.param` 语句中提取参数名和当前值
  - 从电阻、电容、电感元件中提取数值
  - 自动识别参数单位和合理范围
  - 支持用户自定义参数范围
- [ ] **实时仿真模式**：
  - 开启"自动仿真"开关后，参数变化自动触发仿真
  - 使用防抖动机制，参数停止变化 500ms 后触发仿真
  - 仿真完成后自动更新图表显示
  - 显示仿真进度指示器
- [ ] **参数变化记录**：
  - 记录每次参数调整的历史
  - 支持撤销/重做参数调整
  - 显示参数变化对性能指标的影响
- [ ] **与 LLM 优化的协同**：
  - 用户手动调参后，可选择"让 AI 继续优化"
  - 将用户调整作为新的起点，LLM 在此基础上继续优化
  - 记录用户调参意图，帮助 LLM 理解优化方向
- [ ] **被调用方**：`simulation_tab.py`

##### 4.11.1.5 `presentation/panels/simulation/status_indicator.py` - 状态指示器组件

- [ ] **文件路径**：`presentation/panels/simulation/status_indicator.py`
- [ ] **职责**：专注于工作流状态的可视化提示
- [ ] **核心类**：`StatusIndicator(QWidget)`
- [ ] **核心功能**：
  - `show_awaiting_confirmation(message)` - 显示等待确认状态
  - `show_running(message)` - 显示运行中状态
  - `hide()` - 隐藏状态指示器
- [ ] **状态类型**：
  - 等待确认：提示文本 + 图标，如"迭代完成，请在对话面板中选择下一步操作"
  - 运行中：进度指示器 + 提示文本，如"优化进行中，请等待本轮完成..."
- [ ] **视觉设计**：
  - 提示区背景：略深于面板背景，顶部有分隔线
  - 提示文本：居中显示，图标 + 文字
- [ ] **被调用方**：`simulation_tab.py`

##### 4.11.1.6 `presentation/panels/simulation/simulation_tab.py` - 仿真结果标签页主类

- [ ] **文件路径**：`presentation/panels/simulation/simulation_tab.py`
- [ ] **职责**：协调各子组件，管理仿真结果标签页整体布局
- [ ] **核心类**：`SimulationTab(QWidget)`
- [ ] **视觉设计**（与其他面板统一风格）：
  - 面板背景：`#f8f9fa`（浅灰白）
  - 左右分栏使用细分隔线 `#e0e0e0`
  - 指标卡片式布局：每个指标独立卡片，圆角边框
  - 达标状态：绿色勾选图标（`#4caf50`）/ 红色叉号图标（`#f44336`）
  - 图表区域：背景 `#ffffff`，图表自适应缩放
- [ ] **指标卡片样式**：
  - 卡片背景略深于面板背景
  - 指标名称：小字灰色
  - 指标值：大字主色
  - 目标值：小字显示目标范围
  - 达标图标：右上角
- [ ] **国际化支持**：
  - 实现 `retranslate_ui()` 方法，刷新指标标签、按钮文本、图表切换标签等
  - 订阅 `EVENT_LANGUAGE_CHANGED` 事件
  - 指标名称和单位通过 `i18n_manager` 获取（如"增益"/"Gain"、"带宽"/"Bandwidth"）
- [ ] **项目切换响应**：
  - 订阅 `EVENT_STATE_PROJECT_OPENED` 事件：从新项目的 GraphState 加载仿真结果并刷新显示
  - 订阅 `EVENT_STATE_PROJECT_CLOSED` 事件：清空指标显示、图表区域、重置状态
  - 切换项目时不保留旧项目的仿真数据，确保状态隔离
- [ ] **布局结构**：面板分为左右两栏。左栏（40%宽度）显示指标卡片网格（如增益、带宽等，带达标状态图标）、综合评分进度条和查看历史按钮。右栏（60%宽度）显示图表标签栏（Bode图/瞬态图等）、图表显示区域和图表工具栏（缩放、导出等）。
- [ ] **左栏（指标与控制）**：
  - 指标网格：2-3列卡片布局，自适应宽度
  - 综合评分：进度条 + 百分比
  - `[查看历史]` 按钮 → 弹出历史记录对话框（查看优化历史，支持恢复到指定检查点）
- [ ] **高级仿真结果显示**：
  - **PVT 角点结果标签页**：显示各角点的指标对比，高亮最差角点，显示通过/失败状态
  - **蒙特卡洛结果标签页**：显示统计摘要（均值、标准差、3σ范围）、良率百分比、直方图缩略图
  - **参数扫描结果标签页**：显示扫描曲线缩略图、最优参数点标识
  - **最坏情况分析标签页**：显示最坏情况值、设计裕度、关键参数列表
  - **敏感度分析标签页**：显示龙卷风图缩略图、敏感度排名、优化建议
  - **频谱分析标签页**（借鉴 LTspice FFT 功能）：显示 FFT 频谱图、谐波分量柱状图、THD 数值
  - 标签页切换时更新右栏图表显示
  - 支持展开查看详细结果
- [ ] **迭代状态提示区**（等待用户确认时显示）：
  - 提示区背景：略深于面板背景，顶部有分隔线
  - 提示文本：居中显示，图标 + 文字，如"迭代完成，请在对话面板中选择下一步操作"
  - 订阅 `ITERATION_AWAITING_CONFIRMATION` 事件，显示提示区
  - 用户操作后隐藏提示区
  - **说明**：建议选项按钮在对话面板中以消息形式显示，此处仅显示状态提示
- [ ] **运行中状态提示**（工作流运行中显示）：
  - 进度指示器：旋转动画或进度条
  - 提示文本："优化进行中，请等待本轮完成..."
  - 所有操作按钮灰显
- [ ] **右栏（分析图像）**：
  - 图表标签栏：类似浏览器标签，显示图表类型（Bode/瞬态/噪声等）
  - 图表显示区：深色背景，图表居中显示
  - 图表工具栏：缩放、平移、重置、导出按钮
  - 无图表时显示占位提示
  - 加载 `{work_folder}/simulation_results/session_{timestamp}/charts/` 中的图表
  - 每次检查点后自动刷新显示最新仿真结果
- [ ] **图表交互**：
  - 鼠标滚轮缩放
  - 拖拽平移
  - 双击重置视图
  - 右键菜单：保存图片、复制到剪贴板
- [ ] **核心功能**：
  - `update_metrics(metrics)` - 更新指标显示
  - `load_chart(chart_path)` - 加载图表图片
  - `refresh()` - 刷新显示
  - `show_history_dialog()` - 显示历史记录对话框
- [ ] **选择性展示**：
  - 仅加载用户在工具栏勾选的图表类型
  - 基于 `GraphState.requested_charts`
- [ ] **联动**：
  - `simulation_node` 完成时自动刷新指标
  - `chart_generator` 完成时自动加载图表
  - 检查点到达时显示状态提示
- [ ] **被调用方**：`main_window.py`、`design_workflow.py`

##### 4.11.1.7 高级分析结果标签页组件

> **设计原则**：为每种高级分析提供专用的结果展示组件，统一风格，支持详细查看和图表交互

###### `pvt_result_tab.py` - PVT 角点结果标签页

- [ ] **文件路径**：`presentation/panels/simulation/pvt_result_tab.py`
- [ ] **职责**：展示 PVT 角点仿真结果，支持角点对比和最差角点高亮
- [ ] **核心类**：`PVTResultTab(QWidget)`
- [ ] **UI 布局**：
  - 顶部：角点选择器（下拉框或标签栏，TT/FF/SS/FS/SF）
  - 左侧：指标对比表格（各角点的指标值，最差角点红色高亮）
  - 右侧：角点对比图表（柱状图或雷达图）
  - 底部：通过/失败状态汇总
- [ ] **核心功能**：
  - `update_results(pvt_result: PVTAnalysisResult)` - 更新显示数据
  - `highlight_worst_corner(metric)` - 高亮指定指标的最差角点
  - `export_comparison()` - 导出角点对比数据
- [ ] **事件订阅**：`EVENT_PVT_COMPLETE` - 分析完成时自动更新
- [ ] **被调用方**：`simulation_tab.py`

###### `monte_carlo_result_tab.py` - 蒙特卡洛结果标签页

- [ ] **文件路径**：`presentation/panels/simulation/monte_carlo_result_tab.py`
- [ ] **职责**：展示蒙特卡洛统计分析结果，支持直方图和良率显示
- [ ] **核心类**：`MonteCarloResultTab(QWidget)`
- [ ] **UI 布局**：
  - 顶部：指标选择器（选择要查看的指标）
  - 左侧：统计摘要卡片（均值、标准差、最小值、最大值、3σ 范围）
  - 中间：直方图显示区（带规格限标注）
  - 右侧：良率显示（大字体百分比 + 进度环）
  - 底部：敏感参数排名列表
- [ ] **核心功能**：
  - `update_results(mc_result: MonteCarloResult)` - 更新显示数据
  - `switch_metric(metric_name)` - 切换显示的指标
  - `show_distribution_details()` - 显示详细分布信息
  - `export_statistics()` - 导出统计数据
- [ ] **事件订阅**：`EVENT_MC_COMPLETE` - 分析完成时自动更新
- [ ] **被调用方**：`simulation_tab.py`

###### `sweep_result_tab.py` - 参数扫描结果标签页

- [ ] **文件路径**：`presentation/panels/simulation/sweep_result_tab.py`
- [ ] **职责**：展示参数扫描结果，支持曲线图和等高线图显示
- [ ] **核心类**：`SweepResultTab(QWidget)`
- [ ] **UI 布局**：
  - 顶部：参数和指标选择器
  - 主区域：图表显示（单参数扫描显示曲线，双参数扫描显示等高线/热力图）
  - 侧边：最优点信息卡片（最优参数值、对应指标值）
  - 底部：可行区域标注说明
- [ ] **核心功能**：
  - `update_results(sweep_result: SweepResult)` - 更新显示数据
  - `switch_view_mode(mode)` - 切换视图模式（曲线/等高线/热力图）
  - `highlight_optimal_point()` - 高亮最优参数点
  - `export_sweep_data()` - 导出扫描数据
- [ ] **事件订阅**：`EVENT_SWEEP_COMPLETE` - 分析完成时自动更新
- [ ] **被调用方**：`simulation_tab.py`

###### `worst_case_result_tab.py` - 最坏情况结果标签页

- [ ] **文件路径**：`presentation/panels/simulation/worst_case_result_tab.py`
- [ ] **职责**：展示最坏情况分析结果，显示设计裕度和关键参数
- [ ] **核心类**：`WorstCaseResultTab(QWidget)`
- [ ] **UI 布局**：
  - 顶部：分析方法标签（RSS/EVA）
  - 左侧：结果摘要卡片（标称值、最坏情况值、设计裕度百分比）
  - 中间：裕度可视化（进度条或仪表盘，绿色/黄色/红色区域）
  - 右侧：关键参数列表（按影响程度排序）
  - 底部：与蒙特卡洛对比建议
- [ ] **核心功能**：
  - `update_results(wc_result: WorstCaseResult)` - 更新显示数据
  - `show_parameter_impact(param_name)` - 显示单个参数的影响详情
  - `export_worst_case_report()` - 导出最坏情况报告
- [ ] **事件订阅**：`EVENT_WC_COMPLETE` - 分析完成时自动更新
- [ ] **被调用方**：`simulation_tab.py`

###### `sensitivity_result_tab.py` - 敏感度分析结果标签页

- [ ] **文件路径**：`presentation/panels/simulation/sensitivity_result_tab.py`
- [ ] **职责**：展示敏感度分析结果，显示龙卷风图和优化建议
- [ ] **核心类**：`SensitivityResultTab(QWidget)`
- [ ] **UI 布局**：
  - 顶部：指标选择器
  - 主区域：龙卷风图（参数按敏感度排序，正负影响分左右显示）
  - 侧边：敏感度排名列表（可点击查看详情）
  - 底部：优化建议面板（基于敏感度生成的调参建议）
- [ ] **核心功能**：
  - `update_results(sens_result: SensitivityResult)` - 更新显示数据
  - `switch_metric(metric_name)` - 切换显示的指标
  - `show_optimization_suggestions()` - 显示优化建议
  - `apply_suggestion(suggestion)` - 应用优化建议（跳转到参数编辑）
  - `export_sensitivity_data()` - 导出敏感度数据
- [ ] **事件订阅**：`EVENT_SENS_COMPLETE` - 分析完成时自动更新
- [ ] **被调用方**：`simulation_tab.py`

###### `fft_result_tab.py` - FFT 频谱分析结果标签页

- [ ] **文件路径**：`presentation/panels/simulation/fft_result_tab.py`
- [ ] **职责**：展示 FFT 频谱分析结果，显示频谱图和谐波分析
- [ ] **核心类**：`FFTResultTab(QWidget)`
- [ ] **UI 布局**：
  - 顶部：信号选择器和窗函数选择
  - 主区域：FFT 频谱图（对数坐标，可缩放）
  - 侧边：谐波分量柱状图（基波、2次、3次...）
  - 底部：失真指标卡片（THD、SFDR、SNDR、ENOB）
- [ ] **核心功能**：
  - `update_results(fft_result: FFTResult)` - 更新显示数据
  - `switch_signal(signal_name)` - 切换分析的信号
  - `change_window_function(window)` - 更改窗函数并重新计算
  - `export_spectrum_data()` - 导出频谱数据
- [ ] **事件订阅**：`EVENT_FFT_COMPLETE` - 分析完成时自动更新
- [ ] **被调用方**：`simulation_tab.py`

###### `topology_info_panel.py` - 拓扑识别信息面板

- [ ] **文件路径**：`presentation/panels/simulation/topology_info_panel.py`
- [ ] **职责**：展示电路拓扑识别结果，提供推荐配置应用功能
- [ ] **核心类**：`TopologyInfoPanel(QWidget)`
- [ ] **UI 布局**：
  - 顶部：拓扑类型标签（大字体显示，如"运算放大器"）
  - 中间：识别详情（置信度、识别依据、关键节点列表）
  - 下方：推荐分析列表（AC/瞬态/噪声等，带复选框）
  - 底部：`[应用推荐配置]` 按钮
- [ ] **核心功能**：
  - `update_topology(topology_result: TopologyResult)` - 更新显示数据
  - `apply_recommended_config()` - 应用推荐的仿真配置
  - `show_topology_details()` - 显示详细的拓扑分析信息
- [ ] **事件订阅**：`EVENT_TOPOLOGY_DETECTED` - 拓扑识别完成时自动更新
- [ ] **被调用方**：`simulation_tab.py`

###### `diagnosis_panel.py` - 收敛诊断面板

- [ ] **文件路径**：`presentation/panels/simulation/diagnosis_panel.py`
- [ ] **职责**：展示仿真收敛问题诊断结果，提供自动修复功能
- [ ] **核心类**：`DiagnosisPanel(QWidget)`
- [ ] **UI 布局**：
  - 顶部：问题类型标签（如"DC 工作点不收敛"，带严重程度图标）
  - 中间：问题详情（受影响节点、可能原因）
  - 下方：建议修复方案列表（带说明和预期效果）
  - 底部：`[应用自动修复]` 按钮（若可自动修复）、`[手动修复指南]` 按钮
- [ ] **核心功能**：
  - `update_diagnosis(diagnosis: ConvergenceDiagnosis)` - 更新显示数据
  - `apply_auto_fix()` - 应用自动修复方案
  - `show_manual_fix_guide()` - 显示手动修复指南
  - `jump_to_problem_node(node_name)` - 跳转到问题节点（代码编辑器）
- [ ] **事件订阅**：`EVENT_CONVERGENCE_DIAGNOSED` - 诊断完成时自动更新
- [ ] **被调用方**：`simulation_tab.py`

##### 4.11.1.10 `waveform_widget.py` - 波形图表组件

> **设计说明**：基于 Plotly 的交互式波形图表组件，支持缩放、平移、双光标测量

- [ ] **文件路径**：`presentation/panels/simulation/waveform_widget.py`
- [ ] **职责**：渲染交互式波形图表，支持缩放、平移、测量
- [ ] **技术选型**：Plotly + QWebEngineView（通过 QWebChannel 通信）
- [ ] **核心功能**：
  - `load_waveform(signal_name)` - 加载波形数据（调用 `WaveformDataService`）
  - `set_viewport(x_min, x_max)` - 设置视口范围
  - `add_cursor(x_position)` - 添加测量光标
  - `remove_cursor(cursor_id)` - 移除测量光标
  - `get_measurement()` - 获取双光标测量结果
  - `export_image(path, format)` - 导出图表图片
- [ ] **数据获取**：调用 `domain/simulation/data/waveform_data_service.py` 获取降采样数据
- [ ] **性能优化**：
  - 初始加载使用最低分辨率层（500点）
  - 缩放时动态请求更高分辨率数据
  - 前端防抖：50ms 内的连续缩放操作合并
- [ ] **被调用方**：`chart_viewer.py`

##### 4.11.1.11 `measurement_tool.py` - 双光标测量工具

> **设计参考**：借鉴 LTspice 的交互式测量功能

- [ ] **文件路径**：`presentation/panels/simulation/measurement_tool.py`
- [ ] **职责**：提供双光标测量 UI，显示测量结果
- [ ] **UI 结构**：
  - 光标 A 位置输入框 + 数值显示
  - 光标 B 位置输入框 + 数值显示
  - 差值显示区（ΔX、ΔY、斜率、频率）
  - 关键点快速定位按钮（峰值、过零点、-3dB 点）
- [ ] **核心功能**：
  - `set_cursor_a(x_position)` - 设置光标 A 位置
  - `set_cursor_b(x_position)` - 设置光标 B 位置
  - `snap_to_peak()` - 光标吸附到最近峰值
  - `snap_to_zero_crossing()` - 光标吸附到最近过零点
  - `get_delta_values()` - 获取差值计算结果
- [ ] **被调用方**：`chart_viewer.py`

##### 4.11.1.12 `raw_data_table.py` - 原始数据表格

> **设计说明**：使用虚拟滚动技术显示大量仿真数据

- [ ] **文件路径**：`presentation/panels/simulation/raw_data_table.py`
- [ ] **职责**：以表格形式显示仿真原始数据，支持虚拟滚动
- [ ] **技术选型**：`QTableView` + 自定义 `QAbstractTableModel`
- [ ] **核心功能**：
  - `load_data(sim_result_path)` - 加载仿真结果数据
  - `jump_to_row(row_number)` - 跳转到指定行
  - `jump_to_time(time_value)` - 跳转到指定时间点
  - `search_value(column, value, tolerance)` - 搜索特定值
  - `export_selection(path, format)` - 导出选中数据
- [ ] **虚拟滚动实现**：
  - 仅渲染可见行（约 30-50 行）
  - 滚动时动态加载数据块
  - 数据获取调用 `WaveformDataService.get_table_data()`
- [ ] **被调用方**：`simulation_tab.py`

##### 4.11.1.13 `output_log_viewer.py` - 仿真输出日志查看器

- [ ] **文件路径**：`presentation/panels/simulation/output_log_viewer.py`
- [ ] **职责**：显示 ngspice 原始输出日志，便于调试
- [ ] **UI 结构**：
  - 工具栏：搜索框、过滤下拉框（全部/错误/警告）、刷新按钮
  - 日志显示区：`QPlainTextEdit`（只读）
  - 状态栏：显示总行数、错误数、警告数
- [ ] **核心功能**：
  - `load_log(sim_result_path)` - 加载日志（调用 `SimulationOutputReader`）
  - `search(keyword)` - 搜索关键词并高亮
  - `filter_by_level(level)` - 按日志级别过滤
  - `jump_to_error()` - 跳转到第一个错误行
- [ ] **语法高亮**：
  - 错误行：红色背景
  - 警告行：黄色背景
  - 关键信息：蓝色文字
- [ ] **被调用方**：`simulation_tab.py`

##### 4.11.1.14 `waveform_math_dialog.py` - 波形数学运算对话框

> **设计参考**：借鉴 LTspice 的波形数学运算功能

- [ ] **文件路径**：`presentation/panels/simulation/waveform_math_dialog.py`
- [ ] **职责**：提供波形数学运算的 UI 界面
- [ ] **UI 结构**：
  - 表达式输入框（支持自动补全信号名）
  - 预设运算按钮（加、减、乘、除、微分、积分、dB 转换）
  - 结果预览区
  - 确定/取消按钮
- [ ] **支持的表达式**：
  - `V(out) - V(in)` - 信号相减
  - `d(V(out))/dt` - 微分
  - `20*log10(abs(V(out)/V(in)))` - 增益计算
- [ ] **被调用方**：`chart_viewer.py`

##### 4.11.1.15 `simulation_settings_dialog.py` - 仿真设置对话框

> **设计目标**：通过菜单栏「设置 → 仿真设置」打开，让用户配置要执行的分析类型和要显示的图表类型
> **交互方式**：模态对话框，包含两个标签页
> **简化说明**：执行顺序由 AnalysisSelector 内部优先级决定，不支持用户拖拽调整；布局配置由 ChartViewer 自动处理

- [x] **文件路径**：`presentation/dialogs/simulation_settings_dialog.py`
- [x] **职责**：提供仿真分析类型和图表显示类型的统一配置界面
- [x] **核心类**：`SimulationSettingsDialog(QDialog)`
- [x] **触发方式**：菜单栏「设置 → 仿真设置」或快捷键 `Ctrl+Shift+S`
- [x] **UI 结构**：
  - **对话框标题**："仿真设置" / "Simulation Settings"
  - **标签页容器**（`QTabWidget`）：
    - 标签页1：分析类型选择
    - 标签页2：图表显示选择
  - **底部按钮栏**：
    - `[确定]` - 保存配置并关闭对话框
    - `[应用]` - 保存配置但不关闭对话框
    - `[取消]` - 放弃修改并关闭对话框
    - `[重置默认]` - 恢复所有设置为默认值
- [x] **分析类型标签页**：
  - **基础分析组**（`QGroupBox`）：
    - `[✓] AC 小信号分析` - 勾选框
    - `[✓] DC 扫描分析` - 勾选框
    - `[✓] 瞬态分析` - 勾选框
    - `[ ] 噪声分析` - 勾选框
    - `[✓] 工作点分析` - 勾选框
  - **高级分析组**（`QGroupBox`）：
    - `[ ] PVT 角点分析` - 勾选框
    - `[ ] 蒙特卡洛分析` - 勾选框
    - `[ ] 参数扫描` - 勾选框
    - `[ ] 最坏情况分析` - 勾选框
    - `[ ] 敏感度分析` - 勾选框
  - **快捷操作**：
    - `[全选基础]` - 选中所有基础分析
    - `[全选高级]` - 选中所有高级分析
  - **执行顺序显示**（只读标签）：
    - 显示当前选中分析的执行顺序（由 AnalysisSelector 优先级决定）
- [x] **图表显示标签页**：
  - **图表分类树**（`QTreeWidget` 带勾选框）：
    - 波形图表：时域波形、频域波形
    - Bode 图：幅度图、相位图、组合图
    - 特性曲线：DC 传输、DC 扫描
    - 频谱分析：FFT 频谱、谐波柱状图
    - 统计图表：直方图、散点图、箱线图
    - 参数扫描：等高线图、热力图、3D 曲面
    - 敏感度：龙卷风图、敏感度柱状图
    - PVT 图表：角点对比图、角点数据表格
    - 噪声图表：噪声频谱图、噪声密度图
  - **快捷操作**：
    - `[推荐图表]` - 根据选中的分析类型自动选择推荐图表
    - `[全选]` / `[全不选]`
- [x] **核心功能**：
  - `load_settings(project_root)` - 从配置文件加载当前设置
  - `save_settings(project_root)` - 保存设置到配置文件
  - `apply_settings()` - 应用设置（发布事件通知其他组件）
  - `reset_to_default()` - 重置为默认设置
  - `get_selected_analyses() -> List[AnalysisType]` - 获取选中的分析类型
  - `get_selected_charts() -> List[ChartType]` - 获取选中的图表类型
  - `_update_execution_order_display()` - 更新执行顺序显示
- [x] **信号定义**：
  - `settings_changed()` - 设置变更信号
  - `settings_applied()` - 设置应用信号
- [x] **事件发布**：
  - 点击「应用」或「确定」时通过 AnalysisSelector/ChartSelector 发布事件
- [x] **国际化支持**：
  - 实现 `retranslate_ui()` 方法
  - 所有文本支持中英文切换
- [x] **被调用方**：`main_window.py`（菜单栏触发）

#### 4.11.2 `history_dialog.py` - 历史记录对话框

- [ ] **职责**：展示完整的优化历史记录，支持查看详情和恢复
- [ ] **触发方式**：点击仿真结果标签页的 `[查看历史]` 按钮
- [ ] **国际化支持**：
  - 实现 `retranslate_ui()` 方法
  - 订阅 `EVENT_LANGUAGE_CHANGED` 事件
- [ ] **UI组件**：
  - **历史列表**：`QTableWidget`
    - 列：检查点序号、时间、综合评分、状态（完成/已撤回）
    - 行选中高亮
  - **详情区**：
    - 参数变化对比（与上一检查点）
    - 性能指标对比
    - LLM 分析反馈摘要
  - **操作按钮**：
    - `[恢复到此检查点]` - 调用 `undo_manager.restore_snapshot()`
    - `[关闭]`
- [ ] **核心功能**：
  - `load_history()` - 从 `iteration_history_service` 查询迭代历史
  - `on_checkpoint_selected(checkpoint_id)` - 选中检查点时更新详情区
  - `restore_to_checkpoint(checkpoint_id)` - 恢复到指定检查点
- [ ] **被调用方**：`simulation_tab.py`

#### 4.11.3 `select_simulation_file_dialog.py` - 选择仿真文件对话框

- [ ] **职责**：让用户从工作路径中选择要运行仿真的文件
- [ ] **触发方式**：
  - 点击工具栏 `[📂 选择运行]` 按钮（显示所有可仿真文件）
  - 自动检测到多个主电路时自动弹出（仅显示候选主电路）
- [ ] **国际化支持**：
  - 实现 `retranslate_ui()` 方法
  - 订阅 `EVENT_LANGUAGE_CHANGED` 事件
- [ ] **UI组件**：
  - **对话框标题**："选择仿真文件" / "Select Simulation File"
  - **文件列表**：`QListWidget`
    - 显示当前工作路径中所有可仿真文件
    - 支持的文件扩展名：从 `executor_registry.get_all_supported_extensions()` 获取
    - 默认包含：`.cir`、`.sp`、`.spice`、`.net`、`.ckt`、`.py`
    - 每项显示：文件图标 + 文件名 + 相对路径 + 执行器类型标签
    - 单选模式，点击选中
  - **文件类型过滤**（可选）：
    - 下拉框选择文件类型：全部 / SPICE 文件 / Python 脚本
    - 过滤后刷新文件列表
  - **文件预览区**（可选）：
    - 显示选中文件的前 20 行内容
    - 帮助用户确认选择正确的文件
  - **提示文本**：
    - 正常模式："请选择要运行仿真的文件"
    - 多主电路降级模式："检测到多个可能的主电路，请选择一个"
  - **操作按钮**：
    - `[运行]` - 使用选中文件执行仿真
    - `[取消]` - 关闭对话框
- [ ] **核心功能**：
  - `load_simulatable_files()` - 扫描工作路径，加载所有可仿真文件
  - `set_candidates(file_list)` - 设置候选文件列表（多主电路降级时使用）
  - `get_selected_file()` - 获取用户选中的文件路径
  - `on_file_selected(file_path)` - 文件选中时更新预览
  - `filter_by_type(file_type)` - 按文件类型过滤列表
- [ ] **多主电路降级模式**：
  - 通过 `set_candidates()` 传入候选列表时进入降级模式
  - 降级模式下仅显示候选文件，不显示全部电路文件
  - 提示文本切换为降级模式提示
- [ ] **用户引导增强**：
  - **候选文件说明**：每个候选文件显示"为什么被识别为主电路"的简要说明
    - 包含仿真控制语句（.ac/.dc/.tran）
    - 不被其他文件引用
    - 文件大小和修改时间
  - **推荐标记**：置信度最高的候选文件显示"推荐"标签
  - **帮助提示**：对话框底部显示"什么是主电路？"的帮助链接或提示文字
  - **记住选择**：可选"记住此项目的选择"复选框，下次自动使用
- [ ] **与 UI 仿真按钮集成**：
  - `[▶ 自动运行]` 按钮检测到多个主电路时，调用 `set_candidates()` 并弹出对话框
  - 用户选择后执行仿真
  - 用户取消则不执行仿真
- [ ] **被调用方**：`main_window.py`（工具栏按钮）、`design_workflow.py`（多主电路降级事件）

---

### 4.12 主窗口更新 (`presentation/`)

#### 4.12.1 `main_window.py` - 集成下栏面板与电路图查看器

- [ ] **本阶段新增**：
  - 将下栏占位替换为 `bottom_panel`（包含仿真结果和报告生成两个标签页）
  - 在中栏添加 `schematic_viewer_panel` 作为可切换的标签页（与代码编辑器并列）
  - 连接 `simulation_worker` 的信号到仿真结果标签页
  - 连接 `schematic_worker` 的信号到电路图查看器面板
  - 连接 `rag_worker` 的信号到状态栏
  - 连接报告生成相关事件到报告标签页
- [ ] **电路图查看器集成**：
  - 中栏使用 `QTabWidget` 管理代码编辑器和电路图查看器
  - 标签页：`[代码编辑器]` `[电路图]`
  - 打开 SPICE 文件时自动切换到电路图标签页（可配置）
  - 支持拖拽分离为独立窗口
- [ ] **电路图与代码编辑器联动**：
  - 订阅 `EVENT_JUMP_TO_LINE` 事件，跳转到代码编辑器对应行
  - 代码编辑器中选中元件定义行时，电路图中高亮对应元件
  - 双向同步选中状态
- [ ] **菜单栏更新**：
  - **文件菜单**：新增"导出对话记录"、"生成设计报告"、"导出波形数据"、"导出电路图"
  - **编辑菜单**：启用"撤回本次迭代"（调用 `undo_manager`，恢复到上一迭代检查点，会覆盖用户的手动编辑）
  - **视图菜单**（新增）：显示/隐藏电路图面板、显示/隐藏元件信息面板、电路图缩放（子菜单：放大、缩小、适应窗口、100%）
  - **仿真菜单**（启用）：运行仿真、停止仿真、选择分析类型（子菜单）、选择图表类型（子菜单）、数据检查、快速调参模式
  - **高级分析菜单**（新增）：PVT 角点仿真、蒙特卡洛分析、参数扫描、最坏情况分析、敏感度分析
  - **知识库菜单**（启用）：索引论文文件夹、刷新代码索引、启用/禁用 RAG 检索、查看索引状态
  - **库管理菜单**（新增）：打开库管理器、导入库文件、搜索元件、管理收藏
  - **国际化**：新增菜单项文本需添加到 `i18n_manager` 文本字典
- [ ] **工具栏更新（全部启用）**：
  - `[仿真]` - 运行仿真，图标 `play.svg`
  - `[停止]` - 停止仿真，图标 `stop.svg`
  - `[撤回]` - 撤回本次开发，图标 `undo.svg`
  - `[图表]` - 图表选择下拉（多选），图标 `chart.svg`
  - `[电路图]` - 切换到电路图查看器，图标 `schematic.svg`
  - `[检查]` - 数据检查下拉，图标 `inspect.svg`
  - `[调参]` - 快速调参模式开关，图标 `tuning.svg`
  - `[测量]` - 波形测量模式开关，图标 `measure.svg`
  - `[导出]` - 数据导出下拉（CSV/MATLAB/PNG），图标 `export.svg`
  - `[报告]` - 生成设计报告（调用 `report_generator`），图标 `report.svg`
  - `[RAG索引]` - 触发论文索引，图标 `index.svg`
  - `[RAG模式]` - RAG检索开关（功能启用），图标 `search.svg`
  - `[库管理]` - 打开子电路库管理器，图标 `library.svg`
  - **国际化**：新增工具栏按钮和下拉菜单文本需添加到 `i18n_manager` 文本字典
  - **说明**：由于 PySpice 共享库模式不支持暂停，仅提供停止功能
- [ ] **图标规范**：
  - **存放位置**：`resources/icons/toolbar/` 目录
  - **文件格式**：SVG 矢量格式，确保高 DPI 显示清晰
  - **命名规范**：小写字母 + 下划线，如 `play.svg`、`stop.svg`
  - **尺寸规范**：设计尺寸 24x24，viewBox 设置为 `0 0 24 24`
  - **颜色规范**：使用 `currentColor` 以支持主题切换
  - **图标来源**：优先使用 Material Design Icons 或 Feather Icons
  - **图标清单**：
    ```
    resources/icons/toolbar/
    ├── play.svg          # 运行仿真
    ├── stop.svg          # 停止仿真
    ├── undo.svg          # 撤回
    ├── chart.svg         # 图表
    ├── schematic.svg     # 电路图
    ├── inspect.svg       # 检查
    ├── tuning.svg        # 调参
    ├── measure.svg       # 测量
    ├── export.svg        # 导出
    ├── report.svg        # 报告
    ├── index.svg         # 索引
    ├── search.svg        # 搜索
    └── library.svg       # 库管理
    ```
- [ ] **状态栏更新**：
  - 任务状态：`仿真进行中...` / `RAG索引中...`
  - 代码索引状态：`代码索引: 同步中/完成`
  - **国际化**：状态栏文本通过 `i18n_manager.get_text()` 获取
- [ ] **异步信号处理**：
  - 统一接收 `simulation_worker`/`rag_worker` 的信号
  - `progress` → 更新状态栏进度
  - `result` → 更新仿真结果标签页
  - `error` → 显示错误提示
- [ ] **按钮忙碌态管理**：
  - 仿真期间禁用仿真按钮
  - RAG索引期间禁用索引按钮
  - 其他按钮保持可点击

---

### 4.13 代码编辑器增强 (`presentation/panels/editor/`)

> **设计参考**：借鉴 LTspice 的 SPICE 语法支持功能，增强代码编辑体验

#### 4.13.1 `spice_completer.py` - SPICE 自动补全器

- [ ] **文件路径**：`presentation/panels/editor/spice_completer.py`
- [ ] **职责**：为 SPICE 文件提供智能自动补全功能
- [ ] **核心类**：`SpiceCompleter(QCompleter)`
- [ ] **核心功能**：
  - `update_completions(text, cursor_pos)` - 根据当前输入更新补全列表
  - `get_keyword_completions(prefix)` - 获取关键词补全
  - `get_component_completions(prefix)` - 获取元件名补全
  - `get_node_completions(prefix)` - 获取节点名补全
  - `get_parameter_completions(prefix)` - 获取参数名补全
- [ ] **补全类型**：
  - SPICE 指令补全：`.ac`、`.dc`、`.tran`、`.param`、`.subckt`、`.include`、`.lib`、`.model`、`.ends`、`.end` 等
  - 分析类型补全：`dec`、`oct`、`lin`（AC 分析）、`uic`（瞬态分析）等
  - 元件前缀补全：`R`（电阻）、`C`（电容）、`L`（电感）、`Q`（BJT）、`M`（MOSFET）、`D`（二极管）、`V`（电压源）、`I`（电流源）等
  - 单位后缀补全：`k`、`meg`、`g`、`t`、`m`、`u`、`n`、`p`、`f` 等
- [ ] **上下文感知补全**：
  - 在 `.ac` 后补全分析参数（dec/oct/lin、频率范围）
  - 在 `.tran` 后补全时间参数
  - 在元件定义后补全节点名（基于当前文件已使用的节点）
  - 在 `.param` 后补全已定义的参数名
  - 在 `.include` 后补全项目中的文件路径
- [ ] **元件名和节点名提取**：
  - 解析当前文件，提取所有已定义的元件名
  - 解析当前文件，提取所有已使用的节点名
  - 解析 `.include` 引用的文件，提取子电路名
  - 缓存解析结果，文件变更时更新
- [ ] **补全触发条件**：
  - 输入 `.` 后自动触发指令补全
  - 输入字母后延迟 300ms 触发元件/节点补全
  - 按 Ctrl+Space 手动触发补全
- [ ] **被调用方**：`code_editor.py`

#### 4.13.2 `spice_linter.py` - SPICE 实时语法检查器

- [ ] **文件路径**：`presentation/panels/editor/spice_linter.py`
- [ ] **职责**：在用户输入时实时检测 SPICE 语法错误
- [ ] **核心类**：`SpiceLinter`
- [ ] **核心功能**：
  - `lint(text)` - 检查文本中的语法错误
  - `get_errors()` - 获取错误列表
  - `get_warnings()` - 获取警告列表
- [ ] **检测规则**：
  - 指令拼写错误（如 `.tarn` 应为 `.tran`）
  - 元件定义格式错误（如缺少节点、参数格式错误）
  - 未闭合的 `.subckt` / `.ends` 对
  - 未闭合的 `.control` / `.endc` 对
  - 引用的 `.include` 文件不存在
  - 未定义的参数引用
  - 节点名使用保留字（如 `0`、`gnd`）
  - 重复的元件名
- [ ] **错误信息结构**：错误信息包含行号、列号、错误类型（error/warning）、错误消息，以及修复建议（可选）。
- [ ] **错误显示方式**：
  - 错误行左侧显示红色标记
  - 警告行左侧显示黄色标记
  - 鼠标悬停显示错误详情
  - 错误列表可在底部面板显示
- [ ] **检查触发时机**：
  - 用户停止输入 500ms 后触发
  - 文件保存时触发
  - 手动触发（菜单或快捷键）
- [ ] **被调用方**：`code_editor.py`

#### 4.13.3 代码编辑器核心组件增强

- [ ] **文件路径**：`presentation/panels/editor/code_editor.py`（在阶段二基础上增强）
- [ ] **新增功能**：
  - `set_completer(completer)` - 设置自动补全器
  - `set_linter(linter)` - 设置语法检查器
  - `show_error_markers(errors)` - 显示错误标记
  - `goto_error(error_index)` - 跳转到指定错误
- [ ] **自动补全集成**：
  - 检测到 SPICE 文件时自动启用 `SpiceCompleter`
  - 补全列表以弹出菜单形式显示
  - 支持键盘导航和回车确认
  - 支持 Tab 键快速补全
- [ ] **语法检查集成**：
  - 检测到 SPICE 文件时自动启用 `SpiceLinter`
  - 错误标记显示在行号区域
  - 状态栏显示错误/警告数量
  - 支持快捷键跳转到下一个错误

---

### 4.14 跨阶段集成点说明

> **设计目标**：明确阶段四与其他阶段的接口和依赖关系，确保集成顺畅

#### 4.14.1 与阶段三（LLM 集成）的接口

- [ ] **simulation_node 与 LLM 工作流的协作**：
  - `simulation_node` 是 LangGraph 工作流中的一个节点
  - 接收 `GraphState.circuit_file_path` 作为输入
  - 调用 `SimulationService.run_simulation()` 执行仿真
  - 将结果写入 `GraphState.simulation_results` 和 `GraphState.last_metrics`
  - 仿真失败时写入 `GraphState.error_context`
- [ ] **仿真工具定义**：
  - 在 `domain/llm/tools/simulation_tools.py` 中定义仿真相关工具
  - `run_simulation` - 执行仿真
  - `run_pvt_analysis` - PVT 角点分析
  - `run_monte_carlo` - 蒙特卡洛分析
  - `generate_chart` - 生成图表
  - 工具通过 `ToolExecutor` 调用 `SimulationService`
- [ ] **仿真结果注入 Prompt**：
  - `SimulationContextCollector` 从 `GraphState.simulation_results` 收集仿真结果
  - 格式化为 LLM 可理解的文本，注入到 Prompt 中
  - 包含：分析类型、关键指标、达标状态、图表路径

#### 4.14.2 与阶段五（RAG 知识检索）的集成点

- [ ] **RAG 检索结果影响仿真配置**：
  - 当用户询问特定电路类型时，RAG 检索相关论文和设计指南
  - 检索结果中的推荐参数可作为仿真配置的参考
  - 通过 `GraphState.rag_context` 传递检索结果
- [ ] **仿真结果增强 RAG 检索**：
  - 仿真失败时，可触发 RAG 检索相关错误解决方案
  - 检索关键词：错误类型、电路拓扑、收敛问题等
  - 检索结果注入到 `fix_error_action` 的 Prompt 中

#### 4.14.3 与阶段九（统一信息展示面板）的集成细节

- [ ] **事件数据格式规范**：
  - 领域层事件只携带结构化业务数据，不包含展示文本
  - `SIMULATION_COMPLETE` 事件数据：`SimulationResult` 对象、指标字典、图表路径列表
  - `SIMULATION_ERROR` 事件数据：`SimulationError` 对象、文件路径、行号
- [ ] **格式化职责划分**：
  - 阶段四：定义数据结构和事件
  - 阶段九：`SimulationFormatter` 负责将数据格式化为展示文本
  - 阶段九：`MetricsFormatter` 负责将指标格式化为卡片内容
- [ ] **信息卡片生成流程**：
  1. 仿真完成 → 发布 `SIMULATION_COMPLETE` 事件
  2. `SimulationInfoCollector`（阶段九）订阅事件
  3. 调用 `SimulationFormatter.format_result()` 生成展示文本
  4. 创建 `InfoCard` 并添加到信息展示面板

#### 4.14.4 与阶段一（基础设施）的依赖

- [ ] **复用的基础设施模块**：
  - `EventBus` - 事件发布订阅
  - `EventThrottler` - 事件节流（仿真进度）
  - `AsyncTaskRegistry` - 异步任务注册
  - `ServiceLocator` - 服务定位
  - `ErrorHandler` - 错误处理
- [ ] **初始化顺序依赖**：
  - 阶段一基础设施必须先初始化
  - `ExecutorRegistry` 在 Phase 3.10 初始化
  - `SimulationService` 在 Phase 3.11 初始化

---

**阶段四检查点：**

- [ ] **三层分离架构**：
  - `executor_registry` 正确注册 `SpiceExecutor` 和 `PythonExecutor`
  - `simulation_service` 根据文件扩展名自动选择执行器
  - `AutoScanStrategy` 和 `ManualSelectStrategy` 正常工作
  - 两层（执行方式、文件选择）可自由组合
- [ ] **内嵌仿真引擎**：`SpiceExecutor` 可自动加载内嵌 ngspice，无需用户手动安装
- [ ] `SpiceExecutor` 可执行AC/DC/TRAN/NOISE分析
- [ ] `PythonExecutor` 可执行用户自定义 Python 仿真脚本
- [ ] `MetricsExtractor` 指标提取准确
- [ ] `chart_generator` 可生成各类图表
- [ ] `report_generator` 可生成PDF报告
- [ ] `simulation_worker` 后台仿真正常
- [ ] PDF文本提取正常
- [ ] 向量检索Top-K结果相关性高
- [ ] `rag_worker` 索引/检索正常
- [ ] 仿真结果标签页可显示指标和图表
- [ ] 报告生成标签页可收集信息并生成报告
- [ ] 检查点状态提示正常显示
- [ ] 撤回功能可用
- [ ] **历史记录对话框**：可查看完整优化历史，支持恢复到指定检查点
- [ ] **生成报告按钮**：可生成PDF设计报告
- [ ] **检查点确认功能**：每次优化完成后工作流等待用户确认，在对话面板显示建议选项，用户确认后才继续
- [ ] 设计管理域：`DesignGoals` 序列化/反序列化正常，`TerminationChecker` 判断逻辑正确
- [ ] **状态同步协调**：
  - 迭代历史从 SqliteSaver 查询，无独立 JSON 文件
  - 设计目标通过 `design_service` 读写
  - GraphState 是唯一的迭代状态源
- [ ] **仿真进程管理**：超时强制终止正常，资源清理无泄漏
- [ ] **仿真按钮功能**：
  - `[▶ 自动运行]` 按钮使用 `AutoScanStrategy` 自动检测后执行仿真
  - `[📂 选择运行]` 按钮使用 `ManualSelectStrategy` 弹出对话框选择文件
  - 检测到多个主电路时自动弹出选择对话框
  - 文件浏览器右键"运行此文件仿真"正确运行指定文件
  - 选择仿真文件对话框显示所有支持的文件类型（.cir/.sp/.spice/.py 等）
  - 根据选中文件扩展名自动选择对应执行器
- [ ] **启动流程**：仿真/RAG服务注册，所有Worker就绪
- [ ] **事件机制**：`SIM_*`/`RAG_*` 事件正常流转
- [ ] **数据流**：仿真结果 → GraphState 更新 → SessionState 投影 → 面板自动刷新
- [ ] **国际化**：下栏面板各标签页实现 `retranslate_ui()` 方法，指标名称和单位支持中英文切换
- [ ] **冷启动测试**：删除缓存后从零启动，阶段一至四的所有服务正确初始化，无循环依赖报错
- [ ] **统一信息面板集成验收**：
  - 仿真完成后 `SIMULATION_COMPLETE` 事件正确发布
  - 仿真错误时 `SIMULATION_ERROR` 事件正确发布
  - 事件数据结构符合规范（包含 result、metrics、charts 等字段）
  - 阶段九的 `SimulationInfoCollector` 能正确订阅并处理事件
- [ ] **高级仿真功能验收**：
  - PVT 角点仿真：可执行 5 个默认角点（TT/FF/SS/FS/SF），结果正确汇总，最差角点正确标识
  - 蒙特卡洛分析：可执行指定次数的随机仿真，统计结果（均值、标准差、良率）正确计算
  - 参数扫描：可执行单参数和嵌套扫描，结果数据正确组织
  - 收敛辅助：仿真失败时可诊断问题类型，提供修复建议
  - 拓扑识别：可正确识别常见电路类型（放大器、滤波器等），推荐合适的分析类型
- [ ] **扩展指标提取验收**：
  - 放大器指标：增益、带宽、GBW、相位裕度、增益裕度、CMRR、PSRR、压摆率正确提取
  - 噪声指标：输入噪声密度、积分噪声、信噪比正确计算
  - 失真指标：THD、SFDR、SNDR 正确计算
  - 功率分析指标：元件功耗、效率曲线、功耗分布正确计算
- [ ] **高级图表生成验收**：
  - 蒙特卡洛直方图、良率曲线正确生成
  - PVT 角点对比图正确生成
  - 参数扫描曲线、等高线图正确生成
  - FFT 频谱图、谐波分量柱状图正确生成
  - 功耗分布饼图、效率曲线图正确生成
  - 龙卷风图（敏感度分析）正确生成
- [ ] **最坏情况分析验收**：
  - RSS 方法计算正确
  - EVA 方法计算正确
  - 设计裕度计算正确
  - 关键参数识别正确
- [ ] **敏感度分析验收**：
  - 敏感度系数计算正确
  - 参数排名正确
  - 优化建议生成合理
- [ ] **波形测量功能验收**：
  - 双光标放置和拖拽正常
  - 测量值（Δx、Δy、斜率、频率）计算正确
  - 关键点自动检测正确（-3dB 点、过零点、峰值等）
- [ ] **波形数学运算验收**：
  - 加减乘除运算正确
  - 微分积分运算正确
  - 自定义表达式解析正确
- [ ] **数据导出功能验收**：
  - CSV 导出格式正确
  - MATLAB .mat 导出格式正确
  - 信号选择和范围设置正常
- [ ] **快速调参功能验收**：
  - 可调参数提取正确
  - 滑块调参响应正常
  - 自动仿真模式正常工作
  - 参数变化记录正确
- [ ] **子电路库管理验收**：
  - 库文件导入正常
  - 元件搜索功能正常
  - 预置库内容完整
- [ ] **SPICE 编辑器增强验收**：
  - 自动补全功能正常（指令、元件、节点、参数）
  - 实时语法检查正常
  - 错误标记显示正确

### 4.15 核心流程预集成

> **目的**：在阶段五之前验证"LLM → 仿真 → 分析"主线流程，降低最终集成风险

#### 4.15.1 主线流程集成验证

- [ ] **验证目标**：确认核心业务流程可通过 LangGraph 串联
- [ ] **验证内容**：
  - 创建包含 3-4 个业务节点的状态图
  - 节点：`llm_node`（调用 llm_worker）→ `simulation_node`（调用 simulation_worker）→ `analysis_node`（提取指标）
  - 验证 Worker 调度与状态更新的协同
  - 验证事件流转（`LLM_COMPLETE` → `SIM_STARTED` → `SIM_COMPLETE`）
- [ ] **验证范围**：
  - 使用简化的 Prompt（不含完整模板）
  - 使用简单的测试电路（如单级放大器）
  - 可作为集成测试用例保留
- [ ] **验证检查项**：
  - [ ] LLM 输出可正确解析为电路代码
  - [ ] 电路代码可触发仿真执行
  - [ ] 仿真结果可传递到分析节点
  - [ ] 分析结果可更新 GraphState
  - [ ] 整个流程的状态可通过 Checkpointer 持久化
  - [ ] UI 面板可响应状态变更事件

#### 4.15.2 迭代确认机制验证

- [ ] **验证目标**：
  - 验证 `interrupt()` 和 `Command(resume=value)` 机制可正常工作
  - 验证迭代暂停和恢复流程
- [ ] **设计**：
  - 每轮迭代完成后暂停等待用户确认
  - 用户点击"下一轮优化"后继续
- [ ] **停止条件**：
  - 所有设计目标达成
  - 达到最大检查点次数
  - 连续多次无性能提升（停滞）
  - 发生需要用户处理的错误

#### 4.15.3 工作流锁定机制

- [ ] **设计原则**：工作流运行中锁定危险操作，仅在安全检查点解锁，避免状态不一致
- [ ] **锁定状态管理**：
  - 通过 `SessionState.workflow_locked` 统一管理（由 GraphStateProjector 从 GraphState.current_node 派生）
  - 工作流启动时 → `current_node` 变为执行节点 → `workflow_locked = True`，发布 `WORKFLOW_LOCKED` 事件
  - 到达用户确认检查点时 → `current_node` 变为 "user_checkpoint" → `workflow_locked = False`，发布 `WORKFLOW_UNLOCKED` 事件
  - 用户点击"下一轮优化"时 → `current_node` 变为执行节点 → `workflow_locked = True`
  - 工作流结束时 → `current_node` 变为 "end" → `workflow_locked = False`
- [ ] **锁定时禁用的操作**：
  - 项目操作：关闭工作文件夹、切换项目（会清空当前状态，中断工作流）
  - 文件操作：手动保存文件、删除文件（可能与 LLM 的文件操作冲突）
  - 编辑操作：代码编辑器输入（可能与 LLM 修改同一文件冲突）
  - 对话操作：发送按钮禁用（但输入框可编辑，用户可预先输入内容）
  - 工作流操作：停止按钮、撤回按钮（仅在检查点可用）
  - 配置操作：修改 API 配置、切换模型（运行中切换可能导致不一致）
- [ ] **检查点时可用的操作**（`workflow_locked = False` 时）：
  - 发送消息：发送按钮启用，用户可以发送消息与 AI 对话
  - 点击建议按钮：选择系统推荐的下一步行动
  - 停止设计、撤回操作：终止或回退工作流
- [ ] **输入框特殊处理**：
  - 输入框始终可编辑，用户可随时输入和修改文本内容
  - 仅发送按钮根据锁定状态启用/禁用
  - 这样用户可以在等待 LLM 响应时预先准备下一条消息
- [ ] **始终可用的操作**：
  - 查看文件（只读模式）
  - 切换图表显示、查看优化历史
  - 缩放、滚动等 UI 交互
  - 退出程序（需确认对话框）
- [ ] **UI 响应**：
  - 各组件订阅 `WORKFLOW_LOCKED` / `WORKFLOW_UNLOCKED` 事件
  - 锁定时：按钮灰显、菜单项禁用、编辑器切换为只读模式
  - 解锁时：恢复正常操作
  - 状态栏提示："优化进行中，部分操作已暂时禁用"
  - 用户尝试被锁定操作时提示："请等待当前优化轮次完成"
- [ ] **锁定状态持久化与恢复**：
  - **持久化**：`workflow_locked` 状态由 `GraphState.current_node` 派生，随 Checkpointer 持久化
  - **启动时恢复策略**：
    ```
    1. 从 Checkpointer 加载上次的 GraphState
    2. 检查 workflow_locked 字段：
       - 若为 True → 说明上次运行中异常退出
       - 自动重置为 False（安全默认）
       - 记录日志："检测到上次运行中断，已重置锁定状态"
       - 在状态栏提示用户
    3. 检查 awaiting_user_confirmation 字段：
       - 若为 True → 恢复到等待确认状态
       - 在对话历史区追加建议选项消息
    ```
  - **强制关闭处理**：
    - 用户强制关闭程序时，锁定状态可能未正确清理
    - 下次启动时通过上述恢复策略自动修复
    - 不会导致死锁或功能不可用
  - **`interrupt()` 失败处理**：
    - 若 `user_checkpoint_node` 的 `interrupt()` 调用失败
    - 捕获异常，记录日志
    - 强制设置 `workflow_locked = False`
    - 发布 `WORKFLOW_UNLOCKED` 事件
    - 提示用户"迭代暂停失败，请手动检查状态"
- [ ] **设计优点**：
  - 统一管理，避免遗漏
  - 状态始终一致，不会出现"操作执行一半"的情况
  - 异常退出后可自动恢复，不会导致功能锁死

---

### 4.16 与统一信息展示面板集成

> **集成说明**：仿真模块的摘要信息展示由阶段九的"统一信息展示面板"负责，详细图表查看、数据导出等功能由本阶段的下栏仿真面板负责。职责分工详见 4.0 节开头的"面板职责边界"说明。

#### 4.16.1 仿真进度数据模型

##### `simulation_progress.py` - 仿真进度数据类

- [ ] **文件路径**：`domain/simulation/models/simulation_progress.py`
- [ ] **职责**：定义仿真进度的详细数据结构
- [ ] **数据类定义**：
  - `SimulationProgressDetail` - 仿真进度详情
    - `phase: str` - 当前阶段（preparing/running/analyzing/charting）
    - `phase_progress: float` - 阶段内进度（0-100）
    - `overall_progress: float` - 总体进度（0-100）
    - `current_operation: str` - 当前操作描述
    - `elapsed_time_ms: float` - 已用时间
    - `estimated_remaining_ms: Optional[float]` - 预计剩余时间
    - `analysis_points_completed: Optional[int]` - 已完成分析点数
    - `analysis_points_total: Optional[int]` - 总分析点数
- [ ] **阶段定义**：
  - `preparing` - 准备阶段（加载文件、初始化执行器）
  - `running` - 仿真运行阶段
  - `analyzing` - 结果分析阶段（指标提取）
  - `charting` - 图表生成阶段
- [ ] **被调用方**：`SimulationService`、`SimulationInfoCollector`（阶段九）

#### 4.16.2 仿真事件数据规范

> **说明**：仿真事件已在 4.0.3 节定义，此处补充事件携带的数据规范

##### `SIMULATION_COMPLETE` 事件数据

- [ ] **事件名**：`SimulationEvents.SIMULATION_COMPLETE`
- [ ] **数据结构**：
  ```python
  {
    "result": SimulationResult,      # 仿真结果对象
    "metrics": Dict[str, Any],       # 性能指标字典（结构化数据）
    "charts": List[str],             # 图表文件路径列表（供下栏面板使用）
    "duration_seconds": float,       # 仿真耗时
    "analysis_type": str,            # 分析类型
    "file_path": str,                # 仿真文件路径
  }
  ```
- [ ] **消费方**：
  - 下栏仿真面板：使用完整数据展示图表和详情
  - 右栏信息面板：仅使用 `duration_seconds`、`analysis_type`、`metrics` 中的关键数值

##### `SIMULATION_ERROR` 事件数据

- [ ] **事件名**：`SimulationEvents.SIMULATION_ERROR`
- [ ] **数据结构**：
  ```python
  {
    "error": SimulationError,        # 错误对象（包含 type、message、recovery_suggestion）
    "file_path": str,                # 出错文件路径
    "line_number": int,              # 出错行号
    "context": str,                  # 错误上下文代码
  }
  ```
- [ ] **消费方**：
  - 下栏仿真面板：展示完整错误详情和恢复建议
  - 右栏信息面板：仅展示错误类型和简短描述

##### `SIMULATION_PROGRESS` 事件数据

- [ ] **事件名**：`SimulationEvents.SIMULATION_PROGRESS`
- [ ] **数据结构**：
  ```python
  {
    "progress": SimulationProgressDetail,  # 进度详情对象
  }
  ```

#### 4.16.3 面板间跳转事件

> **说明**：右栏信息面板点击卡片后，通过事件通知下栏面板切换到对应标签页

- [ ] **事件名**：`EVENT_NAVIGATE_TO_SIMULATION_PANEL`
- [ ] **数据结构**：
  ```python
  {
    "target_tab": str,               # 目标标签页（simulation/chart/data/log）
    "context": Dict[str, Any],       # 上下文数据（如仿真结果 ID）
  }
  ```
- [ ] **发布方**：右栏信息面板的仿真摘要卡片
- [ ] **订阅方**：下栏仿真面板，切换到指定标签页并加载对应数据

#### 4.16.4 统一信息面板集成点

> **集成说明**：仿真模块的**摘要信息**将自动推送到统一信息展示面板（阶段九 9.0 节），便于用户快速查看状态

- [ ] **仿真摘要卡片**：`SimulationInfoCollector`（阶段九）订阅 `SIMULATION_COMPLETE` 事件，创建摘要 `InfoCard`
- [ ] **关键指标卡片**：`SimulationInfoCollector` 从 `metrics` 字典提取关键数值创建 `InfoCard`
- [ ] **错误摘要卡片**：`SimulationInfoCollector` 订阅 `SIMULATION_ERROR` 事件，创建摘要 `InfoCard`
- [ ] **格式化职责**：由阶段九的 `SimulationSummaryFormatter` 负责生成摘要展示文本
- [ ] **跳转功能**：卡片包含"查看详情"按钮，点击发布 `EVENT_NAVIGATE_TO_SIMULATION_PANEL` 事件

---

### 4.17 报告生成标签页模块组 (`presentation/panels/report/`)

> **功能概述**：报告生成功能允许用户收集项目中的各类信息（仿真结果、RAG 检索结果、文件内容等），配合自定义提示词，由 LLM 以 Agentic Loop 模式自主撰写报告。

> **与对话系统的关系**：
>
> - 报告生成是独立功能，不通过对话面板输入
> - 复用 `AgenticLoopController`（阶段三 3.3.2 节）执行 LLM 调用和工具执行
> - 复用 qasync 融合事件循环（阶段三 3.0 节）确保不阻塞 UI
> - 通过 `EventBus` 发布进度事件，与其他模块解耦

> **架构解耦设计**：
>
> - **UI 层**：`presentation/panels/report/` - 负责用户交互和显示
> - **领域层**：`domain/report/` - 负责报告生成业务逻辑
> - **应用层**：复用现有的 `AgenticLoopController` 和 `ToolExecutor`
> - 三层分离，职责清晰，便于测试和维护

#### 4.17.1 报告生成事件定义

- [ ] **文件路径**：`shared/events/report_events.py`
- [ ] **事件常量定义**：
  ```python
  class ReportEvents:
      """报告生成相关事件定义"""

      # 报告生成生命周期事件
      REPORT_GENERATION_STARTED = "report.generation_started"
      REPORT_GENERATION_PROGRESS = "report.generation_progress"
      REPORT_GENERATION_COMPLETE = "report.generation_complete"
      REPORT_GENERATION_ERROR = "report.generation_error"
      REPORT_GENERATION_CANCELLED = "report.generation_cancelled"

      # 信息收集事件
      REPORT_INFO_ADDED = "report.info_added"
      REPORT_INFO_REMOVED = "report.info_removed"
      REPORT_INFO_CLEARED = "report.info_cleared"

      # 工具执行事件（Agentic Loop 中）
      REPORT_TOOL_EXECUTING = "report.tool_executing"
      REPORT_TOOL_COMPLETE = "report.tool_complete"
      REPORT_FILE_CREATED = "report.file_created"
  ```
- [ ] **被调用方**：报告生成相关模块通过导入此常量类使用事件名

#### 4.17.2 报告生成 ViewModel (`report_view_model.py`)

- [ ] **文件路径**：`presentation/panels/report/report_view_model.py`
- [ ] **职责**：作为 UI 与报告生成服务之间的中间层，管理报告生成状态
- [ ] **继承**：`BaseViewModel`（阶段一 1.7.2 节定义）
- [ ] **核心属性**（供 UI 绑定）：
  - `collected_info_items` - 已收集的信息项列表（`List[InfoItem]`）
  - `user_prompt` - 用户输入的提示词
  - `generation_status` - 生成状态（idle/generating/complete/error）
  - `progress` - 生成进度（0-100）
  - `progress_message` - 当前进度描述
  - `output_dir` - 输出目录路径
  - `generated_files` - 已生成的文件列表
  - `error_message` - 错误信息（若有）
- [ ] **核心方法**：
  - `add_info_item(item)` - 添加信息项
  - `remove_info_item(item_id)` - 移除信息项
  - `clear_info_items()` - 清空所有信息项
  - `set_prompt(prompt)` - 设置用户提示词
  - `start_generation()` - 开始生成报告
  - `cancel_generation()` - 取消生成
  - `open_output_dir()` - 打开输出目录
  - `get_available_current_info()` - 获取当前可选择的信息列表
- [ ] **事件订阅**：
  - 订阅 `EVENT_REPORT_GENERATION_PROGRESS` 更新进度
  - 订阅 `EVENT_REPORT_GENERATION_COMPLETE` 更新状态
  - 订阅 `EVENT_REPORT_GENERATION_ERROR` 显示错误
  - 订阅 `EVENT_REPORT_FILE_CREATED` 更新文件列表
- [ ] **被调用方**：`report_tab.py`

#### 4.17.3 报告标签页主类 (`report_tab.py`)

- [ ] **文件路径**：`presentation/panels/report/report_tab.py`
- [ ] **职责**：协调报告生成标签页的各子组件，管理整体布局
- [ ] **核心类**：`ReportTab(QWidget)`
- [ ] **布局结构**：
  - 上半部分（60%高度）：信息收集区（`InfoCollectorWidget`）
  - 下半部分（40%高度）：提示输入区（`PromptInputWidget`）+ 操作按钮
  - 生成中时：显示进度面板（`ReportProgressWidget`）覆盖输入区域
- [ ] **核心功能**：
  - `_setup_ui()` - 初始化 UI 布局
  - `_connect_signals()` - 连接子组件信号
  - `on_generate_clicked()` - 处理生成按钮点击
  - `on_cancel_clicked()` - 处理取消按钮点击
  - `show_progress_view()` - 切换到进度显示视图
  - `show_input_view()` - 切换到输入视图
- [ ] **国际化支持**：
  - 实现 `retranslate_ui()` 方法
  - 订阅 `EVENT_LANGUAGE_CHANGED` 事件
- [ ] **被调用方**：`bottom_panel.py`

#### 4.17.4 信息收集区组件 (`info_collector_widget.py`)

- [ ] **文件路径**：`presentation/panels/report/info_collector_widget.py`
- [ ] **职责**：管理报告素材的收集，支持文件上传和当前信息选择
- [ ] **核心类**：`InfoCollectorWidget(QWidget)`
- [ ] **UI 结构**：
  - 标题栏："信息收集" / "Information Collection"
  - 操作按钮区：
    - `[上传文件]` 按钮 - 打开文件选择对话框
    - `[选择当前信息]` 按钮 - 打开当前信息选择对话框
    - `[清空]` 按钮 - 清空所有已收集信息
  - 已收集信息列表：`QListWidget`
    - 每项显示：图标 + 信息类型 + 名称/描述 + 删除按钮
    - 支持拖拽排序
    - 支持多选删除
  - 拖拽区域：支持拖拽文件到此区域上传
- [ ] **信息项类型**：
  - 上传文件：显示文件图标 + 文件名 + 文件大小
  - 仿真结果：显示图表图标 + "仿真结果" + 时间戳
  - RAG 检索结果：显示搜索图标 + "知识检索" + 查询关键词
  - 设计目标：显示目标图标 + "设计目标" + 目标摘要
  - 项目文件：显示代码图标 + 文件名 + 相对路径
- [ ] **核心功能**：
  - `add_uploaded_file(file_path)` - 添加上传的文件
  - `add_info_item(item)` - 添加信息项
  - `remove_item(item_id)` - 移除指定信息项
  - `clear_all()` - 清空所有信息项
  - `get_all_items()` - 获取所有已收集的信息项
  - `on_drop_files(file_paths)` - 处理拖拽文件
- [ ] **信号定义**：
  - `info_added(InfoItem)` - 信息项添加时发出
  - `info_removed(str)` - 信息项移除时发出（参数为 item_id）
  - `info_cleared()` - 信息清空时发出
- [ ] **被调用方**：`report_tab.py`

#### 4.17.5 选择当前信息对话框 (`current_info_dialog.py`)

- [ ] **文件路径**：`presentation/panels/report/current_info_dialog.py`
- [ ] **职责**：展示当前可用的信息（从 GraphState 和信息展示面板获取），供用户选择添加到报告素材
- [ ] **核心类**：`CurrentInfoDialog(QDialog)`
- [ ] **UI 结构**：
  - 对话框标题："选择当前信息" / "Select Current Information"
  - 信息分类标签页（`QTabWidget`）：
    - 仿真结果：显示当前仿真结果摘要，可选择添加
    - RAG 检索：显示最近的 RAG 检索结果列表
    - 设计目标：显示当前设计目标
    - 项目文件：显示项目文件树，可多选
    - 迭代历史：显示迭代历史记录列表
  - 每个标签页内：
    - 信息列表（`QListWidget` 或 `QTreeWidget`）
    - 支持多选（复选框）
    - 显示信息预览
  - 操作按钮：
    - `[添加选中]` - 将选中项添加到信息收集区
    - `[取消]` - 关闭对话框
- [ ] **信息来源**：
  - 仿真结果：从 `GraphState.simulation_results` 获取
  - RAG 检索结果：从 `GraphState.rag_context` 获取
  - 设计目标：从 `GraphState.design_goals` 获取
  - 项目文件：从 `SessionState.project_root` 扫描
  - 迭代历史：从 `iteration_history_service` 查询 SqliteSaver
- [ ] **核心功能**：
  - `load_available_info()` - 加载当前可用的信息
  - `get_selected_items()` - 获取用户选中的信息项
  - `on_tab_changed(index)` - 标签页切换时刷新内容
  - `on_item_double_clicked(item)` - 双击预览信息详情
- [ ] **国际化支持**：实现 `retranslate_ui()` 方法
- [ ] **被调用方**：`info_collector_widget.py`

#### 4.17.6 提示输入区组件 (`prompt_input_widget.py`)

- [ ] **文件路径**：`presentation/panels/report/prompt_input_widget.py`
- [ ] **职责**：提供用户输入报告生成提示词的界面
- [ ] **核心类**：`PromptInputWidget(QWidget)`
- [ ] **UI 结构**：
  - 标题栏："生成提示" / "Generation Prompt"
  - 提示词输入框：`QPlainTextEdit`
    - 占位符文本："请输入报告生成指导，如报告结构、风格、重点内容等..."
    - 支持多行输入
    - 显示字符计数
  - 预设模板下拉框（可选）：
    - "技术报告模板"
    - "设计文档模板"
    - "仿真分析报告模板"
    - "自定义"
  - 操作按钮：
    - `[生成报告]` 按钮 - 主操作按钮，醒目样式
    - `[清空]` 按钮 - 清空输入框
- [ ] **核心功能**：
  - `get_prompt()` - 获取用户输入的提示词
  - `set_prompt(text)` - 设置提示词内容
  - `clear()` - 清空输入框
  - `apply_template(template_name)` - 应用预设模板
  - `set_enabled(enabled)` - 设置输入区启用/禁用状态
- [ ] **信号定义**：
  - `prompt_changed(str)` - 提示词变化时发出
  - `generate_requested()` - 点击生成按钮时发出
- [ ] **被调用方**：`report_tab.py`

#### 4.17.7 生成进度显示组件 (`report_progress_widget.py`)

- [ ] **文件路径**：`presentation/panels/report/report_progress_widget.py`
- [ ] **职责**：显示报告生成的进度和状态
- [ ] **核心类**：`ReportProgressWidget(QWidget)`
- [ ] **UI 结构**：
  - 状态图标：旋转动画（生成中）/ 勾选（完成）/ 叉号（错误）
  - 状态文本："正在生成报告..." / "报告生成完成" / "生成失败"
  - 进度条：显示总体进度
  - 当前操作标签：显示 LLM 正在执行的操作
    - "正在分析素材..."
    - "正在撰写章节：xxx"
    - "正在创建文件：xxx.md"
  - 已生成文件列表：
    - 显示已创建的文件名
    - 点击可预览文件内容
  - 操作按钮：
    - `[取消]` 按钮 - 生成中显示
    - `[打开报告目录]` 按钮 - 完成后显示
    - `[返回]` 按钮 - 完成/错误后显示
- [ ] **核心功能**：
  - `update_progress(percent, message)` - 更新进度
  - `add_generated_file(file_path)` - 添加已生成文件
  - `show_complete()` - 显示完成状态
  - `show_error(message)` - 显示错误状态
  - `reset()` - 重置为初始状态
- [ ] **被调用方**：`report_tab.py`

---

### 4.18 报告生成领域模块 (`domain/report/`)

> **职责边界**：领域层负责报告生成的核心业务逻辑，与 UI 层解耦。

> **目录结构**：
>
> ```
> domain/report/
> ├── __init__.py
> ├── report_types.py              # 报告相关类型定义
> ├── report_context_builder.py    # 报告上下文构建器
> └── report_generator.py          # 报告生成控制器
> ```

#### 4.18.1 报告类型定义 (`report_types.py`)

- [ ] **文件路径**：`domain/report/report_types.py`
- [ ] **职责**：定义报告生成相关的数据类型
- [ ] **信息项类型枚举**：
  ```python
  class InfoItemType(Enum):
      UPLOADED_FILE = "uploaded_file"       # 用户上传的文件
      SIMULATION_RESULT = "simulation"      # 仿真结果
      RAG_CONTEXT = "rag"                   # RAG 检索结果
      DESIGN_GOALS = "design_goals"         # 设计目标
      PROJECT_FILE = "project_file"         # 项目文件
      ITERATION_HISTORY = "iteration"       # 迭代历史
  ```
- [ ] **信息项数据类**：
  ```python
  @dataclass
  class InfoItem:
      id: str                               # 唯一标识
      type: InfoItemType                    # 信息类型
      name: str                             # 显示名称
      description: str                      # 描述
      content: Optional[str]                # 文本内容（若可直接读取）
      file_path: Optional[str]              # 文件路径（若为文件）
      metadata: Dict[str, Any]              # 元数据
      created_at: str                       # 添加时间（ISO 格式）
  ```
- [ ] **报告上下文数据类**：
  ```python
  @dataclass
  class ReportContext:
      info_items: List[InfoItem]            # 收集的信息项列表
      user_prompt: str                      # 用户提示词
      output_dir: Path                      # 输出目录
      project_path: Path                    # 项目路径
      session_id: str                       # 会话标识
  ```
- [ ] **报告生成结果数据类**：
  ```python
  @dataclass
  class ReportGenerationResult:
      success: bool                         # 是否成功
      output_dir: Path                      # 输出目录
      generated_files: List[str]            # 生成的文件列表
      error_message: Optional[str]          # 错误信息
      duration_seconds: float               # 耗时
  ```
- [ ] **被调用方**：`report_context_builder.py`、`report_generator.py`、`report_view_model.py`

#### 4.18.2 报告上下文构建器 (`report_context_builder.py`)

- [ ] **文件路径**：`domain/report/report_context_builder.py`
- [ ] **职责**：将收集的信息项转换为 LLM 可理解的上下文格式
- [ ] **核心类**：`ReportContextBuilder`
- [ ] **核心方法**：
  - `build_context(info_items, user_prompt)` - 构建完整的报告上下文
  - `format_info_item(item)` - 格式化单个信息项为文本
  - `build_system_prompt(context)` - 构建报告生成的系统提示词
  - `estimate_token_count(context)` - 估算上下文 Token 数量
- [ ] **信息项格式化规则**：
  - 上传文件：读取文件内容，添加文件名标注
  - 仿真结果：格式化为结构化文本（指标列表、图表描述）
  - RAG 检索结果：保留原始检索片段，添加来源标注
  - 设计目标：格式化为目标列表
  - 项目文件：读取文件内容，添加路径标注
  - 迭代历史：格式化为时间线描述
- [ ] **系统提示词模板**：
  - 角色定义：专业的技术报告撰写助手
  - 任务说明：根据提供的素材撰写报告
  - 输出要求：使用 Markdown 格式，结构清晰
  - 工具使用指导：使用 `create_file` 工具创建报告文件
  - 用户提示词注入位置
- [ ] **被调用方**：`report_generator.py`

#### 4.18.3 报告生成控制器 (`report_generator.py`)

- [ ] **文件路径**：`domain/report/report_generator.py`
- [ ] **职责**：控制报告生成流程，协调 LLM 调用和工具执行
- [ ] **核心类**：`ReportGenerator`
- [ ] **依赖模块**：
  - `AgenticLoopController`（阶段三 3.3.2 节）- 执行 LLM 调用和工具循环
  - `AsyncTaskManager`（阶段三 3.0.2 节）- 异步任务管理
  - `ToolExecutor`（阶段六）- 工具执行
  - `ReportContextBuilder` - 上下文构建
  - `EventBus` - 事件发布
- [ ] **核心方法**：
  - `generate(context, callbacks)` - 异步生成报告
  - `cancel()` - 取消生成
  - `_prepare_output_dir(project_path)` - 准备输出目录
  - `_get_available_tools()` - 获取报告生成可用的工具列表
  - `_on_loop_progress(progress)` - 处理 Agentic Loop 进度回调
  - `_on_tool_executed(tool_name, result)` - 处理工具执行回调
- [ ] **可用工具**（报告生成专用，限制范围）：
  - `create_file` - 创建文件（限制在 Report 目录内）
  - `read_file` - 读取文件（用于引用项目文件内容）
  - `list_project_files` - 列出项目文件（用于了解项目结构）
  - 不提供仿真工具、修改工具，确保报告生成不会意外修改项目
- [ ] **输出目录规则**：
  - 默认目录：`{project_path}/Report/`
  - 若目录已存在，自动创建：`{project_path}/Report_{timestamp}/`
  - 所有生成的文件必须在输出目录内
- [ ] **进度事件发布**：
  - 开始时发布 `EVENT_REPORT_GENERATION_STARTED`
  - 每次工具执行后发布 `EVENT_REPORT_GENERATION_PROGRESS`
  - 每创建一个文件发布 `EVENT_REPORT_FILE_CREATED`
  - 完成时发布 `EVENT_REPORT_GENERATION_COMPLETE`
  - 错误时发布 `EVENT_REPORT_GENERATION_ERROR`
- [ ] **被调用方**：`report_view_model.py`

#### 4.18.4 报告生成 Prompt 模板

- [ ] **文件路径**：`resources/prompts/report_prompts.json`
- [ ] **模板定义**：
  - `REPORT_SYSTEM_PROMPT` - 报告生成系统提示词
  - `REPORT_TECHNICAL_TEMPLATE` - 技术报告模板提示
  - `REPORT_DESIGN_DOC_TEMPLATE` - 设计文档模板提示
  - `REPORT_SIMULATION_ANALYSIS_TEMPLATE` - 仿真分析报告模板提示
- [ ] **系统提示词要点**：
  - 角色：专业的电路设计技术报告撰写助手
  - 能力：根据提供的素材撰写结构化报告
  - 输出格式：Markdown 格式，支持标题、列表、表格、代码块
  - 工具使用：使用 `create_file` 创建报告文件，文件名应有意义
  - 报告结构建议：摘要、背景、方法、结果、结论
  - 图表引用：可引用仿真结果中的图表路径
- [ ] **模板变量**：
  - `{collected_info}` - 格式化后的收集信息
  - `{user_prompt}` - 用户的指导提示
  - `{project_name}` - 项目名称
  - `{output_dir}` - 输出目录路径
- [ ] **被调用方**：`report_context_builder.py`

---

### 4.19 阶段检查点 - 报告生成功能

#### 4.19.1 功能验证检查项

- [ ] 下栏面板标签页切换正常（仿真结果 ↔ 报告生成）
- [ ] 信息收集区可上传本地文件
- [ ] 信息收集区可拖拽文件上传
- [ ] "选择当前信息"对话框正确显示当前可用信息
- [ ] 可从对话框选择仿真结果、RAG 结果、设计目标等添加到收集区
- [ ] 已收集信息列表显示正确，支持删除
- [ ] 提示输入区可输入自定义提示词
- [ ] 预设模板可正确应用
- [ ] 点击"生成报告"后进入进度显示视图
- [ ] 进度显示正确更新
- [ ] 报告生成完成后可打开输出目录
- [ ] 取消功能可正确中断生成

#### 4.19.2 集成验证检查项

- [ ] `ReportGenerator` 正确使用 `AgenticLoopController`
- [ ] LLM 调用通过 qasync 融合循环执行，不阻塞 UI
- [ ] 工具执行限制在 Report 目录内
- [ ] 事件发布和订阅正常工作
- [ ] 报告生成不影响主对话流程
- [ ] 报告生成不影响仿真功能

#### 4.19.3 国际化验证

- [ ] 报告标签页标题支持中英文切换
- [ ] 信息收集区所有文本支持中英文
- [ ] 选择当前信息对话框支持中英文
- [ ] 提示输入区支持中英文
- [ ] 进度显示支持中英文
