## é˜¶æ®µäº”ï¼šRAGçŸ¥è¯†æ£€ç´¢ä¸ä»£ç ç´¢å¼• (2å‘¨)

> **ç›®æ ‡**ï¼šå®ç°è®ºæ–‡å¤„ç†ã€å‘é‡å­˜å‚¨ã€æ··åˆæ£€ç´¢ã€ä»£ç ç´¢å¼•ï¼Œå®ŒæˆçŸ¥è¯†æ£€ç´¢åŠŸèƒ½

> **âš ï¸ æ ¸å¿ƒæ¶æ„ï¼šåŸºäºå¼•ç”¨çš„å•ä¸€æ•°æ®æº**ï¼š
> - **UnifiedSearchService**ï¼šç»Ÿä¸€æœç´¢é—¨é¢ï¼Œèåˆç²¾ç¡®æœç´¢å’Œè¯­ä¹‰æœç´¢ï¼Œå¯¹ LLM å·¥å…·å±‚æš´éœ²å•ä¸€å…¥å£
> - **RAGService**ï¼šæ— çŠ¶æ€ RAG æ£€ç´¢æœåŠ¡ï¼Œæ‰§è¡Œè¯­ä¹‰æ£€ç´¢å¹¶è¿”å›ç»“æœ
> - **æŒ‰éœ€æ£€ç´¢**ï¼šæ£€ç´¢ç»“æœä¸ç¼“å­˜åœ¨å†…å­˜ä¸­ï¼Œæ¯æ¬¡æŒ‰éœ€è·å–
> - **ç´¢å¼•ç”± ChromaDB ç®¡ç†**ï¼šå‘é‡ç´¢å¼•å­˜å‚¨åœ¨ `.circuit_ai/chroma/`

> **âš ï¸ æœ¬é˜¶æ®µç»Ÿä¸€ç®¡ç†æç¤º**ï¼š
> - RAG ç´¢å¼•ä»»åŠ¡é€šè¿‡ `AsyncTaskRegistry` æäº¤åç¨‹æ‰§è¡Œ
> - ç´¢å¼•æ–‡ä»¶é€šè¿‡ FileManager å†™å…¥
> - ç´¢å¼•é”™è¯¯é€šè¿‡ ErrorHandler ç»Ÿä¸€å¤„ç†
> - RAG æ£€ç´¢é€šè¿‡ RAGService æ‰§è¡Œï¼Œç»“æœä¸ç¼“å­˜
> - æ–°å¢ UI é¢æ¿éœ€å®ç° `retranslate_ui()` æ–¹æ³•

> **âš ï¸ è·¨é˜¶æ®µä¾èµ–æ£€æŸ¥**ï¼š
> - å¼€å§‹æœ¬é˜¶æ®µå‰ï¼Œå¿…é¡»ç¡®è®¤ä»¥ä¸‹æ¨¡å—å·²æ­£ç¡®å®ç°å¹¶è¯»å–å…¶æºç ï¼š
>   - `domain/state/base_state_manager.py` - é¢†åŸŸçŠ¶æ€ç®¡ç†å™¨åŸºç±»ï¼ˆé˜¶æ®µ 2.5ï¼‰
>   - `domain/state/state_coordinator.py` - çŠ¶æ€åè°ƒå™¨ï¼ˆé˜¶æ®µ 2.5ï¼‰
>   - `shared/worker_manager.py` - Worker æ³¨å†Œå’Œè°ƒåº¦æ¥å£
>   - `infrastructure/persistence/file_manager.py` - æ–‡ä»¶å†™å…¥æ¥å£
>   - `shared/error_handler.py` - é”™è¯¯å¤„ç†æ¥å£
>   - `application/workers/base_worker.py` - Worker åŸºç±»å’Œä¿¡å·å®šä¹‰
>   - `shared/event_bus.py` - äº‹ä»¶å‘å¸ƒè®¢é˜…æœºåˆ¶
> - ç¡®è®¤ Worker ä¿¡å·å®šä¹‰ä¸æ–‡æ¡£ä¸€è‡´ï¼Œç‰¹åˆ«æ˜¯ `progress`ã€`result`ã€`error` ä¿¡å·

> **âš ï¸ ä¸é˜¶æ®µäºŒ/ä¸‰çš„é›†æˆå…³ç³»**ï¼š
> - é˜¶æ®µäºŒçš„ `FileSearchService` æ˜¯åº•å±‚ç²¾ç¡®æœç´¢å¼•æ“ï¼ˆæ­£åˆ™/æ¨¡ç³Š/ç¬¦å·ï¼‰
> - æœ¬é˜¶æ®µçš„ `RetrievalService` æ˜¯åº•å±‚è¯­ä¹‰æœç´¢å¼•æ“ï¼ˆå‘é‡/BM25/é‡æ’åºï¼‰
> - æœ¬é˜¶æ®µçš„ `UnifiedSearchService` ç»Ÿä¸€å¯¹å¤–æš´éœ²æœç´¢èƒ½åŠ›ï¼Œèåˆä¸¤ä¸ªå¼•æ“çš„ç»“æœ
> - é˜¶æ®µä¸‰çš„ `context_retriever.py` é€šè¿‡ `UnifiedSearchService` è·å–ä¸Šä¸‹æ–‡
> - é˜¶æ®µå…­çš„ LLM å·¥å…· `search_project` è°ƒç”¨ `UnifiedSearchService`
> - ä¸¤ä¸ªé˜¶æ®µçš„èŒè´£åˆ’åˆ†ï¼š
>   - **é˜¶æ®µäºŒ**ï¼šç²¾ç¡®æœç´¢å¼•æ“ï¼ˆIDE åŠŸèƒ½ï¼šè·³è½¬å®šä¹‰ã€æŸ¥æ‰¾å¼•ç”¨ã€æ­£åˆ™æœç´¢ï¼‰
>   - **é˜¶æ®µäº”**ï¼šè¯­ä¹‰æœç´¢å¼•æ“ + ç»Ÿä¸€æœç´¢é—¨é¢ï¼ˆæœ¬é˜¶æ®µï¼‰

> **ğŸ“š ä¸»æµçŸ¥è¯†åº“æŠ€æœ¯å‚è€ƒ**ï¼š
> æœ¬é˜¶æ®µè®¾è®¡å‚è€ƒäº†ä»¥ä¸‹ä¸»æµçŸ¥è¯†åº“ç³»ç»Ÿçš„é«˜ä»·å€¼ç‰¹æ€§ï¼š
> - **ChromaDB**ï¼šè½»é‡çº§å‘é‡æ•°æ®åº“ï¼Œæ”¯æŒæœ¬åœ°æŒä¹…åŒ–ï¼Œé€‚åˆæ¡Œé¢åº”ç”¨
> - **LlamaIndex**ï¼šæ–‡æ¡£ç´¢å¼•æ¡†æ¶ï¼Œæä¾›å¤šç§åˆ†å—ç­–ç•¥å’Œæ£€ç´¢æ¨¡å¼
> - **LangChain RAG**ï¼šæ£€ç´¢å¢å¼ºç”Ÿæˆæœ€ä½³å®è·µï¼Œæ··åˆæ£€ç´¢å’Œé‡æ’åº
> - **Cursor/Continue**ï¼šAI IDE çš„ä¸Šä¸‹æ–‡ç®¡ç†æ–¹æ¡ˆï¼Œéšå¼ä¸Šä¸‹æ–‡æ”¶é›†
> - **Notion AI / Obsidian**ï¼šçŸ¥è¯†åº“çš„å¢é‡ç´¢å¼•å’Œå®æ—¶åŒæ­¥æœºåˆ¶
>
> **æ ¸å¿ƒè®¾è®¡å†³ç­–**ï¼š
> - å‘é‡æ•°æ®åº“é€‰ç”¨ ChromaDBï¼ˆè½»é‡ã€æœ¬åœ°åŒ–ã€æ— éœ€æœåŠ¡ç«¯ï¼‰
> - åµŒå…¥æ¨¡å‹é€‰ç”¨ ModernBERT æ¶æ„ï¼ˆé•¿ä¸Šä¸‹æ–‡ã€é«˜æ€§èƒ½ï¼‰
> - æ£€ç´¢ç­–ç•¥é‡‡ç”¨æ··åˆæ£€ç´¢ + é‡æ’åºï¼ˆè¯­ä¹‰ + å…³é”®è¯ + ç²¾æ’ï¼‰
> - ç´¢å¼•æœºåˆ¶é‡‡ç”¨å¢é‡æ›´æ–° + é˜²æŠ–åŠ¨ï¼ˆå®æ—¶æ€§ + æ€§èƒ½å¹³è¡¡ï¼‰

---

### 5.0 ç»Ÿä¸€æœç´¢å±‚ (`domain/search/`)

> **âš ï¸ æ ¸å¿ƒè®¾è®¡**ï¼šç»Ÿä¸€æœç´¢å±‚æ˜¯å¯¹ LLM å·¥å…·æš´éœ²çš„å”¯ä¸€æœç´¢å…¥å£ï¼Œå†…éƒ¨èåˆç²¾ç¡®æœç´¢å’Œè¯­ä¹‰æœç´¢ä¸¤ä¸ªå¼•æ“çš„ç»“æœã€‚
> æ¶ˆé™¤ LLM åœ¨ `search_files` å’Œ `search_knowledge` ä¹‹é—´çš„é€‰æ‹©å›°æƒ‘ã€‚

#### 5.0.0 ç»Ÿä¸€æœç´¢å±‚ç›®å½•ç»“æ„

```
domain/search/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ unified_search_service.py    # é¡¹ç›®çº§ç»Ÿä¸€æœç´¢é—¨é¢
â”œâ”€â”€ in_file_search_service.py    # å•æ–‡ä»¶æœç´¢æœåŠ¡ï¼ˆåˆ†å±‚é™çº§ç­–ç•¥ï¼‰
â”œâ”€â”€ search_result_merger.py      # ç»“æœèåˆå™¨
â”œâ”€â”€ token_budget_allocator.py    # Tokené¢„ç®—åˆ†é…å™¨
â””â”€â”€ models/
    â”œâ”€â”€ __init__.py
    â”œâ”€â”€ unified_search_types.py  # é¡¹ç›®æœç´¢æ•°æ®ç±»å‹
    â””â”€â”€ in_file_search_types.py  # å•æ–‡ä»¶æœç´¢æ•°æ®ç±»å‹
```

> **âš ï¸ èŒè´£åˆ’åˆ†**ï¼š
> - `UnifiedSearchService`ï¼šé¡¹ç›®çº§æœç´¢ï¼Œå¯¹ LLM å·¥å…· `search_project` æš´éœ²
> - `InFileSearchService`ï¼šå•æ–‡ä»¶æœç´¢ï¼Œå¯¹ LLM å·¥å…· `read_file(query=...)` æš´éœ²ï¼Œå®ç°åˆ†å±‚é™çº§ç­–ç•¥

#### 5.0.1 `unified_search_types.py` - é¡¹ç›®æœç´¢æ•°æ®ç±»å‹

- [ ] **æ–‡ä»¶è·¯å¾„**ï¼š`domain/search/models/unified_search_types.py`
- [ ] **èŒè´£**ï¼šå®šä¹‰é¡¹ç›®çº§ç»Ÿä¸€æœç´¢çš„è¯·æ±‚å’Œå“åº”æ•°æ®ç»“æ„
- [ ] **æ•°æ®ç±»å®šä¹‰**ï¼š
  - `UnifiedSearchOptions` - ç»Ÿä¸€æœç´¢é€‰é¡¹
    - `query: str` - æœç´¢æŸ¥è¯¢
    - `scope: str` - æœç´¢èŒƒå›´ï¼ˆcode/docs/allï¼Œé»˜è®¤ allï¼‰
    - `max_results: int` - æœ€å¤§ç»“æœæ•°ï¼ˆé»˜è®¤ 10ï¼‰
    - `token_budget: int` - Token é¢„ç®—ï¼ˆé»˜è®¤ 4000ï¼‰
    - `include_exact: bool` - æ˜¯å¦åŒ…å«ç²¾ç¡®æœç´¢ç»“æœï¼ˆé»˜è®¤ Trueï¼‰
    - `include_semantic: bool` - æ˜¯å¦åŒ…å«è¯­ä¹‰æœç´¢ç»“æœï¼ˆé»˜è®¤ Trueï¼‰
    - `file_types: List[str]` - é™å®šæ–‡ä»¶ç±»å‹ï¼ˆå¯é€‰ï¼‰
    - `case_sensitive: bool` - ç²¾ç¡®æœç´¢æ˜¯å¦åŒºåˆ†å¤§å°å†™ï¼ˆé»˜è®¤ Falseï¼‰
  - `UnifiedSearchResult` - ç»Ÿä¸€æœç´¢ç»“æœ
    - `exact_matches: List[SearchMatch]` - ç²¾ç¡®åŒ¹é…ç»“æœ
    - `semantic_matches: List[SearchMatch]` - è¯­ä¹‰åŒ¹é…ç»“æœ
    - `total_exact_count: int` - ç²¾ç¡®åŒ¹é…æ€»æ•°
    - `total_semantic_count: int` - è¯­ä¹‰åŒ¹é…æ€»æ•°
    - `query: str` - åŸå§‹æŸ¥è¯¢
    - `search_time_ms: float` - æœç´¢è€—æ—¶
    - `token_usage: TokenUsage` - Token ä½¿ç”¨ç»Ÿè®¡
  - `SearchMatch` - å•æ¡æœç´¢åŒ¹é…
    - `content: str` - åŒ¹é…å†…å®¹ï¼ˆå·²æˆªæ–­åˆ° Token é¢„ç®—ï¼‰
    - `source: str` - æ¥æºï¼ˆæ–‡ä»¶è·¯å¾„æˆ–æ–‡æ¡£æ ‡é¢˜ï¼‰
    - `location: MatchLocation` - ä½ç½®ä¿¡æ¯
    - `score: float` - ç›¸å…³æ€§åˆ†æ•°ï¼ˆ0-1ï¼‰
    - `match_type: str` - åŒ¹é…ç±»å‹ï¼ˆexact/fuzzy/regex/semanticï¼‰
    - `highlight_ranges: List[Tuple[int, int]]` - é«˜äº®èŒƒå›´
    - `truncated: bool` - æ˜¯å¦è¢«æˆªæ–­
  - `MatchLocation` - åŒ¹é…ä½ç½®
    - `line_number: int` - è¡Œå·ï¼ˆä»£ç æ–‡ä»¶ï¼‰
    - `column: int` - åˆ—å·ï¼ˆä»£ç æ–‡ä»¶ï¼‰
    - `page_number: int` - é¡µç ï¼ˆæ–‡æ¡£ï¼‰
    - `section: str` - ç« èŠ‚ï¼ˆæ–‡æ¡£ï¼‰
  - `TokenUsage` - Token ä½¿ç”¨ç»Ÿè®¡
    - `exact_tokens: int` - ç²¾ç¡®æœç´¢ç»“æœå ç”¨ Token
    - `semantic_tokens: int` - è¯­ä¹‰æœç´¢ç»“æœå ç”¨ Token
    - `total_tokens: int` - æ€» Token ä½¿ç”¨
    - `budget: int` - Token é¢„ç®—
    - `utilization: float` - åˆ©ç”¨ç‡ï¼ˆ0-1ï¼‰
- [ ] **è¢«è°ƒç”¨æ–¹**ï¼š`UnifiedSearchService`ã€`SearchResultMerger`ã€`TokenBudgetAllocator`

#### 5.0.2 `token_budget_allocator.py` - Token é¢„ç®—åˆ†é…å™¨

- [ ] **æ–‡ä»¶è·¯å¾„**ï¼š`domain/search/token_budget_allocator.py`
- [ ] **èŒè´£**ï¼šç®¡ç†æœç´¢ç»“æœçš„ Token é¢„ç®—åˆ†é…å’Œæˆªæ–­
- [ ] **æ ¸å¿ƒåŠŸèƒ½**ï¼š
  - `allocate(total_budget, exact_count, semantic_count)` - åˆ†é…é¢„ç®—
  - `truncate_text(text, max_tokens, preserve_ends)` - æˆªæ–­å†…å®¹åˆ°æŒ‡å®š Token æ•°
  - `allocate_exact_results(results)` - åˆ†é…ç²¾ç¡®æœç´¢ç»“æœé¢„ç®—
  - `allocate_semantic_results(results)` - åˆ†é…è¯­ä¹‰æœç´¢ç»“æœé¢„ç®—
  - `calculate_utilization(results, budget)` - è®¡ç®—é¢„ç®—åˆ©ç”¨ç‡
- [ ] **é¢„ç®—åˆ†é…ç­–ç•¥**ï¼š
  - é»˜è®¤æ€»é¢„ç®—ï¼š4000 tokens
  - ç²¾ç¡®æœç´¢é¢„ç®—æ¯”ä¾‹ï¼š40%ï¼ˆ1600 tokensï¼‰
  - è¯­ä¹‰æœç´¢é¢„ç®—æ¯”ä¾‹ï¼š60%ï¼ˆ2400 tokensï¼‰
  - å•æ¡ç»“æœæœ€å¤§é•¿åº¦ï¼š500 tokens
  - åŠ¨æ€è°ƒæ•´ï¼šè‹¥æŸç±»ç»“æœä¸è¶³ï¼Œå°†é¢„ç®—è½¬ç§»ç»™å¦ä¸€ç±»
- [ ] **æˆªæ–­ç­–ç•¥**ï¼š
  - ä¿ç•™å¼€å¤´ï¼ˆ60%ï¼‰å’Œç»“å°¾ï¼ˆ30%ï¼‰ï¼Œä¸­é—´çœç•¥ï¼ˆ10%ç”¨äºçœç•¥æ ‡è®°ï¼‰
  - çœç•¥æ ‡è®°æ ¼å¼ï¼š`\n... [truncated] ...\n`
  - ä»£ç æ–‡ä»¶ï¼šä¼˜å…ˆä¿ç•™å®Œæ•´è¡Œï¼Œé¿å…æˆªæ–­åœ¨è¡Œä¸­é—´
  - æ–‡æ¡£æ–‡ä»¶ï¼šä¼˜å…ˆåœ¨å¥å­è¾¹ç•Œæˆªæ–­
- [ ] **æ€§èƒ½ä¼˜åŒ–ï¼ˆO(1) æˆªæ–­ï¼‰**ï¼š
  - **æˆªæ–­åˆ¤æ–­é˜¶æ®µ**ï¼šä½¿ç”¨å­—ç¬¦æ•°å¿«é€Ÿä¼°ç®—ï¼ˆ`CHARS_PER_TOKEN_ESTIMATE` = 4 å­—ç¬¦/tokenï¼‰ï¼Œä¸è°ƒç”¨ tokenizer
  - **æˆªæ–­æ‰§è¡Œé˜¶æ®µ**ï¼šç›´æ¥æŒ‰å­—ç¬¦æ•°åˆ‡åˆ†ï¼ˆå¦‚ä¿ç•™å‰ 8000 å­—ç¬¦ + å 4000 å­—ç¬¦ï¼‰ï¼ŒO(1) å­—ç¬¦ä¸²åˆ‡ç‰‡
  - **ç²¾ç¡®è®¡æ•°é˜¶æ®µ**ï¼šä»…å¯¹æˆªæ–­åçš„ç»“æœè°ƒç”¨ `token_counter.estimate_tokens()` è¿›è¡Œç²¾ç¡®è®¡æ•°
  - **æ€§èƒ½ä¿è¯**ï¼šæ— è®ºè¾“å…¥æ–‡æœ¬å¤šå¤§ï¼Œæˆªæ–­æ“ä½œå§‹ç»ˆæ˜¯ O(1) çš„ï¼Œé¿å…å¯¹ 200KB æ–‡æœ¬è°ƒç”¨ tokenizer çš„ O(N) å¼€é”€
- [ ] **`truncate_text` æ–¹æ³•è¯¦ç»†è®¾è®¡**ï¼š
  - è¾“å…¥ï¼š`text`ï¼ˆåŸå§‹æ–‡æœ¬ï¼‰ã€`max_tokens`ï¼ˆæœ€å¤§ Token æ•°ï¼‰ã€`preserve_ends`ï¼ˆæ˜¯å¦ä¿ç•™å¤´å°¾ï¼‰
  - æ‰§è¡Œæµç¨‹ï¼š
    1. å¿«é€Ÿä¼°ç®—ï¼š`estimated_tokens = len(text) // CHARS_PER_TOKEN_ESTIMATE`
    2. è‹¥ `estimated_tokens <= max_tokens`ï¼Œç›´æ¥è¿”å›åŸæ–‡æœ¬ï¼Œ`truncated=False`
    3. è‹¥éœ€è¦æˆªæ–­ï¼Œè®¡ç®—ç›®æ ‡å­—ç¬¦æ•°ï¼š`target_chars = max_tokens * CHARS_PER_TOKEN_ESTIMATE`
    4. æŒ‰å­—ç¬¦æ•°åˆ‡åˆ†ï¼šä¿ç•™å‰ `target_chars * 0.6` å­—ç¬¦ + çœç•¥æ ‡è®° + å `target_chars * 0.3` å­—ç¬¦
    5. è¿”å›æˆªæ–­åçš„æ–‡æœ¬ï¼Œ`truncated=True`
  - è¿”å›å€¼ï¼š`Tuple[str, bool]`ï¼ˆæˆªæ–­åçš„æ–‡æœ¬ï¼Œæ˜¯å¦è¢«æˆªæ–­ï¼‰
- [ ] **ä¾èµ–æ¨¡å—**ï¼š
  - `shared/constants/file_limits.py` - è·å– `CHARS_PER_TOKEN_ESTIMATE` å¸¸é‡
  - `domain/llm/token_counter.py` - ä»…ç”¨äºæˆªæ–­åçš„ç²¾ç¡®è®¡æ•°
- [ ] **è¢«è°ƒç”¨æ–¹**ï¼š`SearchResultMerger`ã€`UnifiedSearchService`ã€`tool_dispatcher.py`ï¼ˆé˜¶æ®µå…­ read_file å·¥å…·ï¼‰

#### 5.0.3 `search_result_merger.py` - æœç´¢ç»“æœèåˆå™¨

- [ ] **æ–‡ä»¶è·¯å¾„**ï¼š`domain/search/search_result_merger.py`
- [ ] **èŒè´£**ï¼šèåˆç²¾ç¡®æœç´¢å’Œè¯­ä¹‰æœç´¢çš„ç»“æœï¼Œå»é‡æ’åº
- [ ] **æ ¸å¿ƒåŠŸèƒ½**ï¼š
  - `merge(exact_results, semantic_results, options)` - èåˆä¸¤è·¯ç»“æœ
  - `deduplicate(results)` - å»é‡ï¼ˆåŒä¸€æ–‡ä»¶åŒä¸€ä½ç½®ï¼‰
  - `rank_results(results)` - ç»¼åˆæ’åº
  - `apply_token_budget(results, budget)` - åº”ç”¨ Token é¢„ç®—æˆªæ–­
- [ ] **å»é‡è§„åˆ™**ï¼š
  - åŒä¸€æ–‡ä»¶ã€åŒä¸€è¡Œå·çš„ç»“æœè§†ä¸ºé‡å¤
  - é‡å¤æ—¶ä¿ç•™åˆ†æ•°æ›´é«˜çš„ç»“æœ
  - è®°å½•é‡å¤æ¥æºï¼ˆä¾¿äºè°ƒè¯•ï¼‰
- [ ] **æ’åºè§„åˆ™**ï¼š
  - ç²¾ç¡®åŒ¹é…ä¼˜å…ˆï¼ˆexact > fuzzy > regex > semanticï¼‰
  - åŒç±»å‹æŒ‰åˆ†æ•°é™åº
  - åˆ†æ•°ç›¸åŒæŒ‰æ–‡ä»¶è·¯å¾„å­—æ¯åº
- [ ] **èåˆç»“æœç»“æ„**ï¼š
  - åˆ†ç»„è¿”å›ï¼š`exact_matches` å’Œ `semantic_matches` ä¸¤ä¸ªåˆ—è¡¨
  - æ¯ç»„å†…éƒ¨æŒ‰åˆ†æ•°æ’åº
  - æ ‡æ³¨æ¯æ¡ç»“æœçš„æ¥æºå¼•æ“
- [ ] **ä¾èµ–æ¨¡å—**ï¼š`TokenBudgetAllocator`
- [ ] **è¢«è°ƒç”¨æ–¹**ï¼š`UnifiedSearchService`

#### 5.0.4 `unified_search_service.py` - é¡¹ç›®çº§ç»Ÿä¸€æœç´¢é—¨é¢

> **åˆå§‹åŒ–é¡ºåº**ï¼šPhase 3.25ï¼Œä¾èµ– FileSearchServiceã€RetrievalServiceï¼Œæ³¨å†Œåˆ° ServiceLocator

- [ ] **æ–‡ä»¶è·¯å¾„**ï¼š`domain/search/unified_search_service.py`
- [ ] **èŒè´£**ï¼šé¡¹ç›®çº§ç»Ÿä¸€æœç´¢å…¥å£ï¼Œå¹¶è¡Œè°ƒç”¨ç²¾ç¡®æœç´¢å’Œè¯­ä¹‰æœç´¢ï¼Œèåˆç»“æœ
- [ ] **æ ¸å¿ƒåŠŸèƒ½**ï¼š
  - `search(query, options)` - ä¸»æœç´¢å…¥å£ï¼Œè¿”å› `UnifiedSearchResult`
  - `search_code_only(query, options)` - ä»…æœç´¢ä»£ç æ–‡ä»¶
  - `search_docs_only(query, options)` - ä»…æœç´¢æ–‡æ¡£
  - `get_search_status()` - è·å–æœç´¢å¼•æ“çŠ¶æ€ï¼ˆç´¢å¼•æ˜¯å¦å°±ç»ªç­‰ï¼‰
- [ ] **æœç´¢æµç¨‹**ï¼š
  1. è§£ææœç´¢é€‰é¡¹ï¼Œç¡®å®šæœç´¢èŒƒå›´
  2. å¹¶è¡Œè°ƒç”¨ä¸¤ä¸ªæœç´¢å¼•æ“ï¼š
     - `FileSearchService.search_by_content()` - ç²¾ç¡®æœç´¢
     - `RetrievalService.retrieve()` - è¯­ä¹‰æœç´¢
  3. ç­‰å¾…ä¸¤è·¯ç»“æœè¿”å›ï¼ˆè®¾ç½®è¶…æ—¶ 5 ç§’ï¼‰
  4. è°ƒç”¨ `SearchResultMerger.merge()` èåˆç»“æœ
  5. åº”ç”¨ Token é¢„ç®—æˆªæ–­
  6. è¿”å›ç»Ÿä¸€æ ¼å¼çš„ç»“æœ
- [ ] **å¹¶è¡Œæ‰§è¡Œç­–ç•¥**ï¼š
  - ä½¿ç”¨ `asyncio.gather()` å¹¶è¡Œæ‰§è¡Œä¸¤è·¯æœç´¢
  - å•è·¯è¶…æ—¶ä¸å½±å“å¦ä¸€è·¯ç»“æœè¿”å›
  - è¶…æ—¶çš„æœç´¢å¼•æ“è¿”å›ç©ºç»“æœï¼Œè®°å½•è­¦å‘Šæ—¥å¿—
- [ ] **é™çº§ç­–ç•¥**ï¼š
  - è¯­ä¹‰æœç´¢ç´¢å¼•æœªå°±ç»ªæ—¶ï¼Œä»…è¿”å›ç²¾ç¡®æœç´¢ç»“æœ
  - ç²¾ç¡®æœç´¢å¤±è´¥æ—¶ï¼Œä»…è¿”å›è¯­ä¹‰æœç´¢ç»“æœ
  - ä¸¤è·¯éƒ½å¤±è´¥æ—¶ï¼Œè¿”å›ç©ºç»“æœå¹¶è®°å½•é”™è¯¯
- [ ] **ä¾èµ–æ¨¡å—**ï¼š
  - `FileSearchService`ï¼ˆé˜¶æ®µäºŒï¼‰- ç²¾ç¡®æœç´¢å¼•æ“
  - `RetrievalService`ï¼ˆæœ¬é˜¶æ®µ 5.3ï¼‰- è¯­ä¹‰æœç´¢å¼•æ“
  - `SearchResultMerger` - ç»“æœèåˆ
  - `TokenBudgetAllocator` - Token é¢„ç®—ç®¡ç†
- [ ] **è¢«è°ƒç”¨æ–¹**ï¼š`tool_executor.py`ï¼ˆé˜¶æ®µå…­ `search_project` å·¥å…·ï¼‰ã€`context_retriever.py`ï¼ˆé˜¶æ®µä¸‰ï¼‰

#### 5.0.5 ç»Ÿä¸€æœç´¢äº‹ä»¶å®šä¹‰

- [ ] **æ–‡ä»¶è·¯å¾„**ï¼š`shared/events/search_events.py`
- [ ] **äº‹ä»¶å¸¸é‡å®šä¹‰**ï¼š
  ```python
  class SearchEvents:
      """ç»Ÿä¸€æœç´¢ç›¸å…³äº‹ä»¶å®šä¹‰"""
      
      # æœç´¢æ‰§è¡Œäº‹ä»¶
      UNIFIED_SEARCH_STARTED = "search.unified_started"
      UNIFIED_SEARCH_COMPLETE = "search.unified_complete"
      UNIFIED_SEARCH_ERROR = "search.unified_error"
      
      # å•æ–‡ä»¶æœç´¢äº‹ä»¶
      IN_FILE_SEARCH_STARTED = "search.in_file_started"
      IN_FILE_SEARCH_COMPLETE = "search.in_file_complete"
      IN_FILE_SEMANTIC_SKIPPED = "search.in_file_semantic_skipped"
      
      # å¼•æ“çŠ¶æ€äº‹ä»¶
      EXACT_ENGINE_TIMEOUT = "search.exact_engine_timeout"
      SEMANTIC_ENGINE_TIMEOUT = "search.semantic_engine_timeout"
      SEMANTIC_INDEX_NOT_READY = "search.semantic_index_not_ready"
  ```

---

#### 5.0.6 `in_file_search_types.py` - å•æ–‡ä»¶æœç´¢æ•°æ®ç±»å‹

- [ ] **æ–‡ä»¶è·¯å¾„**ï¼š`domain/search/models/in_file_search_types.py`
- [ ] **èŒè´£**ï¼šå®šä¹‰å•æ–‡ä»¶æœç´¢çš„è¯·æ±‚å’Œå“åº”æ•°æ®ç»“æ„
- [ ] **æ•°æ®ç±»å®šä¹‰**ï¼š
  - `InFileSearchOptions` - å•æ–‡ä»¶æœç´¢é€‰é¡¹
    - `max_results: int` - æœ€å¤§ç»“æœæ•°ï¼ˆé»˜è®¤ 5ï¼‰
    - `include_exact: bool` - æ˜¯å¦åŒ…å«ç²¾ç¡®åŒ¹é…ï¼ˆé»˜è®¤ Trueï¼‰
    - `include_semantic: bool` - æ˜¯å¦åŒ…å«è¯­ä¹‰åŒ¹é…ï¼ˆé»˜è®¤ Trueï¼‰
    - `context_lines: int` - ä¸Šä¸‹æ–‡è¡Œæ•°ï¼ˆé»˜è®¤ 5ï¼‰
    - `min_score: float` - æœ€ä½ç›¸å…³æ€§åˆ†æ•°ï¼ˆé»˜è®¤ 0.3ï¼‰
  - `InFileSearchResult` - å•æ–‡ä»¶æœç´¢ç»“æœ
    - `matches: List[InFileMatch]` - åŒ¹é…ç»“æœåˆ—è¡¨
    - `file_path: str` - æ–‡ä»¶è·¯å¾„
    - `query: str` - åŸå§‹æŸ¥è¯¢
    - `search_time_ms: float` - æœç´¢è€—æ—¶
    - `exact_count: int` - ç²¾ç¡®åŒ¹é…æ•°é‡
    - `semantic_count: int` - è¯­ä¹‰åŒ¹é…æ•°é‡
    - `semantic_available: bool` - è¯­ä¹‰æœç´¢æ˜¯å¦å¯ç”¨ï¼ˆæ–‡ä»¶æ˜¯å¦å·²ç´¢å¼•ï¼‰
  - `InFileMatch` - å•æ–‡ä»¶åŒ¹é…é¡¹
    - `start_line: int` - èµ·å§‹è¡Œå·
    - `end_line: int` - ç»“æŸè¡Œå·
    - `score: float` - ç›¸å…³æ€§åˆ†æ•°ï¼ˆ0-1ï¼‰
    - `match_type: str` - åŒ¹é…ç±»å‹ï¼ˆexact/semantic/mergedï¼‰
    - `matched_text: str` - åŒ¹é…çš„æ–‡æœ¬ç‰‡æ®µ
    - `context_before: List[str]` - ä¸Šæ–‡è¡Œ
    - `context_after: List[str]` - ä¸‹æ–‡è¡Œ
- [ ] **è¢«è°ƒç”¨æ–¹**ï¼š`InFileSearchService`ã€`FileContentLocator`ï¼ˆé˜¶æ®µå…­ï¼‰

---

#### 5.0.7 `in_file_search_service.py` - å•æ–‡ä»¶æœç´¢æœåŠ¡

> **åˆå§‹åŒ–é¡ºåº**ï¼šPhase 3.26ï¼Œä¾èµ– FileSearchServiceã€RAGServiceï¼Œæ³¨å†Œåˆ° ServiceLocator

> **âš ï¸ æ ¸å¿ƒè®¾è®¡ï¼šåˆ†å±‚é™çº§ç­–ç•¥**
> - ç²¾ç¡®æœç´¢ï¼šå§‹ç»ˆæ‰§è¡Œï¼ˆåŸºç¡€èƒ½åŠ›ï¼‰
> - è¯­ä¹‰æœç´¢ï¼šä»…å½“æ–‡ä»¶å·²ç´¢å¼•æ—¶æ‰§è¡Œï¼ˆå¢å¼ºèƒ½åŠ›ï¼‰
> - ç”¨æˆ·ä¸ä¼šå› ä¸ºç´¢å¼•æœªå°±ç»ªè€Œå®Œå…¨æ— æ³•å®šä½å†…å®¹

- [ ] **æ–‡ä»¶è·¯å¾„**ï¼š`domain/search/in_file_search_service.py`
- [ ] **èŒè´£**ï¼šåœ¨å•ä¸ªæ–‡ä»¶å†…æ‰§è¡Œæœç´¢ï¼Œæ”¯æŒåˆ†å±‚é™çº§ç­–ç•¥
- [ ] **æ ¸å¿ƒåŠŸèƒ½**ï¼š
  - `search(file_path, query, options)` - ä¸»æœç´¢å…¥å£ï¼Œè¿”å› `InFileSearchResult`
  - `is_file_indexed(file_path)` - æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²è¢«ç´¢å¼•
- [ ] **æœç´¢æµç¨‹**ï¼š
  1. æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™è¿”å›ç©ºç»“æœ
  2. æ‰§è¡Œç²¾ç¡®æœç´¢ï¼ˆå§‹ç»ˆæ‰§è¡Œï¼‰ï¼š
     - è°ƒç”¨ `FileSearchService.search_in_file(file_path, query)`
  3. æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²ç´¢å¼•ï¼š
     - è°ƒç”¨ `RAGService.has_indexed_file(file_path)`
  4. è‹¥å·²ç´¢å¼•ä¸” `options.include_semantic=True`ï¼Œæ‰§è¡Œè¯­ä¹‰æœç´¢ï¼š
     - è°ƒç”¨ `RAGService.retrieve_from_file(file_path, query)`
  5. èåˆå»é‡ï¼ŒæŒ‰åˆ†æ•°æ’åº
  6. æ‰©å±•è¡Œå·èŒƒå›´ï¼ˆåŠ å…¥ä¸Šä¸‹æ–‡è¡Œï¼‰
  7. åˆå¹¶é‡å çš„è¡Œå·èŒƒå›´
  8. è¿”å›ç»“æœï¼ˆæ ‡æ³¨ `semantic_available` çŠ¶æ€ï¼‰
- [ ] **è¡Œå·èŒƒå›´åˆå¹¶è§„åˆ™**ï¼š
  - ä¸¤ä¸ªèŒƒå›´é‡å æˆ–ç›¸é‚»ï¼ˆé—´éš” â‰¤3 è¡Œï¼‰æ—¶åˆå¹¶
  - åˆå¹¶åçš„åˆ†æ•°å–æœ€é«˜å€¼
  - åˆå¹¶åçš„åŒ¹é…ç±»å‹æ ‡è®°ä¸º "merged"
- [ ] **é™çº§è¡Œä¸º**ï¼š
  - æ–‡ä»¶æœªç´¢å¼•æ—¶ï¼Œ`semantic_available=False`ï¼Œä»…è¿”å›ç²¾ç¡®æœç´¢ç»“æœ
  - ç²¾ç¡®æœç´¢å¤±è´¥æ—¶ï¼Œè‹¥æ–‡ä»¶å·²ç´¢å¼•åˆ™è¿”å›è¯­ä¹‰æœç´¢ç»“æœ
  - ä¸¤è·¯éƒ½å¤±è´¥æ—¶ï¼Œè¿”å›ç©ºç»“æœ
- [ ] **ä¾èµ–æ¨¡å—**ï¼š
  - `FileSearchService`ï¼ˆé˜¶æ®µäºŒï¼‰- ç²¾ç¡®æœç´¢å¼•æ“
  - `RAGService`ï¼ˆæœ¬é˜¶æ®µ 5.1ï¼‰- è¯­ä¹‰æœç´¢å¼•æ“
- [ ] **è¢«è°ƒç”¨æ–¹**ï¼š`FileContentLocator`ï¼ˆé˜¶æ®µå…­ è¯­ä¹‰å®šä½è¯»å–ï¼‰

---

### 5.1 RAGService - RAG æ£€ç´¢æœåŠ¡

> **âš ï¸ æ ¸å¿ƒç»„ä»¶**ï¼šRAGService æ˜¯æ— çŠ¶æ€çš„ RAG æ£€ç´¢æœåŠ¡ï¼Œä½œä¸ºè¯­ä¹‰æœç´¢å¼•æ“è¢« `UnifiedSearchService` å’Œ `InFileSearchService` è°ƒç”¨ã€‚

- [ ] **æ–‡ä»¶è·¯å¾„**ï¼š`domain/services/rag_service.py`
- [ ] **èŒè´£**ï¼šæ‰§è¡Œ RAG è¯­ä¹‰æ£€ç´¢ï¼Œè¿”å›æ£€ç´¢ç»“æœ
- [ ] **è®¾è®¡åŸåˆ™**ï¼šæ— çŠ¶æ€ï¼Œæ£€ç´¢ç»“æœä¸ç¼“å­˜åœ¨å†…å­˜ä¸­

#### 5.1.1 æ ¸å¿ƒæ–¹æ³•

##### æ£€ç´¢æ‰§è¡Œ
- [ ] `retrieve(query, top_k) -> list[SearchResult]` - æ‰§è¡Œæ£€ç´¢ï¼Œè¿”å›ç»“æœåˆ—è¡¨
- [ ] `retrieve_with_rerank(query, top_k, rerank_model) -> list[SearchResult]` - æ£€ç´¢å¹¶é‡æ’åº
- [ ] `hybrid_retrieve(query, top_k) -> list[SearchResult]` - æ··åˆæ£€ç´¢ï¼ˆè¯­ä¹‰ + å…³é”®è¯ï¼‰
- [ ] `retrieve_from_file(file_path, query, top_k) -> list[SearchResult]` - ä»å•ä¸ªæ–‡ä»¶æ£€ç´¢ï¼ˆæ”¯æŒè¯­ä¹‰å®šä½è¯»å–ï¼‰

##### ç´¢å¼•çŠ¶æ€
- [ ] `get_index_status() -> dict` - è·å–ç´¢å¼•çŠ¶æ€
- [ ] `is_index_ready() -> bool` - æ£€æŸ¥ç´¢å¼•æ˜¯å¦å°±ç»ª
- [ ] `get_document_count() -> int` - è·å–å·²ç´¢å¼•æ–‡æ¡£æ•°é‡
- [ ] `has_indexed_file(file_path) -> bool` - æ£€æŸ¥æŒ‡å®šæ–‡ä»¶æ˜¯å¦å·²è¢«ç´¢å¼•

##### ç´¢å¼•ç®¡ç†
- [ ] `build_index(documents) -> None` - æ„å»ºç´¢å¼•
- [ ] `update_index(documents) -> None` - å¢é‡æ›´æ–°ç´¢å¼•
- [ ] `clear_index() -> None` - æ¸…é™¤ç´¢å¼•

#### 5.1.2 `retrieve_from_file` æ–¹æ³•è¯¦ç»†è®¾è®¡

> **è®¾è®¡èƒŒæ™¯**ï¼šæ”¯æŒ `InFileSearchService` çš„è¯­ä¹‰æœç´¢éƒ¨åˆ†ï¼Œåœ¨å•ä¸ªæ–‡ä»¶çš„å·²ç´¢å¼•åˆ†å—ä¸­æ‰§è¡Œè¯­ä¹‰æ£€ç´¢ã€‚

- [ ] **æ–¹æ³•ç­¾å**ï¼š`retrieve_from_file(file_path: str, query: str, top_k: int = 5) -> List[SearchResult]`
- [ ] **æ‰§è¡Œæµç¨‹**ï¼š
  1. æ ¹æ® `file_path` è¿‡æ»¤å‘é‡æ•°æ®åº“ä¸­çš„åˆ†å—ï¼ˆä½¿ç”¨å…ƒæ•°æ®è¿‡æ»¤ï¼‰
  2. å¯¹æŸ¥è¯¢è¿›è¡ŒåµŒå…¥
  3. åœ¨è¿‡æ»¤åçš„åˆ†å—ä¸­æ‰§è¡Œå‘é‡ç›¸ä¼¼åº¦æœç´¢
  4. è¿”å›åŒ¹é…çš„åˆ†å—åˆ—è¡¨ï¼ˆåŒ…å«è¡Œå·èŒƒå›´ï¼‰
- [ ] **å…ƒæ•°æ®è¿‡æ»¤**ï¼š
  - ChromaDB æ”¯æŒ `where` æ¡ä»¶è¿‡æ»¤
  - è¿‡æ»¤æ¡ä»¶ï¼š`{"source_file": file_path}`
- [ ] **è¿”å›ç»“æœ**ï¼š
  - æ¯ä¸ªç»“æœåŒ…å« `start_line`ã€`end_line`ã€`score`ã€`content`
  - ç»“æœæŒ‰ç›¸å…³æ€§åˆ†æ•°é™åºæ’åˆ—
- [ ] **é™çº§å¤„ç†**ï¼š
  - è‹¥æ–‡ä»¶æœªè¢«ç´¢å¼•ï¼Œè¿”å›ç©ºåˆ—è¡¨
  - è°ƒç”¨æ–¹ï¼ˆ`InFileSearchService`ï¼‰ä¼šå›é€€åˆ°ç²¾ç¡®æœç´¢

#### 5.1.3 `has_indexed_file` æ–¹æ³•è¯¦ç»†è®¾è®¡

> **è®¾è®¡èƒŒæ™¯**ï¼šæ”¯æŒ `InFileSearchService` çš„åˆ†å±‚é™çº§ç­–ç•¥ï¼Œå¿«é€Ÿåˆ¤æ–­æ–‡ä»¶æ˜¯å¦å·²è¢«ç´¢å¼•ã€‚

- [ ] **æ–¹æ³•ç­¾å**ï¼š`has_indexed_file(file_path: str) -> bool`
- [ ] **æ‰§è¡Œæµç¨‹**ï¼š
  1. æŸ¥è¯¢å‘é‡æ•°æ®åº“ä¸­æ˜¯å¦æœ‰è¯¥æ–‡ä»¶çš„åˆ†å—
  2. ä½¿ç”¨å…ƒæ•°æ®è¿‡æ»¤ï¼š`{"source_file": file_path}`
  3. ä»…æŸ¥è¯¢ countï¼Œä¸è¿”å›å®é™…å†…å®¹
- [ ] **æ€§èƒ½è¦æ±‚**ï¼š
  - è¿™æ˜¯ä¸€ä¸ªè½»é‡çº§çš„å…ƒæ•°æ®æŸ¥è¯¢
  - åº”åœ¨ 10ms å†…è¿”å›ç»“æœ
  - å¯è€ƒè™‘ç¼“å­˜å·²ç´¢å¼•æ–‡ä»¶åˆ—è¡¨

#### 5.1.4 å­˜å‚¨è·¯å¾„

- [ ] å‘é‡ç´¢å¼•ï¼š`.circuit_ai/chroma/`ï¼ˆç”± ChromaDB ç®¡ç†ï¼‰
- [ ] ç´¢å¼•å…ƒæ•°æ®ï¼š`.circuit_ai/rag_index_meta.json`

#### 5.1.5 SearchResult æ•°æ®ç»“æ„

```python
@dataclass
class SearchResult:
    content: str           # æ£€ç´¢åˆ°çš„å†…å®¹
    source: str            # æ¥æºï¼ˆæ–‡ä»¶è·¯å¾„æˆ–æ–‡æ¡£æ ‡é¢˜ï¼‰
    score: float           # ç›¸å…³æ€§åˆ†æ•°
    metadata: dict         # å…ƒæ•°æ®ï¼ˆé¡µç ã€ç« èŠ‚ã€è¡Œå·èŒƒå›´ç­‰ï¼‰
    start_line: int        # èµ·å§‹è¡Œå·ï¼ˆä»£ç æ–‡ä»¶ï¼‰
    end_line: int          # ç»“æŸè¡Œå·ï¼ˆä»£ç æ–‡ä»¶ï¼‰
```

#### 5.1.6 æŒ‰éœ€åŠ è½½è®¾è®¡

> **è®¾è®¡åŸåˆ™**ï¼šRAG ä¸Šä¸‹æ–‡æŒ‰éœ€åŠ è½½ï¼Œä¸å¸¸é©»å†…å­˜ï¼Œå‡å°‘èµ„æºå ç”¨ã€‚

- [ ] **åŠ è½½æ—¶æœº**ï¼š
  - ç”¨æˆ·æ¶ˆæ¯æ¶‰åŠçŸ¥è¯†åº“å†…å®¹æ—¶
  - å›¾èŠ‚ç‚¹æ˜¾å¼è¯·æ±‚æ£€ç´¢æ—¶
  - LLM éœ€è¦å‚è€ƒèµ„æ–™æ—¶
- [ ] **æ¸…ç†æ—¶æœº**ï¼š
  - æ£€ç´¢ç»“æœä½¿ç”¨å®Œæ¯•å
  - ä¼šè¯åˆ‡æ¢æ—¶
  - å†…å­˜å‹åŠ›å¤§æ—¶
- [ ] **ç¼“å­˜ç­–ç•¥**ï¼š
  - ç›¸åŒæŸ¥è¯¢åœ¨ä¸€å®šæ—¶é—´å†…å¤ç”¨ç¼“å­˜
  - ç¼“å­˜è¿‡æœŸæ—¶é—´å¯é…ç½®ï¼ˆé»˜è®¤ 5 åˆ†é’Ÿï¼‰

#### 5.1.5 æ³¨å†Œåˆ° StateCoordinator

- [ ] åœ¨åˆå§‹åŒ–æ—¶å‘ `StateCoordinator` æ³¨å†Œè‡ªèº«
- [ ] å‚ä¸ç»Ÿä¸€çš„å¿«ç…§/æ¢å¤æµç¨‹
- [ ] å“åº”ä¼šè¯ç”Ÿå‘½å‘¨æœŸäº‹ä»¶

#### 5.1.6 è¢«è°ƒç”¨æ–¹

- [ ] `UnifiedSearchService`ï¼ˆæœ¬é˜¶æ®µ 5.0ï¼‰- ç»Ÿä¸€æœç´¢é—¨é¢
- [ ] `rag_node`ï¼ˆå›¾èŠ‚ç‚¹ï¼‰
- [ ] `free_work_node`ï¼ˆå›¾èŠ‚ç‚¹ï¼‰

---

### 5.2 çŸ¥è¯†æ£€ç´¢åŸŸæ¶æ„æ¦‚è§ˆ

> **æ¶æ„è®¾è®¡åŸåˆ™**ï¼š
> - å•ä¸€èŒè´£ï¼šæ¯ä¸ªæ¨¡å—ä¸“æ³¨äºä¸€ä¸ªæ˜ç¡®çš„èŒè´£
> - å¼€é—­åŸåˆ™ï¼šé€šè¿‡ç­–ç•¥æ¨¡å¼æ”¯æŒæ‰©å±•
> - ä¾èµ–å€’ç½®ï¼šé«˜å±‚æ¨¡å—ä¾èµ–æŠ½è±¡æ¥å£ï¼Œä¸ä¾èµ–å…·ä½“å®ç°
> - æ•°æ®ç±»å‹åŒ–ï¼šä½¿ç”¨ dataclass å®šä¹‰æ ‡å‡†åŒ–æ•°æ®ç»“æ„ï¼Œç¡®ä¿ç±»å‹å®‰å…¨

> **çŸ¥è¯†åº“æ ¸å¿ƒèƒ½åŠ›çŸ©é˜µ**ï¼š
> - **æ–‡æ¡£å¤„ç†**ï¼šPDF/Word/Markdown è§£æã€å…ƒæ•°æ®æå–ã€æ™ºèƒ½åˆ†å—
> - **å‘é‡å­˜å‚¨**ï¼šChromaDB æœ¬åœ°æŒä¹…åŒ–ã€å¤šé›†åˆç®¡ç†ã€å¢é‡æ›´æ–°
> - **æ£€ç´¢ç­–ç•¥**ï¼šå‘é‡è¯­ä¹‰æ£€ç´¢ã€BM25 å…³é”®è¯æ£€ç´¢ã€RRF èåˆã€äº¤å‰ç¼–ç å™¨é‡æ’åº
> - **ä»£ç ç´¢å¼•**ï¼šSPICE è¯­æ³•æ„ŸçŸ¥åˆ†å—ã€æ–‡ä»¶å˜æ›´ç›‘å¬ã€é˜²æŠ–åŠ¨å¢é‡æ›´æ–°
> - **ä¸Šä¸‹æ–‡æ‰©å±•**ï¼šçˆ¶å­åˆ†å—ã€æ»‘åŠ¨çª—å£ã€è¯­ä¹‰è¾¹ç•Œæ£€æµ‹

#### 5.2.1 çŸ¥è¯†æ£€ç´¢åŸŸç›®å½•ç»“æ„

```
domain/knowledge/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ models/                          # æ•°æ®æ¨¡å‹å®šä¹‰
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ document_chunk.py            # æ–‡æ¡£åˆ†ç‰‡æ•°æ®ç±»
â”‚   â”œâ”€â”€ search_result.py             # æ£€ç´¢ç»“æœæ•°æ®ç±»
â”‚   â””â”€â”€ index_status.py              # ç´¢å¼•çŠ¶æ€æ•°æ®ç±»
â”œâ”€â”€ document/                        # æ–‡æ¡£å¤„ç†æ¨¡å—ç»„
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ document_processor.py        # æ–‡æ¡£å¤„ç†é—¨é¢ç±»
â”‚   â”œâ”€â”€ pdf_extractor.py             # PDF æ–‡æœ¬æå–
â”‚   â”œâ”€â”€ word_extractor.py            # Word æ–‡æ¡£æå–
â”‚   â”œâ”€â”€ markdown_extractor.py        # Markdown è§£æ
â”‚   â”œâ”€â”€ metadata_extractor.py        # å…ƒæ•°æ®æå–
â”‚   â””â”€â”€ chunking/                    # åˆ†å—ç­–ç•¥æ¨¡å—ç»„
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ chunking_strategy.py     # åˆ†å—ç­–ç•¥æŠ½è±¡åŸºç±»
â”‚       â”œâ”€â”€ semantic_chunker.py      # è¯­ä¹‰åˆ†å—å™¨
â”‚       â”œâ”€â”€ recursive_chunker.py     # é€’å½’åˆ†å—å™¨
â”‚       â””â”€â”€ parent_child_chunker.py  # çˆ¶å­åˆ†å—å™¨
â”œâ”€â”€ code/                            # ä»£ç ç´¢å¼•æ¨¡å—ç»„
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ code_indexer.py              # ä»£ç ç´¢å¼•å™¨é—¨é¢ç±»
â”‚   â”œâ”€â”€ spice_chunker.py             # SPICE è¯­æ³•æ„ŸçŸ¥åˆ†å—
â”‚   â”œâ”€â”€ python_chunker.py            # Python ä»£ç åˆ†å—
â”‚   â”œâ”€â”€ file_change_handler.py       # æ–‡ä»¶å˜æ›´å¤„ç†
â”‚   â””â”€â”€ debounced_indexer.py         # é˜²æŠ–åŠ¨ç´¢å¼•è°ƒåº¦
â”œâ”€â”€ embedding/                       # åµŒå…¥æ¨¡å‹æ¨¡å—ç»„
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ embedding_service.py         # åµŒå…¥æœåŠ¡é—¨é¢ç±»ï¼ˆç»Ÿä¸€æœ¬åœ°/çº¿ä¸Šæ¥å£ï¼‰
â”‚   â”œâ”€â”€ base_embedding_client.py     # åµŒå…¥å®¢æˆ·ç«¯æŠ½è±¡åŸºç±»
â”‚   â”œâ”€â”€ local_embedding_client.py    # æœ¬åœ°åµŒå…¥æ¨¡å‹å®¢æˆ·ç«¯
â”‚   â”œâ”€â”€ model_loader.py              # æœ¬åœ°æ¨¡å‹åŠ è½½å™¨
â”‚   â””â”€â”€ batch_embedder.py            # æ‰¹é‡åµŒå…¥å¤„ç†
â”œâ”€â”€ vector/                          # å‘é‡å­˜å‚¨æ¨¡å—ç»„
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ vector_store.py              # é—¨é¢ç±»ï¼Œç®¡ç†æ•°æ®åº“è¿æ¥å’Œé›†åˆ
â”‚   â”œâ”€â”€ collection_manager.py        # é›†åˆç®¡ç†å™¨
â”‚   â”œâ”€â”€ incremental_updater.py       # å¢é‡æ›´æ–°å™¨
â”‚   â””â”€â”€ cache_manager.py             # æŸ¥è¯¢ç¼“å­˜ç®¡ç†
â”œâ”€â”€ retrieval/                       # æ£€ç´¢æ¨¡å—ç»„
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ retrieval_service.py         # æ£€ç´¢æœåŠ¡é—¨é¢ç±»
â”‚   â”œâ”€â”€ hybrid_searcher.py           # æ··åˆæ£€ç´¢å™¨ï¼ˆå‘é‡ + BM25 + RRFï¼‰
â”‚   â”œâ”€â”€ query_expander.py            # æŸ¥è¯¢æ‰©å±•å™¨
â”‚   â”œâ”€â”€ reranker.py                  # é‡æ’åºå™¨
â”‚   â””â”€â”€ context_expander.py          # ä¸Šä¸‹æ–‡çª—å£æ‰©å±•å™¨
â””â”€â”€ index_manager.py                 # ç´¢å¼•ç®¡ç†å™¨ï¼ˆç»Ÿä¸€å…¥å£ï¼‰
```


#### 5.2.2 çŸ¥è¯†æ£€ç´¢æ•°æ®æµå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ–‡æ¡£ç´¢å¼•æ•°æ®æµè½¬è·¯å¾„                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  [ç”¨æˆ·è§¦å‘ç´¢å¼•]                                                          â”‚
â”‚       â”‚                                                                 â”‚
â”‚       â–¼                                                                 â”‚
â”‚  IndexManager.index_documents(folder_path)                              â”‚
â”‚       â”‚                                                                 â”‚
â”‚       â”œâ”€â”€â–º DocumentProcessor.process_folder()                           â”‚
â”‚       â”‚         â”‚                                                       â”‚
â”‚       â”‚         â”œâ”€â”€â–º PDFExtractor / WordExtractor / MarkdownExtractor   â”‚
â”‚       â”‚         â”‚         â”‚                                             â”‚
â”‚       â”‚         â”‚         â–¼                                             â”‚
â”‚       â”‚         â”‚    [åŸå§‹æ–‡æœ¬ + ç»“æ„ä¿¡æ¯]                               â”‚
â”‚       â”‚         â”‚                                                       â”‚
â”‚       â”‚         â”œâ”€â”€â–º MetadataExtractor.extract()                        â”‚
â”‚       â”‚         â”‚         â”‚                                             â”‚
â”‚       â”‚         â”‚         â–¼                                             â”‚
â”‚       â”‚         â”‚    [æ ‡é¢˜ã€ä½œè€…ã€æ‘˜è¦ã€å…³é”®è¯]                          â”‚
â”‚       â”‚         â”‚                                                       â”‚
â”‚       â”‚         â””â”€â”€â–º ChunkingStrategy.chunk()                           â”‚
â”‚       â”‚                   â”‚                                             â”‚
â”‚       â”‚                   â”œâ”€â”€â–º SemanticChunkerï¼ˆè¯­ä¹‰è¾¹ç•Œï¼‰               â”‚
â”‚       â”‚                   â”œâ”€â”€â–º RecursiveChunkerï¼ˆé€’å½’åˆ†å‰²ï¼‰              â”‚
â”‚       â”‚                   â””â”€â”€â–º ParentChildChunkerï¼ˆçˆ¶å­åˆ†å—ï¼‰            â”‚
â”‚       â”‚                         â”‚                                       â”‚
â”‚       â”‚                         â–¼                                       â”‚
â”‚       â”‚                    [DocumentChunk åˆ—è¡¨]                         â”‚
â”‚       â”‚                                                                 â”‚
â”‚       â”œâ”€â”€â–º EmbeddingService.embed_batch(chunks)                         â”‚
â”‚       â”‚         â”‚                                                       â”‚
â”‚       â”‚         â”œâ”€â”€â–º BatchEmbedder.process()ï¼ˆæ‰¹é‡å¤„ç† + GPUåŠ é€Ÿï¼‰       â”‚
â”‚       â”‚         â”‚                                                       â”‚
â”‚       â”‚         â–¼                                                       â”‚
â”‚       â”‚    [å‘é‡åˆ—è¡¨ + å…ƒæ•°æ®]                                           â”‚
â”‚       â”‚                                                                 â”‚
â”‚       â””â”€â”€â–º VectorStore.add_documents_batch()                            â”‚
â”‚                 â”‚                                                       â”‚
â”‚                 â”œâ”€â”€â–º IncrementalUpdater.upsert()ï¼ˆå¢é‡æ›´æ–°ï¼‰             â”‚
â”‚                 â”‚                                                       â”‚
â”‚                 â–¼                                                       â”‚
â”‚            [ChromaDB æŒä¹…åŒ–å­˜å‚¨]                                         â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ä»£ç ç´¢å¼•æ•°æ®æµè½¬è·¯å¾„                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  [æ–‡ä»¶å˜æ›´äº‹ä»¶]                                                          â”‚
â”‚       â”‚                                                                 â”‚
â”‚       â”œâ”€â”€â–º FileWatcherWorker æ£€æµ‹å˜æ›´                                   â”‚
â”‚       â”‚                                                                 â”‚
â”‚       â–¼                                                                 â”‚
â”‚  FileChangeHandler.on_file_changed(event)                               â”‚
â”‚       â”‚                                                                 â”‚
â”‚       â”œâ”€â”€â–º è¿‡æ»¤å¿½ç•¥æ–‡ä»¶ï¼ˆ.tmpã€éšè—æ–‡ä»¶ã€ç³»ç»Ÿç›®å½•ï¼‰                       â”‚
â”‚       â”‚                                                                 â”‚
â”‚       â–¼                                                                 â”‚
â”‚  DebouncedIndexer.schedule_update(file_path)                            â”‚
â”‚       â”‚                                                                 â”‚
â”‚       â”œâ”€â”€â–º 500ms é˜²æŠ–åŠ¨å»¶è¿Ÿ                                             â”‚
â”‚       â”œâ”€â”€â–º åˆå¹¶åŒä¸€æ–‡ä»¶çš„å¤šæ¬¡å˜æ›´                                        â”‚
â”‚       â”‚                                                                 â”‚
â”‚       â–¼                                                                 â”‚
â”‚  CodeIndexer.update_index(file_path)                                    â”‚
â”‚       â”‚                                                                 â”‚
â”‚       â”œâ”€â”€â–º è®¡ç®—æ–‡ä»¶å†…å®¹ SHA256 å“ˆå¸Œ                                      â”‚
â”‚       â”œâ”€â”€â–º æ¯”å¯¹å·²ç´¢å¼•å“ˆå¸Œï¼ˆå¢é‡åˆ¤æ–­ï¼‰                                    â”‚
â”‚       â”‚                                                                 â”‚
â”‚       â”œâ”€ å“ˆå¸Œç›¸åŒ â”€â”€â–º è·³è¿‡ç´¢å¼•                                          â”‚
â”‚       â”‚                                                                 â”‚
â”‚       â”œâ”€ å“ˆå¸Œä¸åŒ â”€â”€â–º SpiceChunker / PythonChunker                      â”‚
â”‚       â”‚                   â”‚                                             â”‚
â”‚       â”‚                   â”œâ”€â”€â–º è¯­æ³•æ„ŸçŸ¥åˆ†å—ï¼ˆ.subckt/.ends è¾¹ç•Œï¼‰        â”‚
â”‚       â”‚                   â”‚                                             â”‚
â”‚       â”‚                   â–¼                                             â”‚
â”‚       â”‚              [ä»£ç åˆ†ç‰‡ + è¯­æ³•æ ‡ç­¾]                               â”‚
â”‚       â”‚                                                                 â”‚
â”‚       â””â”€â”€â–º VectorStore.upsert_code_chunks()                             â”‚
â”‚                 â”‚                                                       â”‚
â”‚                 â–¼                                                       â”‚
â”‚            [code é›†åˆæ›´æ–°]                                               â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ™ºèƒ½æ£€ç´¢æ•°æ®æµè½¬è·¯å¾„                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  [ç”¨æˆ·æŸ¥è¯¢]                                                              â”‚
â”‚       â”‚                                                                 â”‚
â”‚       â–¼                                                                 â”‚
â”‚  RetrievalService.retrieve(query, options)                              â”‚
â”‚       â”‚                                                                 â”‚
â”‚       â”œâ”€â”€â–º QueryExpander.expand(query)                                  â”‚
â”‚       â”‚         â”‚                                                       â”‚
â”‚       â”‚         â”œâ”€â”€â–º åŒä¹‰è¯æ‰©å±•ï¼ˆæ”¾å¤§å™¨ â†’ amplifierï¼‰                    â”‚
â”‚       â”‚         â”œâ”€â”€â–º ç”µè·¯æœ¯è¯­æå–ï¼ˆR1ã€C2ã€Voutï¼‰                        â”‚
â”‚       â”‚         â””â”€â”€â–º ä¸­è‹±æ–‡äº’è¯‘                                         â”‚
â”‚       â”‚               â”‚                                                 â”‚
â”‚       â”‚               â–¼                                                 â”‚
â”‚       â”‚          [æ‰©å±•æŸ¥è¯¢åˆ—è¡¨]                                          â”‚
â”‚       â”‚                                                                 â”‚
â”‚       â”œâ”€â”€â–º CacheManager.get_cached(query_hash)                          â”‚
â”‚       â”‚         â”‚                                                       â”‚
â”‚       â”‚         â”œâ”€ ç¼“å­˜å‘½ä¸­ â”€â”€â–º ç›´æ¥è¿”å›                                â”‚
â”‚       â”‚         â”‚                                                       â”‚
â”‚       â”‚         â””â”€ ç¼“å­˜æœªå‘½ä¸­ â”€â”€â–º ç»§ç»­æ£€ç´¢                              â”‚
â”‚       â”‚                                                                 â”‚
â”‚       â”œâ”€â”€â–º HybridSearcher.search()                                      â”‚
â”‚       â”‚         â”‚                                                       â”‚
â”‚       â”‚         â”œâ”€â”€â–º vector_search()ï¼ˆè¯­ä¹‰ç›¸ä¼¼åº¦ï¼‰                       â”‚
â”‚       â”‚         â”‚         â”‚                                             â”‚
â”‚       â”‚         â”‚         â””â”€â”€â–º EmbeddingService.embed(query)            â”‚
â”‚       â”‚         â”‚                                                       â”‚
â”‚       â”‚         â”œâ”€â”€â–º bm25_search()ï¼ˆå…³é”®è¯åŒ¹é…ï¼‰                         â”‚
â”‚       â”‚         â”‚                                                       â”‚
â”‚       â”‚         â””â”€â”€â–º RRF_fuse()ï¼ˆå€’æ•°æ’åèåˆï¼‰                          â”‚
â”‚       â”‚                   â”‚                                             â”‚
â”‚       â”‚                   â–¼                                             â”‚
â”‚       â”‚              [å€™é€‰ç»“æœ top_k * 3]                                â”‚
â”‚       â”‚                                                                 â”‚
â”‚       â”œâ”€â”€â–º Reranker.rerank(query, candidates)                           â”‚
â”‚       â”‚         â”‚                                                       â”‚
â”‚       â”‚         â”œâ”€â”€â–º CrossEncoder ç²¾æ’                                  â”‚
â”‚       â”‚         â”‚                                                       â”‚
â”‚       â”‚         â–¼                                                       â”‚
â”‚       â”‚    [ç²¾æ’ç»“æœ top_k]                                              â”‚
â”‚       â”‚                                                                 â”‚
â”‚       â”œâ”€â”€â–º ContextExpander.expand(results)                              â”‚
â”‚       â”‚         â”‚                                                       â”‚
â”‚       â”‚         â”œâ”€â”€â–º è·å–ç›¸é‚»åˆ†ç‰‡ï¼ˆçˆ¶å­åˆ†å—ï¼‰                            â”‚
â”‚       â”‚         â”œâ”€â”€â–º è¯­ä¹‰è¾¹ç•Œæ£€æµ‹                                        â”‚
â”‚       â”‚         â””â”€â”€â–º Token é¢„ç®—æˆªæ–­                                      â”‚
â”‚       â”‚               â”‚                                                 â”‚
â”‚       â”‚               â–¼                                                 â”‚
â”‚       â”‚          [æ‰©å±•ä¸Šä¸‹æ–‡ç»“æœ]                                        â”‚
â”‚       â”‚                                                                 â”‚
â”‚       â””â”€â”€â–º CacheManager.set_cached(query_hash, results)                 â”‚
â”‚                 â”‚                                                       â”‚
â”‚                 â–¼                                                       â”‚
â”‚            [SearchResult åˆ—è¡¨]                                           â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 5.2.3 çŸ¥è¯†æ£€ç´¢äº‹ä»¶å®šä¹‰

> **è®¾è®¡åŸåˆ™**ï¼šé›†ä¸­å®šä¹‰æ‰€æœ‰çŸ¥è¯†æ£€ç´¢ç›¸å…³äº‹ä»¶å¸¸é‡ï¼Œé¿å…äº‹ä»¶åæ‹¼å†™é”™è¯¯ï¼Œä¾¿äºè¿½è¸ªå‘å¸ƒè€…å’Œè®¢é˜…è€…

- [ ] **æ–‡ä»¶è·¯å¾„**ï¼š`shared/events/knowledge_events.py`
- [ ] **äº‹ä»¶å¸¸é‡å®šä¹‰**ï¼š
  ```python
  class KnowledgeEvents:
      """çŸ¥è¯†æ£€ç´¢ç›¸å…³äº‹ä»¶å®šä¹‰"""
      
      # å‘é‡å­˜å‚¨äº‹ä»¶
      VECTOR_STORE_READY = "knowledge.vector_store_ready"
      VECTOR_STORE_ERROR = "knowledge.vector_store_error"
      VECTOR_STORE_COLLECTION_CREATED = "knowledge.collection_created"
      
      # æ–‡æ¡£ç´¢å¼•äº‹ä»¶
      DOCUMENT_INDEX_STARTED = "knowledge.document_index_started"
      DOCUMENT_INDEX_PROGRESS = "knowledge.document_index_progress"
      DOCUMENT_INDEX_COMPLETE = "knowledge.document_index_complete"
      DOCUMENT_INDEX_ERROR = "knowledge.document_index_error"
      DOCUMENT_PROCESSING_STARTED = "knowledge.document_processing_started"
      DOCUMENT_PROCESSING_COMPLETE = "knowledge.document_processing_complete"
      
      # ä»£ç ç´¢å¼•äº‹ä»¶
      CODE_INDEX_STARTED = "knowledge.code_index_started"
      CODE_INDEX_UPDATED = "knowledge.code_index_updated"
      CODE_INDEX_COMPLETE = "knowledge.code_index_complete"
      CODE_INDEX_ERROR = "knowledge.code_index_error"
      CODE_FILE_INDEXED = "knowledge.code_file_indexed"
      CODE_FILE_REMOVED = "knowledge.code_file_removed"
      
      # æ£€ç´¢äº‹ä»¶
      SEARCH_STARTED = "knowledge.search_started"
      SEARCH_COMPLETE = "knowledge.search_complete"
      SEARCH_ERROR = "knowledge.search_error"
      SEARCH_CACHE_HIT = "knowledge.search_cache_hit"
      
      # åµŒå…¥æ¨¡å‹äº‹ä»¶
      EMBEDDING_MODEL_LOADING = "knowledge.embedding_model_loading"
      EMBEDDING_MODEL_READY = "knowledge.embedding_model_ready"
      EMBEDDING_MODEL_ERROR = "knowledge.embedding_model_error"
      EMBEDDING_PROVIDER_CHANGED = "knowledge.embedding_provider_changed"
      EMBEDDING_DIMENSION_CHANGED = "knowledge.embedding_dimension_changed"
      
      # é‡æ’åºäº‹ä»¶
      RERANKER_MODEL_LOADING = "knowledge.reranker_model_loading"
      RERANKER_MODEL_READY = "knowledge.reranker_model_ready"
  ```
- [ ] **åµŒå…¥æ¨¡å‹å‚å•†åˆ‡æ¢äº‹ä»¶æºå¸¦æ•°æ®**ï¼š
  ```python
  # EMBEDDING_PROVIDER_CHANGED äº‹ä»¶æ•°æ®
  {
    "old_provider": str,      # æ—§å‚å•†æ ‡è¯†
    "new_provider": str,      # æ–°å‚å•†æ ‡è¯†
    "old_model": str,         # æ—§æ¨¡å‹åç§°
    "new_model": str,         # æ–°æ¨¡å‹åç§°
    "old_dimension": int,     # æ—§å‘é‡ç»´åº¦
    "new_dimension": int,     # æ–°å‘é‡ç»´åº¦
    "requires_rebuild": bool, # æ˜¯å¦éœ€è¦é‡å»ºç´¢å¼•
  }
  ```
- [ ] **è¢«è°ƒç”¨æ–¹**ï¼šæ‰€æœ‰çŸ¥è¯†æ£€ç´¢ç›¸å…³æ¨¡å—é€šè¿‡å¯¼å…¥æ­¤å¸¸é‡ç±»ä½¿ç”¨äº‹ä»¶å

#### 5.2.4 çŸ¥è¯†æ£€ç´¢æ•°æ®æ¨¡å‹ (`domain/knowledge/models/`)

> **è®¾è®¡åŸåˆ™**ï¼šä½¿ç”¨ dataclass å®šä¹‰æ ‡å‡†åŒ–æ•°æ®ç»“æ„ï¼Œç¡®ä¿ç±»å‹å®‰å…¨ï¼Œæä¾› IDE è‡ªåŠ¨è¡¥å…¨æ”¯æŒ

##### 5.2.4.1 `document_chunk.py` - æ–‡æ¡£åˆ†ç‰‡æ•°æ®ç±»

- [ ] **æ–‡ä»¶è·¯å¾„**ï¼š`domain/knowledge/models/document_chunk.py`
- [ ] **èŒè´£**ï¼šå®šä¹‰æ–‡æ¡£åˆ†ç‰‡çš„æ ‡å‡†åŒ–æ•°æ®ç»“æ„
- [ ] **æ•°æ®ç±»å®šä¹‰**ï¼š
  - `DocumentChunk` - æ–‡æ¡£åˆ†ç‰‡
    - `chunk_id: str` - åˆ†ç‰‡å”¯ä¸€æ ‡è¯†ï¼ˆUUIDï¼‰
    - `content: str` - åˆ†ç‰‡æ–‡æœ¬å†…å®¹
    - `source_file: str` - æºæ–‡ä»¶è·¯å¾„
    - `chunk_index: int` - åˆ†ç‰‡åœ¨æ–‡æ¡£ä¸­çš„ç´¢å¼•
    - `start_char: int` - èµ·å§‹å­—ç¬¦ä½ç½®
    - `end_char: int` - ç»“æŸå­—ç¬¦ä½ç½®
    - `token_count: int` - Token æ•°é‡
    - `metadata: ChunkMetadata` - åˆ†ç‰‡å…ƒæ•°æ®
    - `parent_chunk_id: Optional[str]` - çˆ¶åˆ†ç‰‡ IDï¼ˆçˆ¶å­åˆ†å—æ—¶ï¼‰
    - `child_chunk_ids: List[str]` - å­åˆ†ç‰‡ ID åˆ—è¡¨
  - `ChunkMetadata` - åˆ†ç‰‡å…ƒæ•°æ®
    - `title: Optional[str]` - æ–‡æ¡£æ ‡é¢˜
    - `authors: Optional[List[str]]` - ä½œè€…åˆ—è¡¨
    - `section: Optional[str]` - æ‰€å±ç« èŠ‚
    - `page_number: Optional[int]` - é¡µç 
    - `chunk_type: str` - åˆ†ç‰‡ç±»å‹ï¼ˆtext/code/formula/tableï¼‰
    - `language: str` - è¯­è¨€ï¼ˆen/zhï¼‰
    - `created_at: str` - åˆ›å»ºæ—¶é—´
    - `content_hash: str` - å†…å®¹å“ˆå¸Œï¼ˆç”¨äºå¢é‡æ›´æ–°ï¼‰
- [ ] **æ ¸å¿ƒæ–¹æ³•**ï¼š
  - `to_dict()` - åºåˆ—åŒ–ä¸ºå­—å…¸
  - `from_dict(data)` - ä»å­—å…¸ååºåˆ—åŒ–
  - `get_embedding_text()` - è·å–ç”¨äºåµŒå…¥çš„æ–‡æœ¬ï¼ˆå¯åŒ…å«å…ƒæ•°æ®å‰ç¼€ï¼‰
- [ ] **è¢«è°ƒç”¨æ–¹**ï¼šæ‰€æœ‰æ–‡æ¡£å¤„ç†å’Œæ£€ç´¢æ¨¡å—

##### 5.2.4.2 `search_result.py` - æ£€ç´¢ç»“æœæ•°æ®ç±»

- [ ] **æ–‡ä»¶è·¯å¾„**ï¼š`domain/knowledge/models/search_result.py`
- [ ] **èŒè´£**ï¼šå®šä¹‰æ£€ç´¢ç»“æœçš„æ ‡å‡†åŒ–æ•°æ®ç»“æ„
- [ ] **æ•°æ®ç±»å®šä¹‰**ï¼š
  - `SearchResult` - å•æ¡æ£€ç´¢ç»“æœ
    - `chunk: DocumentChunk` - åŒ¹é…çš„æ–‡æ¡£åˆ†ç‰‡
    - `score: float` - ç›¸å…³åº¦åˆ†æ•°ï¼ˆ0-1ï¼‰
    - `retrieval_method: str` - æ£€ç´¢æ–¹æ³•ï¼ˆvector/bm25/hybridï¼‰
    - `rerank_score: Optional[float]` - é‡æ’åºåˆ†æ•°
    - `expanded_context: Optional[str]` - æ‰©å±•åçš„ä¸Šä¸‹æ–‡
    - `highlight_ranges: List[Tuple[int, int]]` - é«˜äº®èŒƒå›´
  - `SearchResults` - æ£€ç´¢ç»“æœé›†åˆ
    - `results: List[SearchResult]` - ç»“æœåˆ—è¡¨
    - `query: str` - åŸå§‹æŸ¥è¯¢
    - `expanded_queries: List[str]` - æ‰©å±•åçš„æŸ¥è¯¢
    - `total_candidates: int` - å€™é€‰æ€»æ•°
    - `search_time_ms: float` - æ£€ç´¢è€—æ—¶
    - `cache_hit: bool` - æ˜¯å¦ç¼“å­˜å‘½ä¸­
- [ ] **è¢«è°ƒç”¨æ–¹**ï¼šæ£€ç´¢æœåŠ¡ã€ä¸Šä¸‹æ–‡æ£€ç´¢æ¨¡å—

##### 5.2.4.3 `index_status.py` - ç´¢å¼•çŠ¶æ€æ•°æ®ç±»

- [ ] **æ–‡ä»¶è·¯å¾„**ï¼š`domain/knowledge/models/index_status.py`
- [ ] **èŒè´£**ï¼šå®šä¹‰ç´¢å¼•çŠ¶æ€çš„æ ‡å‡†åŒ–æ•°æ®ç»“æ„
- [ ] **æ•°æ®ç±»å®šä¹‰**ï¼š
  - `IndexStatus` - ç´¢å¼•çŠ¶æ€
    - `collection_name: str` - é›†åˆåç§°
    - `document_count: int` - æ–‡æ¡£æ•°é‡
    - `chunk_count: int` - åˆ†ç‰‡æ•°é‡
    - `last_updated: str` - æœ€åæ›´æ–°æ—¶é—´
    - `index_size_bytes: int` - ç´¢å¼•å¤§å°
    - `is_indexing: bool` - æ˜¯å¦æ­£åœ¨ç´¢å¼•
    - `progress: float` - ç´¢å¼•è¿›åº¦ï¼ˆ0-1ï¼‰
    - `error_message: Optional[str]` - é”™è¯¯ä¿¡æ¯
  - `IndexedFile` - å·²ç´¢å¼•æ–‡ä»¶ä¿¡æ¯
    - `file_path: str` - æ–‡ä»¶è·¯å¾„
    - `file_hash: str` - æ–‡ä»¶å†…å®¹å“ˆå¸Œ
    - `chunk_count: int` - åˆ†ç‰‡æ•°é‡
    - `indexed_at: str` - ç´¢å¼•æ—¶é—´
    - `file_size: int` - æ–‡ä»¶å¤§å°
    - `file_type: str` - æ–‡ä»¶ç±»å‹
- [ ] **è¢«è°ƒç”¨æ–¹**ï¼šç´¢å¼•ç®¡ç†å™¨ã€ç´¢å¼•çŠ¶æ€å¯¹è¯æ¡†

---

### 5.3 æ–‡æ¡£å¤„ç†æ¨¡å—ç»„ (`domain/knowledge/document/`)

> **æ¨¡å—ç»„è®¾è®¡è¯´æ˜**ï¼šæ–‡æ¡£å¤„ç†æ¶‰åŠå¤šç§æ–‡ä»¶æ ¼å¼å’Œåˆ†å—ç­–ç•¥ï¼Œä¸ºéµå¾ªå•ä¸€èŒè´£åŸåˆ™ï¼Œæ‹†åˆ†ä¸ºä»¥ä¸‹å­æ¨¡å—ï¼š
> - `document_processor.py` - é—¨é¢ç±»ï¼Œåè°ƒå„æå–å™¨å’Œåˆ†å—å™¨
> - `pdf_extractor.py` - PDF æ–‡æœ¬æå–
> - `word_extractor.py` - Word æ–‡æ¡£æå–
> - `markdown_extractor.py` - Markdown è§£æ
> - `metadata_extractor.py` - å…ƒæ•°æ®æå–
> - `chunking/` - åˆ†å—ç­–ç•¥æ¨¡å—ç»„

#### 5.1.1 `document_processor.py` - æ–‡æ¡£å¤„ç†é—¨é¢ç±»

> **åˆå§‹åŒ–é¡ºåº**ï¼šæ— éœ€æ˜¾å¼åˆå§‹åŒ–ï¼Œä½œä¸ºå·¥å…·ç±»æŒ‰éœ€å®ä¾‹åŒ–

- [ ] **æ–‡ä»¶è·¯å¾„**ï¼š`domain/knowledge/document/document_processor.py`
- [ ] **èŒè´£**ï¼šä½œä¸ºæ–‡æ¡£å¤„ç†çš„ç»Ÿä¸€å…¥å£ï¼Œåè°ƒå„æå–å™¨å’Œåˆ†å—å™¨
- [ ] **æ ¸å¿ƒåŠŸèƒ½**ï¼š
  - `process_file(file_path)` - å¤„ç†å•ä¸ªæ–‡ä»¶ï¼Œè¿”å› DocumentChunk åˆ—è¡¨
  - `process_folder(folder_path, pattern)` - æ‰¹é‡å¤„ç†æ–‡ä»¶å¤¹
  - `get_supported_extensions()` - è·å–æ”¯æŒçš„æ–‡ä»¶æ‰©å±•å
  - `estimate_processing_time(file_path)` - ä¼°ç®—å¤„ç†æ—¶é—´
- [ ] **æ–‡ä»¶ç±»å‹è·¯ç”±**ï¼š
  - `.pdf` â†’ `PDFExtractor`
  - `.docx` â†’ `WordExtractor`
  - `.md`ã€`.markdown` â†’ `MarkdownExtractor`
  - `.txt` â†’ ç›´æ¥è¯»å–æ–‡æœ¬
- [ ] **å¤„ç†æµç¨‹**ï¼š
  1. æ ¹æ®æ–‡ä»¶æ‰©å±•åé€‰æ‹©æå–å™¨
  2. è°ƒç”¨æå–å™¨è·å–åŸå§‹æ–‡æœ¬å’Œç»“æ„ä¿¡æ¯
  3. è°ƒç”¨ `MetadataExtractor` æå–å…ƒæ•°æ®
  4. æ ¹æ®é…ç½®é€‰æ‹©åˆ†å—ç­–ç•¥
  5. è°ƒç”¨åˆ†å—å™¨ç”Ÿæˆ DocumentChunk åˆ—è¡¨
  6. è¿”å›å¸¦æœ‰å®Œæ•´å…ƒæ•°æ®çš„åˆ†ç‰‡åˆ—è¡¨
- [ ] **ä¾èµ–æ¨¡å—**ï¼š
  - `PDFExtractor`ã€`WordExtractor`ã€`MarkdownExtractor`
  - `MetadataExtractor`
  - `ChunkingStrategy` åŠå…¶å®ç°ç±»
- [ ] **è¢«è°ƒç”¨æ–¹**ï¼š`IndexManager`ï¼ˆç´¢å¼•æ—¶ï¼‰

#### 5.1.2 `pdf_extractor.py` - PDF æ–‡æœ¬æå–å™¨

- [ ] **æ–‡ä»¶è·¯å¾„**ï¼š`domain/knowledge/document/pdf_extractor.py`
- [ ] **èŒè´£**ï¼šä» PDF æ–‡ä»¶æå–æ–‡æœ¬å†…å®¹å’Œç»“æ„ä¿¡æ¯
- [ ] **æ ¸å¿ƒåŠŸèƒ½**ï¼š
  - `extract(pdf_path)` - æå–æ–‡æœ¬ï¼Œè¿”å› ExtractedDocument
  - `extract_with_layout(pdf_path)` - ä¿ç•™å¸ƒå±€ä¿¡æ¯çš„æå–
  - `extract_tables(pdf_path)` - æå–è¡¨æ ¼æ•°æ®
  - `extract_images(pdf_path)` - æå–å›¾ç‰‡ï¼ˆå¯é€‰ï¼‰
- [ ] **æå–ç­–ç•¥**ï¼š
  - ä¼˜å…ˆä½¿ç”¨ `PyMuPDF`ï¼ˆé€Ÿåº¦å¿«ã€å‡†ç¡®åº¦é«˜ï¼‰
  - å›é€€åˆ° `pdfplumber`ï¼ˆè¡¨æ ¼æå–æ›´å¥½ï¼‰
  - æ”¯æŒ OCR å›é€€ï¼ˆå›¾ç‰‡å‹ PDFï¼‰
- [ ] **ç»“æ„ä¿¡æ¯ä¿ç•™**ï¼š
  - è¯†åˆ«æ ‡é¢˜å±‚çº§ï¼ˆåŸºäºå­—ä½“å¤§å°å’Œæ ·å¼ï¼‰
  - è¯†åˆ«æ®µè½è¾¹ç•Œ
  - è¯†åˆ«å…¬å¼å—ï¼ˆLaTeX æˆ–å›¾ç‰‡å…¬å¼ï¼‰
  - è¯†åˆ«ä»£ç å—ï¼ˆç­‰å®½å­—ä½“åŒºåŸŸï¼‰
  - è¯†åˆ«è¡¨æ ¼åŒºåŸŸ
- [ ] **ä¾èµ–**ï¼š`PyMuPDF`ã€`pdfplumber`
- [ ] **è¢«è°ƒç”¨æ–¹**ï¼š`DocumentProcessor`

#### 5.1.3 `word_extractor.py` - Word æ–‡æ¡£æå–å™¨

- [ ] **æ–‡ä»¶è·¯å¾„**ï¼š`domain/knowledge/document/word_extractor.py`
- [ ] **èŒè´£**ï¼šä» Word æ–‡æ¡£æå–æ–‡æœ¬å†…å®¹å’Œç»“æ„ä¿¡æ¯
- [ ] **æ ¸å¿ƒåŠŸèƒ½**ï¼š
  - `extract(docx_path)` - æå–æ–‡æœ¬ï¼Œè¿”å› ExtractedDocument
  - `extract_with_styles(docx_path)` - ä¿ç•™æ ·å¼ä¿¡æ¯çš„æå–
- [ ] **ç»“æ„ä¿¡æ¯ä¿ç•™**ï¼š
  - è¯†åˆ«æ ‡é¢˜æ ·å¼ï¼ˆHeading 1-6ï¼‰
  - è¯†åˆ«åˆ—è¡¨å’Œç¼–å·
  - è¯†åˆ«è¡¨æ ¼
  - è¯†åˆ«å›¾ç‰‡è¯´æ˜
- [ ] **ä¾èµ–**ï¼š`python-docx`
- [ ] **è¢«è°ƒç”¨æ–¹**ï¼š`DocumentProcessor`

#### 5.1.4 `markdown_extractor.py` - Markdown è§£æå™¨

- [ ] **æ–‡ä»¶è·¯å¾„**ï¼š`domain/knowledge/document/markdown_extractor.py`
- [ ] **èŒè´£**ï¼šè§£æ Markdown æ–‡ä»¶ï¼Œæå–ç»“æ„åŒ–å†…å®¹
- [ ] **æ ¸å¿ƒåŠŸèƒ½**ï¼š
  - `extract(md_path)` - è§£æ Markdownï¼Œè¿”å› ExtractedDocument
  - `extract_sections(md_path)` - æŒ‰ç« èŠ‚æå–
- [ ] **ç»“æ„ä¿¡æ¯ä¿ç•™**ï¼š
  - è¯†åˆ«æ ‡é¢˜å±‚çº§ï¼ˆ# åˆ° ######ï¼‰
  - è¯†åˆ«ä»£ç å—ï¼ˆè¯­è¨€æ ‡è®°ï¼‰
  - è¯†åˆ«å¼•ç”¨å—
  - è¯†åˆ«åˆ—è¡¨
  - è¯†åˆ«é“¾æ¥å’Œå›¾ç‰‡å¼•ç”¨
- [ ] **ä¾èµ–**ï¼š`markdown` åº“
- [ ] **è¢«è°ƒç”¨æ–¹**ï¼š`DocumentProcessor`

#### 5.1.5 `metadata_extractor.py` - å…ƒæ•°æ®æå–å™¨

- [ ] **æ–‡ä»¶è·¯å¾„**ï¼š`domain/knowledge/document/metadata_extractor.py`
- [ ] **èŒè´£**ï¼šä»æ–‡æ¡£ä¸­æå–å…ƒæ•°æ®ä¿¡æ¯
- [ ] **æ ¸å¿ƒåŠŸèƒ½**ï¼š
  - `extract(extracted_doc)` - ä»æå–çš„æ–‡æ¡£ä¸­æå–å…ƒæ•°æ®
  - `extract_from_pdf_info(pdf_path)` - ä» PDF å…ƒä¿¡æ¯æå–
  - `extract_from_content(text)` - ä»å†…å®¹æ¨æ–­å…ƒæ•°æ®
- [ ] **æå–å†…å®¹**ï¼š
  - æ ‡é¢˜ï¼ˆä» PDF å…ƒä¿¡æ¯æˆ–é¦–ä¸ªå¤§æ ‡é¢˜ï¼‰
  - ä½œè€…åˆ—è¡¨ï¼ˆä» PDF å…ƒä¿¡æ¯æˆ–ä½œè€…è¡Œï¼‰
  - æ‘˜è¦ï¼ˆè¯†åˆ« Abstract ç« èŠ‚ï¼‰
  - å…³é”®è¯ï¼ˆè¯†åˆ« Keywords ç« èŠ‚ï¼‰
  - å‘å¸ƒæ—¥æœŸ
  - æ–‡æ¡£ç±»å‹ï¼ˆè®ºæ–‡/æŠ¥å‘Š/æ‰‹å†Œï¼‰
- [ ] **ç”µè·¯é¢†åŸŸç‰¹åŒ–**ï¼š
  - è¯†åˆ«ç”µè·¯ç±»å‹å…³é”®è¯ï¼ˆamplifierã€filterã€oscillator ç­‰ï¼‰
  - æå–æ€§èƒ½æŒ‡æ ‡å…³é”®è¯ï¼ˆgainã€bandwidthã€noise ç­‰ï¼‰
  - è¯†åˆ«å™¨ä»¶å‹å·ï¼ˆLM741ã€TL072 ç­‰ï¼‰
- [ ] **è¢«è°ƒç”¨æ–¹**ï¼š`DocumentProcessor`

#### 5.1.6 åˆ†å—ç­–ç•¥æ¨¡å—ç»„ (`domain/knowledge/document/chunking/`)

##### 5.1.6.1 `chunking_strategy.py` - åˆ†å—ç­–ç•¥æŠ½è±¡åŸºç±»

- [ ] **æ–‡ä»¶è·¯å¾„**ï¼š`domain/knowledge/document/chunking/chunking_strategy.py`
- [ ] **èŒè´£**ï¼šå®šä¹‰åˆ†å—ç­–ç•¥çš„ç»Ÿä¸€æ¥å£
- [ ] **æŠ½è±¡åŸºç±» `ChunkingStrategy`**ï¼š
  - `chunk(extracted_doc, config)` - æ‰§è¡Œåˆ†å—ï¼Œè¿”å› DocumentChunk åˆ—è¡¨
  - `get_strategy_name()` - è¿”å›ç­–ç•¥åç§°
  - `estimate_chunk_count(text_length)` - ä¼°ç®—åˆ†ç‰‡æ•°é‡
- [ ] **åˆ†å—é…ç½® `ChunkingConfig`**ï¼š
  - `target_chunk_size: int` - ç›®æ ‡åˆ†ç‰‡å¤§å°ï¼ˆtokensï¼Œé»˜è®¤ 1000ï¼‰
  - `overlap_ratio: float` - é‡å æ¯”ä¾‹ï¼ˆé»˜è®¤ 0.1ï¼‰
  - `min_chunk_size: int` - æœ€å°åˆ†ç‰‡å¤§å°ï¼ˆé»˜è®¤ 100ï¼‰
  - `max_chunk_size: int` - æœ€å¤§åˆ†ç‰‡å¤§å°ï¼ˆé»˜è®¤ 2000ï¼‰
  - `preserve_boundaries: bool` - æ˜¯å¦ä¿ç•™è¯­ä¹‰è¾¹ç•Œï¼ˆé»˜è®¤ Trueï¼‰
  - `enable_parent_child: bool` - æ˜¯å¦å¯ç”¨çˆ¶å­åˆ†å—ï¼ˆé»˜è®¤ Trueï¼‰
- [ ] **è¢«è°ƒç”¨æ–¹**ï¼š`DocumentProcessor`

##### 5.1.6.2 `semantic_chunker.py` - è¯­ä¹‰åˆ†å—å™¨

- [ ] **æ–‡ä»¶è·¯å¾„**ï¼š`domain/knowledge/document/chunking/semantic_chunker.py`
- [ ] **èŒè´£**ï¼šåŸºäºè¯­ä¹‰è¾¹ç•Œè¿›è¡Œæ™ºèƒ½åˆ†å—
- [ ] **æ ¸å¿ƒåŠŸèƒ½**ï¼š
  - `chunk(extracted_doc, config)` - è¯­ä¹‰åˆ†å—
  - `detect_boundaries(text)` - æ£€æµ‹è¯­ä¹‰è¾¹ç•Œ
  - `merge_small_chunks(chunks)` - åˆå¹¶è¿‡å°çš„åˆ†ç‰‡
- [ ] **è¯­ä¹‰è¾¹ç•Œè¯†åˆ«**ï¼š
  - ç« èŠ‚æ ‡é¢˜è¾¹ç•Œï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰
  - æ®µè½è¾¹ç•Œï¼ˆç©ºè¡Œåˆ†éš”ï¼‰
  - å…¬å¼å—è¾¹ç•Œï¼ˆLaTeX ç¯å¢ƒï¼‰
  - ä»£ç å—è¾¹ç•Œ
  - è¡¨æ ¼è¾¹ç•Œ
  - åˆ—è¡¨è¾¹ç•Œ
- [ ] **åˆ†å—ç­–ç•¥**ï¼š
  - ä¼˜å…ˆåœ¨é«˜ä¼˜å…ˆçº§è¾¹ç•Œåˆ‡åˆ†
  - è‹¥åˆ†ç‰‡è¿‡å¤§ï¼Œåœ¨ä½ä¼˜å…ˆçº§è¾¹ç•Œç»§ç»­åˆ‡åˆ†
  - è‹¥åˆ†ç‰‡è¿‡å°ï¼Œä¸ç›¸é‚»åˆ†ç‰‡åˆå¹¶
  - ä¿æŒå…¬å¼ã€ä»£ç å—ã€è¡¨æ ¼çš„å®Œæ•´æ€§
- [ ] **è¢«è°ƒç”¨æ–¹**ï¼š`DocumentProcessor`

##### 5.1.6.3 `recursive_chunker.py` - é€’å½’åˆ†å—å™¨

- [ ] **æ–‡ä»¶è·¯å¾„**ï¼š`domain/knowledge/document/chunking/recursive_chunker.py`
- [ ] **èŒè´£**ï¼šä½¿ç”¨é€’å½’ç­–ç•¥è¿›è¡Œå¤šçº§åˆ†å—
- [ ] **æ ¸å¿ƒåŠŸèƒ½**ï¼š
  - `chunk(extracted_doc, config)` - é€’å½’åˆ†å—
  - `split_by_separators(text, separators)` - æŒ‰åˆ†éš”ç¬¦åˆ—è¡¨é€’å½’åˆ†å‰²
- [ ] **åˆ†éš”ç¬¦ä¼˜å…ˆçº§**ï¼ˆä»ç²—åˆ°ç»†ï¼‰ï¼š
  1. ç« èŠ‚åˆ†éš”ç¬¦ï¼ˆ`\n# `ã€`\n## `ï¼‰
  2. æ®µè½åˆ†éš”ç¬¦ï¼ˆ`\n\n`ï¼‰
  3. å¥å­åˆ†éš”ç¬¦ï¼ˆ`. `ã€`ã€‚`ï¼‰
  4. å­å¥åˆ†éš”ç¬¦ï¼ˆ`, `ã€`ï¼Œ`ï¼‰
- [ ] **é€’å½’é€»è¾‘**ï¼š
  - ä½¿ç”¨æœ€ç²—ç²’åº¦åˆ†éš”ç¬¦åˆ‡åˆ†
  - è‹¥åˆ†ç‰‡è¶…è¿‡ç›®æ ‡å¤§å°ï¼Œä½¿ç”¨æ›´ç»†ç²’åº¦åˆ†éš”ç¬¦ç»§ç»­åˆ‡åˆ†
  - é€’å½’ç›´åˆ°æ‰€æœ‰åˆ†ç‰‡åœ¨ç›®æ ‡èŒƒå›´å†…
- [ ] **è¢«è°ƒç”¨æ–¹**ï¼š`DocumentProcessor`

##### 5.1.6.4 `parent_child_chunker.py` - çˆ¶å­åˆ†å—å™¨

- [ ] **æ–‡ä»¶è·¯å¾„**ï¼š`domain/knowledge/document/chunking/parent_child_chunker.py`
- [ ] **èŒè´£**ï¼šå®ç°çˆ¶å­åˆ†å—ç­–ç•¥ï¼Œæé«˜æ£€ç´¢ç²¾åº¦åŒæ—¶ä¿è¯ä¸Šä¸‹æ–‡å®Œæ•´
- [ ] **æ ¸å¿ƒåŠŸèƒ½**ï¼š
  - `chunk(extracted_doc, config)` - çˆ¶å­åˆ†å—
  - `create_parent_chunks(text)` - åˆ›å»ºçˆ¶åˆ†ç‰‡ï¼ˆå¤§åˆ†ç‰‡ï¼‰
  - `create_child_chunks(parent_chunk)` - åˆ›å»ºå­åˆ†ç‰‡ï¼ˆå°åˆ†ç‰‡ï¼‰
  - `link_parent_child(parent, children)` - å»ºç«‹çˆ¶å­å…³è”
- [ ] **åˆ†å—å‚æ•°**ï¼š
  - çˆ¶åˆ†ç‰‡å¤§å°ï¼š2000-4000 tokens
  - å­åˆ†ç‰‡å¤§å°ï¼š500-1000 tokens
  - å­åˆ†ç‰‡é‡å ï¼š10-15%
- [ ] **æ£€ç´¢ç­–ç•¥**ï¼š
  - æ£€ç´¢æ—¶åŒ¹é…å­åˆ†ç‰‡ï¼ˆç²¾ç¡®åŒ¹é…ï¼‰
  - è¿”å›æ—¶æ‰©å±•åˆ°çˆ¶åˆ†ç‰‡ï¼ˆå®Œæ•´ä¸Šä¸‹æ–‡ï¼‰
  - å¯é…ç½®è¿”å›å­åˆ†ç‰‡æˆ–çˆ¶åˆ†ç‰‡
- [ ] **å­˜å‚¨ç­–ç•¥**ï¼š
  - çˆ¶åˆ†ç‰‡å’Œå­åˆ†ç‰‡éƒ½å­˜å…¥å‘é‡æ•°æ®åº“
  - é€šè¿‡ `parent_chunk_id` å’Œ `child_chunk_ids` å…³è”
  - æ£€ç´¢æ—¶å¯æŒ‡å®šåªæœç´¢å­åˆ†ç‰‡
- [ ] **è¢«è°ƒç”¨æ–¹**ï¼š`DocumentProcessor`

---

### 5.4 å‘é‡å­˜å‚¨æ¨¡å—ç»„ (`domain/knowledge/vector/`)

> **åˆå§‹åŒ–é¡ºåº**ï¼šPhase 3.21ï¼Œä¾èµ– EmbeddingServiceã€ConfigManagerï¼Œæ³¨å†Œåˆ° ServiceLocator

> **æ¨¡å—æ‹†åˆ†è¯´æ˜**ï¼šä¸ºéµå¾ªå•ä¸€èŒè´£åŸåˆ™ï¼Œå°†å‘é‡å­˜å‚¨æ‹†åˆ†ä¸ºä»¥ä¸‹å­æ¨¡å—ï¼š
> - `vector_store.py` - é—¨é¢ç±»ï¼Œç®¡ç†æ•°æ®åº“è¿æ¥
> - `collection_manager.py` - é›†åˆç®¡ç†ï¼ˆåˆ›å»ºã€åˆ é™¤ã€ç»Ÿè®¡ï¼‰
> - `incremental_updater.py` - å¢é‡æ›´æ–°é€»è¾‘
> - `cache_manager.py` - æŸ¥è¯¢ç¼“å­˜ç®¡ç†

#### 5.2.1 `vector_store.py` - å‘é‡å­˜å‚¨é—¨é¢ç±»

- [ ] **æ–‡ä»¶è·¯å¾„**ï¼š`domain/knowledge/vector/vector_store.py`
- [ ] **èŒè´£**ï¼šç®¡ç† ChromaDB å‘é‡æ•°æ®åº“è¿æ¥ï¼Œæä¾›ç»Ÿä¸€çš„å­˜å‚¨æ¥å£
- [ ] **æ ¸å¿ƒåŠŸèƒ½**ï¼š
  - `initialize(db_path)` - åˆå§‹åŒ–æ•°æ®åº“è¿æ¥
  - `shutdown()` - å…³é—­æ•°æ®åº“è¿æ¥
  - `add_documents(collection_name, chunks, embeddings)` - æ·»åŠ æ–‡æ¡£
  - `delete_documents(collection_name, chunk_ids)` - åˆ é™¤æ–‡æ¡£
  - `upsert_documents(collection_name, chunks, embeddings)` - æ›´æ–°æˆ–æ’å…¥æ–‡æ¡£
  - `query(collection_name, query_embedding, top_k, filters)` - å‘é‡æŸ¥è¯¢
  - `get_collection_stats(collection_name)` - è·å–é›†åˆç»Ÿè®¡ä¿¡æ¯
  - `health_check()` - å¥åº·æ£€æŸ¥
- [ ] **ChromaDB é…ç½®**ï¼š
  - æŒä¹…åŒ–æ¨¡å¼ï¼š`PersistentClient`
  - å­˜å‚¨è·¯å¾„ï¼š`~/.circuit_design_ai/rag_database/`
  - è·ç¦»å‡½æ•°ï¼šä½™å¼¦ç›¸ä¼¼åº¦ï¼ˆcosineï¼‰
  - åµŒå…¥ç»´åº¦ï¼š768ï¼ˆä¸ ModernBERT åŒ¹é…ï¼‰
- [ ] **é›†åˆè®¾è®¡**ï¼š
  - `documents` - æ–‡æ¡£é›†åˆï¼ˆè®ºæ–‡ã€æ‰‹å†Œã€ç¬”è®°ï¼‰
    - å…ƒæ•°æ®ï¼š`source_file`ã€`chunk_index`ã€`title`ã€`authors`ã€`section`ã€`chunk_type`ã€`content_hash`ã€`parent_chunk_id`
  - `code` - ä»£ç ç´¢å¼•é›†åˆ
    - å…ƒæ•°æ®ï¼š`file_path`ã€`chunk_offset`ã€`syntax_tags`ã€`file_hash`ã€`mtime`ã€`language`
- [ ] **åˆå§‹åŒ–æ—¶åº**ï¼š
  1. æ£€æŸ¥æ•°æ®åº“ç›®å½•æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»º
  2. åˆ›å»º ChromaDB PersistentClient
  3. å§”æ‰˜ CollectionManager åˆ›å»ºæˆ–éªŒè¯é›†åˆ
  4. å§”æ‰˜ CacheManager åˆå§‹åŒ–ç¼“å­˜
  5. æ³¨å†Œåˆ° ServiceLocator
  6. å‘å¸ƒ `EVENT_VECTOR_STORE_READY` äº‹ä»¶
- [ ] **é”™è¯¯å¤„ç†**ï¼š
  - æ•°æ®åº“æ–‡ä»¶æŸåï¼šå°è¯•ä»å¤‡ä»½æ¢å¤ï¼Œå¤±è´¥åˆ™é‡å»º
  - ç£ç›˜ç©ºé—´ä¸è¶³ï¼šå‘å¸ƒè­¦å‘Šäº‹ä»¶ï¼Œæ‹’ç»å†™å…¥æ“ä½œ
  - è¿æ¥è¶…æ—¶ï¼šè‡ªåŠ¨é‡è¿ï¼Œæœ€å¤šé‡è¯• 3 æ¬¡
- [ ] **ä¾èµ–æ¨¡å—**ï¼š
  - `CollectionManager` - é›†åˆç®¡ç†
  - `IncrementalUpdater` - å¢é‡æ›´æ–°
  - `CacheManager` - ç¼“å­˜ç®¡ç†
- [ ] **è¢«è°ƒç”¨æ–¹**ï¼š`IndexManager`ã€`RetrievalService`

#### 5.2.2 `collection_manager.py` - é›†åˆç®¡ç†å™¨

- [ ] **æ–‡ä»¶è·¯å¾„**ï¼š`domain/knowledge/vector/collection_manager.py`
- [ ] **èŒè´£**ï¼šç®¡ç† ChromaDB é›†åˆçš„åˆ›å»ºã€åˆ é™¤ã€ç»Ÿè®¡
- [ ] **æ ¸å¿ƒåŠŸèƒ½**ï¼š
  - `create_collection(name, metadata)` - åˆ›å»ºé›†åˆ
  - `delete_collection(name)` - åˆ é™¤é›†åˆ
  - `get_collection(name)` - è·å–é›†åˆå¼•ç”¨
  - `list_collections()` - åˆ—å‡ºæ‰€æœ‰é›†åˆ
  - `get_stats(name)` - è·å–é›†åˆç»Ÿè®¡ä¿¡æ¯
  - `rebuild_collection(name)` - é‡å»ºé›†åˆï¼ˆæ¸…ç©ºå¹¶é‡æ–°ç´¢å¼•ï¼‰
- [ ] **é›†åˆå…ƒæ•°æ®**ï¼š
  - `created_at` - åˆ›å»ºæ—¶é—´
  - `last_updated` - æœ€åæ›´æ–°æ—¶é—´
  - `document_count` - æ–‡æ¡£æ•°é‡
  - `chunk_count` - åˆ†ç‰‡æ•°é‡
  - `version` - é›†åˆç‰ˆæœ¬å·ï¼ˆç”¨äºç¼“å­˜å¤±æ•ˆï¼‰
- [ ] **è¢«è°ƒç”¨æ–¹**ï¼š`VectorStore`

#### 5.2.3 `incremental_updater.py` - å¢é‡æ›´æ–°å™¨

- [ ] **æ–‡ä»¶è·¯å¾„**ï¼š`domain/knowledge/vector/incremental_updater.py`
- [ ] **èŒè´£**ï¼šå®ç°æ–‡æ¡£çš„å¢é‡æ›´æ–°é€»è¾‘ï¼Œé¿å…å…¨é‡é‡å»º
- [ ] **æ ¸å¿ƒåŠŸèƒ½**ï¼š
  - `compute_file_hash(file_path)` - è®¡ç®—æ–‡ä»¶å†…å®¹å“ˆå¸Œ
  - `get_indexed_files(collection_name)` - è·å–å·²ç´¢å¼•æ–‡ä»¶åˆ—è¡¨
  - `detect_changes(folder_path, collection_name)` - æ£€æµ‹æ–‡ä»¶å˜æ›´
  - `apply_changes(changes, collection_name)` - åº”ç”¨å˜æ›´
- [ ] **å˜æ›´æ£€æµ‹é€»è¾‘**ï¼š
  - æ‰«æç›®æ ‡æ–‡ä»¶å¤¹ï¼Œè®¡ç®—æ¯ä¸ªæ–‡ä»¶çš„ SHA256 å“ˆå¸Œ
  - ä¸å·²ç´¢å¼•æ–‡ä»¶çš„å“ˆå¸Œæ¯”å¯¹
  - åˆ†ç±»ä¸ºï¼šæ–°å¢ã€ä¿®æ”¹ã€åˆ é™¤ã€æœªå˜æ›´
- [ ] **å˜æ›´åº”ç”¨ç­–ç•¥**ï¼š
  - æ–°å¢æ–‡ä»¶ï¼šå¤„ç†å¹¶æ·»åŠ åˆ°é›†åˆ
  - ä¿®æ”¹æ–‡ä»¶ï¼šåˆ é™¤æ—§åˆ†ç‰‡ï¼Œæ·»åŠ æ–°åˆ†ç‰‡
  - åˆ é™¤æ–‡ä»¶ï¼šä»é›†åˆä¸­åˆ é™¤å¯¹åº”åˆ†ç‰‡
  - æœªå˜æ›´ï¼šè·³è¿‡å¤„ç†
- [ ] **æ‰¹é‡æ“ä½œä¼˜åŒ–**ï¼š
  - æ‰¹é‡æ·»åŠ ï¼šæ¯æ‰¹ 100 æ¡ï¼Œé¿å…å†…å­˜æº¢å‡º
  - æ‰¹é‡åˆ é™¤ï¼šæ¯æ‰¹ 500 æ¡ï¼Œé¿å…é”è¡¨
  - è¿›åº¦å›è°ƒï¼šæŠ¥å‘Šå¤„ç†è¿›åº¦
  - æ–­ç‚¹ç»­ä¼ ï¼šè®°å½•å·²å¤„ç†æ–‡ä»¶ï¼Œæ”¯æŒä¸­æ–­æ¢å¤
- [ ] **è¢«è°ƒç”¨æ–¹**ï¼š`IndexManager`ã€`CodeIndexer`

#### 5.2.4 `cache_manager.py` - æŸ¥è¯¢ç¼“å­˜ç®¡ç†å™¨

- [ ] **æ–‡ä»¶è·¯å¾„**ï¼š`domain/knowledge/vector/cache_manager.py`
- [ ] **èŒè´£**ï¼šç®¡ç†æ£€ç´¢æŸ¥è¯¢çš„ç¼“å­˜ï¼Œæé«˜é‡å¤æŸ¥è¯¢æ€§èƒ½
- [ ] **æ ¸å¿ƒåŠŸèƒ½**ï¼š
  - `get(cache_key)` - è·å–ç¼“å­˜ç»“æœ
  - `set(cache_key, results, ttl)` - è®¾ç½®ç¼“å­˜
  - `invalidate(collection_name)` - å¤±æ•ˆæŒ‡å®šé›†åˆçš„ç¼“å­˜
  - `invalidate_all()` - å¤±æ•ˆæ‰€æœ‰ç¼“å­˜
  - `get_stats()` - è·å–ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯
- [ ] **ç¼“å­˜ç­–ç•¥**ï¼š
  - **æŸ¥è¯¢ç»“æœç¼“å­˜**ï¼š
    - ç¼“å­˜å®¹é‡ï¼šæœ€è¿‘ 1000 æ¬¡æŸ¥è¯¢
    - ç¼“å­˜é”®ï¼š`hash(query + collection + top_k + filters)`
    - è¿‡æœŸæ—¶é—´ï¼š5 åˆ†é’Ÿï¼ˆå¯é…ç½®ï¼‰
    - æ·˜æ±°ç­–ç•¥ï¼šLRUï¼ˆæœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼‰
  - **åµŒå…¥å‘é‡ç¼“å­˜**ï¼š
    - ç¼“å­˜å®¹é‡ï¼šæœ€è¿‘ 500 ä¸ªæŸ¥è¯¢çš„åµŒå…¥å‘é‡
    - é¿å…é‡å¤è®¡ç®—ç›¸åŒæŸ¥è¯¢çš„åµŒå…¥
  - **é›†åˆå…ƒæ•°æ®ç¼“å­˜**ï¼š
    - ç¼“å­˜é›†åˆçš„æ–‡æ¡£æ•°é‡ã€æœ€åæ›´æ–°æ—¶é—´
    - è¿‡æœŸæ—¶é—´ï¼š1 åˆ†é’Ÿ
- [ ] **ç¼“å­˜å¤±æ•ˆæœºåˆ¶**ï¼š
  - æ–‡æ¡£å¢åˆ æ”¹æ—¶ï¼Œå¤±æ•ˆç›¸å…³é›†åˆçš„æŸ¥è¯¢ç¼“å­˜
  - ä½¿ç”¨ç‰ˆæœ¬å·æœºåˆ¶ï¼šé›†åˆå˜æ›´æ—¶ç‰ˆæœ¬å·é€’å¢
  - ç¼“å­˜é”®åŒ…å«ç‰ˆæœ¬å·ï¼Œç‰ˆæœ¬ä¸åŒ¹é…è‡ªåŠ¨å¤±æ•ˆ
- [ ] **ç¼“å­˜ç»Ÿè®¡**ï¼š
  - å‘½ä¸­ç‡ç»Ÿè®¡
  - ç¼“å­˜å¤§å°ç»Ÿè®¡
  - å¤±æ•ˆæ¬¡æ•°ç»Ÿè®¡
- [ ] **è¢«è°ƒç”¨æ–¹**ï¼š`RetrievalService`

---

### 5.5 æ£€ç´¢æ¨¡å—ç»„ (`domain/knowledge/retrieval/`)

> **æ¨¡å—æ‹†åˆ†è¯´æ˜**ï¼šæ£€ç´¢åŠŸèƒ½æ¶‰åŠå¤šä¸ªç‹¬ç«‹çš„å¤„ç†æ­¥éª¤ï¼Œä¸ºéµå¾ªå•ä¸€èŒè´£åŸåˆ™ï¼Œæ‹†åˆ†ä¸ºä»¥ä¸‹å­æ¨¡å—ï¼š
> - `retrieval_service.py` - æ£€ç´¢æœåŠ¡é—¨é¢ç±»
> - `hybrid_searcher.py` - æ··åˆæ£€ç´¢å™¨
> - `query_expander.py` - æŸ¥è¯¢æ‰©å±•å™¨
> - `reranker.py` - é‡æ’åºå™¨
> - `context_expander.py` - ä¸Šä¸‹æ–‡æ‰©å±•å™¨

#### 5.3.1 `retrieval_service.py` - æ£€ç´¢æœåŠ¡é—¨é¢ç±»

- [ ] **æ–‡ä»¶è·¯å¾„**ï¼š`domain/knowledge/retrieval/retrieval_service.py`
- [ ] **èŒè´£**ï¼šä½œä¸ºæ£€ç´¢åŠŸèƒ½çš„ç»Ÿä¸€å…¥å£ï¼Œåè°ƒå„å­æ¨¡å—å®Œæˆæ£€ç´¢æµç¨‹
- [ ] **æ ¸å¿ƒåŠŸèƒ½**ï¼š
  - `retrieve(query, options)` - ä¸»æ£€ç´¢å…¥å£
  - `retrieve_from_documents(query, top_k)` - ä»æ–‡æ¡£é›†åˆæ£€ç´¢
  - `retrieve_from_code(query, top_k)` - ä»ä»£ç é›†åˆæ£€ç´¢
  - `retrieve_hybrid(query, collections, top_k)` - è·¨é›†åˆæ··åˆæ£€ç´¢
  - `retrieve_from_file(file_path, query, top_k)` - ä»å•ä¸ªæ–‡ä»¶æ£€ç´¢ï¼ˆæ”¯æŒè¯­ä¹‰å®šä½è¯»å–ï¼‰
- [ ] **æ£€ç´¢é€‰é¡¹ `RetrievalOptions`**ï¼š
  - `collections: List[str]` - ç›®æ ‡é›†åˆåˆ—è¡¨
  - `top_k: int` - è¿”å›ç»“æœæ•°é‡ï¼ˆé»˜è®¤ 5ï¼‰
  - `enable_query_expansion: bool` - æ˜¯å¦å¯ç”¨æŸ¥è¯¢æ‰©å±•ï¼ˆé»˜è®¤ Trueï¼‰
  - `enable_reranking: bool` - æ˜¯å¦å¯ç”¨é‡æ’åºï¼ˆé»˜è®¤ Trueï¼‰
  - `enable_context_expansion: bool` - æ˜¯å¦å¯ç”¨ä¸Šä¸‹æ–‡æ‰©å±•ï¼ˆé»˜è®¤ Trueï¼‰
  - `filters: Dict` - å…ƒæ•°æ®è¿‡æ»¤æ¡ä»¶
  - `token_budget: int` - Token é¢„ç®—ï¼ˆé»˜è®¤ 4000ï¼‰
- [ ] **æ£€ç´¢æµç¨‹**ï¼š
  1. è°ƒç”¨ `QueryExpander.expand()` æ‰©å±•æŸ¥è¯¢
  2. æ£€æŸ¥ `CacheManager` æ˜¯å¦æœ‰ç¼“å­˜ç»“æœ
  3. è°ƒç”¨ `HybridSearcher.search()` æ‰§è¡Œæ··åˆæ£€ç´¢
  4. è°ƒç”¨ `Reranker.rerank()` ç²¾æ’ç»“æœ
  5. è°ƒç”¨ `ContextExpander.expand()` æ‰©å±•ä¸Šä¸‹æ–‡
  6. ç¼“å­˜ç»“æœå¹¶è¿”å›
- [ ] **ä¾èµ–æ¨¡å—**ï¼š
  - `HybridSearcher` - æ··åˆæ£€ç´¢
  - `QueryExpander` - æŸ¥è¯¢æ‰©å±•
  - `Reranker` - é‡æ’åº
  - `ContextExpander` - ä¸Šä¸‹æ–‡æ‰©å±•
  - `CacheManager` - ç¼“å­˜ç®¡ç†
- [ ] **è¢«è°ƒç”¨æ–¹**ï¼š`rag_worker.py`ã€`context_retrieval/context_retriever.py`ï¼ˆé˜¶æ®µä¸‰ï¼‰ã€`UnifiedSearchService.search_in_file()`ï¼ˆæœ¬é˜¶æ®µï¼‰

##### 5.3.1.1 `retrieve_from_file` æ–¹æ³•è¯¦ç»†è®¾è®¡

> **è®¾è®¡èƒŒæ™¯**ï¼šæ”¯æŒ `UnifiedSearchService.search_in_file()` çš„è¯­ä¹‰æœç´¢éƒ¨åˆ†ï¼Œåœ¨å•ä¸ªæ–‡ä»¶çš„å·²ç´¢å¼•åˆ†å—ä¸­æ‰§è¡Œè¯­ä¹‰æ£€ç´¢ã€‚

- [ ] **æ–¹æ³•ç­¾å**ï¼š`retrieve_from_file(file_path: str, query: str, top_k: int = 5) -> List[SearchResult]`
- [ ] **æ‰§è¡Œæµç¨‹**ï¼š
  1. æ ¹æ® `file_path` è¿‡æ»¤å‘é‡æ•°æ®åº“ä¸­çš„åˆ†å—ï¼ˆä½¿ç”¨å…ƒæ•°æ®è¿‡æ»¤ï¼‰
  2. å¯¹æŸ¥è¯¢è¿›è¡ŒåµŒå…¥
  3. åœ¨è¿‡æ»¤åçš„åˆ†å—ä¸­æ‰§è¡Œå‘é‡ç›¸ä¼¼åº¦æœç´¢
  4. è¿”å›åŒ¹é…çš„åˆ†å—åˆ—è¡¨ï¼ˆåŒ…å«è¡Œå·èŒƒå›´ï¼‰
- [ ] **å…ƒæ•°æ®è¿‡æ»¤**ï¼š
  - ChromaDB æ”¯æŒ `where` æ¡ä»¶è¿‡æ»¤
  - è¿‡æ»¤æ¡ä»¶ï¼š`{"source_file": file_path}`
- [ ] **è¿”å›ç»“æœ**ï¼š
  - æ¯ä¸ªç»“æœåŒ…å« `start_line`ã€`end_line`ã€`score`ã€`content`
  - ç»“æœæŒ‰ç›¸å…³æ€§åˆ†æ•°é™åºæ’åˆ—
- [ ] **é™çº§å¤„ç†**ï¼š
  - è‹¥æ–‡ä»¶æœªè¢«ç´¢å¼•ï¼Œè¿”å›ç©ºåˆ—è¡¨
  - è°ƒç”¨æ–¹ï¼ˆ`UnifiedSearchService`ï¼‰ä¼šå›é€€åˆ°ç²¾ç¡®æœç´¢

#### 5.3.2 `hybrid_searcher.py` - æ··åˆæ£€ç´¢å™¨

- [ ] **æ–‡ä»¶è·¯å¾„**ï¼š`domain/knowledge/retrieval/hybrid_searcher.py`
- [ ] **èŒè´£**ï¼šå®ç°æ··åˆæ£€ç´¢é€»è¾‘ï¼Œèåˆå‘é‡è¯­ä¹‰æ£€ç´¢å’Œ BM25 å…³é”®è¯æ£€ç´¢
- [ ] **æ ¸å¿ƒåŠŸèƒ½**ï¼š
  - `search(query, query_embedding, collection, top_k)` - æ‰§è¡Œæ··åˆæ£€ç´¢
  - `vector_search(query_embedding, collection, top_k)` - å‘é‡è¯­ä¹‰æ£€ç´¢
  - `bm25_search(query_text, collection, top_k)` - BM25 å…³é”®è¯æ£€ç´¢
  - `fuse_results(vector_results, bm25_results, weights)` - RRF ç®—æ³•èåˆç»“æœ
- [ ] **æ··åˆæ£€ç´¢ç­–ç•¥**ï¼š
  - åŒæ—¶æ‰§è¡Œå‘é‡è¯­ä¹‰æ£€ç´¢å’Œ BM25 å…³é”®è¯æ£€ç´¢
  - ä½¿ç”¨ RRFï¼ˆReciprocal Rank Fusionï¼‰ç®—æ³•èåˆä¸¤è·¯ç»“æœ
  - è¯­ä¹‰æ£€ç´¢æ•è·æ¦‚å¿µç›¸ä¼¼æ€§ï¼Œå…³é”®è¯æ£€ç´¢æ•è·ç²¾ç¡®åŒ¹é…
  - å¯é…ç½®ä¸¤è·¯æ£€ç´¢çš„æƒé‡æ¯”ä¾‹
- [ ] **RRF èåˆç®—æ³•**ï¼š
  - å¯¹æ¯è·¯æ£€ç´¢ç»“æœæŒ‰ç›¸å…³åº¦æ’åº
  - è®¡ç®— RRF åˆ†æ•°ï¼š`score = Î£ 1/(k + rank_i)`ï¼Œå…¶ä¸­ k=60
  - åˆå¹¶æ‰€æœ‰è·¯å¾„çš„ RRF åˆ†æ•°ï¼Œç»Ÿä¸€æ’åº
  - å»é‡ï¼šåŒä¸€æ–‡æ¡£åªä¿ç•™æœ€é«˜åˆ†
- [ ] **BM25 å®ç°**ï¼š
  - ä½¿ç”¨ `rank_bm25` åº“å®ç° BM25 ç®—æ³•
  - åœ¨ç´¢å¼•æ—¶é¢„è®¡ç®— IDF å€¼
  - æ”¯æŒä¸­è‹±æ–‡åˆ†è¯ï¼ˆjieba + nltkï¼‰
- [ ] **æ£€ç´¢å‚æ•°**ï¼š
  - `vector_weight: float` - å‘é‡æ£€ç´¢æƒé‡ï¼ˆé»˜è®¤ 0.7ï¼‰
  - `bm25_weight: float` - BM25 æ£€ç´¢æƒé‡ï¼ˆé»˜è®¤ 0.3ï¼‰
  - `rrf_k: int` - RRF å‚æ•° kï¼ˆé»˜è®¤ 60ï¼‰
  - `candidate_multiplier: int` - å€™é€‰å€æ•°ï¼ˆé»˜è®¤ 3ï¼Œå³æ£€ç´¢ top_k * 3 ä¸ªå€™é€‰ï¼‰
- [ ] **è¢«è°ƒç”¨æ–¹**ï¼š`RetrievalService`

#### 5.3.3 `query_expander.py` - æŸ¥è¯¢æ‰©å±•å™¨

- [ ] **æ–‡ä»¶è·¯å¾„**ï¼š`domain/knowledge/retrieval/query_expander.py`
- [ ] **èŒè´£**ï¼šå¯¹ç”¨æˆ·æŸ¥è¯¢è¿›è¡Œæ‰©å±•ï¼Œæé«˜æ£€ç´¢å¬å›ç‡
- [ ] **æ ¸å¿ƒåŠŸèƒ½**ï¼š
  - `expand(query)` - ä¸»å…¥å£ï¼Œè¿”å›æ‰©å±•åçš„æŸ¥è¯¢åˆ—è¡¨
  - `expand_synonyms(query)` - åŒä¹‰è¯æ‰©å±•
  - `extract_circuit_terms(query)` - æå–ç”µè·¯ä¸“ä¸šæœ¯è¯­
  - `translate_terms(terms)` - ä¸­è‹±æ–‡æœ¯è¯­äº’è¯‘
  - `generate_semantic_variants(query)` - ç”Ÿæˆè¯­ä¹‰å˜ä½“
- [ ] **æŸ¥è¯¢æ‰©å±•ç­–ç•¥**ï¼š
  - **åŒä¹‰è¯æ‰©å±•**ï¼šä½¿ç”¨é¢„å®šä¹‰è¯è¡¨æ‰©å±•åŒä¹‰è¯
  - **æœ¯è¯­æå–**ï¼šè¯†åˆ«ç”µè·¯é¢†åŸŸä¸“ä¸šæœ¯è¯­
  - **ä¸­è‹±äº’è¯‘**ï¼šæ”¯æŒä¸­è‹±æ–‡æœ¯è¯­åŒå‘ç¿»è¯‘
  - **è¯­ä¹‰å˜ä½“**ï¼šç”ŸæˆæŸ¥è¯¢çš„è¯­ä¹‰ç­‰ä»·è¡¨è¾¾

> **æœ¯è¯­è¯è¡¨å…±äº«è¯´æ˜**ï¼šç”µè·¯æœ¯è¯­è¯è¡¨å¯æŠ½å–ä¸ºå…±äº«æ¨¡å— `shared/circuit_vocabulary.py`ï¼Œä¾›æœ¬æ¨¡å—å’Œé˜¶æ®µä¸‰çš„ `keyword_extractor.py` å…±åŒä½¿ç”¨ã€‚

- [ ] **ç”µè·¯æœ¯è¯­è¯è¡¨**ï¼š
  - **å™¨ä»¶ç±»å‹**ï¼š
    - æ”¾å¤§å™¨/amplifier/amp
    - æ»¤æ³¢å™¨/filter
    - æŒ¯è¡å™¨/oscillator
    - ç¨³å‹å™¨/regulator/voltage regulator
    - æ¯”è¾ƒå™¨/comparator
  - **æ€§èƒ½æŒ‡æ ‡**ï¼š
    - å¢ç›Š/gain
    - å¸¦å®½/bandwidth/BW
    - å™ªå£°/noise
    - å¤±çœŸ/distortion/THD
    - åŠŸè€—/power consumption
    - å‹æ‘†ç‡/slew rate
    - å…±æ¨¡æŠ‘åˆ¶æ¯”/CMRR
    - ç”µæºæŠ‘åˆ¶æ¯”/PSRR
  - **ç”µè·¯å…ƒä»¶**ï¼š
    - ç”µé˜»/resistor/R
    - ç”µå®¹/capacitor/C
    - ç”µæ„Ÿ/inductor/L
    - æ™¶ä½“ç®¡/transistor/BJT/MOSFET
    - è¿ç®—æ”¾å¤§å™¨/op-amp/operational amplifier
  - **åˆ†æç±»å‹**ï¼š
    - äº¤æµåˆ†æ/AC analysis
    - ç›´æµåˆ†æ/DC analysis
    - ç¬æ€åˆ†æ/transient analysis
    - å™ªå£°åˆ†æ/noise analysis
- [ ] **æ‰©å±•ç»“æœç»“æ„**ï¼š
  - `original_query` - åŸå§‹æŸ¥è¯¢
  - `expanded_queries` - æ‰©å±•åçš„æŸ¥è¯¢åˆ—è¡¨
  - `extracted_terms` - æå–çš„ä¸“ä¸šæœ¯è¯­
  - `translations` - æœ¯è¯­ç¿»è¯‘
- [ ] **è¢«è°ƒç”¨æ–¹**ï¼š`RetrievalService`

#### 5.3.4 `reranker.py` - é‡æ’åºå™¨

- [ ] **æ–‡ä»¶è·¯å¾„**ï¼š`domain/knowledge/retrieval/reranker.py`
- [ ] **èŒè´£**ï¼šä½¿ç”¨äº¤å‰ç¼–ç å™¨å¯¹æ£€ç´¢ç»“æœè¿›è¡Œç²¾æ’
- [ ] **æ ¸å¿ƒåŠŸèƒ½**ï¼š
  - `rerank(query, candidates, top_k)` - å¯¹å€™é€‰ç»“æœé‡æ’åº
  - `load_model()` - åŠ è½½é‡æ’åºæ¨¡å‹
  - `compute_scores(query, documents)` - è®¡ç®—æŸ¥è¯¢ä¸æ–‡æ¡£çš„ç›¸å…³åº¦åˆ†æ•°
  - `is_model_loaded()` - æ£€æŸ¥æ¨¡å‹æ˜¯å¦å·²åŠ è½½
- [ ] **é‡æ’åºç­–ç•¥**ï¼š
  - åˆæ¬¡æ£€ç´¢è¿”å› top_k * 3 ä¸ªå€™é€‰
  - ä½¿ç”¨äº¤å‰ç¼–ç å™¨ï¼ˆCross-Encoderï¼‰å¯¹å€™é€‰è¿›è¡Œç²¾æ’
  - æœ€ç»ˆè¿”å› top_k ä¸ªæœ€ç›¸å…³ç»“æœ
- [ ] **æ¨¡å‹é…ç½®**ï¼š
  - é»˜è®¤æ¨¡å‹ï¼š`mixedbread-ai/mxbai-rerank-base-v1`
  - æ¨¡å‹è·¯å¾„ï¼š`vendor/models/rerankers/mxbai-rerank-base-v1/`
  - æ¨¡å‹å‚æ•°ï¼š110M å‚æ•°ï¼Œçº¦ 440MB
  - ä¸Šä¸‹æ–‡é•¿åº¦ï¼š512 tokens
- [ ] **æ¨¡å‹åŠ è½½ç­–ç•¥**ï¼š
  - ä¼˜å…ˆä» `vendor/models/rerankers/` åŠ è½½æœ¬åœ°æ¨¡å‹
  - è‹¥æœ¬åœ°æ¨¡å‹ä¸å­˜åœ¨ï¼Œå›é€€åˆ° HuggingFace ç¼“å­˜
  - æ¨¡å‹æ‡’åŠ è½½ï¼ˆé¦–æ¬¡ä½¿ç”¨æ—¶åŠ è½½ï¼‰
  - åŠ è½½æ—¶å‘å¸ƒ `EVENT_RERANKER_MODEL_LOADING` äº‹ä»¶
  - åŠ è½½å®Œæˆå‘å¸ƒ `EVENT_RERANKER_MODEL_READY` äº‹ä»¶
- [ ] **æ€§èƒ½ä¼˜åŒ–**ï¼š
  - æ‰¹é‡è®¡ç®—åˆ†æ•°å‡å°‘å¼€é”€ï¼ˆbatch_size=32ï¼‰
  - GPU åŠ é€Ÿï¼ˆè‡ªåŠ¨æ£€æµ‹ CUDA/MPSï¼‰
  - æ¨¡å‹é‡åŒ–æ”¯æŒï¼ˆå¯é€‰ï¼Œå‡å°‘å†…å­˜å ç”¨ï¼‰
  - åˆ†æ•°ç¼“å­˜ï¼ˆç›¸åŒ query-document å¯¹ä¸é‡å¤è®¡ç®—ï¼‰
- [ ] **é™çº§ç­–ç•¥**ï¼š
  - æ¨¡å‹åŠ è½½å¤±è´¥æ—¶ï¼Œè·³è¿‡é‡æ’åºæ­¥éª¤
  - è¿”å›åŸå§‹æ£€ç´¢ç»“æœï¼Œè®°å½•è­¦å‘Šæ—¥å¿—
- [ ] **è¢«è°ƒç”¨æ–¹**ï¼š`RetrievalService`

#### 5.3.5 `context_expander.py` - ä¸Šä¸‹æ–‡æ‰©å±•å™¨

- [ ] **æ–‡ä»¶è·¯å¾„**ï¼š`domain/knowledge/retrieval/context_expander.py`
- [ ] **èŒè´£**ï¼šæ‰©å±•æ£€ç´¢ç»“æœçš„ä¸Šä¸‹æ–‡ï¼Œæä¾›æ›´å®Œæ•´çš„ä¿¡æ¯
- [ ] **æ ¸å¿ƒåŠŸèƒ½**ï¼š
  - `expand(results, token_budget)` - æ‰©å±•æ£€ç´¢ç»“æœçš„ä¸Šä¸‹æ–‡
  - `get_adjacent_chunks(chunk, direction)` - è·å–ç›¸é‚»åˆ†ç‰‡
  - `get_parent_chunk(chunk)` - è·å–çˆ¶åˆ†ç‰‡ï¼ˆçˆ¶å­åˆ†å—æ—¶ï¼‰
  - `merge_overlapping(chunks)` - åˆå¹¶é‡å åˆ†ç‰‡
  - `truncate_to_budget(expanded_results, token_budget)` - æŒ‰ Token é¢„ç®—æˆªæ–­
- [ ] **æ‰©å±•ç­–ç•¥**ï¼š
  - **æ»‘åŠ¨çª—å£æ‰©å±•**ï¼š
    - è·å–æ£€ç´¢åˆ†ç‰‡çš„å‰åç›¸é‚»åˆ†ç‰‡
    - çª—å£å¤§å°å¯é…ç½®ï¼ˆé»˜è®¤å‰åå„ 1 ä¸ªåˆ†ç‰‡ï¼‰
    - åˆå¹¶è¿ç»­åˆ†ç‰‡ï¼Œé¿å…é‡å¤
  - **çˆ¶å­åˆ†å—æ‰©å±•**ï¼š
    - è‹¥ä½¿ç”¨çˆ¶å­åˆ†å—ç­–ç•¥ï¼Œæ£€ç´¢åŒ¹é…å­åˆ†ç‰‡
    - è¿”å›æ—¶æ‰©å±•åˆ°çˆ¶åˆ†ç‰‡ï¼Œæä¾›å®Œæ•´ä¸Šä¸‹æ–‡
  - **è¯­ä¹‰è¾¹ç•Œæ‰©å±•**ï¼š
    - æ£€æµ‹åˆ†ç‰‡æ˜¯å¦åœ¨è¯­ä¹‰è¾¹ç•Œï¼ˆç« èŠ‚ã€æ®µè½ç»“å°¾ï¼‰
    - è‹¥ä¸åœ¨è¾¹ç•Œï¼Œæ‰©å±•åˆ°æœ€è¿‘çš„è¯­ä¹‰è¾¹ç•Œ
- [ ] **æ‰©å±•å‚æ•°**ï¼š
  - `window_size: int` - æ»‘åŠ¨çª—å£å¤§å°ï¼ˆé»˜è®¤ 1ï¼‰
  - `use_parent_child: bool` - æ˜¯å¦ä½¿ç”¨çˆ¶å­åˆ†å—æ‰©å±•ï¼ˆé»˜è®¤ Trueï¼‰
  - `max_total_tokens: int` - æ‰©å±•åçš„æœ€å¤§ Token æ•°ï¼ˆé»˜è®¤ 2000ï¼‰
  - `overlap_threshold: float` - é‡å é˜ˆå€¼ï¼ˆé»˜è®¤ 0.3ï¼‰
- [ ] **æ™ºèƒ½æ‰©å±•ç­–ç•¥**ï¼š
  - **ä»£ç åˆ†ç‰‡**ï¼šæ‰©å±•åˆ°å®Œæ•´å‡½æ•°/ç±»å®šä¹‰
  - **å…¬å¼åˆ†ç‰‡**ï¼šæ‰©å±•åˆ°å®Œæ•´å…¬å¼å—
  - **è¡¨æ ¼åˆ†ç‰‡**ï¼šæ‰©å±•åˆ°å®Œæ•´è¡¨æ ¼
  - **åˆ—è¡¨åˆ†ç‰‡**ï¼šæ‰©å±•åˆ°å®Œæ•´åˆ—è¡¨
- [ ] **Token é¢„ç®—ç®¡ç†**ï¼š
  - æŒ‰ç›¸å…³åº¦åˆ†æ•°åˆ†é… Token é¢„ç®—
  - é«˜ç›¸å…³åº¦ç»“æœè·å¾—æ›´å¤šæ‰©å±•ç©ºé—´
  - è¶…å‡ºé¢„ç®—æ—¶ä¼˜å…ˆä¿ç•™åŸå§‹æ£€ç´¢ç»“æœ
- [ ] **æ‰©å±•ç»“æœç»“æ„**ï¼š
  - `original_chunk` - åŸå§‹æ£€ç´¢åˆ†ç‰‡
  - `expanded_content` - æ‰©å±•åçš„å®Œæ•´å†…å®¹
  - `expansion_info` - æ‰©å±•ä¿¡æ¯ï¼ˆå‘å‰/å‘åæ‰©å±•æ•°ã€æ€» Token æ•°ã€æ˜¯å¦æˆªæ–­ï¼‰
  - `metadata` - å…ƒæ•°æ®ï¼ˆæ–‡ä»¶åã€ä½ç½®ç­‰ï¼‰
- [ ] **è¢«è°ƒç”¨æ–¹**ï¼š`RetrievalService`

---

### 5.6 ä»£ç ç´¢å¼•æ¨¡å—ç»„ (`domain/knowledge/code/`)

> **æ¨¡å—ç»„è®¾è®¡è¯´æ˜**ï¼šä»£ç ç´¢å¼•æ¶‰åŠæ–‡ä»¶ç›‘å¬ã€é˜²æŠ–åŠ¨ã€è¯­æ³•æ„ŸçŸ¥åˆ†å—ç­‰å¤šä¸ªç‹¬ç«‹èŒè´£ï¼Œä¸ºéµå¾ªå•ä¸€èŒè´£åŸåˆ™ï¼Œæ‹†åˆ†ä¸ºä»¥ä¸‹å­æ¨¡å—ï¼š
> - `code_indexer.py` - ä»£ç ç´¢å¼•å™¨é—¨é¢ç±»
> - `spice_chunker.py` - SPICE è¯­æ³•æ„ŸçŸ¥åˆ†å—
> - `python_chunker.py` - Python ä»£ç åˆ†å—
> - `file_change_handler.py` - æ–‡ä»¶å˜æ›´å¤„ç†
> - `debounced_indexer.py` - é˜²æŠ–åŠ¨ç´¢å¼•è°ƒåº¦

#### 5.4.1 `code_indexer.py` - ä»£ç ç´¢å¼•å™¨é—¨é¢ç±»

> **åˆå§‹åŒ–é¡ºåº**ï¼šPhase 3.22ï¼Œä¾èµ– VectorStoreã€EmbeddingServiceã€EventBusï¼Œæ³¨å†Œåˆ° ServiceLocator

- [ ] **æ–‡ä»¶è·¯å¾„**ï¼š`domain/knowledge/code/code_indexer.py`
- [ ] **èŒè´£**ï¼šä½œä¸ºä»£ç ç´¢å¼•çš„ç»Ÿä¸€å…¥å£ï¼Œåè°ƒå„å­æ¨¡å—å®Œæˆç´¢å¼•ç®¡ç†
- [ ] **è®¾è®¡è¯´æ˜**ï¼š
  - æ–‡æ¡£ç´¢å¼•ç”±ç”¨æˆ·æ‰‹åŠ¨è§¦å‘ï¼Œå­˜å‚¨åœ¨ `documents` é›†åˆ
  - ä»£ç ç´¢å¼•ç”±æ–‡ä»¶å˜æ›´è‡ªåŠ¨è§¦å‘ï¼Œå­˜å‚¨åœ¨ `code` é›†åˆ
  - ä¸¤è€…æ›´æ–°æœºåˆ¶ä¸åŒï¼Œç‹¬ç«‹æ¨¡å—ä¾¿äºç»´æŠ¤å’Œè°ƒè¯•
- [ ] **æ ¸å¿ƒåŠŸèƒ½**ï¼š
  - `initialize(project_path)` - åˆå§‹åŒ–ä»£ç ç´¢å¼•å™¨
  - `index_file(file_path)` - ç´¢å¼•å•ä¸ªæ–‡ä»¶
  - `index_directory(dir_path, pattern)` - æ‰¹é‡ç´¢å¼•ç›®å½•
  - `update_index(file_path)` - å¢é‡æ›´æ–°å•ä¸ªæ–‡ä»¶ç´¢å¼•
  - `remove_from_index(file_path)` - ä»ç´¢å¼•ä¸­åˆ é™¤æ–‡ä»¶
  - `rebuild_index()` - é‡å»ºæ•´ä¸ªä»£ç ç´¢å¼•
  - `get_index_status()` - è·å–ç´¢å¼•çŠ¶æ€ç»Ÿè®¡
- [ ] **ç´¢å¼•è§¦å‘æœºåˆ¶**ï¼š
  - é¡¹ç›®æ‰“å¼€ï¼šè‡ªåŠ¨å…¨é‡æ‰«æï¼Œå¢é‡æ›´æ–°ï¼ˆæ¯”å¯¹å“ˆå¸Œï¼‰
  - æ–‡ä»¶ä¿å­˜ï¼šè‡ªåŠ¨å•æ–‡ä»¶å¢é‡æ›´æ–°
  - LLM åˆ›å»ºæ–‡ä»¶ï¼šè‡ªåŠ¨å•æ–‡ä»¶æ–°å¢ç´¢å¼•
  - LLM ä¿®æ”¹æ–‡ä»¶ï¼šè‡ªåŠ¨å•æ–‡ä»¶å¢é‡æ›´æ–°
  - æ–‡ä»¶åˆ é™¤ï¼šè‡ªåŠ¨ä»ç´¢å¼•ä¸­åˆ é™¤
  - ç”¨æˆ·æ‰‹åŠ¨ï¼šå¯é€‰å…¨é‡é‡å»º
- [ ] **å¢é‡æ›´æ–°ç®—æ³•**ï¼š
  1. è®¡ç®—æ–‡ä»¶å†…å®¹ SHA256 å“ˆå¸Œ
  2. æŸ¥è¯¢ `code` é›†åˆä¸­è¯¥æ–‡ä»¶çš„å·²å­˜å“ˆå¸Œ
  3. å“ˆå¸Œç›¸åŒ â†’ è·³è¿‡ç´¢å¼•
  4. å“ˆå¸Œä¸åŒ â†’ åˆ é™¤æ—§åˆ†ç‰‡ï¼Œé‡æ–°åˆ†å—å¹¶ç´¢å¼•
  5. æ–‡ä»¶ä¸å­˜åœ¨äºç´¢å¼• â†’ æ–°å¢ç´¢å¼•
- [ ] **æ–‡ä»¶ç±»å‹è·¯ç”±**ï¼š
  - `.cir`ã€`.sp`ã€`.spice`ã€`.net`ã€`.ckt` â†’ `SpiceChunker`
  - `.py` â†’ `PythonChunker`
  - å…¶ä»–æ–‡æœ¬æ–‡ä»¶ â†’ é€šç”¨è¡Œåˆ†å—
- [ ] **ä¸ EventBus é›†æˆ**ï¼š
  - è®¢é˜… `EVENT_FILE_CHANGED` äº‹ä»¶
  - è®¢é˜… `EVENT_STATE_PROJECT_OPENED` äº‹ä»¶
  - å‘å¸ƒ `CODE_INDEX_STARTED`ã€`CODE_INDEX_UPDATED`ã€`CODE_INDEX_COMPLETE` äº‹ä»¶
- [ ] **ä¾èµ–æ¨¡å—**ï¼š
  - `SpiceChunker` - SPICE åˆ†å—
  - `PythonChunker` - Python åˆ†å—
  - `FileChangeHandler` - æ–‡ä»¶å˜æ›´å¤„ç†
  - `DebouncedIndexer` - é˜²æŠ–åŠ¨è°ƒåº¦
  - `VectorStore` - å‘é‡å­˜å‚¨
  - `EmbeddingService` - åµŒå…¥æœåŠ¡
- [ ] **è¢«è°ƒç”¨æ–¹**ï¼š`IndexManager`ã€`context_retrieval/context_retriever.py`ï¼ˆé˜¶æ®µä¸‰ï¼‰

#### 5.4.2 `spice_chunker.py` - SPICE è¯­æ³•æ„ŸçŸ¥åˆ†å—å™¨

- [ ] **æ–‡ä»¶è·¯å¾„**ï¼š`domain/knowledge/code/spice_chunker.py`
- [ ] **èŒè´£**ï¼šé’ˆå¯¹ SPICE æ–‡ä»¶è¿›è¡Œè¯­æ³•æ„ŸçŸ¥çš„æ™ºèƒ½åˆ†å—
- [ ] **æ ¸å¿ƒåŠŸèƒ½**ï¼š
  - `chunk(file_path)` - å¯¹ SPICE æ–‡ä»¶è¿›è¡Œåˆ†å—
  - `parse_structure(content)` - è§£ææ–‡ä»¶ç»“æ„
  - `extract_subcircuits(content)` - æå–å­ç”µè·¯å®šä¹‰
  - `extract_control_blocks(content)` - æå–æ§åˆ¶å—
  - `extract_metadata(chunk)` - æå–åˆ†ç‰‡å…ƒæ•°æ®
- [ ] **åˆ†å—ç­–ç•¥**ï¼š
  - **å­ç”µè·¯è¾¹ç•Œ**ï¼šæŒ‰ `.subckt` / `.ends` è¾¹ç•Œåˆ†ç‰‡ï¼Œæ¯ä¸ªå­ç”µè·¯ç‹¬ç«‹æˆç‰‡
  - **æ§åˆ¶å—è¾¹ç•Œ**ï¼šæŒ‰ `.control` / `.endc` è¾¹ç•Œåˆ†ç‰‡
  - **åˆ†æå‘½ä»¤**ï¼š`.ac`ã€`.dc`ã€`.tran`ã€`.noise` ç­‰åˆ†æå‘½ä»¤ç‹¬ç«‹æˆç‰‡
  - **å‚æ•°å®šä¹‰**ï¼š`.param` è¯­å¥å—ç‹¬ç«‹æˆç‰‡
  - **å…¶ä»–å†…å®¹**ï¼šæŒ‰è¡Œæ•°åˆ†ç‰‡ï¼ˆé»˜è®¤ 50 è¡Œï¼‰ï¼Œä¿ç•™ä¸Šä¸‹æ–‡ï¼ˆå‰åå„ 5 è¡Œï¼‰
- [ ] **å…ƒæ•°æ®æå–**ï¼š
  - `file_path` - æ–‡ä»¶ç›¸å¯¹è·¯å¾„
  - `chunk_offset` - åˆ†ç‰‡èµ·å§‹è¡Œå·
  - `chunk_type` - åˆ†ç‰‡ç±»å‹ï¼ˆsubckt/control/analysis/param/generalï¼‰
  - `syntax_tags` - è¯­æ³•æ ‡ç­¾åˆ—è¡¨
  - `device_names` - åŒ…å«çš„å™¨ä»¶åï¼ˆR1ã€C2ã€Q3 ç­‰ï¼‰
  - `node_names` - åŒ…å«çš„èŠ‚ç‚¹å
  - `subcircuit_name` - å­ç”µè·¯åç§°ï¼ˆè‹¥ä¸ºå­ç”µè·¯åˆ†ç‰‡ï¼‰
  - `file_hash` - æ–‡ä»¶å†…å®¹å“ˆå¸Œ
  - `mtime` - æ–‡ä»¶ä¿®æ”¹æ—¶é—´
- [ ] **è¯­æ³•æ ‡ç­¾è¯†åˆ«**ï¼š
  - `subckt` - å­ç”µè·¯å®šä¹‰
  - `control` - æ§åˆ¶å—
  - `ac_analysis` - AC åˆ†æ
  - `dc_analysis` - DC åˆ†æ
  - `tran_analysis` - ç¬æ€åˆ†æ
  - `noise_analysis` - å™ªå£°åˆ†æ
  - `param` - å‚æ•°å®šä¹‰
  - `include` - æ–‡ä»¶åŒ…å«
  - `model` - æ¨¡å‹å®šä¹‰
- [ ] **è¢«è°ƒç”¨æ–¹**ï¼š`CodeIndexer`

#### 5.4.3 `python_chunker.py` - Python ä»£ç åˆ†å—å™¨

- [ ] **æ–‡ä»¶è·¯å¾„**ï¼š`domain/knowledge/code/python_chunker.py`
- [ ] **èŒè´£**ï¼šé’ˆå¯¹ Python æ–‡ä»¶è¿›è¡Œè¯­æ³•æ„ŸçŸ¥çš„æ™ºèƒ½åˆ†å—
- [ ] **æ ¸å¿ƒåŠŸèƒ½**ï¼š
  - `chunk(file_path)` - å¯¹ Python æ–‡ä»¶è¿›è¡Œåˆ†å—
  - `parse_ast(content)` - è§£æ AST ç»“æ„
  - `extract_functions(content)` - æå–å‡½æ•°å®šä¹‰
  - `extract_classes(content)` - æå–ç±»å®šä¹‰
- [ ] **åˆ†å—ç­–ç•¥**ï¼š
  - **ç±»å®šä¹‰**ï¼šæ¯ä¸ªç±»ç‹¬ç«‹æˆç‰‡ï¼ˆåŒ…å«æ‰€æœ‰æ–¹æ³•ï¼‰
  - **å‡½æ•°å®šä¹‰**ï¼šæ¯ä¸ªé¡¶å±‚å‡½æ•°ç‹¬ç«‹æˆç‰‡
  - **å¯¼å…¥è¯­å¥**ï¼šæ‰€æœ‰å¯¼å…¥è¯­å¥åˆå¹¶æˆä¸€ç‰‡
  - **æ¨¡å—çº§ä»£ç **ï¼šå…¶ä»–æ¨¡å—çº§ä»£ç æŒ‰è¡Œæ•°åˆ†ç‰‡
- [ ] **å…ƒæ•°æ®æå–**ï¼š
  - `file_path` - æ–‡ä»¶ç›¸å¯¹è·¯å¾„
  - `chunk_offset` - åˆ†ç‰‡èµ·å§‹è¡Œå·
  - `chunk_type` - åˆ†ç‰‡ç±»å‹ï¼ˆclass/function/import/moduleï¼‰
  - `symbol_name` - ç¬¦å·åç§°ï¼ˆç±»å/å‡½æ•°åï¼‰
  - `docstring` - æ–‡æ¡£å­—ç¬¦ä¸²
  - `dependencies` - ä¾èµ–çš„æ¨¡å—/å‡½æ•°
- [ ] **è¢«è°ƒç”¨æ–¹**ï¼š`CodeIndexer`

#### 5.4.4 `file_change_handler.py` - æ–‡ä»¶å˜æ›´å¤„ç†å™¨

- [ ] **æ–‡ä»¶è·¯å¾„**ï¼š`domain/knowledge/code/file_change_handler.py`
- [ ] **èŒè´£**ï¼šå¤„ç†æ–‡ä»¶å˜æ›´äº‹ä»¶ï¼Œè¿‡æ»¤å’Œåˆ†ç±»å˜æ›´
- [ ] **æ ¸å¿ƒåŠŸèƒ½**ï¼š
  - `on_file_changed(event)` - å¤„ç†æ–‡ä»¶å˜æ›´äº‹ä»¶
  - `filter_event(event)` - è¿‡æ»¤å¿½ç•¥çš„äº‹ä»¶
  - `classify_event(event)` - åˆ†ç±»äº‹ä»¶ç±»å‹
  - `deduplicate_events(events)` - äº‹ä»¶å»é‡
- [ ] **äº‹ä»¶è¿‡æ»¤è§„åˆ™**ï¼š
  - å¿½ç•¥ä¸´æ—¶æ–‡ä»¶ï¼ˆ.tmpã€.swpã€~ç»“å°¾ï¼‰
  - å¿½ç•¥éšè—æ–‡ä»¶ï¼ˆ.å¼€å¤´ï¼‰
  - å¿½ç•¥ `.circuit_ai/` ç›®å½•ä¸‹çš„æ–‡ä»¶
  - å¿½ç•¥ `simulation_results/` ç›®å½•ä¸‹çš„æ–‡ä»¶
  - å¿½ç•¥ `__pycache__/` ç›®å½•
  - å¿½ç•¥ `.git/` ç›®å½•
- [ ] **äº‹ä»¶åˆ†ç±»**ï¼š
  - `created` - æ–‡ä»¶åˆ›å»º
  - `modified` - æ–‡ä»¶ä¿®æ”¹
  - `deleted` - æ–‡ä»¶åˆ é™¤
  - `renamed` - æ–‡ä»¶é‡å‘½å
- [ ] **äº‹ä»¶æ¥æºè¯†åˆ«**ï¼š
  - `file_watcher` - æ–‡ä»¶ç³»ç»Ÿç›‘å¬å™¨æ£€æµ‹
  - `llm_tool` - LLM å·¥å…·è°ƒç”¨è§¦å‘
  - `user_save` - ç”¨æˆ·ç¼–è¾‘å™¨ä¿å­˜è§¦å‘
- [ ] **é‡å¤äº‹ä»¶è¿‡æ»¤**ï¼š
  - åŒä¸€æ–‡ä»¶åœ¨ 100ms å†…çš„å¤šä¸ªäº‹ä»¶åˆå¹¶
  - LLM å·¥å…·è°ƒç”¨å 500ms å†…å¿½ç•¥ file_watcher çš„é‡å¤äº‹ä»¶
  - ä½¿ç”¨äº‹ä»¶æŒ‡çº¹ï¼ˆpath + type + timestampï¼‰å»é‡
- [ ] **è¢«è°ƒç”¨æ–¹**ï¼š`CodeIndexer`

#### 5.4.5 `debounced_indexer.py` - é˜²æŠ–åŠ¨ç´¢å¼•è°ƒåº¦å™¨

- [ ] **æ–‡ä»¶è·¯å¾„**ï¼š`domain/knowledge/code/debounced_indexer.py`
- [ ] **èŒè´£**ï¼šå®ç°é˜²æŠ–åŠ¨æœºåˆ¶ï¼Œåˆå¹¶çŸ­æ—¶é—´å†…çš„å¤šæ¬¡ç´¢å¼•è¯·æ±‚
- [ ] **æ ¸å¿ƒåŠŸèƒ½**ï¼š
  - `schedule_update(file_path)` - è°ƒåº¦æ–‡ä»¶ç´¢å¼•æ›´æ–°
  - `schedule_batch_update(file_paths)` - è°ƒåº¦æ‰¹é‡æ›´æ–°
  - `cancel_pending(file_path)` - å–æ¶ˆå¾…å¤„ç†çš„æ›´æ–°
  - `flush()` - ç«‹å³æ‰§è¡Œæ‰€æœ‰å¾…å¤„ç†æ›´æ–°
- [ ] **é˜²æŠ–åŠ¨æœºåˆ¶**ï¼š
  - æ–‡ä»¶å˜æ›´äº‹ä»¶åœ¨ 500ms å†…åˆå¹¶å¤„ç†
  - åŒä¸€æ–‡ä»¶çš„å¤šæ¬¡å˜æ›´åªè§¦å‘ä¸€æ¬¡ç´¢å¼•æ›´æ–°
  - ä½¿ç”¨ `threading.Timer` å®ç°å»¶è¿Ÿæ‰§è¡Œ
- [ ] **æ‰¹é‡å˜æ›´ä¼˜åŒ–**ï¼š
  - å½“å¤šä¸ªæ–‡ä»¶åŒæ—¶å˜æ›´æ—¶ï¼ˆå¦‚ Git åˆ‡æ¢åˆ†æ”¯ï¼‰ï¼Œåˆå¹¶ä¸ºå•æ¬¡æ‰¹é‡æ›´æ–°
  - æ‰¹é‡æ›´æ–°é˜ˆå€¼ï¼š10 ä¸ªæ–‡ä»¶ä»¥ä¸Šè§¦å‘æ‰¹é‡æ¨¡å¼
  - æ‰¹é‡æ¨¡å¼ä¸‹ä½¿ç”¨ `index_directory()` è€Œéé€æ–‡ä»¶æ›´æ–°
- [ ] **å®ç°ç»†èŠ‚**ï¼š
  - ç»´æŠ¤å¾…å¤„ç†æ–‡ä»¶å­—å…¸ï¼š`{file_path: Timer}`
  - çº¿ç¨‹é”ä¿æŠ¤å¹¶å‘è®¿é—®
  - å®šæ—¶å™¨è§¦å‘åæ‰§è¡Œå®é™…ç´¢å¼•æ›´æ–°
  - æ”¯æŒå–æ¶ˆå¾…å¤„ç†çš„æ›´æ–°
- [ ] **è¢«è°ƒç”¨æ–¹**ï¼š`CodeIndexer`

---

### 5.7 è‡ªåŠ¨ç´¢å¼•è§¦å‘æœºåˆ¶ (`domain/knowledge/trigger/`)

> **âš ï¸ æ ¸å¿ƒè®¾è®¡**ï¼šé¡¹ç›®æ‰“å¼€æ—¶è‡ªåŠ¨è§¦å‘ä»£ç ç´¢å¼•ï¼Œç¡®ä¿è¯­ä¹‰æœç´¢åŠŸèƒ½å¯ç”¨ã€‚
> ç±»ä¼¼ Cursor/VS Code çš„ç´¢å¼•æœºåˆ¶ï¼Œç”¨æˆ·æ— éœ€æ‰‹åŠ¨è§¦å‘ï¼Œæ‰“å¼€é¡¹ç›®å³å¼€å§‹åå°ç´¢å¼•ã€‚

> **è®¾è®¡åŸåˆ™**ï¼š
> - ç´¢å¼•åœ¨åå°å¼‚æ­¥æ‰§è¡Œï¼Œä¸é˜»å¡é¡¹ç›®æ‰“å¼€æµç¨‹
> - ä½¿ç”¨å¢é‡ç´¢å¼•ç­–ç•¥ï¼Œä»…ç´¢å¼•å˜æ›´æ–‡ä»¶
> - çŠ¶æ€æ æ˜¾ç¤ºç´¢å¼•è¿›åº¦ï¼Œå®Œæˆåè‡ªåŠ¨æ¶ˆå¤±
> - ç´¢å¼•å®Œæˆåè¯­ä¹‰æœç´¢åŠŸèƒ½è‡ªåŠ¨å¯ç”¨

> **ç›®å½•ç»“æ„**ï¼š
> ```
> domain/knowledge/trigger/
> â”œâ”€â”€ __init__.py
> â”œâ”€â”€ index_trigger_service.py    # ç´¢å¼•è§¦å‘æœåŠ¡
> â””â”€â”€ index_progress_tracker.py   # ç´¢å¼•è¿›åº¦è¿½è¸ªå™¨
> ```

#### 5.7.1 `index_trigger_service.py` - ç´¢å¼•è§¦å‘æœåŠ¡

> **åˆå§‹åŒ–é¡ºåº**ï¼šPhase 3.24ï¼Œä¾èµ– CodeIndexerã€EventBusï¼Œæ³¨å†Œåˆ° ServiceLocator

- [ ] **æ–‡ä»¶è·¯å¾„**ï¼š`domain/knowledge/trigger/index_trigger_service.py`
- [ ] **èŒè´£**ï¼šåè°ƒé¡¹ç›®æ‰“å¼€æ—¶çš„è‡ªåŠ¨ç´¢å¼•è§¦å‘ï¼Œç®¡ç†ç´¢å¼•ç”Ÿå‘½å‘¨æœŸ
- [ ] **æ ¸å¿ƒåŠŸèƒ½**ï¼š
  - `trigger_project_index(project_path)` - è§¦å‘é¡¹ç›®ç´¢å¼•ï¼ˆå¼‚æ­¥ï¼‰
  - `cancel_current_index()` - å–æ¶ˆå½“å‰ç´¢å¼•ä»»åŠ¡
  - `is_indexing()` - æ£€æŸ¥æ˜¯å¦æ­£åœ¨ç´¢å¼•
  - `get_index_progress()` - è·å–å½“å‰ç´¢å¼•è¿›åº¦
- [ ] **è§¦å‘æ—¶æœº**ï¼š
  - `ProjectService.initialize_project()` å®Œæˆåè°ƒç”¨ `trigger_project_index()`
  - ä¸é˜»å¡é¡¹ç›®æ‰“å¼€ä¸»æµç¨‹
- [ ] **ç´¢å¼•æµç¨‹**ï¼š
  1. å‘å¸ƒ `CODE_INDEX_STARTED` äº‹ä»¶
  2. é€šè¿‡ `AsyncTaskRegistry` æäº¤ç´¢å¼•ä»»åŠ¡
  3. è°ƒç”¨ `CodeIndexer.index_project_async(project_path)`
  4. å®šæœŸå‘å¸ƒ `CODE_INDEX_PROGRESS` äº‹ä»¶ï¼ˆè¿›åº¦æ›´æ–°ï¼‰
  5. ç´¢å¼•å®Œæˆåå‘å¸ƒ `CODE_INDEX_COMPLETE` äº‹ä»¶
  6. ç´¢å¼•å¤±è´¥æ—¶å‘å¸ƒ `CODE_INDEX_ERROR` äº‹ä»¶
- [ ] **å¢é‡ç´¢å¼•ç­–ç•¥**ï¼š
  - é¦–æ¬¡æ‰“å¼€é¡¹ç›®ï¼šå…¨é‡æ‰«ææ‰€æœ‰ä»£ç æ–‡ä»¶
  - å†æ¬¡æ‰“å¼€é¡¹ç›®ï¼šæ¯”å¯¹æ–‡ä»¶å“ˆå¸Œï¼Œä»…ç´¢å¼•å˜æ›´æ–‡ä»¶
  - å“ˆå¸Œå­˜å‚¨ä½ç½®ï¼š`.circuit_ai/index_meta.json`
- [ ] **ä¸ EventBus é›†æˆ**ï¼š
  - è®¢é˜… `EVENT_STATE_PROJECT_OPENED` äº‹ä»¶ï¼Œè‡ªåŠ¨è§¦å‘ç´¢å¼•
  - è®¢é˜… `EVENT_STATE_PROJECT_CLOSED` äº‹ä»¶ï¼Œå–æ¶ˆè¿›è¡Œä¸­çš„ç´¢å¼•
  - è®¢é˜… `EVENT_FILE_CHANGED` äº‹ä»¶ï¼Œè§¦å‘å•æ–‡ä»¶å¢é‡æ›´æ–°
- [ ] **ä¾èµ–æ¨¡å—**ï¼š
  - `CodeIndexer`ï¼ˆ5.6.1ï¼‰- æ‰§è¡Œå®é™…ç´¢å¼•
  - `IndexProgressTracker` - è¿›åº¦è¿½è¸ª
  - `AsyncTaskRegistry` - å¼‚æ­¥ä»»åŠ¡æäº¤
- [ ] **è¢«è°ƒç”¨æ–¹**ï¼š`ProjectService`ï¼ˆé˜¶æ®µäºŒ 2.5.1ï¼‰

#### 5.7.2 `index_progress_tracker.py` - ç´¢å¼•è¿›åº¦è¿½è¸ªå™¨

- [ ] **æ–‡ä»¶è·¯å¾„**ï¼š`domain/knowledge/trigger/index_progress_tracker.py`
- [ ] **èŒè´£**ï¼šè¿½è¸ªç´¢å¼•è¿›åº¦ï¼Œæä¾›è¿›åº¦ä¿¡æ¯ä¾› UI æ˜¾ç¤º
- [ ] **æ ¸å¿ƒåŠŸèƒ½**ï¼š
  - `start_tracking(total_files)` - å¼€å§‹è¿½è¸ª
  - `update_progress(current_file, processed_count)` - æ›´æ–°è¿›åº¦
  - `finish_tracking(success)` - ç»“æŸè¿½è¸ª
  - `get_progress()` - è·å–å½“å‰è¿›åº¦
- [ ] **è¿›åº¦æ•°æ®ç»“æ„**ï¼š
  ```python
  @dataclass
  class IndexProgress:
      is_indexing: bool           # æ˜¯å¦æ­£åœ¨ç´¢å¼•
      total_files: int            # æ€»æ–‡ä»¶æ•°
      processed_files: int        # å·²å¤„ç†æ–‡ä»¶æ•°
      current_file: str           # å½“å‰å¤„ç†çš„æ–‡ä»¶å
      percent: float              # å®Œæˆç™¾åˆ†æ¯”ï¼ˆ0-100ï¼‰
      start_time: float           # å¼€å§‹æ—¶é—´æˆ³
      elapsed_seconds: float      # å·²ç”¨æ—¶é—´
      estimated_remaining: float  # é¢„ä¼°å‰©ä½™æ—¶é—´
  ```
- [ ] **è¿›åº¦äº‹ä»¶èŠ‚æµ**ï¼š
  - ä½¿ç”¨ `EventThrottler` èšåˆé«˜é¢‘è¿›åº¦æ›´æ–°
  - æœ€å°å‘å¸ƒé—´éš”ï¼š100ms
  - é¿å…äº‹ä»¶é£æš´å½±å“ UI æ€§èƒ½
- [ ] **è¢«è°ƒç”¨æ–¹**ï¼š`IndexTriggerService`ã€`StatusBarIndexWidget`

#### 5.7.3 ç´¢å¼•è§¦å‘äº‹ä»¶å®šä¹‰

- [ ] **æ‰©å±• `shared/events/knowledge_events.py`**ï¼š
  ```python
  class KnowledgeEvents:
      # ... ç°æœ‰äº‹ä»¶ ...
      
      # è‡ªåŠ¨ç´¢å¼•è§¦å‘äº‹ä»¶
      CODE_INDEX_TRIGGERED = "knowledge.code_index_triggered"
      CODE_INDEX_STARTED = "knowledge.code_index_started"
      CODE_INDEX_PROGRESS = "knowledge.code_index_progress"
      CODE_INDEX_COMPLETE = "knowledge.code_index_complete"
      CODE_INDEX_ERROR = "knowledge.code_index_error"
      CODE_INDEX_CANCELLED = "knowledge.code_index_cancelled"
  ```
- [ ] **äº‹ä»¶æ•°æ®ç»“æ„**ï¼š
  - `CODE_INDEX_STARTED`ï¼š`{"project_path": str, "total_files": int}`
  - `CODE_INDEX_PROGRESS`ï¼š`{"current_file": str, "processed": int, "total": int, "percent": float}`
  - `CODE_INDEX_COMPLETE`ï¼š`{"project_path": str, "indexed_files": int, "duration_seconds": float}`
  - `CODE_INDEX_ERROR`ï¼š`{"project_path": str, "error_message": str}`

#### 5.7.4 ä¸ `CodeIndexer` çš„é›†æˆ

- [ ] **`CodeIndexer` æ–°å¢æ–¹æ³•**ï¼š
  - `index_project_async(project_path, progress_callback)` - å¼‚æ­¥ç´¢å¼•æ•´ä¸ªé¡¹ç›®
  - å†…éƒ¨è°ƒç”¨ `index_directory()` æ‰§è¡Œå®é™…ç´¢å¼•
  - é€šè¿‡ `progress_callback` æŠ¥å‘Šè¿›åº¦
- [ ] **å¢é‡ç´¢å¼•å…ƒæ•°æ®**ï¼š
  - å­˜å‚¨ä½ç½®ï¼š`.circuit_ai/index_meta.json`
  - å†…å®¹ï¼š`{"files": {"path": {"hash": str, "indexed_at": str, "chunk_count": int}}}`
  - ç”¨äºåˆ¤æ–­æ–‡ä»¶æ˜¯å¦éœ€è¦é‡æ–°ç´¢å¼•

---

### 5.8 çŠ¶æ€æ ç´¢å¼•è¿›åº¦æ˜¾ç¤º (`presentation/widgets/`)

> **è®¾è®¡ç›®æ ‡**ï¼šåœ¨ä¸»çª—å£çŠ¶æ€æ æ˜¾ç¤ºç´¢å¼•è¿›åº¦ï¼Œç´¢å¼•å®Œæˆåè‡ªåŠ¨æ¶ˆå¤±ã€‚
> å‚è€ƒ Cursor/VS Code çš„ç´¢å¼•è¿›åº¦æ˜¾ç¤ºé£æ ¼ã€‚

#### 5.8.1 `status_bar_index_widget.py` - çŠ¶æ€æ ç´¢å¼•è¿›åº¦ç»„ä»¶

- [ ] **æ–‡ä»¶è·¯å¾„**ï¼š`presentation/widgets/status_bar_index_widget.py`
- [ ] **èŒè´£**ï¼šåœ¨çŠ¶æ€æ æ˜¾ç¤ºç´¢å¼•è¿›åº¦ï¼Œæä¾›å–æ¶ˆæŒ‰é’®
- [ ] **æ ¸å¿ƒåŠŸèƒ½**ï¼š
  - `show_progress(progress)` - æ˜¾ç¤ºç´¢å¼•è¿›åº¦
  - `hide()` - éšè—è¿›åº¦æ˜¾ç¤º
  - `set_error(message)` - æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
- [ ] **UI å¸ƒå±€**ï¼š
  ```
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  [å…¶ä»–çŠ¶æ€æ å†…å®¹]  â”‚  [spinner] ç´¢å¼•ä¸­ 45/120 æ–‡ä»¶...  [Ã—]  â”‚  Ln 1  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  ```
- [ ] **æ˜¾ç¤ºçŠ¶æ€**ï¼ˆä½¿ç”¨ SVG å›¾æ ‡ï¼Œè·¯å¾„ï¼š`resources/icons/status/`ï¼‰ï¼š
  - ç´¢å¼•ä¸­ï¼š`spinner.svg` + `ç´¢å¼•ä¸­ {processed}/{total} æ–‡ä»¶...` + å–æ¶ˆæŒ‰é’®
  - ç´¢å¼•å®Œæˆï¼š`check.svg` + `ç´¢å¼•å®Œæˆ` â†’ 2 ç§’åè‡ªåŠ¨æ¶ˆå¤±
  - ç´¢å¼•å¤±è´¥ï¼š`warning.svg` + `ç´¢å¼•å¤±è´¥` + ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…
  - ç©ºé—²ï¼šä¸æ˜¾ç¤ºï¼ˆç»„ä»¶éšè—ï¼‰
- [ ] **äº¤äº’**ï¼š
  - ç‚¹å‡»å–æ¶ˆæŒ‰é’®ï¼šè°ƒç”¨ `IndexTriggerService.cancel_current_index()`
  - ç‚¹å‡»é”™è¯¯çŠ¶æ€ï¼šå¼¹å‡ºé”™è¯¯è¯¦æƒ…å¯¹è¯æ¡†
- [ ] **äº‹ä»¶è®¢é˜…**ï¼š
  - `CODE_INDEX_STARTED` â†’ æ˜¾ç¤ºè¿›åº¦ç»„ä»¶
  - `CODE_INDEX_PROGRESS` â†’ æ›´æ–°è¿›åº¦æ˜¾ç¤º
  - `CODE_INDEX_COMPLETE` â†’ æ˜¾ç¤ºå®ŒæˆçŠ¶æ€ï¼Œ2 ç§’åéšè—
  - `CODE_INDEX_ERROR` â†’ æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
- [ ] **å›½é™…åŒ–æ”¯æŒ**ï¼šå®ç° `retranslate_ui()` æ–¹æ³•
- [ ] **è¢«è°ƒç”¨æ–¹**ï¼š`MainWindow`ï¼ˆçŠ¶æ€æ é›†æˆï¼‰

#### 5.8.2 `main_window.py` çŠ¶æ€æ é›†æˆ

- [ ] **çŠ¶æ€æ å¸ƒå±€æ›´æ–°**ï¼š
  - åœ¨çŠ¶æ€æ å³ä¾§æ·»åŠ  `StatusBarIndexWidget`
  - ä½ç½®ï¼šåœ¨è¡Œå·æ˜¾ç¤ºå·¦ä¾§
- [ ] **åˆå§‹åŒ–**ï¼š
  - åœ¨ `MainWindow.__init__()` ä¸­åˆ›å»º `StatusBarIndexWidget`
  - æ·»åŠ åˆ°çŠ¶æ€æ å¸ƒå±€
  - åˆå§‹çŠ¶æ€ä¸ºéšè—

---

### 5.9 åµŒå…¥æ¨¡å‹æ¨¡å—ç»„ (`domain/knowledge/embedding/`)

> **æ¨¡å—ç»„è®¾è®¡è¯´æ˜**ï¼šåµŒå…¥æ¨¡å‹æ¶‰åŠæ¨¡å‹åŠ è½½ã€æ‰¹é‡å¤„ç†ã€çº¿ä¸Š/æœ¬åœ°é€‚é…ç­‰å¤šä¸ªèŒè´£ï¼Œä¸ºéµå¾ªå•ä¸€èŒè´£åŸåˆ™ï¼Œæ‹†åˆ†ä¸ºä»¥ä¸‹å­æ¨¡å—ï¼š
> - `embedding_service.py` - åµŒå…¥æœåŠ¡é—¨é¢ç±»ï¼Œç»Ÿä¸€æœ¬åœ°å’Œçº¿ä¸ŠåµŒå…¥æ¨¡å‹çš„è°ƒç”¨æ¥å£
> - `model_loader.py` - æœ¬åœ°æ¨¡å‹åŠ è½½å™¨
> - `batch_embedder.py` - æ‰¹é‡åµŒå…¥å¤„ç†
> - `base_embedding_client.py` - åµŒå…¥å®¢æˆ·ç«¯æŠ½è±¡åŸºç±»
> - `local_embedding_client.py` - æœ¬åœ°åµŒå…¥æ¨¡å‹å®¢æˆ·ç«¯
> - `remote_embedding_client.py` - çº¿ä¸ŠåµŒå…¥æ¨¡å‹å®¢æˆ·ç«¯ï¼ˆæ™ºè°±ã€OpenAI ç­‰ï¼‰

> **æœ¬åœ°ä¸çº¿ä¸Šæ¨¡å‹åˆ‡æ¢è®¾è®¡**ï¼š
> - åµŒå…¥æœåŠ¡æ”¯æŒæœ¬åœ°æ¨¡å‹å’Œçº¿ä¸Šæ¨¡å‹çš„åŠ¨æ€åˆ‡æ¢
> - é€šè¿‡ `ConfigManager.get("embedding_provider")` è·å–å½“å‰é…ç½®çš„å‚å•†
> - å‚å•†åˆ‡æ¢æ—¶é€šè¿‡ `EVENT_EMBEDDING_PROVIDER_CHANGED` äº‹ä»¶é€šçŸ¥ï¼Œè‡ªåŠ¨é‡æ–°åˆå§‹åŒ–å®¢æˆ·ç«¯
> - å‘é‡ç»´åº¦å˜åŒ–æ—¶éœ€è¦é‡å»ºç´¢å¼•ï¼ˆæç¤ºç”¨æˆ·ç¡®è®¤ï¼‰

#### 5.5.1 `embedding_service.py` - åµŒå…¥æœåŠ¡é—¨é¢ç±»

> **åˆå§‹åŒ–é¡ºåº**ï¼šPhase 3.20ï¼Œä¾èµ– ConfigManagerã€EmbeddingModelRegistryï¼Œæ³¨å†Œåˆ° ServiceLocator

- [ ] **æ–‡ä»¶è·¯å¾„**ï¼š`domain/knowledge/embedding/embedding_service.py`
- [ ] **èŒè´£**ï¼šä½œä¸ºåµŒå…¥åŠŸèƒ½çš„ç»Ÿä¸€å…¥å£ï¼Œåè°ƒæœ¬åœ°å’Œçº¿ä¸ŠåµŒå…¥æ¨¡å‹çš„è°ƒç”¨
- [ ] **æ ¸å¿ƒåŠŸèƒ½**ï¼š
  - `initialize()` - åˆå§‹åŒ–åµŒå…¥æœåŠ¡ï¼Œæ ¹æ®é…ç½®é€‰æ‹©æœ¬åœ°æˆ–çº¿ä¸Šå®¢æˆ·ç«¯
  - `embed_text(text)` - å•æ–‡æœ¬å‘é‡åŒ–
  - `embed_batch(texts)` - æ‰¹é‡å‘é‡åŒ–
  - `embed_query(query)` - æŸ¥è¯¢å‘é‡åŒ–ï¼ˆå¯èƒ½æœ‰ç‰¹æ®Šå¤„ç†ï¼‰
  - `get_embedding_dimension()` - è·å–å½“å‰æ¨¡å‹çš„å‘é‡ç»´åº¦
  - `is_ready()` - æ£€æŸ¥æœåŠ¡æ˜¯å¦å°±ç»ª
  - `get_current_provider()` - è·å–å½“å‰ä½¿ç”¨çš„å‚å•†
  - `switch_provider(provider_id)` - åˆ‡æ¢åµŒå…¥æ¨¡å‹å‚å•†
- [ ] **å®¢æˆ·ç«¯é€‰æ‹©é€»è¾‘**ï¼š
  - ä» `ConfigManager.get("embedding_provider")` è·å–å½“å‰å‚å•†
  - `local` â†’ ä½¿ç”¨ `LocalEmbeddingClient`
  - `zhipu` â†’ ä½¿ç”¨ `ZhipuEmbeddingClient`
  - `openai` â†’ ä½¿ç”¨ `OpenAIEmbeddingClient`ï¼ˆå ä½ï¼‰
  - å®¢æˆ·ç«¯å®ä¾‹ç¼“å­˜ï¼Œå‚å•†åˆ‡æ¢æ—¶é‡æ–°åˆ›å»º
- [ ] **æœ¬åœ°æ¨¡å‹é…ç½®**ï¼ˆé»˜è®¤ï¼‰ï¼š
  - **é»˜è®¤æ¨¡å‹**ï¼š`Alibaba-NLP/gte-modernbert-base`
    - ç»´åº¦ï¼š768ï¼Œå‚æ•°é‡ï¼š149Mï¼Œçº¦ 600MB
    - åŸºäº ModernBERT æ¶æ„ï¼Œæ”¯æŒ 8192 é•¿ä¸Šä¸‹æ–‡
    - MTEB 64.38 åˆ†ï¼Œé€‚åˆæŠ€æœ¯æ–‡æ¡£å’Œä»£ç æ£€ç´¢
  - **è½»é‡å¤‡é€‰**ï¼š`BAAI/bge-small-en-v1.5`
    - ç»´åº¦ï¼š384ï¼Œå‚æ•°é‡ï¼š33Mï¼Œçº¦ 130MB
    - èµ„æºå—é™æ—¶ä½¿ç”¨
- [ ] **çº¿ä¸Šæ¨¡å‹é…ç½®**ï¼š
  - **æ™ºè°± Embedding-3**ï¼šç»´åº¦ 2048ï¼Œæœ€å¤§ 8192 tokens
  - **æ™ºè°± Embedding-2**ï¼šç»´åº¦ 1024ï¼Œæœ€å¤§ 512 tokensï¼ˆæ—§ç‰ˆï¼‰
  - **OpenAI text-embedding-3-small**ï¼šç»´åº¦ 1536ï¼ˆå ä½ï¼‰
- [ ] **åˆå§‹åŒ–æµç¨‹**ï¼š
  1. ä» ConfigManager è¯»å– `embedding_provider` é…ç½®
  2. å‘å¸ƒ `EVENT_EMBEDDING_MODEL_LOADING` äº‹ä»¶
  3. æ ¹æ®å‚å•†åˆ›å»ºå¯¹åº”çš„åµŒå…¥å®¢æˆ·ç«¯
  4. æœ¬åœ°æ¨¡å‹ï¼šå§”æ‰˜ `ModelLoader` åŠ è½½æ¨¡å‹
  5. çº¿ä¸Šæ¨¡å‹ï¼šéªŒè¯ API Key æœ‰æ•ˆæ€§
  6. å‘å¸ƒ `EVENT_EMBEDDING_MODEL_READY` äº‹ä»¶
  7. æ³¨å†Œåˆ° ServiceLocator
- [ ] **å‚å•†åˆ‡æ¢å¤„ç†**ï¼š
  - è®¢é˜… `EVENT_EMBEDDING_PROVIDER_CHANGED` äº‹ä»¶
  - åˆ‡æ¢æ—¶æ£€æŸ¥å‘é‡ç»´åº¦æ˜¯å¦å˜åŒ–
  - ç»´åº¦å˜åŒ–æ—¶æç¤ºç”¨æˆ·éœ€è¦é‡å»ºç´¢å¼•
  - é‡æ–°åˆ›å»ºå¯¹åº”çš„åµŒå…¥å®¢æˆ·ç«¯
- [ ] **ä¾èµ–æ¨¡å—**ï¼š
  - `LocalEmbeddingClient` - æœ¬åœ°åµŒå…¥å®¢æˆ·ç«¯
  - `ZhipuEmbeddingClient` - æ™ºè°±åµŒå…¥å®¢æˆ·ç«¯
  - `BatchEmbedder` - æ‰¹é‡å¤„ç†
  - `ConfigManager` - é…ç½®ç®¡ç†
  - `EmbeddingModelRegistry` - åµŒå…¥æ¨¡å‹æ³¨å†Œè¡¨
- [ ] **è¢«è°ƒç”¨æ–¹**ï¼š`VectorStore`ã€`RetrievalService`ã€`CodeIndexer`

#### 5.5.2 `model_loader.py` - æ¨¡å‹åŠ è½½å™¨

- [ ] **æ–‡ä»¶è·¯å¾„**ï¼š`domain/knowledge/embedding/model_loader.py`
- [ ] **èŒè´£**ï¼šè´Ÿè´£åµŒå…¥æ¨¡å‹çš„åŠ è½½å’Œç®¡ç†
- [ ] **æ ¸å¿ƒåŠŸèƒ½**ï¼š
  - `load_model(model_name)` - åŠ è½½æŒ‡å®šæ¨¡å‹
  - `get_model()` - è·å–å·²åŠ è½½çš„æ¨¡å‹
  - `unload_model()` - å¸è½½æ¨¡å‹é‡Šæ”¾å†…å­˜
  - `get_model_info()` - è·å–æ¨¡å‹ä¿¡æ¯
- [ ] **æ¨¡å‹åŠ è½½ç­–ç•¥**ï¼š
  - ä¼˜å…ˆä» `vendor/models/embeddings/` åŠ è½½æœ¬åœ°é¢„ä¸‹è½½æ¨¡å‹
  - é€šè¿‡ `model_config.get_embedding_model_path()` è·å–æ¨¡å‹è·¯å¾„
  - è‹¥æœ¬åœ°æ¨¡å‹ä¸å­˜åœ¨ï¼Œå›é€€åˆ° HuggingFace ç¼“å­˜ç›®å½•
  - æ‰“åŒ…åç”¨æˆ·æ— éœ€è”ç½‘å³å¯ä½¿ç”¨ RAG åŠŸèƒ½
- [ ] **è®¾å¤‡é€‰æ‹©**ï¼š
  - è‡ªåŠ¨æ£€æµ‹å¯ç”¨è®¾å¤‡ï¼ˆCUDA > MPS > CPUï¼‰
  - æ”¯æŒæ‰‹åŠ¨æŒ‡å®šè®¾å¤‡
  - GPU å†…å­˜ä¸è¶³æ—¶è‡ªåŠ¨å›é€€åˆ° CPU
- [ ] **æ¨¡å‹é…ç½®**ï¼š
  - `max_seq_length` - æœ€å¤§åºåˆ—é•¿åº¦ï¼ˆé»˜è®¤ 8192ï¼‰
  - `normalize_embeddings` - æ˜¯å¦å½’ä¸€åŒ–ï¼ˆé»˜è®¤ Trueï¼‰
  - `device` - è¿è¡Œè®¾å¤‡
- [ ] **ä¾èµ–**ï¼š`sentence-transformers>=3.3.0`ã€`transformers>=4.48.0`
- [ ] **è¢«è°ƒç”¨æ–¹**ï¼š`EmbeddingService`

#### 5.5.3 `batch_embedder.py` - æ‰¹é‡åµŒå…¥å¤„ç†å™¨

- [ ] **æ–‡ä»¶è·¯å¾„**ï¼š`domain/knowledge/embedding/batch_embedder.py`
- [ ] **èŒè´£**ï¼šé«˜æ•ˆå¤„ç†æ‰¹é‡æ–‡æœ¬çš„å‘é‡åŒ–
- [ ] **æ ¸å¿ƒåŠŸèƒ½**ï¼š
  - `embed_batch(texts, batch_size)` - æ‰¹é‡å‘é‡åŒ–
  - `embed_with_progress(texts, callback)` - å¸¦è¿›åº¦å›è°ƒçš„æ‰¹é‡å‘é‡åŒ–
  - `estimate_time(text_count)` - ä¼°ç®—å¤„ç†æ—¶é—´
- [ ] **æ‰¹é‡å¤„ç†ç­–ç•¥**ï¼š
  - é»˜è®¤æ‰¹å¤§å°ï¼š32ï¼ˆå¯æ ¹æ® GPU å†…å­˜è°ƒæ•´ï¼‰
  - åŠ¨æ€æ‰¹å¤§å°ï¼šæ ¹æ®æ–‡æœ¬é•¿åº¦è‡ªåŠ¨è°ƒæ•´
  - é•¿æ–‡æœ¬æˆªæ–­ï¼šè¶…è¿‡ `max_seq_length` æ—¶æˆªæ–­
- [ ] **æ€§èƒ½ä¼˜åŒ–**ï¼š
  - æ‰¹é‡å¤„ç†å‡å°‘ GPU è°ƒç”¨å¼€é”€
  - æ–‡æœ¬é¢„æ’åºï¼šæŒ‰é•¿åº¦æ’åºå‡å°‘ padding
  - å†…å­˜ç®¡ç†ï¼šåŠæ—¶é‡Šæ”¾ä¸­é—´ç»“æœ
  - è¿›åº¦å›è°ƒï¼šæ”¯æŒ UI è¿›åº¦æ˜¾ç¤º
- [ ] **é”™è¯¯å¤„ç†**ï¼š
  - å•æ¡æ–‡æœ¬å¤±è´¥ä¸å½±å“æ•´æ‰¹
  - å¤±è´¥æ–‡æœ¬è¿”å›é›¶å‘é‡å¹¶è®°å½•è­¦å‘Š
  - GPU å†…å­˜æº¢å‡ºæ—¶è‡ªåŠ¨å‡å°æ‰¹å¤§å°é‡è¯•
- [ ] **è¢«è°ƒç”¨æ–¹**ï¼š`EmbeddingService`

#### 5.5.4 `base_embedding_client.py` - åµŒå…¥å®¢æˆ·ç«¯æŠ½è±¡åŸºç±»

- [ ] **æ–‡ä»¶è·¯å¾„**ï¼š`domain/knowledge/embedding/base_embedding_client.py`
- [ ] **èŒè´£**ï¼šå®šä¹‰æ‰€æœ‰åµŒå…¥å®¢æˆ·ç«¯çš„ç»Ÿä¸€æ¥å£
- [ ] **æŠ½è±¡æ–¹æ³•**ï¼š
  - `embed(text: str) -> List[float]` - å•æ–‡æœ¬å‘é‡åŒ–
  - `embed_batch(texts: List[str]) -> List[List[float]]` - æ‰¹é‡å‘é‡åŒ–
  - `get_dimension() -> int` - è·å–å‘é‡ç»´åº¦
  - `get_max_tokens() -> int` - è·å–æœ€å¤§ token æ•°
  - `is_ready() -> bool` - æ£€æŸ¥å®¢æˆ·ç«¯æ˜¯å¦å°±ç»ª
  - `get_provider_id() -> str` - è·å–å‚å•†æ ‡è¯†
  - `is_local() -> bool` - æ˜¯å¦ä¸ºæœ¬åœ°æ¨¡å‹
- [ ] **é€šç”¨å±æ€§**ï¼š
  - `model_name: str` - æ¨¡å‹åç§°
  - `dimension: int` - å‘é‡ç»´åº¦
  - `max_tokens: int` - æœ€å¤§ token æ•°
- [ ] **è¢«è°ƒç”¨æ–¹**ï¼š`EmbeddingService`

#### 5.5.5 `local_embedding_client.py` - æœ¬åœ°åµŒå…¥æ¨¡å‹å®¢æˆ·ç«¯

- [ ] **æ–‡ä»¶è·¯å¾„**ï¼š`domain/knowledge/embedding/local_embedding_client.py`
- [ ] **èŒè´£**ï¼šå°è£…æœ¬åœ°åµŒå…¥æ¨¡å‹çš„åŠ è½½å’Œè°ƒç”¨
- [ ] **æ ¸å¿ƒåŠŸèƒ½**ï¼š
  - `__init__(model_name)` - åˆå§‹åŒ–ï¼ŒæŒ‡å®šæ¨¡å‹åç§°
  - `load_model()` - åŠ è½½æ¨¡å‹åˆ°å†…å­˜
  - `embed(text)` - å•æ–‡æœ¬å‘é‡åŒ–
  - `embed_batch(texts)` - æ‰¹é‡å‘é‡åŒ–ï¼ˆå§”æ‰˜ç»™ BatchEmbedderï¼‰
  - `unload_model()` - å¸è½½æ¨¡å‹é‡Šæ”¾å†…å­˜
- [ ] **æ¨¡å‹åŠ è½½ç­–ç•¥**ï¼š
  - ä¼˜å…ˆä» `vendor/models/embeddings/` åŠ è½½æœ¬åœ°é¢„ä¸‹è½½æ¨¡å‹
  - è‹¥æœ¬åœ°æ¨¡å‹ä¸å­˜åœ¨ï¼Œå›é€€åˆ° HuggingFace ç¼“å­˜ç›®å½•
  - ä½¿ç”¨ `sentence-transformers` åº“åŠ è½½æ¨¡å‹
- [ ] **è®¾å¤‡é€‰æ‹©**ï¼š
  - è‡ªåŠ¨æ£€æµ‹å¯ç”¨è®¾å¤‡ï¼ˆCUDA > MPS > CPUï¼‰
  - GPU å†…å­˜ä¸è¶³æ—¶è‡ªåŠ¨å›é€€åˆ° CPU
- [ ] **ä¾èµ–**ï¼š`ModelLoader`ã€`BatchEmbedder`
- [ ] **è¢«è°ƒç”¨æ–¹**ï¼š`EmbeddingService`

#### 5.5.6 çº¿ä¸ŠåµŒå…¥æ¨¡å‹é€‚é…å™¨ (`infrastructure/embedding_adapters/`)

> **è®¾è®¡è¯´æ˜**ï¼šçº¿ä¸ŠåµŒå…¥æ¨¡å‹é€‚é…å™¨æ”¾åœ¨åŸºç¡€è®¾æ–½å±‚ï¼Œä¸ LLM é€‚é…å™¨ï¼ˆ`llm_adapters/`ï¼‰è®¾è®¡é£æ ¼ä¿æŒä¸€è‡´ã€‚

- [ ] **ç›®å½•ç»“æ„**ï¼š
  ```
  infrastructure/embedding_adapters/
  â”œâ”€â”€ __init__.py
  â”œâ”€â”€ base_remote_client.py           # çº¿ä¸ŠåµŒå…¥å®¢æˆ·ç«¯åŸºç±»
  â”œâ”€â”€ zhipu/                           # æ™ºè°±åµŒå…¥é€‚é…å™¨
  â”‚   â”œâ”€â”€ __init__.py
  â”‚   â”œâ”€â”€ zhipu_embedding_client.py   # æ™ºè°±åµŒå…¥å®¢æˆ·ç«¯
  â”‚   â””â”€â”€ zhipu_embedding_models.py   # æ™ºè°±åµŒå…¥æ¨¡å‹é…ç½®
  â””â”€â”€ openai/                          # OpenAI åµŒå…¥é€‚é…å™¨ï¼ˆå ä½ï¼‰
      â”œâ”€â”€ __init__.py
      â””â”€â”€ openai_embedding_client.py
  ```

##### 5.5.6.1 `base_remote_client.py` - çº¿ä¸ŠåµŒå…¥å®¢æˆ·ç«¯åŸºç±»

- [ ] **æ–‡ä»¶è·¯å¾„**ï¼š`infrastructure/embedding_adapters/base_remote_client.py`
- [ ] **èŒè´£**ï¼šå®šä¹‰çº¿ä¸ŠåµŒå…¥å®¢æˆ·ç«¯çš„é€šç”¨é€»è¾‘
- [ ] **æ ¸å¿ƒåŠŸèƒ½**ï¼š
  - `__init__(api_key, base_url, model, timeout)` - åˆå§‹åŒ–
  - `_make_request(texts)` - å‘é€åµŒå…¥è¯·æ±‚ï¼ˆæŠ½è±¡æ–¹æ³•ï¼‰
  - `_parse_response(response)` - è§£æå“åº”ï¼ˆæŠ½è±¡æ–¹æ³•ï¼‰
  - `embed(text)` - å•æ–‡æœ¬å‘é‡åŒ–
  - `embed_batch(texts)` - æ‰¹é‡å‘é‡åŒ–ï¼ˆè‡ªåŠ¨åˆ†æ‰¹ï¼‰
- [ ] **é€šç”¨é…ç½®**ï¼š
  - `batch_size: int` - å•æ¬¡è¯·æ±‚æœ€å¤§æ–‡æœ¬æ•°ï¼ˆé»˜è®¤ 32ï¼‰
  - `timeout: int` - è¯·æ±‚è¶…æ—¶ç§’æ•°ï¼ˆé»˜è®¤ 30ï¼‰
  - `retry_count: int` - é‡è¯•æ¬¡æ•°ï¼ˆé»˜è®¤ 3ï¼‰
- [ ] **é”™è¯¯å¤„ç†**ï¼š
  - è®¤è¯å¤±è´¥ï¼ˆ401/403ï¼‰ï¼šæŠ›å‡º `AuthError`
  - é€Ÿç‡é™åˆ¶ï¼ˆ429ï¼‰ï¼šæŠ›å‡º `RateLimitError`ï¼Œæºå¸¦å»ºè®®ç­‰å¾…æ—¶é—´
  - ç½‘ç»œé”™è¯¯ï¼šæŠ›å‡º `NetworkError`
  - è¶…æ—¶ï¼šæŠ›å‡º `TimeoutError`
- [ ] **ä¸ ExternalServiceManager é›†æˆ**ï¼š
  - æ‰€æœ‰ API è°ƒç”¨é€šè¿‡ `external_service_manager.call_service()` è¿›è¡Œ
  - è‡ªåŠ¨è·å¾—é‡è¯•ã€ç†”æ–­ã€ç»Ÿè®¡èƒ½åŠ›
- [ ] **è¢«è°ƒç”¨æ–¹**ï¼š`ZhipuEmbeddingClient`ã€`OpenAIEmbeddingClient`

##### 5.5.6.2 `zhipu_embedding_client.py` - æ™ºè°±åµŒå…¥å®¢æˆ·ç«¯

> **API æ–‡æ¡£å‚è€ƒ**ï¼šhttps://open.bigmodel.cn/dev/api/vector/embedding-3

- [ ] **æ–‡ä»¶è·¯å¾„**ï¼š`infrastructure/embedding_adapters/zhipu/zhipu_embedding_client.py`
- [ ] **èŒè´£**ï¼šå°è£…æ™ºè°±åµŒå…¥ API çš„è°ƒç”¨
- [ ] **API ç«¯ç‚¹**ï¼š`https://open.bigmodel.cn/api/paas/v4/embeddings`
- [ ] **è®¤è¯æ–¹å¼**ï¼šHTTP Bearer Tokenï¼ˆ`Authorization: Bearer YOUR_API_KEY`ï¼‰
- [ ] **æ ¸å¿ƒåŠŸèƒ½**ï¼š
  - `__init__(api_key, model, base_url, timeout)` - åˆå§‹åŒ–
  - `embed(text)` - å•æ–‡æœ¬å‘é‡åŒ–
  - `embed_batch(texts)` - æ‰¹é‡å‘é‡åŒ–
  - `get_dimension()` - è·å–å‘é‡ç»´åº¦
  - `test_connection()` - æµ‹è¯• API è¿æ¥
- [ ] **è¯·æ±‚ä½“ç»“æ„**ï¼š
  ```python
  {
    "model": "embedding-3",  # æˆ– "embedding-2"
    "input": ["text1", "text2", ...]  # æ–‡æœ¬åˆ—è¡¨
  }
  ```
- [ ] **å“åº”ä½“ç»“æ„**ï¼š
  ```python
  {
    "model": "embedding-3",
    "data": [
      {"index": 0, "embedding": [0.1, 0.2, ...]},
      {"index": 1, "embedding": [0.3, 0.4, ...]},
    ],
    "usage": {
      "prompt_tokens": 10,
      "total_tokens": 10
    }
  }
  ```
- [ ] **æ”¯æŒçš„æ¨¡å‹**ï¼š
  - `embedding-3`ï¼š2048 ç»´ï¼Œæœ€å¤§ 8192 tokensï¼Œæ¨èä½¿ç”¨
  - `embedding-2`ï¼š1024 ç»´ï¼Œæœ€å¤§ 512 tokensï¼Œæ—§ç‰ˆå…¼å®¹
- [ ] **æ‰¹é‡è¯·æ±‚é™åˆ¶**ï¼š
  - å•æ¬¡è¯·æ±‚æœ€å¤š 64 æ¡æ–‡æœ¬
  - è¶…è¿‡é™åˆ¶æ—¶è‡ªåŠ¨åˆ†æ‰¹è¯·æ±‚
- [ ] **é”™è¯¯å¤„ç†**ï¼š
  - è§£ææ™ºè°± API é”™è¯¯å“åº”
  - æ˜ å°„åˆ°ç»Ÿä¸€çš„å¼‚å¸¸ç±»å‹
- [ ] **è¢«è°ƒç”¨æ–¹**ï¼š`EmbeddingService`

##### 5.5.6.3 `zhipu_embedding_models.py` - æ™ºè°±åµŒå…¥æ¨¡å‹é…ç½®

- [ ] **æ–‡ä»¶è·¯å¾„**ï¼š`infrastructure/embedding_adapters/zhipu/zhipu_embedding_models.py`
- [ ] **èŒè´£**ï¼šå®šä¹‰æ™ºè°±åµŒå…¥æ¨¡å‹çš„é…ç½®ä¿¡æ¯
- [ ] **æ¨¡å‹é…ç½®**ï¼š
  ```python
  ZHIPU_EMBEDDING_MODELS = [
      EmbeddingModelConfig(
          id="zhipu:embedding-3",
          provider="zhipu",
          name="embedding-3",
          display_name="Embedding-3 (æ¨è)",
          dimensions=2048,
          max_tokens=8192,
          is_local=False,
          description="æ™ºè°±æœ€æ–°åµŒå…¥æ¨¡å‹ï¼Œ2048ç»´å‘é‡ï¼Œæ”¯æŒ8Kä¸Šä¸‹æ–‡"
      ),
      EmbeddingModelConfig(
          id="zhipu:embedding-2",
          provider="zhipu",
          name="embedding-2",
          display_name="Embedding-2 (æ—§ç‰ˆ)",
          dimensions=1024,
          max_tokens=512,
          is_local=False,
          description="æ™ºè°±æ—§ç‰ˆåµŒå…¥æ¨¡å‹ï¼Œ1024ç»´å‘é‡"
      ),
  ]
  ```
- [ ] **è¢«è°ƒç”¨æ–¹**ï¼š`EmbeddingModelRegistry`ï¼ˆåˆå§‹åŒ–æ—¶åŠ è½½ï¼‰

#### 5.5.7 å‘é‡ç»´åº¦å˜åŒ–å¤„ç†

> **è®¾è®¡è¯´æ˜**ï¼šåˆ‡æ¢åµŒå…¥æ¨¡å‹å‚å•†æ—¶ï¼Œå‘é‡ç»´åº¦å¯èƒ½å‘ç”Ÿå˜åŒ–ï¼ˆå¦‚æœ¬åœ° 768 ç»´ â†’ æ™ºè°± 2048 ç»´ï¼‰ï¼Œéœ€è¦é‡å»ºç´¢å¼•ã€‚

- [ ] **ç»´åº¦å˜åŒ–æ£€æµ‹**ï¼š
  - `EmbeddingService.switch_provider()` æ—¶æ¯”è¾ƒæ–°æ—§ç»´åº¦
  - ç»´åº¦ä¸åŒæ—¶å‘å¸ƒ `EVENT_EMBEDDING_DIMENSION_CHANGED` äº‹ä»¶
- [ ] **ç”¨æˆ·ç¡®è®¤æµç¨‹**ï¼š
  - å¼¹å‡ºç¡®è®¤å¯¹è¯æ¡†ï¼Œè¯´æ˜éœ€è¦é‡å»ºç´¢å¼•
  - æ˜¾ç¤ºå½“å‰ç´¢å¼•æ–‡æ¡£æ•°é‡å’Œé¢„ä¼°é‡å»ºæ—¶é—´
  - ç”¨æˆ·ç¡®è®¤åæ‰§è¡Œé‡å»ºï¼Œå–æ¶ˆåˆ™å›é€€å‚å•†é€‰æ‹©
- [ ] **ç´¢å¼•é‡å»º**ï¼š
  - è°ƒç”¨ `IndexManager.rebuild_all()` é‡å»ºæ‰€æœ‰ç´¢å¼•
  - æ˜¾ç¤ºè¿›åº¦å¯¹è¯æ¡†
  - é‡å»ºå®Œæˆåæ›´æ–° `VectorStore` çš„ç»´åº¦é…ç½®
- [ ] **ChromaDB é›†åˆå¤„ç†**ï¼š
  - ç»´åº¦å˜åŒ–æ—¶éœ€è¦åˆ é™¤æ—§é›†åˆå¹¶åˆ›å»ºæ–°é›†åˆ
  - æ–°é›†åˆä½¿ç”¨æ–°çš„å‘é‡ç»´åº¦é…ç½®

---

### 5.10 ç´¢å¼•ç®¡ç†å™¨ (`domain/knowledge/`)

#### 5.10.1 `index_manager.py` - ç´¢å¼•ç®¡ç†å™¨

> **åˆå§‹åŒ–é¡ºåº**ï¼šPhase 3.23ï¼Œä¾èµ– VectorStoreã€EmbeddingServiceã€DocumentProcessorã€CodeIndexerï¼Œæ³¨å†Œåˆ° ServiceLocator

- [ ] **æ–‡ä»¶è·¯å¾„**ï¼š`domain/knowledge/index_manager.py`
- [ ] **èŒè´£**ï¼šä½œä¸ºçŸ¥è¯†åº“ç´¢å¼•çš„ç»Ÿä¸€å…¥å£ï¼Œåè°ƒæ–‡æ¡£ç´¢å¼•å’Œä»£ç ç´¢å¼•
- [ ] **æ ¸å¿ƒåŠŸèƒ½**ï¼š
  - `index_documents(folder_path, options)` - ç´¢å¼•æ–‡æ¡£æ–‡ä»¶å¤¹
  - `index_code(project_path)` - ç´¢å¼•ä»£ç æ–‡ä»¶
  - `rebuild_all()` - é‡å»ºæ‰€æœ‰ç´¢å¼•
  - `get_index_status()` - è·å–ç´¢å¼•çŠ¶æ€
  - `clear_index(collection_name)` - æ¸…ç©ºæŒ‡å®šç´¢å¼•
  - `export_index(path)` - å¯¼å‡ºç´¢å¼•æ•°æ®
  - `import_index(path)` - å¯¼å…¥ç´¢å¼•æ•°æ®
- [ ] **ç´¢å¼•é€‰é¡¹ `IndexOptions`**ï¼š
  - `file_patterns: List[str]` - æ–‡ä»¶åŒ¹é…æ¨¡å¼ï¼ˆé»˜è®¤ ["*.pdf", "*.docx", "*.md"]ï¼‰
  - `recursive: bool` - æ˜¯å¦é€’å½’å­ç›®å½•ï¼ˆé»˜è®¤ Trueï¼‰
  - `incremental: bool` - æ˜¯å¦å¢é‡æ›´æ–°ï¼ˆé»˜è®¤ Trueï¼‰
  - `chunking_strategy: str` - åˆ†å—ç­–ç•¥ï¼ˆsemantic/recursive/parent_childï¼‰
  - `chunk_size: int` - ç›®æ ‡åˆ†ç‰‡å¤§å°ï¼ˆé»˜è®¤ 1000 tokensï¼‰
  - `enable_metadata: bool` - æ˜¯å¦æå–å…ƒæ•°æ®ï¼ˆé»˜è®¤ Trueï¼‰
- [ ] **ç´¢å¼•æµç¨‹**ï¼š
  1. æ‰«æç›®æ ‡æ–‡ä»¶å¤¹ï¼Œè·å–å¾…å¤„ç†æ–‡ä»¶åˆ—è¡¨
  2. è‹¥å¢é‡æ¨¡å¼ï¼Œè°ƒç”¨ `IncrementalUpdater.detect_changes()` è¿‡æ»¤æœªå˜æ›´æ–‡ä»¶
  3. å§”æ‰˜ `DocumentProcessor` å¤„ç†æ¯ä¸ªæ–‡ä»¶
  4. å§”æ‰˜ `EmbeddingService` æ‰¹é‡ç”Ÿæˆå‘é‡
  5. å§”æ‰˜ `VectorStore` å­˜å‚¨å‘é‡å’Œå…ƒæ•°æ®
  6. å‘å¸ƒè¿›åº¦äº‹ä»¶
- [ ] **è¿›åº¦æŠ¥å‘Š**ï¼š
  - å‘å¸ƒ `DOCUMENT_INDEX_PROGRESS` äº‹ä»¶
  - æºå¸¦ï¼šå½“å‰æ–‡ä»¶ã€å·²å¤„ç†æ•°ã€æ€»æ•°ã€ç™¾åˆ†æ¯”
- [ ] **é”™è¯¯å¤„ç†**ï¼š
  - å•æ–‡ä»¶å¤„ç†å¤±è´¥ä¸å½±å“æ•´ä½“ç´¢å¼•
  - è®°å½•å¤±è´¥æ–‡ä»¶åˆ—è¡¨ï¼Œç´¢å¼•å®Œæˆåæ±‡æ€»æŠ¥å‘Š
  - æ”¯æŒæ–­ç‚¹ç»­ä¼ ï¼ˆè®°å½•å·²å¤„ç†æ–‡ä»¶ï¼‰
- [ ] **ä¾èµ–æ¨¡å—**ï¼š
  - `VectorStore` - å‘é‡å­˜å‚¨
  - `EmbeddingService` - åµŒå…¥æœåŠ¡
  - `DocumentProcessor` - æ–‡æ¡£å¤„ç†
  - `CodeIndexer` - ä»£ç ç´¢å¼•
  - `IncrementalUpdater` - å¢é‡æ›´æ–°
- [ ] **è¢«è°ƒç”¨æ–¹**ï¼š`RAGWorker`ã€`main_window.py`

---

### 5.11 RAG ä»»åŠ¡æ‰§è¡Œ (`domain/knowledge/`)

#### 5.11.1 `rag_task.py` - RAG ä»»åŠ¡å°è£…

> **âš ï¸ æ¶æ„å˜æ›´è¯´æ˜**ï¼šåŸ `rag_worker.py` å·²é‡æ„ä¸º `rag_task.py`ï¼Œä» QThread Worker æ¨¡å¼æ”¹ä¸ºåç¨‹ä»»åŠ¡æ¨¡å¼ï¼Œä¸é˜¶æ®µä¸€çš„å¹¶å‘æ¨¡å‹æ¶æ„ä¿æŒä¸€è‡´ã€‚

> **æ‰§è¡Œä¸Šä¸‹æ–‡**ï¼šä¸»è¿›ç¨‹ï¼Œåç¨‹ï¼ˆé€šè¿‡ AsyncTaskRegistry æäº¤ï¼‰

- [ ] **æ–‡ä»¶è·¯å¾„**ï¼š`domain/knowledge/rag_task.py`
- [ ] **èŒè´£**ï¼šå°è£… RAG ç´¢å¼•å’Œæ£€ç´¢ä»»åŠ¡ï¼Œé€šè¿‡åç¨‹å¼‚æ­¥æ‰§è¡Œ
- [ ] **æ ¸å¿ƒåŠŸèƒ½**ï¼š
  - **ç´¢å¼•ä»»åŠ¡**ï¼š
    - `async index_documents(folder_path, options, progress_callback)` - å¼‚æ­¥æ‰§è¡Œæ–‡æ¡£ç´¢å¼•
    - å§”æ‰˜ `IndexManager.index_documents()` æ‰§è¡Œç´¢å¼•
    - é€šè¿‡ `EventBus` å‘å¸ƒè¿›åº¦äº‹ä»¶ï¼ˆä½¿ç”¨ `EventThrottler` èšåˆï¼‰
  - **æ£€ç´¢ä»»åŠ¡**ï¼š
    - `async retrieve(query, options)` - å¼‚æ­¥æ‰§è¡Œæ£€ç´¢
    - å§”æ‰˜ `RetrievalService.retrieve()` æ‰§è¡Œæ£€ç´¢
    - è¿”å›æ£€ç´¢ç»“æœ
- [ ] **ä»»åŠ¡æäº¤æ–¹å¼**ï¼š
  ```python
  # é€šè¿‡ AsyncTaskRegistry æäº¤
  task_registry = ServiceLocator.get(AsyncTaskRegistry)
  task_registry.submit(
      task_type=TASK_RAG_INDEX,
      task_id=f"rag_index_{uuid4()}",
      coro=rag_task.index_documents(folder_path, options, progress_callback)
  )
  ```
- [ ] **è¿›åº¦äº‹ä»¶å‘å¸ƒ**ï¼š
  ```python
  # ä½¿ç”¨ EventThrottler èšåˆé«˜é¢‘è¿›åº¦æ›´æ–°
  throttler = EventThrottler(interval_ms=100)
  throttler.emit(RAGEvents.INDEX_PROGRESS, {
      "percent": percent,
      "message": f"æ­£åœ¨å¤„ç†: {filename}"
  })
  ```
- [ ] **æ£€ç´¢ç»“æœç»“æ„**ï¼š
  - `results: List[SearchResult]` - æ£€ç´¢ç»“æœåˆ—è¡¨
  - `query: str` - åŸå§‹æŸ¥è¯¢
  - `search_time_ms: float` - æ£€ç´¢è€—æ—¶
  - `total_candidates: int` - å€™é€‰æ€»æ•°
- [ ] **é”™è¯¯å¤„ç†**ï¼š
  - ç´¢å¼•å¤±è´¥ï¼šé€šè¿‡ `EventBus` å‘å¸ƒé”™è¯¯äº‹ä»¶
  - æ£€ç´¢å¤±è´¥ï¼šæŠ›å‡ºå¼‚å¸¸ï¼Œç”±è°ƒç”¨æ–¹å¤„ç†
  - æ¨¡å‹åŠ è½½å¤±è´¥ï¼šæŠ›å‡ºå¼‚å¸¸ï¼Œæç¤ºç”¨æˆ·æ£€æŸ¥æ¨¡å‹æ–‡ä»¶
- [ ] **å–æ¶ˆæ”¯æŒ**ï¼š
  - ä»»åŠ¡é€šè¿‡ `asyncio.CancelledError` å“åº”å–æ¶ˆ
  - å–æ¶ˆåæ¸…ç†å·²å¤„ç†çš„éƒ¨åˆ†æ•°æ®
- [ ] **è¢«è°ƒç”¨æ–¹**ï¼š
  - ç´¢å¼•ï¼š`main_window.py`ï¼ˆRAG ç´¢å¼•æŒ‰é’®ï¼‰
  - æ£€ç´¢ï¼š`rag_node.py`ã€`initial_design_node.py`ã€`context_retrieval/context_retriever.py`ï¼ˆé˜¶æ®µä¸‰ï¼‰

---

### 5.12 ä¸»çª—å£æ›´æ–° (`presentation/`)

#### 5.12.1 `main_window.py` - é›†æˆ RAG åŠŸèƒ½

- [ ] **æœ¬é˜¶æ®µæ–°å¢**ï¼š
  - è¿æ¥ `rag_worker` çš„ä¿¡å·åˆ°çŠ¶æ€æ 
  - å®ç° RAG ç´¢å¼•å’Œæ£€ç´¢çš„ UI äº¤äº’
  - é›†æˆç´¢å¼•çŠ¶æ€å¯¹è¯æ¡†
- [ ] **èœå•æ æ›´æ–°**ï¼š
  - **çŸ¥è¯†åº“èœå•**ï¼ˆæ–°å¢ï¼‰ï¼š
    - ç´¢å¼•æ–‡æ¡£æ–‡ä»¶å¤¹... - é€‰æ‹©æ–‡ä»¶å¤¹å¹¶ç´¢å¼•
    - é‡å»ºä»£ç ç´¢å¼• - é‡å»ºå½“å‰é¡¹ç›®çš„ä»£ç ç´¢å¼•
    - åˆ†éš”çº¿
    - å¯ç”¨ RAG æ£€ç´¢ - å¤é€‰æ¡†ï¼Œæ§åˆ¶æ£€ç´¢å¼€å…³
    - åˆ†éš”çº¿
    - æŸ¥çœ‹ç´¢å¼•çŠ¶æ€... - æ‰“å¼€ç´¢å¼•çŠ¶æ€å¯¹è¯æ¡†
    - æ¸…ç©ºæ‰€æœ‰ç´¢å¼• - æ¸…ç©ºæ‰€æœ‰ç´¢å¼•æ•°æ®
  - **å›½é™…åŒ–**ï¼šæ–°å¢èœå•é¡¹æ–‡æœ¬éœ€æ·»åŠ åˆ° `i18n_manager` æ–‡æœ¬å­—å…¸
- [ ] **å·¥å…·æ æ›´æ–°**ï¼š
  - `[ç´¢å¼•æ–‡æ¡£]` - è§¦å‘æ–‡æ¡£ç´¢å¼•ï¼Œå›¾æ ‡ `index.svg`
  - `[RAG å¼€å…³]` - RAG æ£€ç´¢å¼€å…³ï¼ˆåˆ‡æ¢æŒ‰é’®ï¼‰ï¼Œå›¾æ ‡ `search.svg`
  - **å›½é™…åŒ–**ï¼šæ–°å¢å·¥å…·æ æŒ‰é’®æ–‡æœ¬éœ€æ·»åŠ åˆ° `i18n_manager` æ–‡æœ¬å­—å…¸
- [ ] **çŠ¶æ€æ æ›´æ–°**ï¼š
  - ç´¢å¼•çŠ¶æ€åŒºåŸŸï¼š
    - ç©ºé—²æ—¶ï¼š`æ–‡æ¡£: {count} | ä»£ç : {count}`
    - ç´¢å¼•ä¸­ï¼š`æ­£åœ¨ç´¢å¼•: {filename} ({percent}%)`
  - RAG çŠ¶æ€æŒ‡ç¤ºå™¨ï¼š
    - å¯ç”¨æ—¶ï¼šç»¿è‰²å›¾æ ‡
    - ç¦ç”¨æ—¶ï¼šç°è‰²å›¾æ ‡
  - **å›½é™…åŒ–**ï¼šçŠ¶æ€æ æ–‡æœ¬é€šè¿‡ `i18n_manager.get_text()` è·å–
- [ ] **å¼‚æ­¥ä¿¡å·å¤„ç†**ï¼š
  - è®¢é˜… `DOCUMENT_INDEX_PROGRESS` äº‹ä»¶ â†’ æ›´æ–°çŠ¶æ€æ è¿›åº¦
  - è®¢é˜… `DOCUMENT_INDEX_COMPLETE` äº‹ä»¶ â†’ æ˜¾ç¤ºå®Œæˆæç¤º
  - è®¢é˜… `DOCUMENT_INDEX_ERROR` äº‹ä»¶ â†’ æ˜¾ç¤ºé”™è¯¯å¯¹è¯æ¡†
  - è®¢é˜… `CODE_INDEX_UPDATED` äº‹ä»¶ â†’ æ›´æ–°ä»£ç ç´¢å¼•è®¡æ•°
  - è®¢é˜… `SEARCH_COMPLETE` äº‹ä»¶ â†’ æ›´æ–°æ£€ç´¢ç»“æœ
- [ ] **æŒ‰é’®å¿™ç¢Œæ€ç®¡ç†**ï¼š
  - ç´¢å¼•æœŸé—´ç¦ç”¨ç´¢å¼•æŒ‰é’®
  - æ˜¾ç¤ºå–æ¶ˆæŒ‰é’®
  - å…¶ä»–æŒ‰é’®ä¿æŒå¯ç‚¹å‡»
- [ ] **ç´¢å¼•æ–‡ä»¶å¤¹é€‰æ‹©**ï¼š
  - ç‚¹å‡»"ç´¢å¼•æ–‡æ¡£æ–‡ä»¶å¤¹"åå¼¹å‡ºæ–‡ä»¶å¤¹é€‰æ‹©å¯¹è¯æ¡†
  - é€‰æ‹©åæ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†ï¼Œæ˜¾ç¤ºå°†è¦ç´¢å¼•çš„æ–‡ä»¶æ•°é‡
  - ç¡®è®¤åå¯åŠ¨ `RAGWorker` æ‰§è¡Œç´¢å¼•

---

### 5.13 ç´¢å¼•çŠ¶æ€å¯¹è¯æ¡† (`presentation/dialogs/`)

#### 5.13.1 `index_status_dialog.py` - ç´¢å¼•çŠ¶æ€å¯¹è¯æ¡†

- [ ] **æ–‡ä»¶è·¯å¾„**ï¼š`presentation/dialogs/index_status_dialog.py`
- [ ] **èŒè´£**ï¼šæ˜¾ç¤ºæ–‡æ¡£ç´¢å¼•å’Œä»£ç ç´¢å¼•çš„è¯¦ç»†çŠ¶æ€ï¼Œæä¾›ç´¢å¼•ç®¡ç†æ“ä½œ
- [ ] **è§¦å‘æ–¹å¼**ï¼šç‚¹å‡»èœå•"çŸ¥è¯†åº“ â†’ æŸ¥çœ‹ç´¢å¼•çŠ¶æ€"
- [ ] **å›½é™…åŒ–æ”¯æŒ**ï¼š
  - å®ç° `retranslate_ui()` æ–¹æ³•
  - è®¢é˜… `EVENT_LANGUAGE_CHANGED` äº‹ä»¶
- [ ] **å¯¹è¯æ¡†å¸ƒå±€**ï¼š
  ```
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Index Status / ç´¢å¼•çŠ¶æ€                               [Ã—]  â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                                                             â”‚
  â”‚  â”Œâ”€ Documents / æ–‡æ¡£ç´¢å¼• â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
  â”‚  â”‚                                                         â”‚ â”‚
  â”‚  â”‚  Status / çŠ¶æ€ï¼šReady / å°±ç»ª                            â”‚ â”‚
  â”‚  â”‚  Files / æ–‡ä»¶æ•°ï¼š42                                     â”‚ â”‚
  â”‚  â”‚  Chunks / åˆ†ç‰‡æ•°ï¼š1,256                                 â”‚ â”‚
  â”‚  â”‚  Size / å¤§å°ï¼š128 MB                                    â”‚ â”‚
  â”‚  â”‚  Last Updated / æœ€åæ›´æ–°ï¼š2024-12-19 10:30              â”‚ â”‚
  â”‚  â”‚                                                         â”‚ â”‚
  â”‚  â”‚  [â–¼ Show Files / æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨]                          â”‚ â”‚
  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
  â”‚  â”‚  â”‚ paper1.pdf          â”‚ 32 chunks â”‚ 2024-12-18    â”‚   â”‚ â”‚
  â”‚  â”‚  â”‚ paper2.pdf          â”‚ 28 chunks â”‚ 2024-12-17    â”‚   â”‚ â”‚
  â”‚  â”‚  â”‚ manual.docx         â”‚ 15 chunks â”‚ 2024-12-16    â”‚   â”‚ â”‚
  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
  â”‚  â”‚                                                         â”‚ â”‚
  â”‚  â”‚  [Rebuild / é‡å»º]  [Clear / æ¸…ç©º]                       â”‚ â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
  â”‚                                                             â”‚
  â”‚  â”Œâ”€ Code / ä»£ç ç´¢å¼• â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
  â”‚  â”‚                                                         â”‚ â”‚
  â”‚  â”‚  Status / çŠ¶æ€ï¼šSyncing / åŒæ­¥ä¸­                        â”‚ â”‚
  â”‚  â”‚  Files / æ–‡ä»¶æ•°ï¼š15                                     â”‚ â”‚
  â”‚  â”‚  Chunks / åˆ†ç‰‡æ•°ï¼š89                                    â”‚ â”‚
  â”‚  â”‚  Last Updated / æœ€åæ›´æ–°ï¼š2024-12-19 10:35              â”‚ â”‚
  â”‚  â”‚                                                         â”‚ â”‚
  â”‚  â”‚  [â–¼ Show Files / æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨]                          â”‚ â”‚
  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
  â”‚  â”‚  â”‚ main.cir            â”‚ 8 chunks  â”‚ 2024-12-19    â”‚   â”‚ â”‚
  â”‚  â”‚  â”‚ subcircuits/op.cir  â”‚ 12 chunks â”‚ 2024-12-18    â”‚   â”‚ â”‚
  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
  â”‚  â”‚                                                         â”‚ â”‚
  â”‚  â”‚  [Rebuild / é‡å»º]  [Clear / æ¸…ç©º]                       â”‚ â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
  â”‚                                                             â”‚
  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
  â”‚                                                             â”‚
  â”‚  [Clear All / æ¸…ç©ºæ‰€æœ‰]                      [Close / å…³é—­] â”‚
  â”‚                                                             â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  ```
- [ ] **UI ç»„ä»¶**ï¼š
  - **æ–‡æ¡£ç´¢å¼•çŠ¶æ€åŒº**ï¼š
    - çŠ¶æ€æŒ‡ç¤ºå™¨ï¼ˆå°±ç»ª/ç´¢å¼•ä¸­/é”™è¯¯ï¼‰
    - å·²ç´¢å¼•æ–‡ä»¶æ•°é‡
    - æ€»åˆ†ç‰‡æ•°é‡
    - ç´¢å¼•å¤§å°
    - æœ€åæ›´æ–°æ—¶é—´
    - å¯å±•å¼€çš„æ–‡ä»¶åˆ—è¡¨ï¼ˆæ˜¾ç¤ºæ–‡ä»¶åã€åˆ†ç‰‡æ•°ã€ç´¢å¼•æ—¶é—´ï¼‰
    - é‡å»ºæŒ‰é’®ã€æ¸…ç©ºæŒ‰é’®
  - **ä»£ç ç´¢å¼•çŠ¶æ€åŒº**ï¼š
    - çŠ¶æ€æŒ‡ç¤ºå™¨ï¼ˆå°±ç»ª/åŒæ­¥ä¸­/é”™è¯¯ï¼‰
    - å·²ç´¢å¼•æ–‡ä»¶æ•°é‡
    - æ€»åˆ†ç‰‡æ•°é‡
    - æœ€åæ›´æ–°æ—¶é—´
    - å¯å±•å¼€çš„æ–‡ä»¶åˆ—è¡¨
    - é‡å»ºæŒ‰é’®ã€æ¸…ç©ºæŒ‰é’®
  - **åº•éƒ¨æ“ä½œåŒº**ï¼š
    - æ¸…ç©ºæ‰€æœ‰ç´¢å¼•æŒ‰é’®
    - å…³é—­æŒ‰é’®
- [ ] **æ ¸å¿ƒåŠŸèƒ½**ï¼š
  - `load_status()` - ä» IndexManager åŠ è½½ç´¢å¼•çŠ¶æ€
  - `refresh_status()` - åˆ·æ–°çŠ¶æ€æ˜¾ç¤º
  - `rebuild_document_index()` - é‡å»ºæ–‡æ¡£ç´¢å¼•
  - `rebuild_code_index()` - é‡å»ºä»£ç ç´¢å¼•
  - `clear_document_index()` - æ¸…ç©ºæ–‡æ¡£ç´¢å¼•
  - `clear_code_index()` - æ¸…ç©ºä»£ç ç´¢å¼•
  - `clear_all_indexes()` - æ¸…ç©ºæ‰€æœ‰ç´¢å¼•
- [ ] **ç¡®è®¤å¯¹è¯æ¡†**ï¼š
  - æ¸…ç©ºæ“ä½œå‰æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
  - é‡å»ºæ“ä½œå‰æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†ï¼ˆæç¤ºå°†åˆ é™¤ç°æœ‰ç´¢å¼•ï¼‰
- [ ] **å®æ—¶æ›´æ–°**ï¼š
  - è®¢é˜…ç´¢å¼•ç›¸å…³äº‹ä»¶ï¼Œå®æ—¶æ›´æ–°çŠ¶æ€æ˜¾ç¤º
  - ç´¢å¼•è¿›è¡Œä¸­æ—¶æ˜¾ç¤ºè¿›åº¦æ¡
- [ ] **è¢«è°ƒç”¨æ–¹**ï¼š`main_window.py`

---

### 5.14 ä¸ç»Ÿä¸€ä¿¡æ¯å±•ç¤ºé¢æ¿é›†æˆ

> **âš ï¸ æ¶æ„è¯´æ˜**ï¼šRAG æ¨¡å—çš„ä¿¡æ¯å±•ç¤ºã€æ—¥å¿—æŸ¥çœ‹ã€å¤åˆ¶å¯¼å‡ºç­‰åŠŸèƒ½ç»Ÿä¸€ç”±é˜¶æ®µä¹çš„"ç»Ÿä¸€ä¿¡æ¯å±•ç¤ºé¢æ¿"ï¼ˆUnified Info Panelï¼‰è´Ÿè´£ã€‚æœ¬é˜¶æ®µä»…å®šä¹‰ RAG äº‹ä»¶å’Œæ•°æ®ç»“æ„ï¼Œä¸å®ç°ç‹¬ç«‹çš„æ—¥å¿—æœåŠ¡ã€å¯¼å‡ºæœåŠ¡æˆ–æ—¥å¿—æŸ¥çœ‹å™¨é¢æ¿ã€‚

> **è®¾è®¡åŸåˆ™**ï¼š
> - èŒè´£å•ä¸€ï¼šRAG æ¨¡å—ä¸“æ³¨äºç´¢å¼•å’Œæ£€ç´¢ï¼Œä¿¡æ¯å±•ç¤ºç”±ç»Ÿä¸€é¢æ¿è´Ÿè´£
> - äº‹ä»¶é©±åŠ¨ï¼šRAG æ¨¡å—å‘å¸ƒç»“æ„åŒ–äº‹ä»¶ï¼Œç»Ÿä¸€é¢æ¿è®¢é˜…å¹¶å¤„ç†
> - æ ¼å¼åŒ–åˆ†ç¦»ï¼šé¢†åŸŸå±‚äº‹ä»¶åªæºå¸¦ç»“æ„åŒ–ä¸šåŠ¡æ•°æ®ï¼Œæ ¼å¼åŒ–é€»è¾‘ç”±é˜¶æ®µä¹çš„æ ¼å¼åŒ–å™¨è´Ÿè´£

#### 5.14.1 RAG äº‹ä»¶æ•°æ®è§„èŒƒ

##### `DOCUMENT_INDEX_COMPLETE` äº‹ä»¶æ•°æ®

- [ ] **äº‹ä»¶å**ï¼š`KnowledgeEvents.DOCUMENT_INDEX_COMPLETE`
- [ ] **æ•°æ®ç»“æ„**ï¼š
  ```python
  {
    "collection_name": str,          # é›†åˆåç§°
    "document_count": int,           # æ–‡æ¡£æ•°é‡
    "chunk_count": int,              # åˆ†ç‰‡æ•°é‡
    "duration_seconds": float,       # ç´¢å¼•è€—æ—¶
    "files_indexed": List[str],      # å·²ç´¢å¼•æ–‡ä»¶åˆ—è¡¨
  }
  ```

##### `SEARCH_COMPLETE` äº‹ä»¶æ•°æ®

- [ ] **äº‹ä»¶å**ï¼š`KnowledgeEvents.SEARCH_COMPLETE`
- [ ] **æ•°æ®ç»“æ„**ï¼š
  ```python
  {
    "query": str,                    # æŸ¥è¯¢æ–‡æœ¬
    "results": List[SearchResult],   # æ£€ç´¢ç»“æœåˆ—è¡¨
    "total_candidates": int,         # å€™é€‰æ€»æ•°
    "search_time_ms": float,         # æ£€ç´¢è€—æ—¶
    "cache_hit": bool,               # æ˜¯å¦ç¼“å­˜å‘½ä¸­
  }
  ```

##### `EMBEDDING_MODEL_READY` äº‹ä»¶æ•°æ®

- [ ] **äº‹ä»¶å**ï¼š`KnowledgeEvents.EMBEDDING_MODEL_READY`
- [ ] **æ•°æ®ç»“æ„**ï¼š
  ```python
  {
    "model_name": str,               # æ¨¡å‹åç§°
    "provider": str,                 # å‚å•†æ ‡è¯†
    "dimensions": int,               # å‘é‡ç»´åº¦
    "device": str,                   # è¿è¡Œè®¾å¤‡
  }
  ```

#### 5.14.2 ç»Ÿä¸€ä¿¡æ¯é¢æ¿é›†æˆç‚¹

> **é›†æˆè¯´æ˜**ï¼šRAG æ¨¡å—çš„è¾“å‡ºä¿¡æ¯å°†è‡ªåŠ¨æ¨é€åˆ°ç»Ÿä¸€ä¿¡æ¯å±•ç¤ºé¢æ¿ï¼ˆé˜¶æ®µä¹ 9.0 èŠ‚ï¼‰ï¼Œä¾¿äºç”¨æˆ·é›†ä¸­æŸ¥çœ‹å’Œç®¡ç†

- [ ] **ç´¢å¼•çŠ¶æ€å¡ç‰‡**ï¼š`RAGInfoCollector`ï¼ˆé˜¶æ®µä¹ï¼‰è®¢é˜… `DOCUMENT_INDEX_COMPLETE` äº‹ä»¶ï¼Œåˆ›å»º `InfoCard`
- [ ] **æ£€ç´¢ç»“æœå¡ç‰‡**ï¼š`RAGInfoCollector` è®¢é˜… `SEARCH_COMPLETE` äº‹ä»¶ï¼Œåˆ›å»º `InfoCard`
- [ ] **åµŒå…¥æ¨¡å‹çŠ¶æ€å¡ç‰‡**ï¼š`RAGInfoCollector` è®¢é˜… `EMBEDDING_MODEL_READY` äº‹ä»¶ï¼Œåˆ›å»º `InfoCard`
- [ ] **æ ¼å¼åŒ–èŒè´£**ï¼šç”±é˜¶æ®µä¹çš„ `RAGFormatter` è´Ÿè´£ç”Ÿæˆå±•ç¤ºæ–‡æœ¬
- [ ] **å¤åˆ¶å¯¼å‡ºåŠŸèƒ½**ï¼šç”±ç»Ÿä¸€ä¿¡æ¯é¢æ¿çš„ `export_dialog.py` ç»Ÿä¸€æä¾›

---

### 5.15 ä¸å…ƒå™¨ä»¶ç³»ç»Ÿçš„é›†æˆé¢„ç•™ï¼ˆé˜¶æ®µåå®ç°ï¼‰

> **è®¾è®¡è¯´æ˜**ï¼šé˜¶æ®µåå®ç°å…ƒå™¨ä»¶å•†åŸé›†æˆåï¼Œå¯å°†å…ƒå™¨ä»¶æ•°æ®å’Œæ•°æ®æ‰‹å†Œç´¢å¼•åˆ°çŸ¥è¯†åº“ï¼Œå¢å¼º RAG æ£€ç´¢èƒ½åŠ›ã€‚

#### 5.15.1 å…ƒå™¨ä»¶æ•°æ®ç´¢å¼•é¢„ç•™

- [ ] **å…ƒå™¨ä»¶è§„æ ¼ç´¢å¼•**ï¼š
  - å°†å¸¸ç”¨å…ƒå™¨ä»¶çš„è§„æ ¼å‚æ•°ç´¢å¼•åˆ° `documents` é›†åˆ
  - æ”¯æŒè¯­ä¹‰æœç´¢ï¼ˆå¦‚"ä½å™ªå£°è¿æ”¾æ¨è"ã€"é«˜ç²¾åº¦ç”µé˜»"ï¼‰
  - å…ƒå™¨ä»¶æ•°æ®æ¥æºï¼š`ComponentService.search_component()` è¿”å›ç»“æœ
- [ ] **æ•°æ®æ‰‹å†Œç´¢å¼•**ï¼š
  - ä¸‹è½½çš„æ•°æ®æ‰‹å†Œï¼ˆPDFï¼‰å¯ç´¢å¼•åˆ° `documents` é›†åˆ
  - ä½¿ç”¨ `PDFExtractor` æå–æ–‡æœ¬å†…å®¹
  - å…ƒæ•°æ®åŒ…å«ï¼šå…ƒå™¨ä»¶å‹å·ã€åˆ¶é€ å•†ã€åˆ†ç±»
- [ ] **ç´¢å¼•è§¦å‘æ—¶æœº**ï¼š
  - ç”¨æˆ·æ‰‹åŠ¨è§¦å‘"ç´¢å¼•å…ƒå™¨ä»¶æ•°æ®"
  - ä¸‹è½½æ–°æ•°æ®æ‰‹å†Œåè‡ªåŠ¨ç´¢å¼•

#### 5.15.2 æ£€ç´¢å¢å¼ºé¢„ç•™

- [ ] **å…ƒå™¨ä»¶æ¨èæ£€ç´¢**ï¼š
  - ç”¨æˆ·è¯¢é—®å…ƒå™¨ä»¶é€‰å‹æ—¶ï¼Œç»“åˆçŸ¥è¯†åº“å’Œå•†åŸ API
  - å…ˆä»çŸ¥è¯†åº“æ£€ç´¢ç›¸å…³æŠ€æœ¯æ–‡æ¡£
  - å†è°ƒç”¨å•†åŸ API è·å–å®æ—¶åº“å­˜å’Œä»·æ ¼
- [ ] **æŸ¥è¯¢æ‰©å±•å¢å¼º**ï¼š
  - åœ¨ `QueryExpander` ä¸­æ·»åŠ å…ƒå™¨ä»¶æœ¯è¯­æ‰©å±•
  - æ”¯æŒå‹å·åˆ«åï¼ˆå¦‚ "741" â†’ "LM741"ã€"Î¼A741"ï¼‰
  - æ”¯æŒå‚æ•°å•ä½è½¬æ¢ï¼ˆå¦‚ "10K" â†’ "10kÎ©"ï¼‰

---

### 5.16 é˜¶æ®µäº”æ£€æŸ¥ç‚¹

#### 5.16.1 æ•°æ®æ¨¡å‹æ£€æŸ¥

- [ ] **DocumentChunk æ•°æ®ç±»**ï¼š
  - æ‰€æœ‰å­—æ®µæ­£ç¡®å®šä¹‰
  - åºåˆ—åŒ–/ååºåˆ—åŒ–æ­£å¸¸
  - çˆ¶å­åˆ†å—å…³è”æ­£ç¡®
- [ ] **SearchResult æ•°æ®ç±»**ï¼š
  - æ£€ç´¢ç»“æœç»“æ„å®Œæ•´
  - åˆ†æ•°å’Œå…ƒæ•°æ®æ­£ç¡®
- [ ] **IndexStatus æ•°æ®ç±»**ï¼š
  - ç´¢å¼•çŠ¶æ€ä¿¡æ¯å®Œæ•´
  - å·²ç´¢å¼•æ–‡ä»¶åˆ—è¡¨æ­£ç¡®

#### 5.16.2 æ–‡æ¡£å¤„ç†æ£€æŸ¥

- [ ] **PDF æå–**ï¼š
  - æ–‡æœ¬æå–å‡†ç¡®
  - ç»“æ„ä¿¡æ¯ä¿ç•™ï¼ˆæ ‡é¢˜ã€æ®µè½ï¼‰
  - è¡¨æ ¼å’Œå…¬å¼è¯†åˆ«æ­£å¸¸
- [ ] **Word æå–**ï¼š
  - æ–‡æœ¬æå–å‡†ç¡®
  - æ ·å¼ä¿¡æ¯ä¿ç•™
- [ ] **Markdown è§£æ**ï¼š
  - ç»“æ„è§£ææ­£ç¡®
  - ä»£ç å—è¯†åˆ«æ­£å¸¸
- [ ] **å…ƒæ•°æ®æå–**ï¼š
  - æ ‡é¢˜ã€ä½œè€…æå–å‡†ç¡®
  - ç”µè·¯æœ¯è¯­è¯†åˆ«æ­£å¸¸
- [ ] **åˆ†å—ç­–ç•¥**ï¼š
  - è¯­ä¹‰åˆ†å—è¾¹ç•Œæ­£ç¡®
  - é€’å½’åˆ†å—å¤§å°åˆç†
  - çˆ¶å­åˆ†å—å…³è”æ­£ç¡®

#### 5.16.3 å‘é‡å­˜å‚¨æ£€æŸ¥

- [ ] **ChromaDB åˆå§‹åŒ–**ï¼š
  - æ•°æ®åº“æ–‡ä»¶æ­£ç¡®åˆ›å»º
  - æŒä¹…åŒ–æ¨¡å¼æ­£å¸¸
- [ ] **é›†åˆç®¡ç†**ï¼š
  - `documents` é›†åˆæ­£ç¡®åˆ›å»º
  - `code` é›†åˆæ­£ç¡®åˆ›å»º
  - é›†åˆç»Ÿè®¡ä¿¡æ¯å‡†ç¡®
- [ ] **å¢é‡æ›´æ–°**ï¼š
  - æ–‡ä»¶å“ˆå¸Œæ¯”å¯¹æ­£ç¡®
  - å˜æ›´æ£€æµ‹å‡†ç¡®
  - upsert æ“ä½œæ­£å¸¸
- [ ] **ç¼“å­˜ç®¡ç†**ï¼š
  - æŸ¥è¯¢ç¼“å­˜å‘½ä¸­æ­£å¸¸
  - ç¼“å­˜å¤±æ•ˆæœºåˆ¶æ­£ç¡®
  - ç¼“å­˜ç»Ÿè®¡å‡†ç¡®

#### 5.16.4 æ£€ç´¢åŠŸèƒ½æ£€æŸ¥

- [ ] **æ··åˆæ£€ç´¢**ï¼š
  - å‘é‡æ£€ç´¢ç»“æœç›¸å…³æ€§é«˜
  - BM25 æ£€ç´¢ç»“æœå‡†ç¡®
  - RRF èåˆç®—æ³•æ­£ç¡®
- [ ] **æŸ¥è¯¢æ‰©å±•**ï¼š
  - åŒä¹‰è¯æ‰©å±•æ­£å¸¸
  - ç”µè·¯æœ¯è¯­æå–å‡†ç¡®
  - ä¸­è‹±æ–‡äº’è¯‘æ­£ç¡®
- [ ] **é‡æ’åº**ï¼š
  - æ¨¡å‹åŠ è½½æ­£å¸¸
  - é‡æ’åºè´¨é‡æå‡æ˜æ˜¾
  - GPU åŠ é€Ÿæ­£å¸¸ï¼ˆå¦‚å¯ç”¨ï¼‰
- [ ] **ä¸Šä¸‹æ–‡æ‰©å±•**ï¼š
  - ç›¸é‚»åˆ†ç‰‡è·å–æ­£ç¡®
  - çˆ¶å­åˆ†å—æ‰©å±•æ­£å¸¸
  - Token é¢„ç®—æˆªæ–­æ­£ç¡®

#### 5.16.5 ä»£ç ç´¢å¼•æ£€æŸ¥

- [ ] **SPICE åˆ†å—**ï¼š
  - å­ç”µè·¯è¾¹ç•Œè¯†åˆ«æ­£ç¡®
  - æ§åˆ¶å—è¾¹ç•Œè¯†åˆ«æ­£ç¡®
  - è¯­æ³•æ ‡ç­¾æå–å‡†ç¡®
- [ ] **Python åˆ†å—**ï¼š
  - ç±»/å‡½æ•°è¾¹ç•Œè¯†åˆ«æ­£ç¡®
  - ç¬¦å·åç§°æå–å‡†ç¡®
- [ ] **æ–‡ä»¶å˜æ›´å¤„ç†**ï¼š
  - äº‹ä»¶è¿‡æ»¤è§„åˆ™æ­£ç¡®
  - äº‹ä»¶åˆ†ç±»å‡†ç¡®
  - é‡å¤äº‹ä»¶è¿‡æ»¤æ­£å¸¸
- [ ] **é˜²æŠ–åŠ¨æœºåˆ¶**ï¼š
  - å»¶è¿Ÿæ‰§è¡Œæ­£å¸¸
  - å¤šæ¬¡å˜æ›´åˆå¹¶æ­£ç¡®
  - æ‰¹é‡æ›´æ–°è§¦å‘æ­£å¸¸

#### 5.16.6 åµŒå…¥æ¨¡å‹æ£€æŸ¥

- [ ] **æ¨¡å‹åŠ è½½**ï¼š
  - æœ¬åœ°æ¨¡å‹åŠ è½½æ­£å¸¸
  - å›é€€åˆ° HuggingFace æ­£å¸¸
  - è®¾å¤‡é€‰æ‹©æ­£ç¡®
- [ ] **æ‰¹é‡åµŒå…¥**ï¼š
  - æ‰¹é‡å¤„ç†æ€§èƒ½è¾¾æ ‡
  - è¿›åº¦å›è°ƒæ­£å¸¸
  - é”™è¯¯å¤„ç†æ­£ç¡®
- [ ] **GPU åŠ é€Ÿ**ï¼š
  - CUDA æ£€æµ‹æ­£å¸¸ï¼ˆå¦‚å¯ç”¨ï¼‰
  - MPS æ£€æµ‹æ­£å¸¸ï¼ˆå¦‚å¯ç”¨ï¼‰
  - å†…å­˜ç®¡ç†æ­£ç¡®

#### 5.16.7 è‡ªåŠ¨ç´¢å¼•è§¦å‘æ£€æŸ¥

- [ ] **é¡¹ç›®æ‰“å¼€è§¦å‘**ï¼š
  - æ‰“å¼€é¡¹ç›®æ—¶è‡ªåŠ¨è§¦å‘ç´¢å¼•
  - ç´¢å¼•ä¸é˜»å¡é¡¹ç›®æ‰“å¼€æµç¨‹
  - çŠ¶æ€æ æ­£ç¡®æ˜¾ç¤ºç´¢å¼•è¿›åº¦
- [ ] **å¢é‡ç´¢å¼•**ï¼š
  - é¦–æ¬¡æ‰“å¼€æ‰§è¡Œå…¨é‡ç´¢å¼•
  - å†æ¬¡æ‰“å¼€ä»…ç´¢å¼•å˜æ›´æ–‡ä»¶
  - æ–‡ä»¶å“ˆå¸Œæ¯”å¯¹æ­£ç¡®
- [ ] **è¿›åº¦æ˜¾ç¤º**ï¼š
  - çŠ¶æ€æ è¿›åº¦ç»„ä»¶æ­£å¸¸æ˜¾ç¤º
  - è¿›åº¦æ›´æ–°æµç•…ï¼ˆæ— å¡é¡¿ï¼‰
  - ç´¢å¼•å®Œæˆåè‡ªåŠ¨æ¶ˆå¤±
- [ ] **å–æ¶ˆæ”¯æŒ**ï¼š
  - ç‚¹å‡»å–æ¶ˆæŒ‰é’®æ­£å¸¸å–æ¶ˆç´¢å¼•
  - å–æ¶ˆåçŠ¶æ€æ­£ç¡®æ¸…ç†
- [ ] **é”™è¯¯å¤„ç†**ï¼š
  - ç´¢å¼•å¤±è´¥æ—¶æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
  - é”™è¯¯ä¿¡æ¯å¯æŸ¥çœ‹

#### 5.16.8 RAG Worker æ£€æŸ¥

- [ ] **ç´¢å¼•ä»»åŠ¡**ï¼š
  - ä»»åŠ¡å¯åŠ¨æ­£å¸¸
  - è¿›åº¦æŠ¥å‘Šæ­£ç¡®
  - å–æ¶ˆæ”¯æŒæ­£å¸¸
- [ ] **æ£€ç´¢ä»»åŠ¡**ï¼š
  - ä»»åŠ¡æ‰§è¡Œæ­£å¸¸
  - ç»“æœè¿”å›æ­£ç¡®
  - é”™è¯¯å¤„ç†æ­£å¸¸

#### 5.16.10 UI é›†æˆæ£€æŸ¥

- [ ] **èœå•æ **ï¼š
  - çŸ¥è¯†åº“èœå•åŠŸèƒ½æ­£å¸¸
  - èœå•é¡¹çŠ¶æ€æ­£ç¡®
- [ ] **å·¥å…·æ **ï¼š
  - ç´¢å¼•æŒ‰é’®åŠŸèƒ½æ­£å¸¸
  - RAG å¼€å…³åŠŸèƒ½æ­£å¸¸
- [ ] **çŠ¶æ€æ **ï¼š
  - ç´¢å¼•çŠ¶æ€æ˜¾ç¤ºæ­£ç¡®
  - è¿›åº¦æ˜¾ç¤ºæ­£å¸¸
- [ ] **ç´¢å¼•çŠ¶æ€å¯¹è¯æ¡†**ï¼š
  - çŠ¶æ€åŠ è½½æ­£ç¡®
  - æ–‡ä»¶åˆ—è¡¨æ˜¾ç¤ºæ­£å¸¸
  - æ“ä½œæŒ‰é’®åŠŸèƒ½æ­£å¸¸

#### 5.16.11 äº‹ä»¶æœºåˆ¶æ£€æŸ¥

- [ ] **äº‹ä»¶å‘å¸ƒ**ï¼š
  - `VECTOR_STORE_READY` æ­£å¸¸å‘å¸ƒ
  - `DOCUMENT_INDEX_*` äº‹ä»¶æ­£å¸¸å‘å¸ƒ
  - `CODE_INDEX_*` äº‹ä»¶æ­£å¸¸å‘å¸ƒ
  - `SEARCH_*` äº‹ä»¶æ­£å¸¸å‘å¸ƒ
  - `EMBEDDING_MODEL_*` äº‹ä»¶æ­£å¸¸å‘å¸ƒ
- [ ] **äº‹ä»¶è®¢é˜…**ï¼š
  - UI ç»„ä»¶æ­£ç¡®è®¢é˜…äº‹ä»¶
  - äº‹ä»¶å¤„ç†åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œ

#### 5.16.12 å›½é™…åŒ–æ£€æŸ¥

- [ ] **UI æ–‡æœ¬**ï¼š
  - æ‰€æœ‰æ–°å¢æ–‡æœ¬æ”¯æŒä¸­è‹±æ–‡
  - `retranslate_ui()` æ­£ç¡®å®ç°
- [ ] **è¯­è¨€åˆ‡æ¢**ï¼š
  - åˆ‡æ¢å UI æ­£ç¡®åˆ·æ–°

#### 5.16.13 å†·å¯åŠ¨æµ‹è¯•

- [ ] **ä»é›¶å¯åŠ¨**ï¼š
  - åˆ é™¤ç¼“å­˜åæ­£å¸¸å¯åŠ¨
  - å‘é‡å­˜å‚¨æ­£ç¡®åˆå§‹åŒ–
  - åµŒå…¥æ¨¡å‹æ­£ç¡®åŠ è½½
  - æ— å¾ªç¯ä¾èµ–æŠ¥é”™
- [ ] **æ€§èƒ½åŸºå‡†**ï¼š
  - åµŒå…¥æ¨¡å‹åŠ è½½æ—¶é—´ < 10 ç§’
  - å•æ–‡æ¡£ç´¢å¼•æ—¶é—´ < 5 ç§’
  - æ£€ç´¢å“åº”æ—¶é—´ < 500ms

#### 5.16.14 ç»Ÿä¸€ä¿¡æ¯é¢æ¿é›†æˆéªŒæ”¶

- [ ] **äº‹ä»¶å‘å¸ƒéªŒæ”¶**ï¼š
  - ç´¢å¼•å®Œæˆå `DOCUMENT_INDEX_COMPLETE` äº‹ä»¶æ­£ç¡®å‘å¸ƒ
  - æ£€ç´¢å®Œæˆå `SEARCH_COMPLETE` äº‹ä»¶æ­£ç¡®å‘å¸ƒ
  - åµŒå…¥æ¨¡å‹å°±ç»ªå `EMBEDDING_MODEL_READY` äº‹ä»¶æ­£ç¡®å‘å¸ƒ
  - äº‹ä»¶æ•°æ®ç»“æ„ç¬¦åˆè§„èŒƒ
- [ ] **é›†æˆéªŒæ”¶**ï¼š
  - é˜¶æ®µä¹çš„ `RAGInfoCollector` èƒ½æ­£ç¡®è®¢é˜…å¹¶å¤„ç†äº‹ä»¶
  - ç´¢å¼•çŠ¶æ€å¡ç‰‡åœ¨ç»Ÿä¸€ä¿¡æ¯é¢æ¿æ­£ç¡®æ˜¾ç¤º
  - æ£€ç´¢ç»“æœå¡ç‰‡åœ¨ç»Ÿä¸€ä¿¡æ¯é¢æ¿æ­£ç¡®æ˜¾ç¤º
