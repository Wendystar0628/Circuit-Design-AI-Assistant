## 阶段九：端到端集成验证 (0.5周)

> **目标**：在阶段六至八完成后，进行完整的端到端集成验证，确保所有模块协同工作正常；同时实现统一信息展示面板，整合各类重要输出信息

> **前置条件**：
> - 阶段六（工具系统与执行框架）已完成
> - 阶段七（LangGraph工作流编排）已完成
> - 阶段八（人机协作与检查点）已完成

---

### 9.0 统一信息展示面板 (Unified Info Panel)

> **⚠️ UI架构对齐**：本节设计遵循阶段一 1.7 节定义的 UI 层架构规范：
> - InfoPanelViewModel 继承自 `BaseViewModel`，遵循统一的 ViewModel 模式
> - 面板通过 `PanelManager` 注册，通过 `TabController` 管理标签页切换（TAB_INFO）
> - 各模块事件通过 `UIEventBridge` 桥接到 UI 层，确保主线程执行
> - 与对话面板、仿真面板的通信通过 EventBus，禁止直接调用

> **设计目标**：整合 RAG 索引、仿真结果、元器件商城、工具执行等多类重要输出信息，提供集中的查看、复制、保存功能，便于用户快速分析和归档

> **设计原则**：
> - 信息聚合：将分散在各模块的输出信息统一展示
> - 实时更新：订阅各模块事件，自动刷新显示
> - 可操作性：支持复制、导出、保存等操作
> - 历史追溯：保留信息历史记录，支持回溯查看

#### 9.0.1 统一信息展示面板架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        统一信息展示面板架构                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    InfoPanelManager (门面类)                     │   │
│  │  - 协调各信息收集器                                              │   │
│  │  - 管理信息卡片生命周期                                          │   │
│  │  - 提供统一的信息查询接口                                        │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                    │                                    │
│          ┌─────────────────────────┼─────────────────────────┐         │
│          │                         │                         │         │
│          ▼                         ▼                         ▼         │
│  ┌───────────────┐       ┌───────────────┐       ┌───────────────┐    │
│  │ SimulationInfo│       │  RAGInfoCollector │   │ComponentInfo  │    │
│  │   Collector   │       │                   │   │  Collector    │    │
│  │               │       │                   │   │               │    │
│  │ - 仿真结果    │       │ - 索引状态        │   │ - 搜索结果    │    │
│  │ - 性能指标    │       │ - 检索结果        │   │ - BOM分析     │    │
│  │ - 错误信息    │       │ - 嵌入模型状态    │   │ - 库存状态    │    │
│  └───────────────┘       └───────────────────┘   └───────────────┘    │
│          │                         │                         │         │
│          └─────────────────────────┼─────────────────────────┘         │
│                                    │                                    │
│                                    ▼                                    │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    InfoCardStore (信息存储)                      │   │
│  │  - 按类别存储信息卡片                                            │   │
│  │  - 维护历史记录                                                  │   │
│  │  - 支持查询和过滤                                                │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                    │                                    │
│                                    ▼                                    │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    UnifiedInfoPanel (UI组件)                     │   │
│  │  - 标签页切换（仿真/RAG/元器件/操作）                            │   │
│  │  - 卡片式信息展示                                                │   │
│  │  - 工具栏（复制/导出/清空）                                      │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 9.0.2 信息面板目录结构

```
# 数据模型（shared 层）
shared/
├── info_types.py                # 信息类别枚举
├── content_reference.py         # 内容引用类型定义
└── info_card.py                 # 信息卡片数据模型

# 持久化服务（application 层）
application/
└── info_card_persistence_service.py  # 信息卡片持久化服务

# UI 组件（presentation 层）
presentation/panels/info_panel/
├── __init__.py
├── unified_info_panel.py        # 统一信息面板主组件
├── info_panel_view_model.py     # ViewModel 层
├── info_panel_manager.py        # 信息面板管理器（门面类）
├── info_card_store.py           # 信息卡片内存存储
├── content_reference_resolver.py # 内容引用解析器
├── collectors/                  # 信息收集器
│   ├── __init__.py
│   ├── base_collector.py        # 收集器抽象基类
│   ├── simulation_info_collector.py  # 仿真信息收集
│   ├── rag_info_collector.py    # RAG信息收集
│   ├── component_info_collector.py   # 元器件信息收集
│   └── operation_info_collector.py   # 操作信息收集
├── formatters/                  # 格式化器
│   ├── __init__.py
│   ├── base_formatter.py        # 格式化器抽象基类
│   ├── formatter_registry.py    # 格式化器注册表
│   ├── simulation_formatter.py  # 仿真结果格式化器
│   ├── metrics_formatter.py     # 性能指标格式化器
│   ├── rag_formatter.py         # RAG信息格式化器
│   ├── component_formatter.py   # 元器件信息格式化器
│   └── operation_formatter.py   # 操作记录格式化器
├── cards/                       # 信息卡片组件
│   ├── __init__.py
│   ├── base_info_card.py        # 卡片基类
│   ├── simulation_card.py       # 仿真结果卡片
│   ├── metrics_card.py          # 性能指标卡片
│   ├── rag_status_card.py       # RAG状态卡片
│   ├── search_result_card.py    # 检索结果卡片
│   ├── component_card.py        # 元器件卡片
│   ├── bom_card.py              # BOM分析卡片
│   └── operation_card.py        # 操作记录卡片
└── widgets/                     # 辅助组件
    ├── __init__.py
    ├── info_toolbar.py          # 信息面板工具栏
    ├── category_tabs.py         # 类别标签页
    └── export_dialog.py         # 导出对话框
```

#### 9.0.2.1 存储路径规范

```
.circuit_ai/
├── conversations/
│   └── {session_id}/
│       ├── messages.json        # 对话消息（阶段三）
│       └── info_cards.json      # 信息卡片（本阶段新增）
├── bom_reports/                 # BOM 报告文件
│   └── {report_id}.csv
├── diffs/                       # Diff 文件
│   └── {operation_id}.diff
└── datasheets/                  # 元器件数据手册
    └── {part_number}.pdf

simulation_results/
└── {session_id}/
    ├── {analysis_type}_{timestamp}.png  # 仿真图表
    └── {analysis_type}_{timestamp}.csv  # 原始数据
```

#### 9.0.3 信息类别与数据模型定义

> **⚠️ 核心设计原则：引用而非内嵌 (Reference over Embedding)**
> - 对于大体积数据（图片、大段文本），JSON 中只存储文件路径引用或摘要
> - 仿真图表存储为 `simulation_results/.../chart.png` 的相对路径，而非 Base64 字符串
> - RAG 结果存储 ChunkID 和摘要，点击时再去原始文件查询详情
> - 此设计避免 JSON 文件膨胀导致的性能问题和数据损坏风险

##### 9.0.3.1 `info_types.py` - 信息类型定义

- [ ] **文件路径**：`shared/info_types.py`
- [ ] **信息类别枚举 `InfoCategory`**：
  ```python
  class InfoCategory(Enum):
      SIMULATION = "simulation"    # 仿真相关信息
      RAG = "rag"                  # RAG检索相关信息
      COMPONENT = "component"      # 元器件商城相关信息
      OPERATION = "operation"      # 工具执行操作信息
  ```

##### 9.0.3.2 `content_reference.py` - 内容引用类型

- [ ] **文件路径**：`shared/content_reference.py`
- [ ] **职责**：定义大数据内容的引用类型，避免直接内嵌大数据到 JSON
- [ ] **引用类型枚举 `ReferenceType`**：
  ```python
  class ReferenceType(Enum):
      FILE_PATH = "file_path"      # 文件路径引用（图片、PDF等）
      CHUNK_ID = "chunk_id"        # RAG 分片 ID 引用
      SIMULATION_ID = "sim_id"     # 仿真结果 ID 引用
  ```
- [ ] **内容引用数据类 `ContentReference`**：
  ```python
  @dataclass
  class ContentReference:
      ref_type: ReferenceType      # 引用类型
      ref_value: str               # 引用值（路径或ID）
      summary: str                 # 内容摘要（用于预览）
      mime_type: Optional[str]     # MIME 类型（如 image/png）
      size_bytes: Optional[int]    # 原始数据大小（字节）
  ```
- [ ] **设计说明**：
  - `ref_value` 对于文件路径使用相对于项目根目录的路径
  - `summary` 提供快速预览，避免每次都加载完整内容
  - `size_bytes` 用于 UI 显示和加载策略判断

##### 9.0.3.3 `info_card.py` - 信息卡片数据模型

- [ ] **文件路径**：`shared/info_card.py`
- [ ] **职责**：定义信息卡片的核心数据结构
- [ ] **信息卡片数据类 `InfoCard`**：
  ```python
  @dataclass
  class InfoCard:
      card_id: str                 # 卡片唯一标识（UUID）
      session_id: str              # 所属会话 ID（用于持久化隔离）
      category: InfoCategory       # 信息类别
      card_type: str               # 卡片类型（如 simulation_result, metrics, search_result）
      title: str                   # 卡片标题
      content: InfoCardContent     # 卡片内容（轻量数据 + 引用）
      timestamp: str               # 创建时间（ISO 8601 格式）
      source: str                  # 信息来源（模块名）
      is_pinned: bool              # 是否置顶
      is_read: bool                # 是否已读
      metadata: Dict[str, Any]     # 额外元数据（轻量）
  ```
- [ ] **卡片内容数据类 `InfoCardContent`**：
  ```python
  @dataclass
  class InfoCardContent:
      """
      卡片内容容器，区分轻量数据和重量数据引用
      
      设计原则：
      - inline_data: 仅存储轻量级数据（<1KB），如数值、状态、简短文本
      - references: 存储大数据的引用，实际数据存储在外部文件
      """
      inline_data: Dict[str, Any]           # 轻量内联数据（直接序列化）
      references: List[ContentReference]    # 大数据引用列表
  ```
- [ ] **内联数据规范**：
  - 数值类型：增益、带宽、相位裕度等指标值
  - 状态类型：成功/失败、进度百分比
  - 短文本：错误消息、摘要（限制 500 字符以内）
  - 列表：元器件型号列表（限制 20 项以内）
- [ ] **引用数据规范**：
  - 仿真图表：`ContentReference(FILE_PATH, "simulation_results/session_xxx/ac_analysis.png", "AC分析波形图")`
  - RAG 检索结果：`ContentReference(CHUNK_ID, "chunk_abc123", "关于运放设计的文档片段...")`
  - BOM 报告：`ContentReference(FILE_PATH, ".circuit_ai/bom_reports/report_xxx.csv", "BOM成本分析报告")`

#### 9.0.4 信息面板事件定义

- [ ] **文件路径**：`shared/events/info_panel_events.py`
- [ ] **事件常量定义**：
  ```python
  class InfoPanelEvents:
      """信息面板相关事件定义"""
      
      # 信息卡片事件
      INFO_CARD_ADDED = "info_panel.card_added"
      INFO_CARD_UPDATED = "info_panel.card_updated"
      INFO_CARD_REMOVED = "info_panel.card_removed"
      INFO_CARD_PINNED = "info_panel.card_pinned"
      
      # 面板状态事件
      PANEL_CATEGORY_CHANGED = "info_panel.category_changed"
      PANEL_CLEARED = "info_panel.cleared"
      
      # 导出事件
      INFO_EXPORTED = "info_panel.exported"
      INFO_COPIED = "info_panel.copied"
  ```

#### 9.0.5 信息收集器模块组

##### 9.0.5.1 `base_collector.py` - 收集器抽象基类

- [ ] **文件路径**：`presentation/panels/info_panel/collectors/base_collector.py`
- [ ] **职责**：定义信息收集器的统一接口
- [ ] **抽象基类 `BaseInfoCollector`**：
  - `get_category()` - 返回收集器负责的信息类别
  - `subscribe_events()` - 订阅相关事件
  - `unsubscribe_events()` - 取消事件订阅
  - `collect_current()` - 收集当前状态信息
  - `on_event(event_type, data)` - 事件处理回调
  - `create_card(card_type, title, content)` - 创建信息卡片
- [ ] **被调用方**：`InfoPanelManager`

##### 9.0.5.2 `simulation_info_collector.py` - 仿真信息收集器

- [ ] **文件路径**：`presentation/panels/info_panel/collectors/simulation_info_collector.py`
- [ ] **职责**：收集仿真相关的所有输出信息
- [ ] **订阅事件**：
  - `SIMULATION_COMPLETE` - 仿真完成
  - `SIMULATION_ERROR` - 仿真错误
  - `SIMULATION_PROGRESS` - 仿真进度
- [ ] **收集内容**：
  - 仿真结果摘要（分析类型、耗时、成功/失败）
  - 性能指标（增益、带宽、相位裕度等）
  - 错误信息（错误类型、行号、建议）
  - 图表路径列表
- [ ] **卡片类型**：
  - `simulation_result` - 仿真结果卡片
  - `metrics` - 性能指标卡片
  - `simulation_error` - 仿真错误卡片

##### 9.0.5.3 `rag_info_collector.py` - RAG信息收集器

- [ ] **文件路径**：`presentation/panels/info_panel/collectors/rag_info_collector.py`
- [ ] **职责**：收集 RAG 索引和检索相关信息
- [ ] **订阅事件**：
  - `DOCUMENT_INDEX_COMPLETE` - 文档索引完成
  - `CODE_INDEX_UPDATED` - 代码索引更新
  - `SEARCH_COMPLETE` - 检索完成
  - `EMBEDDING_MODEL_READY` - 嵌入模型就绪
- [ ] **收集内容**：
  - 索引状态（文档数、分片数、最后更新时间）
  - 检索结果（匹配文档、相关度分数、来源）
  - 嵌入模型状态（模型名、维度、加载状态）
- [ ] **卡片类型**：
  - `index_status` - 索引状态卡片
  - `search_result` - 检索结果卡片
  - `embedding_status` - 嵌入模型状态卡片

##### 9.0.5.4 `component_info_collector.py` - 元器件信息收集器

- [ ] **文件路径**：`presentation/panels/info_panel/collectors/component_info_collector.py`
- [ ] **职责**：收集元器件商城相关信息
- [ ] **订阅事件**：
  - `SEARCH_COMPLETE` - 元器件搜索完成
  - `BOM_ANALYSIS_COMPLETE` - BOM分析完成
  - `MODEL_DOWNLOAD_COMPLETE` - SPICE模型下载完成
  - `STOCK_LOW_WARNING` - 库存预警
- [ ] **收集内容**：
  - 搜索结果（元器件列表、规格、价格）
  - BOM分析报告（成本估算、可用性摘要）
  - SPICE模型下载状态
  - 库存预警信息
- [ ] **卡片类型**：
  - `component_search` - 元器件搜索结果卡片
  - `bom_report` - BOM分析报告卡片
  - `model_download` - 模型下载状态卡片
  - `stock_warning` - 库存预警卡片

##### 9.0.5.5 `operation_info_collector.py` - 操作信息收集器

- [ ] **文件路径**：`presentation/panels/info_panel/collectors/operation_info_collector.py`
- [ ] **职责**：收集工具执行操作信息
- [ ] **订阅事件**：
  - `EVENT_OPERATION_RECORDED` - 操作记录
  - `EVENT_TOOL_EXECUTION_COMPLETE` - 工具执行完成
- [ ] **收集内容**：
  - 文件操作记录（创建、修改）
  - 工具执行结果（成功/失败、耗时）
- [ ] **卡片类型**：
  - `file_operation` - 文件操作卡片
  - `tool_execution` - 工具执行卡片

#### 9.0.6 信息卡片存储与持久化

> **⚠️ 持久化设计原则**：
> - 持久化是默认行为，不是可选的
> - 存储路径与会话绑定：`.circuit_ai/conversations/{session_id}/info_cards.json`
> - 采用"引用而非内嵌"策略，JSON 文件保持轻量
> - 会话切换时自动加载/保存对应会话的卡片

##### 9.0.6.1 `info_card_store.py` - 信息卡片内存存储

- [ ] **文件路径**：`presentation/panels/info_panel/info_card_store.py`
- [ ] **职责**：管理当前会话的信息卡片内存缓存，提供查询和过滤接口
- [ ] **设计原则**：
  - 仅负责内存中的卡片管理，不直接处理持久化
  - 持久化由 `InfoCardPersistenceService` 负责
  - 通过事件与持久化服务解耦
- [ ] **核心功能**：
  - `add_card(card)` - 添加信息卡片到内存
  - `update_card(card_id, updates)` - 更新卡片内容
  - `remove_card(card_id)` - 移除卡片
  - `get_cards_by_category(category)` - 按类别获取卡片
  - `get_cards_by_session(session_id)` - 按会话获取卡片
  - `get_recent_cards(limit)` - 获取最近的卡片
  - `pin_card(card_id)` - 置顶卡片
  - `clear_category(category)` - 清空指定类别
  - `clear_session(session_id)` - 清空指定会话的卡片
  - `load_cards(cards)` - 批量加载卡片（从持久化恢复时调用）
  - `get_all_cards()` - 获取所有卡片（用于持久化）
- [ ] **内存限制策略**：
  - 每个类别最多保留 100 条记录
  - 超出限制时移除最旧的非置顶卡片
  - 置顶卡片不受数量限制
- [ ] **被调用方**：`InfoPanelManager`、`InfoCardPersistenceService`

##### 9.0.6.2 `info_card_persistence_service.py` - 信息卡片持久化服务

- [ ] **文件路径**：`application/info_card_persistence_service.py`
- [ ] **职责**：负责信息卡片的持久化存储和恢复，与会话生命周期绑定
- [ ] **服务名称**：`SVC_INFO_CARD_PERSISTENCE`
- [ ] **存储路径规范**：
  - 会话级存储：`.circuit_ai/conversations/{session_id}/info_cards.json`
  - 与对话消息存储目录保持一致，便于统一管理
- [ ] **核心功能**：
  - `save_cards(session_id, cards)` - 保存指定会话的卡片到文件
  - `load_cards(session_id)` - 从文件加载指定会话的卡片
  - `delete_session_cards(session_id)` - 删除指定会话的卡片文件
  - `get_sessions_with_cards()` - 获取有卡片数据的会话列表
  - `cleanup_orphaned_cards()` - 清理孤立的卡片数据（会话已删除但卡片文件残留）
- [ ] **生命周期钩子**：
  - 订阅 `EVENT_SESSION_CHANGED` - 会话切换时保存当前会话卡片，加载新会话卡片
  - 订阅 `EVENT_STATE_PROJECT_CLOSED` - 项目关闭时保存当前会话卡片
  - 订阅 `EVENT_STATE_PROJECT_OPENED` - 项目打开时加载当前会话卡片
- [ ] **序列化策略**：
  - 仅序列化 `InfoCard` 的轻量字段
  - `content.inline_data` 直接序列化
  - `content.references` 序列化引用信息，不序列化实际内容
  - 使用 `orjson` 或标准 `json` 进行序列化
- [ ] **异步写入**：
  - 使用 `asyncio.to_thread` 避免阻塞主线程
  - 写入前先写入临时文件，成功后原子替换
- [ ] **依赖模块**：
  - `InfoCardStore` - 获取内存中的卡片
  - `AsyncFileOps` + `json_utils` - JSON 文件读写
  - `EventBus` - 事件订阅
- [ ] **被调用方**：`InfoPanelManager`、`ProjectService`

##### 9.0.6.3 `content_reference_resolver.py` - 内容引用解析器

- [ ] **文件路径**：`presentation/panels/info_panel/content_reference_resolver.py`
- [ ] **职责**：将 `ContentReference` 解析为实际内容，支持懒加载和缓存
- [ ] **核心功能**：
  - `resolve(reference)` - 解析引用，返回实际内容
  - `resolve_async(reference)` - 异步解析引用
  - `prefetch(references)` - 预加载多个引用
  - `invalidate_cache(ref_value)` - 使缓存失效
  - `clear_cache()` - 清空所有缓存
- [ ] **解析策略**：
  - `FILE_PATH` 类型：读取文件内容，图片返回 QPixmap 或 Base64
  - `CHUNK_ID` 类型：从 VectorStore 或原始文件查询内容
  - `SIMULATION_ID` 类型：从仿真结果存储查询详细数据
- [ ] **缓存策略**：
  - LRU 缓存，最大 50 项
  - 缓存过期时间：5 分钟
  - 大文件（>1MB）不缓存，每次重新加载
- [ ] **错误处理**：
  - 引用文件不存在：返回占位内容 + 错误提示
  - 解析超时：返回摘要内容 + 加载中提示
- [ ] **被调用方**：`InfoPanelViewModel`、各类型卡片组件

#### 9.0.7 信息面板管理器

##### `info_panel_manager.py` - 信息面板管理器

- [ ] **文件路径**：`presentation/panels/info_panel/info_panel_manager.py`
- [ ] **职责**：作为门面类协调各信息收集器和持久化服务，提供统一的信息管理接口
- [ ] **核心功能**：
  - `initialize()` - 初始化所有收集器和持久化服务
  - `shutdown()` - 关闭所有收集器，触发持久化保存
  - `get_cards(category)` - 获取指定类别的卡片
  - `get_all_cards()` - 获取所有卡片
  - `export_to_file(path, categories, format)` - 导出到文件
  - `copy_to_clipboard(card_ids)` - 复制到剪贴板
  - `clear_all()` - 清空所有信息
  - `on_session_changed(old_session_id, new_session_id)` - 会话切换处理
- [ ] **初始化流程**：
  1. 创建 `InfoCardStore` 实例
  2. 获取 `InfoCardPersistenceService` 服务
  3. 从持久化服务加载当前会话的卡片
  4. 创建各类别收集器实例
  5. 调用各收集器的 `subscribe_events()` 订阅事件
  6. 调用各收集器的 `collect_current()` 收集当前状态
- [ ] **会话切换处理**：
  1. 调用持久化服务保存当前会话卡片
  2. 清空内存中的卡片
  3. 从持久化服务加载新会话的卡片
  4. 发布 `INFO_CARDS_LOADED` 事件通知 UI 刷新
- [ ] **依赖模块**：
  - `InfoCardStore` - 卡片内存存储
  - `InfoCardPersistenceService` - 卡片持久化
  - `SimulationInfoCollector` - 仿真信息收集
  - `RAGInfoCollector` - RAG信息收集
  - `ComponentInfoCollector` - 元器件信息收集
  - `OperationInfoCollector` - 操作信息收集
- [ ] **被调用方**：`InfoPanelViewModel`、`MainWindow`

#### 9.0.7.1 `info_panel_view_model.py` - ViewModel 层

- [ ] **文件路径**：`presentation/panels/info_panel/info_panel_view_model.py`
- [ ] **职责**：作为 UI 与 InfoPanelManager 之间的中间层，隔离 unified_info_panel 与数据层的直接依赖，**统一负责将结构化数据格式化为展示文本**
- [ ] **继承**：`BaseViewModel`（阶段一 1.7.2 节定义）
- [ ] **核心属性**（供 UI 绑定）：
  - `current_category` - 当前选中的信息类别
  - `cards` - 当前类别的卡片列表（`DisplayInfoCard` 类型）
  - `unread_counts` - 各类别未读数量字典
  - `filter_keyword` - 当前过滤关键词
  - `is_loading` - 是否正在加载
- [ ] **核心方法**：
  - `switch_category(category)` - 切换类别并加载卡片
  - `load_cards()` - 从 InfoPanelManager 加载卡片并转换为显示格式
  - `format_card(card)` - 将 InfoCard 转换为 DisplayInfoCard，委托给对应的格式化器
  - `filter_cards(keyword)` - 按关键词过滤卡片
  - `pin_card(card_id)` - 置顶卡片
  - `copy_card(card_id)` - 复制卡片内容
  - `export_cards(format, path)` - 导出卡片
  - `clear_category()` - 清空当前类别
  - `mark_as_read(card_id)` - 标记卡片已读
- [ ] **格式化委托逻辑**：
  - 根据 `card.card_type` 选择对应的格式化器
  - 调用格式化器的 `format()` 方法生成 `content_html`
  - 格式化器负责国际化、单位转换、趋势标识等展示逻辑
- [ ] **事件订阅**：
  - 订阅 `INFO_CARD_ADDED` 更新卡片列表和未读计数
  - 订阅 `INFO_CARD_UPDATED` 更新对应卡片显示
  - 订阅 `INFO_CARD_REMOVED` 移除卡片
  - 订阅 `PANEL_CATEGORY_CHANGED` 切换类别
- [ ] **DisplayInfoCard 数据结构**（UI 友好格式）：
  - `id` - 卡片唯一标识
  - `category` - 信息类别
  - `card_type` - 卡片类型
  - `title` - 卡片标题（已国际化）
  - `content_html` - 已渲染的 HTML 内容
  - `copyable_text` - 可复制的纯文本
  - `timestamp_display` - 格式化的时间戳
  - `icon` - 卡片图标
  - `is_pinned` - 是否置顶
  - `is_read` - 是否已读
  - `is_expanded` - 是否展开
  - `actions` - 可用操作列表
- [ ] **与 TabController 集成**：
  - 新卡片添加时，若当前不在信息标签页，更新徽章计数
  - 切换到信息标签页时，清除徽章并标记卡片已读
- [ ] **依赖模块**：
  - `InfoPanelManager` - 卡片数据来源
  - `formatters/` - 格式化器模块组
- [ ] **被调用方**：`unified_info_panel.py`

#### 9.0.7.2 格式化器模块组 (`formatters/`)

> **设计原则**：格式化逻辑集中在 ViewModel 层，领域层事件只携带结构化业务数据，不包含展示文本。这样做的好处是：领域层保持纯净、格式化逻辑便于国际化和样式调整、减少跨阶段耦合。

##### 格式化器目录结构

```
presentation/panels/info_panel/formatters/
├── __init__.py
├── base_formatter.py            # 格式化器抽象基类
├── formatter_registry.py        # 格式化器注册表
├── simulation_formatter.py      # 仿真结果格式化器
├── metrics_formatter.py         # 性能指标格式化器
├── rag_formatter.py             # RAG信息格式化器
├── component_formatter.py       # 元器件信息格式化器
└── operation_formatter.py       # 操作记录格式化器
```

##### `base_formatter.py` - 格式化器抽象基类

- [ ] **文件路径**：`presentation/panels/info_panel/formatters/base_formatter.py`
- [ ] **职责**：定义格式化器的统一接口
- [ ] **抽象基类 `BaseCardFormatter`**：
  - `get_card_types()` - 返回支持的卡片类型列表
  - `format(card: InfoCard) -> FormattedContent` - 格式化卡片内容
  - `get_title(card: InfoCard) -> str` - 生成国际化标题
  - `get_icon(card: InfoCard) -> str` - 获取卡片图标
  - `get_actions(card: InfoCard) -> list[CardAction]` - 获取可用操作
- [ ] **FormattedContent 数据结构**：
  - `content_html: str` - 渲染后的 HTML 内容
  - `copyable_text: str` - 可复制的纯文本
  - `summary: str` - 简短摘要（用于通知等场景）
- [ ] **被调用方**：`InfoPanelViewModel`

##### `formatter_registry.py` - 格式化器注册表

- [ ] **文件路径**：`presentation/panels/info_panel/formatters/formatter_registry.py`
- [ ] **职责**：管理格式化器的注册和查找
- [ ] **核心功能**：
  - `register(formatter)` - 注册格式化器
  - `get_formatter(card_type)` - 根据卡片类型获取格式化器
  - `get_all_formatters()` - 获取所有已注册格式化器
- [ ] **初始化时自动注册**：
  - `SimulationFormatter` - 处理 simulation_result、simulation_error
  - `MetricsFormatter` - 处理 metrics
  - `RAGFormatter` - 处理 index_status、search_result、embedding_status
  - `ComponentFormatter` - 处理 component_search、bom_report、model_download、stock_warning
  - `OperationFormatter` - 处理 file_operation、tool_execution
- [ ] **被调用方**：`InfoPanelViewModel`

##### `simulation_formatter.py` - 仿真结果格式化器

- [ ] **文件路径**：`presentation/panels/info_panel/formatters/simulation_formatter.py`
- [ ] **职责**：格式化仿真相关的信息卡片
- [ ] **支持的卡片类型**：`simulation_result`、`simulation_error`
- [ ] **格式化逻辑**：
  - `simulation_result`：生成分析类型、耗时、成功状态的展示文本
  - `simulation_error`：生成错误类型、位置、恢复建议的展示文本
- [ ] **被调用方**：`FormatterRegistry`

##### `metrics_formatter.py` - 性能指标格式化器

- [ ] **文件路径**：`presentation/panels/info_panel/formatters/metrics_formatter.py`
- [ ] **职责**：格式化性能指标卡片，包含趋势对比逻辑
- [ ] **支持的卡片类型**：`metrics`
- [ ] **格式化逻辑**：
  - 从结构化数据中提取当前值、目标值、上次值
  - 计算趋势（↑ 改善 / ↓ 下降 / → 持平）
  - 生成带单位的格式化文本（如 "增益: 18.5dB (目标: 20dB) ↑+1.0dB"）
  - 标记是否达成目标（使用 `check.svg` / `cross.svg` 图标）
- [ ] **被调用方**：`FormatterRegistry`

##### `rag_formatter.py` - RAG信息格式化器

- [ ] **文件路径**：`presentation/panels/info_panel/formatters/rag_formatter.py`
- [ ] **职责**：格式化 RAG 相关的信息卡片
- [ ] **支持的卡片类型**：`index_status`、`search_result`、`embedding_status`
- [ ] **格式化逻辑**：
  - `index_status`：生成文档数、分片数、最后更新时间的展示文本
  - `search_result`：生成匹配文档列表、相关度分数的展示文本
  - `embedding_status`：生成模型名、维度、加载状态的展示文本
- [ ] **被调用方**：`FormatterRegistry`

##### `component_formatter.py` - 元器件信息格式化器

- [ ] **文件路径**：`presentation/panels/info_panel/formatters/component_formatter.py`
- [ ] **职责**：格式化元器件商城相关的信息卡片
- [ ] **支持的卡片类型**：`component_search`、`bom_report`、`model_download`、`stock_warning`
- [ ] **格式化逻辑**：
  - `component_search`：生成元器件列表、规格、价格的展示文本
  - `bom_report`：生成总成本、可用性摘要的展示文本
  - `model_download`：生成下载状态、进度的展示文本
  - `stock_warning`：生成库存预警信息的展示文本
- [ ] **被调用方**：`FormatterRegistry`

##### `operation_formatter.py` - 操作记录格式化器

- [ ] **文件路径**：`presentation/panels/info_panel/formatters/operation_formatter.py`
- [ ] **职责**：格式化工具执行操作的信息卡片
- [ ] **支持的卡片类型**：`file_operation`、`tool_execution`
- [ ] **格式化逻辑**：
  - `file_operation`：生成操作类型、文件路径、Diff 摘要的展示文本
  - `tool_execution`：生成工具名、执行结果、耗时的展示文本
- [ ] **被调用方**：`FormatterRegistry`

#### 9.0.8 统一信息面板 UI 组件

##### `unified_info_panel.py` - 统一信息面板

- [ ] **文件路径**：`presentation/panels/info_panel/unified_info_panel.py`
- [ ] **职责**：提供统一的信息展示界面，通过 ViewModel 获取数据
- [ ] **位置**：右栏标签页（与对话面板并列，TAB_INFO）
- [ ] **布局结构**（使用 SVG 图标，路径：`resources/icons/info_panel/`）：
  ```
  ┌─────────────────────────────────────────┐
  │ [仿真] [RAG] [元器件] [操作]  [search] [settings]  │  ← 类别标签页 + 工具按钮
  ├─────────────────────────────────────────┤
  │                                         │
  │  ┌─────────────────────────────────┐   │
  │  │ [chart] 仿真结果 - AC分析  14:30│   │  ← 信息卡片
  │  │ 增益: 18.5dB  带宽: 1.2MHz     │   │
  │  │ [复制] [查看详情] [导出]        │   │
  │  └─────────────────────────────────┘   │
  │                                         │
  │  ┌─────────────────────────────────┐   │
  │  │ [metrics] 性能指标        14:28 │   │
  │  │ 增益: 18.5dB (目标: 20dB)      │   │
  │  │ 带宽: 1.2MHz (目标: 1MHz) [check]│   │
  │  │ [复制] [对比历史]               │   │
  │  └─────────────────────────────────┘   │
  │                                         │
  │  ┌─────────────────────────────────┐   │
  │  │ [warning] 仿真错误        14:25 │   │
  │  │ 收敛失败 @ line 23              │   │
  │  │ [复制错误] [查看建议]           │   │
  │  └─────────────────────────────────┘   │
  │                                         │
  └─────────────────────────────────────────┘
  ```
- [ ] **与 ViewModel 集成**（解耦设计）：
  - 通过 `view_model.cards` 获取格式化后的卡片列表
  - 通过 `view_model.current_category` 获取当前类别
  - 通过 `view_model.unread_counts` 获取未读计数
  - 通过 `view_model.switch_category()` 切换类别
  - 通过 `view_model.copy_card()` 复制卡片
  - 不直接调用 InfoPanelManager，保持 UI 与数据层解耦
- [ ] **核心功能**：
  - `refresh_display()` - 从 ViewModel 获取数据并刷新显示
  - `on_category_tab_clicked(category)` - 类别标签点击处理
  - `on_card_action(card_id, action)` - 卡片操作处理
  - `on_filter_changed(keyword)` - 过滤关键词变更处理
- [ ] **工具栏功能**：
  - 搜索过滤：按关键词过滤卡片
  - 导出全部：导出当前类别所有卡片
  - 清空：清空当前类别
  - 设置：配置显示选项
- [ ] **卡片交互**：
  - 单击：展开/折叠详情
  - 复制按钮：复制卡片内容到剪贴板
  - 导出按钮：导出单个卡片
  - 置顶按钮：置顶重要卡片
- [ ] **与 TabController 集成**：
  - 通过 `TabController.set_badge(TAB_INFO, count)` 显示未读徽章
  - 切换到信息标签页时调用 `view_model.mark_all_as_read()`
- [ ] **国际化支持**：
  - 实现 `retranslate_ui()` 方法
  - 订阅 `EVENT_LANGUAGE_CHANGED` 事件
- [ ] **被调用方**：`MainWindow`（布局）、`TabController`（标签页管理）

#### 9.0.9 信息卡片组件

##### `base_info_card.py` - 卡片基类

- [ ] **文件路径**：`presentation/panels/info_panel/cards/base_info_card.py`
- [ ] **职责**：定义信息卡片的通用布局和行为
- [ ] **基类 `BaseInfoCard(QFrame)`**：
  - `set_data(card: InfoCard)` - 设置卡片数据
  - `get_copyable_text()` - 获取可复制的文本
  - `get_exportable_data()` - 获取可导出的数据
  - `toggle_expand()` - 切换展开/折叠
  - `on_action(action)` - 处理卡片操作
- [ ] **通用布局**：
  - 标题栏：图标 + 标题 + 时间戳 + 置顶按钮
  - 内容区：由子类实现具体布局
  - 操作栏：复制、导出、查看详情等按钮
- [ ] **样式**：
  - 圆角边框
  - 悬停高亮
  - 置顶卡片特殊背景色

##### 各类型卡片组件

- [ ] **`simulation_card.py`** - 仿真结果卡片
  - 显示：分析类型、耗时、成功/失败状态
  - 操作：查看图表、导出数据
- [ ] **`metrics_card.py`** - 性能指标卡片
  - 显示：各指标当前值、目标值、达成状态
  - 操作：对比历史、导出报告
- [ ] **`rag_status_card.py`** - RAG状态卡片
  - 显示：索引状态、文档数、最后更新时间
  - 操作：刷新索引、查看详情
- [ ] **`search_result_card.py`** - 检索结果卡片
  - 显示：匹配文档列表、相关度分数
  - 操作：打开文档、复制引用
- [ ] **`component_card.py`** - 元器件卡片
  - 显示：型号、规格、价格、库存状态
  - 操作：查看详情、添加到设计
- [ ] **`bom_card.py`** - BOM分析卡片
  - 显示：总成本、可用性摘要、警告
  - 操作：导出CSV、查找替代料
- [ ] **`operation_card.py`** - 操作记录卡片
  - 显示：操作类型、文件路径、Diff摘要
  - 操作：查看Diff、撤销操作

#### 9.0.10 导出功能

##### `export_dialog.py` - 导出对话框

- [ ] **文件路径**：`presentation/panels/info_panel/widgets/export_dialog.py`
- [ ] **职责**：提供信息导出的配置界面
- [ ] **支持格式**：
  - JSON - 结构化数据导出
  - Markdown - 可读性报告
  - CSV - 表格数据（仅适用于指标、BOM等）
  - TXT - 纯文本
- [ ] **导出选项**：
  - 选择导出类别
  - 选择时间范围
  - 是否包含详情
  - 导出路径选择
- [ ] **被调用方**：`UnifiedInfoPanel`

#### 9.0.11 与其他模块的集成点

> **设计原则**：
> - 领域层事件只携带结构化业务数据，不包含展示文本
> - 格式化逻辑统一在 `InfoPanelViewModel` 的格式化器中完成
> - **大数据采用引用策略**：图片、大段文本等存储为文件，事件中只携带路径引用

##### 与阶段四（仿真引擎）集成

- [ ] **集成位置**：`domain/simulation/service/simulation_service.py`
- [ ] **集成方式**：仿真完成后发布事件，携带结构化结果数据
- [ ] **事件数据规范**：
  - `SIMULATION_COMPLETE` 事件携带 `SimulationResult` 对象和 `metrics` 字典
  - `SIMULATION_ERROR` 事件携带 `SimulationError` 对象
  - 不包含 `summary_text`、`metrics_formatted` 等展示层字段
- [ ] **大数据引用规范**：
  - 仿真图表存储路径：`simulation_results/{session_id}/{analysis_type}_{timestamp}.png`
  - 事件中携带 `chart_paths: List[str]` 而非 Base64 数据
  - 原始仿真数据存储路径：`simulation_results/{session_id}/{analysis_type}_{timestamp}.csv`
- [ ] **格式化职责**：由 `SimulationFormatter` 和 `MetricsFormatter` 负责生成展示文本
- [ ] **InfoCard 内容示例**：
  ```python
  InfoCardContent(
      inline_data={"analysis_type": "AC", "duration_ms": 1234, "success": True},
      references=[
          ContentReference(FILE_PATH, "simulation_results/sess_xxx/ac_20241221.png", "AC分析波形图", "image/png", 45000),
          ContentReference(FILE_PATH, "simulation_results/sess_xxx/ac_20241221.csv", "原始数据", "text/csv", 12000),
      ]
  )
  ```

##### 与阶段五（RAG知识检索）集成

- [ ] **集成位置**：`domain/knowledge/index_manager.py`、`domain/knowledge/retrieval/retrieval_service.py`
- [ ] **集成方式**：索引和检索完成后发布事件，携带结构化结果数据
- [ ] **事件数据规范**：
  - `DOCUMENT_INDEX_COMPLETE` 事件携带 `IndexStatus` 对象
  - `SEARCH_COMPLETE` 事件携带 `SearchResults` 对象
  - 不包含 `summary_text` 等展示层字段
- [ ] **大数据引用规范**：
  - 检索结果存储 `chunk_id` 和摘要（前 200 字符），不存储完整文本
  - 点击"查看详情"时通过 `ContentReferenceResolver` 从 VectorStore 或原始文件加载
  - 若原始文件已删除，显示"原文件不可用"提示
- [ ] **格式化职责**：由 `RAGFormatter` 负责生成展示文本
- [ ] **InfoCard 内容示例**：
  ```python
  InfoCardContent(
      inline_data={"query": "运放设计", "result_count": 5, "top_score": 0.92},
      references=[
          ContentReference(CHUNK_ID, "chunk_abc123", "关于运放设计的基本原理...", None, None),
          ContentReference(CHUNK_ID, "chunk_def456", "运放的频率响应分析...", None, None),
      ]
  )
  ```

##### 与阶段六（工具系统）集成

- [ ] **集成位置**：`application/tool_execution/operation_recorder.py`
- [ ] **集成方式**：操作记录时发布事件
- [ ] **事件数据规范**：`EVENT_OPERATION_RECORDED` 携带结构化操作记录
- [ ] **大数据引用规范**：
  - Diff 内容超过 1KB 时，存储为文件引用
  - Diff 文件路径：`.circuit_ai/diffs/{operation_id}.diff`
- [ ] **格式化职责**：由 `OperationFormatter` 负责生成展示文本

##### 与阶段十（元器件商城）集成

- [ ] **集成位置**：`domain/component/service/component_service.py`
- [ ] **集成方式**：搜索和分析完成后发布事件，携带结构化结果数据
- [ ] **事件数据规范**：
  - `SEARCH_COMPLETE` 事件携带 `ComponentSearchResult` 对象
  - `BOM_ANALYSIS_COMPLETE` 事件携带 `BOMReport` 对象
  - 不包含 `summary_text` 等展示层字段
- [ ] **大数据引用规范**：
  - BOM 报告存储路径：`.circuit_ai/bom_reports/{report_id}.csv`
  - 元器件数据手册存储路径：`.circuit_ai/datasheets/{part_number}.pdf`
  - 事件中携带文件路径引用
- [ ] **格式化职责**：由 `ComponentFormatter` 负责生成展示文本


---

